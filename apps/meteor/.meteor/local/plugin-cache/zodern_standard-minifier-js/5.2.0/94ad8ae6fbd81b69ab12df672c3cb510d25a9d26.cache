{"code":"function module(e,s,i){let t,r,n,o,a,h,d,c,l,g,u,p,m;i.export({Invitation:()=>f}),i.link(\"../core\",{fromBodyLegacy(e){t=e},getBody(e){r=e},Grammar(e){n=e},SignalingState(e){o=e},Timers(e){a=e},TransactionStateError(e){h=e}},0),i.link(\"../core/messages/utils\",{getReasonPhrase(e){d=e}},1),i.link(\"./exceptions\",{ContentTypeUnsupportedError(e){c=e},SessionDescriptionHandlerError(e){l=e},SessionTerminatedError(e){g=e}},2),i.link(\"./session\",{Session(e){u=e}},3),i.link(\"./session-state\",{SessionState(e){p=e}},4),i.link(\"./user-agent-options\",{SIPExtension(e){m=e}},5);class f extends u{constructor(e,s){super(e),this.incomingInviteRequest=s,this.disposed=!1,this.expiresTimer=void 0,this.isCanceled=!1,this.rel100=\"none\",this.rseq=Math.floor(1e4*Math.random()),this.userNoAnswerTimer=void 0,this.waitingForPrack=!1,this.logger=e.getLogger(\"sip.Invitation\");let i=this.incomingInviteRequest.message,t=i.getHeader(\"require\");t&&t.toLowerCase().includes(\"100rel\")&&(this.rel100=\"required\");let r=i.getHeader(\"supported\");if(r&&r.toLowerCase().includes(\"100rel\")&&(this.rel100=\"supported\"),i.toTag=s.toTag,\"string\"!=typeof i.toTag)throw TypeError(\"toTag should have been a string.\");if(this.userNoAnswerTimer=setTimeout(()=>{s.reject({statusCode:480}),this.stateTransition(p.Terminated)},this.userAgent.configuration.noAnswerTimeout?1e3*this.userAgent.configuration.noAnswerTimeout:6e4),i.hasHeader(\"expires\")){let e=1e3*Number(i.getHeader(\"expires\")||0);this.expiresTimer=setTimeout(()=>{this.state===p.Initial&&(s.reject({statusCode:487}),this.stateTransition(p.Terminated))},e)}let o=this.request.getHeader(\"P-Asserted-Identity\");o&&(this._assertedIdentity=n.nameAddrHeaderParse(o)),this._contact=this.userAgent.contact.toString();let a=i.parseHeader(\"Content-Disposition\");a&&\"render\"===a.type&&(this._renderbody=i.body,this._rendertype=i.getHeader(\"Content-Type\")),this._id=i.callId+i.fromTag,this.userAgent._sessions[this._id]=this}dispose(){if(this.disposed)return Promise.resolve();switch(this.disposed=!0,this.expiresTimer&&(clearTimeout(this.expiresTimer),this.expiresTimer=void 0),this.userNoAnswerTimer&&(clearTimeout(this.userNoAnswerTimer),this.userNoAnswerTimer=void 0),this.prackNeverArrived(),this.state){case p.Initial:case p.Establishing:return this.reject().then(()=>super.dispose());case p.Established:case p.Terminating:case p.Terminated:return super.dispose();default:throw Error(\"Unknown state.\")}}get autoSendAnInitialProvisionalResponse(){return\"required\"!==this.rel100&&this.userAgent.configuration.sendInitialProvisionalResponse}get body(){return this.incomingInviteRequest.message.body}get localIdentity(){return this.request.to}get remoteIdentity(){return this.request.from}get request(){return this.incomingInviteRequest.message}accept(e={}){if(this.logger.log(\"Invitation.accept\"),this.state!==p.Initial){let e=Error(`Invalid session state ${this.state}`);return this.logger.error(e.message),Promise.reject(e)}return e.sessionDescriptionHandlerModifiers&&(this.sessionDescriptionHandlerModifiers=e.sessionDescriptionHandlerModifiers),e.sessionDescriptionHandlerOptions&&(this.sessionDescriptionHandlerOptions=e.sessionDescriptionHandlerOptions),this.stateTransition(p.Establishing),this.sendAccept(e).then(({message:e,session:s})=>{s.delegate={onAck:e=>this.onAckRequest(e),onAckTimeout:()=>this.onAckTimeout(),onBye:e=>this.onByeRequest(e),onInfo:e=>this.onInfoRequest(e),onInvite:e=>this.onInviteRequest(e),onMessage:e=>this.onMessageRequest(e),onNotify:e=>this.onNotifyRequest(e),onPrack:e=>this.onPrackRequest(e),onRefer:e=>this.onReferRequest(e)},this._dialog=s,this.stateTransition(p.Established),this._replacee&&this._replacee._bye()}).catch(e=>this.handleResponseError(e))}progress(e={}){if(this.logger.log(\"Invitation.progress\"),this.state!==p.Initial){let e=Error(`Invalid session state ${this.state}`);return this.logger.error(e.message),Promise.reject(e)}let s=e.statusCode||180;if(s<100||s>199)throw TypeError(\"Invalid statusCode: \"+s);return(e.sessionDescriptionHandlerModifiers&&(this.sessionDescriptionHandlerModifiers=e.sessionDescriptionHandlerModifiers),e.sessionDescriptionHandlerOptions&&(this.sessionDescriptionHandlerOptions=e.sessionDescriptionHandlerOptions),this.waitingForPrack)?(this.logger.warn(\"Unexpected call for progress while waiting for prack, ignoring\"),Promise.resolve()):100===e.statusCode?this.sendProgressTrying().then(()=>{}).catch(e=>this.handleResponseError(e)):\"required\"===this.rel100||\"supported\"===this.rel100&&e.rel100||\"supported\"===this.rel100&&this.userAgent.configuration.sipExtension100rel===m.Required?this.sendProgressReliableWaitForPrack(e).then(()=>{}).catch(e=>this.handleResponseError(e)):this.sendProgress(e).then(()=>{}).catch(e=>this.handleResponseError(e))}reject(e={}){if(this.logger.log(\"Invitation.reject\"),this.state!==p.Initial&&this.state!==p.Establishing){let e=Error(`Invalid session state ${this.state}`);return this.logger.error(e.message),Promise.reject(e)}let s=e.statusCode||480,i=e.reasonPhrase?e.reasonPhrase:d(s),r=e.extraHeaders||[];if(s<300||s>699)throw TypeError(\"Invalid statusCode: \"+s);let n=e.body?t(e.body):void 0;return s<400?this.incomingInviteRequest.redirect([],{statusCode:s,reasonPhrase:i,extraHeaders:r,body:n}):this.incomingInviteRequest.reject({statusCode:s,reasonPhrase:i,extraHeaders:r,body:n}),this.stateTransition(p.Terminated),Promise.resolve()}_onCancel(e){if(this.logger.log(\"Invitation._onCancel\"),this.state!==p.Initial&&this.state!==p.Establishing){this.logger.error(`CANCEL received while in state ${this.state}, dropping request`);return}this.isCanceled=!0,this.incomingInviteRequest.reject({statusCode:487}),this.stateTransition(p.Terminated)}handlePrackOfferAnswer(e){if(!this.dialog)throw Error(\"Dialog undefined.\");let s=r(e.message);if(!s||\"session\"!==s.contentDisposition)return Promise.resolve(void 0);let i={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptions,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiers};switch(this.dialog.signalingState){case o.Initial:throw Error(`Invalid signaling state ${this.dialog.signalingState}.`);case o.Stable:return this.setAnswer(s,i).then(()=>void 0);case o.HaveLocalOffer:throw Error(`Invalid signaling state ${this.dialog.signalingState}.`);case o.HaveRemoteOffer:return this.setOfferAndGetAnswer(s,i);case o.Closed:default:throw Error(`Invalid signaling state ${this.dialog.signalingState}.`)}}handleResponseError(e){let s=480;if(e instanceof Error?this.logger.error(e.message):this.logger.error(e),e instanceof c?(this.logger.error(\"A session description handler occurred while sending response (content type unsupported\"),s=415):e instanceof l?this.logger.error(\"A session description handler occurred while sending response\"):e instanceof g?this.logger.error(\"Session ended before response could be formulated and sent (while waiting for PRACK)\"):e instanceof h&&this.logger.error(\"Session changed state before response could be formulated and sent\"),this.state===p.Initial||this.state===p.Establishing)try{this.incomingInviteRequest.reject({statusCode:s}),this.stateTransition(p.Terminated)}catch(e){throw this.logger.error(\"An error occurred attempting to reject the request while handling another error\"),e}if(this.isCanceled){this.logger.warn(\"An error occurred while attempting to formulate and send a response to an incoming INVITE. However a CANCEL was received and processed while doing so which can (and often does) result in errors occurring as the session terminates in the meantime. Said error is being ignored.\");return}throw e}onAckTimeout(){if(this.logger.log(\"Invitation.onAckTimeout\"),!this.dialog)throw Error(\"Dialog undefined.\");this.logger.log(\"No ACK received for an extended period of time, terminating session\"),this.dialog.bye(),this.stateTransition(p.Terminated)}sendAccept(e={}){let s={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptions,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiers},i=e.extraHeaders||[];return this.waitingForPrack?this.waitForArrivalOfPrack().then(()=>clearTimeout(this.userNoAnswerTimer)).then(()=>this.generateResponseOfferAnswer(this.incomingInviteRequest,s)).then(e=>this.incomingInviteRequest.accept({statusCode:200,body:e,extraHeaders:i})):(clearTimeout(this.userNoAnswerTimer),this.generateResponseOfferAnswer(this.incomingInviteRequest,s).then(e=>this.incomingInviteRequest.accept({statusCode:200,body:e,extraHeaders:i})))}sendProgress(e={}){let s=e.statusCode||180,i=e.reasonPhrase,r=(e.extraHeaders||[]).slice(),n=e.body?t(e.body):void 0;if(183===s&&!n)return this.sendProgressWithSDP(e);try{let e=this.incomingInviteRequest.progress({statusCode:s,reasonPhrase:i,extraHeaders:r,body:n});return this._dialog=e.session,Promise.resolve(e)}catch(e){return Promise.reject(e)}}sendProgressWithSDP(e={}){let s={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptions,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiers},i=e.statusCode||183,t=e.reasonPhrase,r=(e.extraHeaders||[]).slice();return this.generateResponseOfferAnswer(this.incomingInviteRequest,s).then(e=>this.incomingInviteRequest.progress({statusCode:i,reasonPhrase:t,extraHeaders:r,body:e})).then(e=>(this._dialog=e.session,e))}sendProgressReliable(e={}){return e.extraHeaders=(e.extraHeaders||[]).slice(),e.extraHeaders.push(\"Require: 100rel\"),e.extraHeaders.push(\"RSeq: \"+Math.floor(1e4*Math.random())),this.sendProgressWithSDP(e)}sendProgressReliableWaitForPrack(e={}){let s;let i={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptions,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiers},t=e.statusCode||183,r=e.reasonPhrase,n=(e.extraHeaders||[]).slice();return n.push(\"Require: 100rel\"),n.push(\"RSeq: \"+this.rseq++),new Promise((e,o)=>{this.waitingForPrack=!0,this.generateResponseOfferAnswer(this.incomingInviteRequest,i).then(e=>(s=e,this.incomingInviteRequest.progress({statusCode:t,reasonPhrase:r,extraHeaders:n,body:s}))).then(i=>{let h,d;this._dialog=i.session,i.session.delegate={onPrack:s=>{h=s,clearTimeout(c),clearTimeout(p),this.waitingForPrack&&(this.waitingForPrack=!1,this.handlePrackOfferAnswer(h).then(s=>{try{d=h.accept({statusCode:200,body:s}),this.prackArrived(),e({prackRequest:h,prackResponse:d,progressResponse:i})}catch(e){o(e)}}).catch(e=>o(e)))}};let c=setTimeout(()=>{this.waitingForPrack&&(this.waitingForPrack=!1,this.logger.warn(\"No PRACK received, rejecting INVITE.\"),clearTimeout(p),this.reject({statusCode:504}).then(()=>o(new g)).catch(e=>o(e)))},64*a.T1),l=()=>{try{this.incomingInviteRequest.progress({statusCode:t,reasonPhrase:r,extraHeaders:n,body:s})}catch(e){this.waitingForPrack=!1,o(e);return}p=setTimeout(l,u*=2)},u=a.T1,p=setTimeout(l,u)}).catch(e=>{this.waitingForPrack=!1,o(e)})})}sendProgressTrying(){try{let e=this.incomingInviteRequest.trying();return Promise.resolve(e)}catch(e){return Promise.reject(e)}}waitForArrivalOfPrack(){if(this.waitingForPrackPromise)throw Error(\"Already waiting for PRACK\");return this.waitingForPrackPromise=new Promise((e,s)=>{this.waitingForPrackResolve=e,this.waitingForPrackReject=s}),this.waitingForPrackPromise}prackArrived(){this.waitingForPrackResolve&&this.waitingForPrackResolve(),this.waitingForPrackPromise=void 0,this.waitingForPrackResolve=void 0,this.waitingForPrackReject=void 0}prackNeverArrived(){this.waitingForPrackReject&&this.waitingForPrackReject(new g),this.waitingForPrackPromise=void 0,this.waitingForPrackResolve=void 0,this.waitingForPrackReject=void 0}}}","map":"{\"version\":3,\"sources\":[\"<anon>\"],\"names\":[],\"mappings\":\"\"}"}