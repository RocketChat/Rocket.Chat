{"code":"function module(e,t,s){let r,i,n,a,o,u,c,g,l,h,d,p,f,v,S,C,m,A,R;s.export({UserAgentCore:()=>w}),s.link(\"../messages\",{C(e){r=e},constructOutgoingResponse(e){i=e},OutgoingRequestMessage(e){n=e}},0),s.link(\"../transactions\",{InviteServerTransaction(e){a=e},NonInviteClientTransaction(e){o=e},TransactionState(e){u=e}},1),s.link(\"../user-agents\",{InviteUserAgentClient(e){c=e},InviteUserAgentServer(e){g=e},MessageUserAgentClient(e){l=e},MessageUserAgentServer(e){h=e},NotifyUserAgentServer(e){d=e},PublishUserAgentClient(e){p=e},ReferUserAgentServer(e){f=e},RegisterUserAgentClient(e){v=e},RegisterUserAgentServer(e){S=e},SubscribeUserAgentClient(e){C=e},SubscribeUserAgentServer(e){m=e},UserAgentClient(e){A=e}},2),s.link(\"./allowed-methods\",{AllowedMethods(e){R=e}},3);let b=[\"application/sdp\",\"application/dtmf-relay\"];class w{constructor(e,t={}){this.userAgentClients=new Map,this.userAgentServers=new Map,this.configuration=e,this.delegate=t,this.dialogs=new Map,this.subscribers=new Map,this.logger=e.loggerFactory.getLogger(\"sip.user-agent-core\")}dispose(){this.reset()}reset(){this.dialogs.forEach(e=>e.dispose()),this.dialogs.clear(),this.subscribers.forEach(e=>e.dispose()),this.subscribers.clear(),this.userAgentClients.forEach(e=>e.dispose()),this.userAgentClients.clear(),this.userAgentServers.forEach(e=>e.dispose()),this.userAgentServers.clear()}get loggerFactory(){return this.configuration.loggerFactory}get transport(){let e=this.configuration.transportAccessor();if(!e)throw Error(\"Transport undefined.\");return e}invite(e,t){return new c(this,e,t)}message(e,t){return new l(this,e,t)}publish(e,t){return new p(this,e,t)}register(e,t){return new v(this,e,t)}subscribe(e,t){return new C(this,e,t)}request(e,t){return new A(o,this,e,t)}makeOutgoingRequestMessage(e,t,s,i,a,o,u){let c=this.configuration.sipjsId,g=this.configuration.displayName,l=this.configuration.viaForceRport,h=this.configuration.hackViaTcp,d=this.configuration.supportedOptionTags.slice();e===r.REGISTER&&d.push(\"path\",\"gruu\"),e===r.INVITE&&(this.configuration.contact.pubGruu||this.configuration.contact.tempGruu)&&d.push(\"gruu\");let p=this.configuration.routeSet,f=this.configuration.userAgentHeaderFieldValue,v=this.configuration.viaHost,S=Object.assign(Object.assign({},{callIdPrefix:c,forceRport:l,fromDisplayName:g,hackViaTcp:h,optionTags:d,routeSet:p,userAgentString:f,viaHost:v}),a);return new n(e,t,s,i,S,o,u)}receiveIncomingRequestFromTransport(e){this.receiveRequestFromTransport(e)}receiveIncomingResponseFromTransport(e){this.receiveResponseFromTransport(e)}replyStateless(e,t){let s=this.configuration.userAgentHeaderFieldValue,r=this.configuration.supportedOptionTagsResponse;t=Object.assign(Object.assign({},t),{userAgent:s,supported:r});let n=i(e,t);return this.transport.send(n.message).catch(t=>{t instanceof Error&&this.logger.error(t.message),this.logger.error(`Transport error occurred sending stateless reply to ${e.method} request.`)}),n}receiveRequestFromTransport(e){let t=e.viaBranch,s=this.userAgentServers.get(t);if(e.method===r.ACK&&s&&s.transaction.state===u.Accepted&&s instanceof g){this.logger.warn(`Discarding out of dialog ACK after 2xx response sent on transaction ${t}.`);return}if(e.method===r.CANCEL){s?(this.replyStateless(e,{statusCode:200}),s.transaction instanceof a&&s.transaction.state===u.Proceeding&&s instanceof g&&s.receiveCancel(e)):this.replyStateless(e,{statusCode:481});return}if(s){s.transaction.receiveRequest(e);return}this.receiveRequest(e)}receiveRequest(e){var t,s,i,n;if(!R.includes(e.method)){let t=\"Allow: \"+R.toString();this.replyStateless(e,{statusCode:405,extraHeaders:[t]});return}if(!e.ruri)throw Error(\"Request-URI undefined.\");if(\"sip\"!==e.ruri.scheme){this.replyStateless(e,{statusCode:416});return}let a=e.ruri;if((!(t=this.configuration.aor)||t.user!==a.user)&&(!(s=this.configuration.contact.uri)||s.user!==a.user)&&(!(i=this.configuration.contact.pubGruu)||i.user!==a.user)&&(!(n=this.configuration.contact.tempGruu)||n.user!==a.user)){this.logger.warn(\"Request-URI does not point to us.\"),e.method!==r.ACK&&this.replyStateless(e,{statusCode:404});return}if(e.method===r.INVITE&&!e.hasHeader(\"Contact\")){this.replyStateless(e,{statusCode:400,reasonPhrase:\"Missing Contact Header\"});return}if(!e.toTag){let t=e.viaBranch;if(!this.userAgentServers.has(t)){let t=Array.from(this.userAgentServers.values()).some(t=>t.transaction.request.fromTag===e.fromTag&&t.transaction.request.callId===e.callId&&t.transaction.request.cseq===e.cseq);if(t){this.replyStateless(e,{statusCode:482});return}}}e.toTag?this.receiveInsideDialogRequest(e):this.receiveOutsideDialogRequest(e)}receiveInsideDialogRequest(e){if(e.method===r.NOTIFY){let t=e.parseHeader(\"Event\");if(!t||!t.event){this.replyStateless(e,{statusCode:489});return}let s=e.callId+e.toTag+t.event,r=this.subscribers.get(s);if(r){let t=new d(this,e);r.onNotify(t);return}}let t=e.callId+e.toTag+e.fromTag,s=this.dialogs.get(t);if(s){if(e.method===r.OPTIONS){let t=\"Allow: \"+R.toString(),s=\"Accept: \"+b.toString();this.replyStateless(e,{statusCode:200,extraHeaders:[t,s]});return}s.receiveRequest(e);return}e.method!==r.ACK&&this.replyStateless(e,{statusCode:481})}receiveOutsideDialogRequest(e){switch(e.method){case r.ACK:break;case r.BYE:this.replyStateless(e,{statusCode:481});break;case r.CANCEL:throw Error(`Unexpected out of dialog request method ${e.method}.`);case r.INFO:this.replyStateless(e,{statusCode:405});break;case r.INVITE:{let t=new g(this,e);this.delegate.onInvite?this.delegate.onInvite(t):t.reject()}break;case r.MESSAGE:{let t=new h(this,e);this.delegate.onMessage?this.delegate.onMessage(t):t.accept()}break;case r.NOTIFY:{let t=new d(this,e);this.delegate.onNotify?this.delegate.onNotify(t):t.reject({statusCode:405})}break;case r.OPTIONS:{let t=\"Allow: \"+R.toString(),s=\"Accept: \"+b.toString();this.replyStateless(e,{statusCode:200,extraHeaders:[t,s]})}break;case r.REFER:{let t=new f(this,e);this.delegate.onRefer?this.delegate.onRefer(t):t.reject({statusCode:405})}break;case r.REGISTER:{let t=new S(this,e);this.delegate.onRegister?this.delegate.onRegister(t):t.reject({statusCode:405})}break;case r.SUBSCRIBE:{let t=new m(this,e);this.delegate.onSubscribe?this.delegate.onSubscribe(t):t.reject({statusCode:480})}break;default:throw Error(`Unexpected out of dialog request method ${e.method}.`)}}receiveResponseFromTransport(e){if(e.getHeaders(\"via\").length>1){this.logger.warn(\"More than one Via header field present in the response, dropping\");return}let t=e.viaBranch+e.method,s=this.userAgentClients.get(t);s?s.transaction.receiveResponse(e):this.logger.warn(`Discarding unmatched ${e.statusCode} response to ${e.method} ${t}.`)}}}","map":"{\"version\":3,\"sources\":[\"<anon>\"],\"names\":[],\"mappings\":\"\"}"}