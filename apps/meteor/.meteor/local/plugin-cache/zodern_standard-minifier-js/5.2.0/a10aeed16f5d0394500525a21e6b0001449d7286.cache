{"code":"function module(e,t,s){let i,r,a;s.export({InviteClientTransaction:()=>n}),s.link(\"../timers\",{Timers(e){i=e}},0),s.link(\"./client-transaction\",{ClientTransaction(e){r=e}},1),s.link(\"./transaction-state\",{TransactionState(e){a=e}},2);class n extends r{constructor(e,t,s){super(e,t,s,a.Calling,\"sip.transaction.ict\"),this.ackRetransmissionCache=new Map,this.B=setTimeout(()=>this.timerB(),i.TIMER_B),this.send(e.toString()).catch(e=>{this.logTransportError(e,\"Failed to send initial outgoing request.\")})}dispose(){this.B&&(clearTimeout(this.B),this.B=void 0),this.D&&(clearTimeout(this.D),this.D=void 0),this.M&&(clearTimeout(this.M),this.M=void 0),super.dispose()}get kind(){return\"ict\"}ackResponse(e){let t=e.toTag;if(!t)throw Error(\"To tag undefined.\");e.setViaHeader(\"z9hG4bK\"+Math.floor(1e7*Math.random()),this.transport.protocol),this.ackRetransmissionCache.set(t,e),this.send(e.toString()).catch(e=>{this.logTransportError(e,\"Failed to send ACK to 2xx response.\")})}receiveResponse(e){let t=e.statusCode;if(!t||t<100||t>699)throw Error(`Invalid status code ${t}`);switch(this.state){case a.Calling:if(t>=100&&t<=199){this.stateTransition(a.Proceeding),this.user.receiveResponse&&this.user.receiveResponse(e);return}if(t>=200&&t<=299){this.ackRetransmissionCache.set(e.toTag,void 0),this.stateTransition(a.Accepted),this.user.receiveResponse&&this.user.receiveResponse(e);return}if(t>=300&&t<=699){this.stateTransition(a.Completed),this.ack(e),this.user.receiveResponse&&this.user.receiveResponse(e);return}break;case a.Proceeding:if(t>=100&&t<=199){this.user.receiveResponse&&this.user.receiveResponse(e);return}if(t>=200&&t<=299){this.ackRetransmissionCache.set(e.toTag,void 0),this.stateTransition(a.Accepted),this.user.receiveResponse&&this.user.receiveResponse(e);return}if(t>=300&&t<=699){this.stateTransition(a.Completed),this.ack(e),this.user.receiveResponse&&this.user.receiveResponse(e);return}break;case a.Accepted:if(t>=200&&t<=299){if(!this.ackRetransmissionCache.has(e.toTag)){this.ackRetransmissionCache.set(e.toTag,void 0),this.user.receiveResponse&&this.user.receiveResponse(e);return}let t=this.ackRetransmissionCache.get(e.toTag);t&&this.send(t.toString()).catch(e=>{this.logTransportError(e,\"Failed to send retransmission of ACK to 2xx response.\")});return}break;case a.Completed:if(t>=300&&t<=699){this.ack(e);return}break;case a.Terminated:break;default:throw Error(`Invalid state ${this.state}`)}let s=`Received unexpected ${t} response while in state ${this.state}.`;this.logger.warn(s)}onTransportError(e){this.user.onTransportError&&this.user.onTransportError(e),this.stateTransition(a.Terminated,!0)}typeToString(){return\"INVITE client transaction\"}ack(e){let t=this.request.ruri,s=this.request.callId,i=this.request.cseq,r=this.request.getHeader(\"from\"),a=e.getHeader(\"to\"),n=this.request.getHeader(\"via\"),o=this.request.getHeader(\"route\");if(!r)throw Error(\"From undefined.\");if(!a)throw Error(\"To undefined.\");if(!n)throw Error(\"Via undefined.\");let h=`ACK ${t} SIP/2.0\\r\n`;o&&(h+=`Route: ${o}\\r\n`),h+=`Via: ${n}\\r\nTo: ${a}\\r\nFrom: ${r}\\r\nCall-ID: ${s}\\r\nCSeq: ${i} ACK\\r\nMax-Forwards: 70\\r\nContent-Length: 0\\r\n\\r\n`,this.send(h).catch(e=>{this.logTransportError(e,\"Failed to send ACK to non-2xx response.\")})}stateTransition(e,t=!1){let s=()=>{throw Error(`Invalid state transition from ${this.state} to ${e}`)};switch(e){case a.Calling:s();break;case a.Proceeding:this.state!==a.Calling&&s();break;case a.Accepted:case a.Completed:this.state!==a.Calling&&this.state!==a.Proceeding&&s();break;case a.Terminated:this.state===a.Calling||this.state===a.Accepted||this.state===a.Completed||t||s();break;default:s()}this.B&&(clearTimeout(this.B),this.B=void 0),a.Proceeding,e===a.Completed&&(this.D=setTimeout(()=>this.timerD(),i.TIMER_D)),e===a.Accepted&&(this.M=setTimeout(()=>this.timerM(),i.TIMER_M)),e===a.Terminated&&this.dispose(),this.setState(e)}timerA(){}timerB(){this.logger.debug(`Timer B expired for INVITE client transaction ${this.id}.`),this.state===a.Calling&&(this.onRequestTimeout(),this.stateTransition(a.Terminated))}timerD(){this.logger.debug(`Timer D expired for INVITE client transaction ${this.id}.`),this.state===a.Completed&&this.stateTransition(a.Terminated)}timerM(){this.logger.debug(`Timer M expired for INVITE client transaction ${this.id}.`),this.state===a.Accepted&&this.stateTransition(a.Terminated)}}}","map":"{\"version\":3,\"sources\":[\"<anon>\"],\"names\":[],\"mappings\":\"\"}"}