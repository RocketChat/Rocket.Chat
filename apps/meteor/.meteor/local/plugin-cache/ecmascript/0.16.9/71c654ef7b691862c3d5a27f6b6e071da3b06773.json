{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/accounts-base/accounts_common.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"packages/accounts-base/accounts_common.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/accounts-base/accounts_common.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/accounts-base/accounts_common.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/accounts-base/accounts_common.js"}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    let _objectSpread;\n    module.link(\"@babel/runtime/helpers/objectSpread2\", {\n      default(v) {\n        _objectSpread = v;\n      }\n    }, 0);\n    module.export({\n      AccountsCommon: () => AccountsCommon,\n      EXPIRE_TOKENS_INTERVAL_MS: () => EXPIRE_TOKENS_INTERVAL_MS\n    });\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 0);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    // config option keys\n    const VALID_CONFIG_KEYS = ['sendVerificationEmail', 'forbidClientAccountCreation', 'restrictCreationByEmailDomain', 'loginExpiration', 'loginExpirationInDays', 'oauthSecretKey', 'passwordResetTokenExpirationInDays', 'passwordResetTokenExpiration', 'passwordEnrollTokenExpirationInDays', 'passwordEnrollTokenExpiration', 'ambiguousErrorMessages', 'bcryptRounds', 'defaultFieldSelector', 'collection', 'loginTokenExpirationHours', 'tokenSequenceLength', 'clientStorage', 'ddpUrl', 'connection'];\n\n    /**\n     * @summary Super-constructor for AccountsClient and AccountsServer.\n     * @locus Anywhere\n     * @class AccountsCommon\n     * @instancename accountsClientOrServer\n     * @param options {Object} an object with fields:\n     * - connection {Object} Optional DDP connection to reuse.\n     * - ddpUrl {String} Optional URL for creating a new DDP connection.\n     * - collection {String|Mongo.Collection} The name of the Mongo.Collection\n     *     or the Mongo.Collection object to hold the users.\n     */\n    class AccountsCommon {\n      constructor(options) {\n        // Validate config options keys\n        for (const key of Object.keys(options)) {\n          if (!VALID_CONFIG_KEYS.includes(key)) {\n            console.error(\"Accounts.config: Invalid key: \".concat(key));\n          }\n        }\n\n        // Currently this is read directly by packages like accounts-password\n        // and accounts-ui-unstyled.\n        this._options = options || {};\n\n        // Note that setting this.connection = null causes this.users to be a\n        // LocalCollection, which is not what we want.\n        this.connection = undefined;\n        this._initConnection(options || {});\n\n        // There is an allow call in accounts_server.js that restricts writes to\n        // this collection.\n        this.users = this._initializeCollection(options || {});\n\n        // Callback exceptions are printed with Meteor._debug and ignored.\n        this._onLoginHook = new Hook({\n          bindEnvironment: false,\n          debugPrintExceptions: 'onLogin callback'\n        });\n        this._onLoginFailureHook = new Hook({\n          bindEnvironment: false,\n          debugPrintExceptions: 'onLoginFailure callback'\n        });\n        this._onLogoutHook = new Hook({\n          bindEnvironment: false,\n          debugPrintExceptions: 'onLogout callback'\n        });\n\n        // Expose for testing.\n        this.DEFAULT_LOGIN_EXPIRATION_DAYS = DEFAULT_LOGIN_EXPIRATION_DAYS;\n        this.LOGIN_UNEXPIRING_TOKEN_DAYS = LOGIN_UNEXPIRING_TOKEN_DAYS;\n\n        // Thrown when the user cancels the login process (eg, closes an oauth\n        // popup, declines retina scan, etc)\n        const lceName = 'Accounts.LoginCancelledError';\n        this.LoginCancelledError = Meteor.makeErrorType(lceName, function (description) {\n          this.message = description;\n        });\n        this.LoginCancelledError.prototype.name = lceName;\n\n        // This is used to transmit specific subclass errors over the wire. We\n        // should come up with a more generic way to do this (eg, with some sort of\n        // symbolic error code rather than a number).\n        this.LoginCancelledError.numericError = 0x8acdc2f;\n      }\n      _initializeCollection(options) {\n        if (options.collection && typeof options.collection !== 'string' && !(options.collection instanceof Mongo.Collection)) {\n          throw new Meteor.Error('Collection parameter can be only of type string or \"Mongo.Collection\"');\n        }\n        let collectionName = 'users';\n        if (typeof options.collection === 'string') {\n          collectionName = options.collection;\n        }\n        let collection;\n        if (options.collection instanceof Mongo.Collection) {\n          collection = options.collection;\n        } else {\n          collection = new Mongo.Collection(collectionName, {\n            _preventAutopublish: true,\n            connection: this.connection\n          });\n        }\n        return collection;\n      }\n\n      /**\n       * @summary Get the current user id, or `null` if no user is logged in. A reactive data source.\n       * @locus Anywhere\n       */\n      userId() {\n        throw new Error('userId method not implemented');\n      }\n\n      // merge the defaultFieldSelector with an existing options object\n      _addDefaultFieldSelector() {\n        let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n        // this will be the most common case for most people, so make it quick\n        if (!this._options.defaultFieldSelector) return options;\n\n        // if no field selector then just use defaultFieldSelector\n        if (!options.fields) return _objectSpread(_objectSpread({}, options), {}, {\n          fields: this._options.defaultFieldSelector\n        });\n\n        // if empty field selector then the full user object is explicitly requested, so obey\n        const keys = Object.keys(options.fields);\n        if (!keys.length) return options;\n\n        // if the requested fields are +ve then ignore defaultFieldSelector\n        // assume they are all either +ve or -ve because Mongo doesn't like mixed\n        if (!!options.fields[keys[0]]) return options;\n\n        // The requested fields are -ve.\n        // If the defaultFieldSelector is +ve then use requested fields, otherwise merge them\n        const keys2 = Object.keys(this._options.defaultFieldSelector);\n        return this._options.defaultFieldSelector[keys2[0]] ? options : _objectSpread(_objectSpread({}, options), {}, {\n          fields: _objectSpread(_objectSpread({}, options.fields), this._options.defaultFieldSelector)\n        });\n      }\n\n      /**\n       * @summary Get the current user record, or `null` if no user is logged in. A reactive data source. In the server this fuction returns a promise.\n       * @locus Anywhere\n       * @param {Object} [options]\n       * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n       */\n      user(options) {\n        if (Meteor.isServer) {\n          console.warn([\"`Meteor.user()` is deprecated on the server side.\", \"    To fetch the current user record on the server,\", \"    use `Meteor.userAsync()` instead.\"].join(\"\\n\"));\n        }\n        const self = this;\n        const userId = self.userId();\n        const findOne = function () {\n          return Meteor.isClient ? self.users.findOne(...arguments) : self.users.findOneAsync(...arguments);\n        };\n        return userId ? findOne(userId, this._addDefaultFieldSelector(options)) : null;\n      }\n\n      /**\n       * @summary Get the current user record, or `null` if no user is logged in.\n       * @locus Anywhere\n       * @param {Object} [options]\n       * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n       */\n      async userAsync(options) {\n        const userId = this.userId();\n        return userId ? this.users.findOneAsync(userId, this._addDefaultFieldSelector(options)) : null;\n      }\n      // Set up config for the accounts system. Call this on both the client\n      // and the server.\n      //\n      // Note that this method gets overridden on AccountsServer.prototype, but\n      // the overriding method calls the overridden method.\n      //\n      // XXX we should add some enforcement that this is called on both the\n      // client and the server. Otherwise, a user can\n      // 'forbidClientAccountCreation' only on the client and while it looks\n      // like their app is secure, the server will still accept createUser\n      // calls. https://github.com/meteor/meteor/issues/828\n      //\n      // @param options {Object} an object with fields:\n      // - sendVerificationEmail {Boolean}\n      //     Send email address verification emails to new users created from\n      //     client signups.\n      // - forbidClientAccountCreation {Boolean}\n      //     Do not allow clients to create accounts directly.\n      // - restrictCreationByEmailDomain {Function or String}\n      //     Require created users to have an email matching the function or\n      //     having the string as domain.\n      // - loginExpirationInDays {Number}\n      //     Number of days since login until a user is logged out (login token\n      //     expires).\n      // - collection {String|Mongo.Collection}\n      //     A collection name or a Mongo.Collection object to hold the users.\n      // - passwordResetTokenExpirationInDays {Number}\n      //     Number of days since password reset token creation until the\n      //     token can't be used any longer (password reset token expires).\n      // - ambiguousErrorMessages {Boolean}\n      //     Return ambiguous error messages from login failures to prevent\n      //     user enumeration.\n      // - bcryptRounds {Number}\n      //     Allows override of number of bcrypt rounds (aka work factor) used\n      //     to store passwords.\n\n      /**\n       * @summary Set global accounts options. You can also set these in `Meteor.settings.packages.accounts` without the need to call this function.\n       * @locus Anywhere\n       * @param {Object} options\n       * @param {Boolean} options.sendVerificationEmail New users with an email address will receive an address verification email.\n       * @param {Boolean} options.forbidClientAccountCreation Calls to [`createUser`](#accounts_createuser) from the client will be rejected. In addition, if you are using [accounts-ui](#accountsui), the \"Create account\" link will not be available.\n       * @param {String | Function} options.restrictCreationByEmailDomain If set to a string, only allows new users if the domain part of their email address matches the string. If set to a function, only allows new users if the function returns true.  The function is passed the full email address of the proposed new user.  Works with password-based sign-in and external services that expose email addresses (Google, Facebook, GitHub). All existing users still can log in after enabling this option. Example: `Accounts.config({ restrictCreationByEmailDomain: 'school.edu' })`.\n       * @param {Number} options.loginExpiration The number of milliseconds from when a user logs in until their token expires and they are logged out, for a more granular control. If `loginExpirationInDays` is set, it takes precedent.\n       * @param {Number} options.loginExpirationInDays The number of days from when a user logs in until their token expires and they are logged out. Defaults to 90. Set to `null` to disable login expiration.\n       * @param {String} options.oauthSecretKey When using the `oauth-encryption` package, the 16 byte key using to encrypt sensitive account credentials in the database, encoded in base64.  This option may only be specified on the server.  See packages/oauth-encryption/README.md for details.\n       * @param {Number} options.passwordResetTokenExpirationInDays The number of days from when a link to reset password is sent until token expires and user can't reset password with the link anymore. Defaults to 3.\n       * @param {Number} options.passwordResetTokenExpiration The number of milliseconds from when a link to reset password is sent until token expires and user can't reset password with the link anymore. If `passwordResetTokenExpirationInDays` is set, it takes precedent.\n       * @param {Number} options.passwordEnrollTokenExpirationInDays The number of days from when a link to set initial password is sent until token expires and user can't set password with the link anymore. Defaults to 30.\n       * @param {Number} options.passwordEnrollTokenExpiration The number of milliseconds from when a link to set initial password is sent until token expires and user can't set password with the link anymore. If `passwordEnrollTokenExpirationInDays` is set, it takes precedent.\n       * @param {Boolean} options.ambiguousErrorMessages Return ambiguous error messages from login failures to prevent user enumeration. Defaults to `false`, but in production environments it is recommended it defaults to `true`.\n       * @param {Number} options.bcryptRounds Allows override of number of bcrypt rounds (aka work factor) used to store passwords. The default is 10.\n       * @param {MongoFieldSpecifier} options.defaultFieldSelector To exclude by default large custom fields from `Meteor.user()` and `Meteor.findUserBy...()` functions when called without a field selector, and all `onLogin`, `onLoginFailure` and `onLogout` callbacks.  Example: `Accounts.config({ defaultFieldSelector: { myBigArray: 0 }})`. Beware when using this. If, for instance, you do not include `email` when excluding the fields, you can have problems with functions like `forgotPassword` that will break because they won't have the required data available. It's recommend that you always keep the fields `_id`, `username`, and `email`.\n       * @param {String|Mongo.Collection} options.collection A collection name or a Mongo.Collection object to hold the users.\n       * @param {Number} options.loginTokenExpirationHours When using the package `accounts-2fa`, use this to set the amount of time a token sent is valid. As it's just a number, you can use, for example, 0.5 to make the token valid for just half hour. The default is 1 hour.\n       * @param {Number} options.tokenSequenceLength When using the package `accounts-2fa`, use this to the size of the token sequence generated. The default is 6.\n       * @param {'session' | 'local'} options.clientStorage By default login credentials are stored in local storage, setting this to true will switch to using session storage.\n       */\n      config(options) {\n        // We don't want users to accidentally only call Accounts.config on the\n        // client, where some of the options will have partial effects (eg removing\n        // the \"create account\" button from accounts-ui if forbidClientAccountCreation\n        // is set, or redirecting Google login to a specific-domain page) without\n        // having their full effects.\n        if (Meteor.isServer) {\n          __meteor_runtime_config__.accountsConfigCalled = true;\n        } else if (!__meteor_runtime_config__.accountsConfigCalled) {\n          // XXX would be nice to \"crash\" the client and replace the UI with an error\n          // message, but there's no trivial way to do this.\n          Meteor._debug('Accounts.config was called on the client but not on the ' + 'server; some configuration options may not take effect.');\n        }\n\n        // We need to validate the oauthSecretKey option at the time\n        // Accounts.config is called. We also deliberately don't store the\n        // oauthSecretKey in Accounts._options.\n        if (Object.prototype.hasOwnProperty.call(options, 'oauthSecretKey')) {\n          if (Meteor.isClient) {\n            throw new Error('The oauthSecretKey option may only be specified on the server');\n          }\n          if (!Package['oauth-encryption']) {\n            throw new Error('The oauth-encryption package must be loaded to set oauthSecretKey');\n          }\n          Package['oauth-encryption'].OAuthEncryption.loadKey(options.oauthSecretKey);\n          options = _objectSpread({}, options);\n          delete options.oauthSecretKey;\n        }\n\n        // Validate config options keys\n        for (const key of Object.keys(options)) {\n          if (!VALID_CONFIG_KEYS.includes(key)) {\n            console.error(\"Accounts.config: Invalid key: \".concat(key));\n          }\n        }\n\n        // set values in Accounts._options\n        for (const key of VALID_CONFIG_KEYS) {\n          if (key in options) {\n            if (key in this._options) {\n              if (key !== 'collection' && Meteor.isTest && key !== 'clientStorage') {\n                throw new Meteor.Error(\"Can't set `\".concat(key, \"` more than once\"));\n              }\n            }\n            this._options[key] = options[key];\n          }\n        }\n        if (options.collection && options.collection !== this.users._name && options.collection !== this.users) {\n          this.users = this._initializeCollection(options);\n        }\n      }\n\n      /**\n       * @summary Register a callback to be called after a login attempt succeeds.\n       * @locus Anywhere\n       * @param {Function} func The callback to be called when login is successful.\n       *                        The callback receives a single object that\n       *                        holds login details. This object contains the login\n       *                        result type (password, resume, etc.) on both the\n       *                        client and server. `onLogin` callbacks registered\n       *                        on the server also receive extra data, such\n       *                        as user details, connection information, etc.\n       */\n      onLogin(func) {\n        let ret = this._onLoginHook.register(func);\n        // call the just registered callback if already logged in\n        this._startupCallback(ret.callback);\n        return ret;\n      }\n\n      /**\n       * @summary Register a callback to be called after a login attempt fails.\n       * @locus Anywhere\n       * @param {Function} func The callback to be called after the login has failed.\n       */\n      onLoginFailure(func) {\n        return this._onLoginFailureHook.register(func);\n      }\n\n      /**\n       * @summary Register a callback to be called after a logout attempt succeeds.\n       * @locus Anywhere\n       * @param {Function} func The callback to be called when logout is successful.\n       */\n      onLogout(func) {\n        return this._onLogoutHook.register(func);\n      }\n      _initConnection(options) {\n        if (!Meteor.isClient) {\n          return;\n        }\n\n        // The connection used by the Accounts system. This is the connection\n        // that will get logged in by Meteor.login(), and this is the\n        // connection whose login state will be reflected by Meteor.userId().\n        //\n        // It would be much preferable for this to be in accounts_client.js,\n        // but it has to be here because it's needed to create the\n        // Meteor.users collection.\n        if (options.connection) {\n          this.connection = options.connection;\n        } else if (options.ddpUrl) {\n          this.connection = DDP.connect(options.ddpUrl);\n        } else if (typeof __meteor_runtime_config__ !== 'undefined' && __meteor_runtime_config__.ACCOUNTS_CONNECTION_URL) {\n          // Temporary, internal hook to allow the server to point the client\n          // to a different authentication server. This is for a very\n          // particular use case that comes up when implementing a oauth\n          // server. Unsupported and may go away at any point in time.\n          //\n          // We will eventually provide a general way to use account-base\n          // against any DDP connection, not just one special one.\n          this.connection = DDP.connect(__meteor_runtime_config__.ACCOUNTS_CONNECTION_URL);\n        } else {\n          this.connection = Meteor.connection;\n        }\n      }\n      _getTokenLifetimeMs() {\n        // When loginExpirationInDays is set to null, we'll use a really high\n        // number of days (LOGIN_UNEXPIRABLE_TOKEN_DAYS) to simulate an\n        // unexpiring token.\n        const loginExpirationInDays = this._options.loginExpirationInDays === null ? LOGIN_UNEXPIRING_TOKEN_DAYS : this._options.loginExpirationInDays;\n        return this._options.loginExpiration || (loginExpirationInDays || DEFAULT_LOGIN_EXPIRATION_DAYS) * 86400000;\n      }\n      _getPasswordResetTokenLifetimeMs() {\n        return this._options.passwordResetTokenExpiration || (this._options.passwordResetTokenExpirationInDays || DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS) * 86400000;\n      }\n      _getPasswordEnrollTokenLifetimeMs() {\n        return this._options.passwordEnrollTokenExpiration || (this._options.passwordEnrollTokenExpirationInDays || DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS) * 86400000;\n      }\n      _tokenExpiration(when) {\n        // We pass when through the Date constructor for backwards compatibility;\n        // `when` used to be a number.\n        return new Date(new Date(when).getTime() + this._getTokenLifetimeMs());\n      }\n      _tokenExpiresSoon(when) {\n        let minLifetimeMs = 0.1 * this._getTokenLifetimeMs();\n        const minLifetimeCapMs = MIN_TOKEN_LIFETIME_CAP_SECS * 1000;\n        if (minLifetimeMs > minLifetimeCapMs) {\n          minLifetimeMs = minLifetimeCapMs;\n        }\n        return new Date() > new Date(when) - minLifetimeMs;\n      }\n\n      // No-op on the server, overridden on the client.\n      _startupCallback(callback) {}\n    }\n    // Note that Accounts is defined separately in accounts_client.js and\n    // accounts_server.js.\n\n    /**\n     * @summary Get the current user id, or `null` if no user is logged in. A reactive data source.\n     * @locus Anywhere\n     * @importFromPackage meteor\n     */\n    Meteor.userId = () => Accounts.userId();\n\n    /**\n     * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n     * @locus Anywhere\n     * @importFromPackage meteor\n     * @param {Object} [options]\n     * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n     */\n    Meteor.user = options => Accounts.user(options);\n\n    /**\n     * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n     * @locus Anywhere\n     * @importFromPackage meteor\n     * @param {Object} [options]\n     * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n     */\n    Meteor.userAsync = options => Accounts.userAsync(options);\n\n    // how long (in days) until a login token expires\n    const DEFAULT_LOGIN_EXPIRATION_DAYS = 90;\n    // how long (in days) until reset password token expires\n    const DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS = 3;\n    // how long (in days) until enrol password token expires\n    const DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS = 30;\n    // Clients don't try to auto-login with a token that is going to expire within\n    // .1 * DEFAULT_LOGIN_EXPIRATION_DAYS, capped at MIN_TOKEN_LIFETIME_CAP_SECS.\n    // Tries to avoid abrupt disconnects from expiring tokens.\n    const MIN_TOKEN_LIFETIME_CAP_SECS = 3600; // one hour\n    // how often (in milliseconds) we check for expired tokens\n    const EXPIRE_TOKENS_INTERVAL_MS = 600 * 1000;\n    // 10 minutes\n    // A large number of expiration days (approximately 100 years worth) that is\n    // used when creating unexpiring tokens.\n    const LOGIN_UNEXPIRING_TOKEN_DAYS = 365 * 100;\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["_objectSpread","module","link","default","v","export","AccountsCommon","EXPIRE_TOKENS_INTERVAL_MS","Meteor","__reifyWaitForDeps__","VALID_CONFIG_KEYS","constructor","options","key","Object","keys","includes","console","error","concat","_options","connection","undefined","_initConnection","users","_initializeCollection","_onLoginHook","Hook","bindEnvironment","debugPrintExceptions","_onLoginFailureHook","_onLogoutHook","DEFAULT_LOGIN_EXPIRATION_DAYS","LOGIN_UNEXPIRING_TOKEN_DAYS","lceName","LoginCancelledError","makeErrorType","description","message","prototype","name","numericError","collection","Mongo","Collection","Error","collectionName","_preventAutopublish","userId","_addDefaultFieldSelector","arguments","length","defaultFieldSelector","fields","keys2","user","isServer","warn","join","self","findOne","isClient","findOneAsync","userAsync","config","__meteor_runtime_config__","accountsConfigCalled","_debug","hasOwnProperty","call","Package","OAuthEncryption","loadKey","oauthSecretKey","isTest","_name","onLogin","func","ret","register","_startupCallback","callback","onLoginFailure","onLogout","ddpUrl","DDP","connect","ACCOUNTS_CONNECTION_URL","_getTokenLifetimeMs","loginExpirationInDays","loginExpiration","_getPasswordResetTokenLifetimeMs","passwordResetTokenExpiration","passwordResetTokenExpirationInDays","DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS","_getPasswordEnrollTokenLifetimeMs","passwordEnrollTokenExpiration","passwordEnrollTokenExpirationInDays","DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS","_tokenExpiration","when","Date","getTime","_tokenExpiresSoon","minLifetimeMs","minLifetimeCapMs","MIN_TOKEN_LIFETIME_CAP_SECS","Accounts","__reify_async_result__","_reifyError","async"],"sources":["packages/accounts-base/accounts_common.js"],"sourcesContent":["import { Meteor } from 'meteor/meteor';\n\n// config option keys\nconst VALID_CONFIG_KEYS = [\n  'sendVerificationEmail',\n  'forbidClientAccountCreation',\n  'restrictCreationByEmailDomain',\n  'loginExpiration',\n  'loginExpirationInDays',\n  'oauthSecretKey',\n  'passwordResetTokenExpirationInDays',\n  'passwordResetTokenExpiration',\n  'passwordEnrollTokenExpirationInDays',\n  'passwordEnrollTokenExpiration',\n  'ambiguousErrorMessages',\n  'bcryptRounds',\n  'defaultFieldSelector',\n  'collection',\n  'loginTokenExpirationHours',\n  'tokenSequenceLength',\n  'clientStorage',\n  'ddpUrl',\n  'connection',\n];\n\n/**\n * @summary Super-constructor for AccountsClient and AccountsServer.\n * @locus Anywhere\n * @class AccountsCommon\n * @instancename accountsClientOrServer\n * @param options {Object} an object with fields:\n * - connection {Object} Optional DDP connection to reuse.\n * - ddpUrl {String} Optional URL for creating a new DDP connection.\n * - collection {String|Mongo.Collection} The name of the Mongo.Collection\n *     or the Mongo.Collection object to hold the users.\n */\nexport class AccountsCommon {\n  constructor(options) {\n    // Validate config options keys\n    for (const key of Object.keys(options)) {\n      if (!VALID_CONFIG_KEYS.includes(key)) {\n        console.error(`Accounts.config: Invalid key: ${key}`);\n      }\n    }\n\n    // Currently this is read directly by packages like accounts-password\n    // and accounts-ui-unstyled.\n    this._options = options || {};\n\n    // Note that setting this.connection = null causes this.users to be a\n    // LocalCollection, which is not what we want.\n    this.connection = undefined;\n    this._initConnection(options || {});\n\n    // There is an allow call in accounts_server.js that restricts writes to\n    // this collection.\n    this.users = this._initializeCollection(options || {});\n\n    // Callback exceptions are printed with Meteor._debug and ignored.\n    this._onLoginHook = new Hook({\n      bindEnvironment: false,\n      debugPrintExceptions: 'onLogin callback',\n    });\n\n    this._onLoginFailureHook = new Hook({\n      bindEnvironment: false,\n      debugPrintExceptions: 'onLoginFailure callback',\n    });\n\n    this._onLogoutHook = new Hook({\n      bindEnvironment: false,\n      debugPrintExceptions: 'onLogout callback',\n    });\n\n    // Expose for testing.\n    this.DEFAULT_LOGIN_EXPIRATION_DAYS = DEFAULT_LOGIN_EXPIRATION_DAYS;\n    this.LOGIN_UNEXPIRING_TOKEN_DAYS = LOGIN_UNEXPIRING_TOKEN_DAYS;\n\n    // Thrown when the user cancels the login process (eg, closes an oauth\n    // popup, declines retina scan, etc)\n    const lceName = 'Accounts.LoginCancelledError';\n    this.LoginCancelledError = Meteor.makeErrorType(lceName, function(\n      description\n    ) {\n      this.message = description;\n    });\n    this.LoginCancelledError.prototype.name = lceName;\n\n    // This is used to transmit specific subclass errors over the wire. We\n    // should come up with a more generic way to do this (eg, with some sort of\n    // symbolic error code rather than a number).\n    this.LoginCancelledError.numericError = 0x8acdc2f;\n  }\n\n  _initializeCollection(options) {\n    if (options.collection && typeof options.collection !== 'string' && !(options.collection instanceof Mongo.Collection)) {\n      throw new Meteor.Error('Collection parameter can be only of type string or \"Mongo.Collection\"');\n    }\n\n    let collectionName = 'users';\n    if (typeof options.collection === 'string') {\n      collectionName = options.collection;\n    }\n\n    let collection;\n    if (options.collection instanceof Mongo.Collection) {\n      collection = options.collection;\n    } else {\n      collection = new Mongo.Collection(collectionName, {\n        _preventAutopublish: true,\n        connection: this.connection,\n      });\n    }\n\n    return collection;\n  }\n\n  /**\n   * @summary Get the current user id, or `null` if no user is logged in. A reactive data source.\n   * @locus Anywhere\n   */\n  userId() {\n    throw new Error('userId method not implemented');\n  }\n\n  // merge the defaultFieldSelector with an existing options object\n  _addDefaultFieldSelector(options = {}) {\n    // this will be the most common case for most people, so make it quick\n    if (!this._options.defaultFieldSelector) return options;\n\n    // if no field selector then just use defaultFieldSelector\n    if (!options.fields)\n      return {\n        ...options,\n        fields: this._options.defaultFieldSelector,\n      };\n\n    // if empty field selector then the full user object is explicitly requested, so obey\n    const keys = Object.keys(options.fields);\n    if (!keys.length) return options;\n\n    // if the requested fields are +ve then ignore defaultFieldSelector\n    // assume they are all either +ve or -ve because Mongo doesn't like mixed\n    if (!!options.fields[keys[0]]) return options;\n\n    // The requested fields are -ve.\n    // If the defaultFieldSelector is +ve then use requested fields, otherwise merge them\n    const keys2 = Object.keys(this._options.defaultFieldSelector);\n    return this._options.defaultFieldSelector[keys2[0]]\n      ? options\n      : {\n          ...options,\n          fields: {\n            ...options.fields,\n            ...this._options.defaultFieldSelector,\n          },\n        };\n  }\n\n  /**\n   * @summary Get the current user record, or `null` if no user is logged in. A reactive data source. In the server this fuction returns a promise.\n   * @locus Anywhere\n   * @param {Object} [options]\n   * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n   */\n  user(options) {\n    if (Meteor.isServer) {\n      console.warn([\n        \"`Meteor.user()` is deprecated on the server side.\",\n        \"    To fetch the current user record on the server,\",\n        \"    use `Meteor.userAsync()` instead.\",\n      ].join(\"\\n\"));\n    }\n\n    const self = this;\n    const userId = self.userId();\n    const findOne = (...args) => Meteor.isClient\n      ? self.users.findOne(...args)\n      : self.users.findOneAsync(...args);\n    return userId\n      ? findOne(userId, this._addDefaultFieldSelector(options))\n      : null;\n  }\n\n  /**\n   * @summary Get the current user record, or `null` if no user is logged in.\n   * @locus Anywhere\n   * @param {Object} [options]\n   * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n   */\n  async userAsync(options) {\n    const userId = this.userId();\n    return userId\n      ? this.users.findOneAsync(userId, this._addDefaultFieldSelector(options))\n      : null;\n  }\n  // Set up config for the accounts system. Call this on both the client\n  // and the server.\n  //\n  // Note that this method gets overridden on AccountsServer.prototype, but\n  // the overriding method calls the overridden method.\n  //\n  // XXX we should add some enforcement that this is called on both the\n  // client and the server. Otherwise, a user can\n  // 'forbidClientAccountCreation' only on the client and while it looks\n  // like their app is secure, the server will still accept createUser\n  // calls. https://github.com/meteor/meteor/issues/828\n  //\n  // @param options {Object} an object with fields:\n  // - sendVerificationEmail {Boolean}\n  //     Send email address verification emails to new users created from\n  //     client signups.\n  // - forbidClientAccountCreation {Boolean}\n  //     Do not allow clients to create accounts directly.\n  // - restrictCreationByEmailDomain {Function or String}\n  //     Require created users to have an email matching the function or\n  //     having the string as domain.\n  // - loginExpirationInDays {Number}\n  //     Number of days since login until a user is logged out (login token\n  //     expires).\n  // - collection {String|Mongo.Collection}\n  //     A collection name or a Mongo.Collection object to hold the users.\n  // - passwordResetTokenExpirationInDays {Number}\n  //     Number of days since password reset token creation until the\n  //     token can't be used any longer (password reset token expires).\n  // - ambiguousErrorMessages {Boolean}\n  //     Return ambiguous error messages from login failures to prevent\n  //     user enumeration.\n  // - bcryptRounds {Number}\n  //     Allows override of number of bcrypt rounds (aka work factor) used\n  //     to store passwords.\n\n  /**\n   * @summary Set global accounts options. You can also set these in `Meteor.settings.packages.accounts` without the need to call this function.\n   * @locus Anywhere\n   * @param {Object} options\n   * @param {Boolean} options.sendVerificationEmail New users with an email address will receive an address verification email.\n   * @param {Boolean} options.forbidClientAccountCreation Calls to [`createUser`](#accounts_createuser) from the client will be rejected. In addition, if you are using [accounts-ui](#accountsui), the \"Create account\" link will not be available.\n   * @param {String | Function} options.restrictCreationByEmailDomain If set to a string, only allows new users if the domain part of their email address matches the string. If set to a function, only allows new users if the function returns true.  The function is passed the full email address of the proposed new user.  Works with password-based sign-in and external services that expose email addresses (Google, Facebook, GitHub). All existing users still can log in after enabling this option. Example: `Accounts.config({ restrictCreationByEmailDomain: 'school.edu' })`.\n   * @param {Number} options.loginExpiration The number of milliseconds from when a user logs in until their token expires and they are logged out, for a more granular control. If `loginExpirationInDays` is set, it takes precedent.\n   * @param {Number} options.loginExpirationInDays The number of days from when a user logs in until their token expires and they are logged out. Defaults to 90. Set to `null` to disable login expiration.\n   * @param {String} options.oauthSecretKey When using the `oauth-encryption` package, the 16 byte key using to encrypt sensitive account credentials in the database, encoded in base64.  This option may only be specified on the server.  See packages/oauth-encryption/README.md for details.\n   * @param {Number} options.passwordResetTokenExpirationInDays The number of days from when a link to reset password is sent until token expires and user can't reset password with the link anymore. Defaults to 3.\n   * @param {Number} options.passwordResetTokenExpiration The number of milliseconds from when a link to reset password is sent until token expires and user can't reset password with the link anymore. If `passwordResetTokenExpirationInDays` is set, it takes precedent.\n   * @param {Number} options.passwordEnrollTokenExpirationInDays The number of days from when a link to set initial password is sent until token expires and user can't set password with the link anymore. Defaults to 30.\n   * @param {Number} options.passwordEnrollTokenExpiration The number of milliseconds from when a link to set initial password is sent until token expires and user can't set password with the link anymore. If `passwordEnrollTokenExpirationInDays` is set, it takes precedent.\n   * @param {Boolean} options.ambiguousErrorMessages Return ambiguous error messages from login failures to prevent user enumeration. Defaults to `false`, but in production environments it is recommended it defaults to `true`.\n   * @param {Number} options.bcryptRounds Allows override of number of bcrypt rounds (aka work factor) used to store passwords. The default is 10.\n   * @param {MongoFieldSpecifier} options.defaultFieldSelector To exclude by default large custom fields from `Meteor.user()` and `Meteor.findUserBy...()` functions when called without a field selector, and all `onLogin`, `onLoginFailure` and `onLogout` callbacks.  Example: `Accounts.config({ defaultFieldSelector: { myBigArray: 0 }})`. Beware when using this. If, for instance, you do not include `email` when excluding the fields, you can have problems with functions like `forgotPassword` that will break because they won't have the required data available. It's recommend that you always keep the fields `_id`, `username`, and `email`.\n   * @param {String|Mongo.Collection} options.collection A collection name or a Mongo.Collection object to hold the users.\n   * @param {Number} options.loginTokenExpirationHours When using the package `accounts-2fa`, use this to set the amount of time a token sent is valid. As it's just a number, you can use, for example, 0.5 to make the token valid for just half hour. The default is 1 hour.\n   * @param {Number} options.tokenSequenceLength When using the package `accounts-2fa`, use this to the size of the token sequence generated. The default is 6.\n   * @param {'session' | 'local'} options.clientStorage By default login credentials are stored in local storage, setting this to true will switch to using session storage.\n   */\n  config(options) {\n    // We don't want users to accidentally only call Accounts.config on the\n    // client, where some of the options will have partial effects (eg removing\n    // the \"create account\" button from accounts-ui if forbidClientAccountCreation\n    // is set, or redirecting Google login to a specific-domain page) without\n    // having their full effects.\n    if (Meteor.isServer) {\n      __meteor_runtime_config__.accountsConfigCalled = true;\n    } else if (!__meteor_runtime_config__.accountsConfigCalled) {\n      // XXX would be nice to \"crash\" the client and replace the UI with an error\n      // message, but there's no trivial way to do this.\n      Meteor._debug(\n        'Accounts.config was called on the client but not on the ' +\n          'server; some configuration options may not take effect.'\n      );\n    }\n\n    // We need to validate the oauthSecretKey option at the time\n    // Accounts.config is called. We also deliberately don't store the\n    // oauthSecretKey in Accounts._options.\n    if (Object.prototype.hasOwnProperty.call(options, 'oauthSecretKey')) {\n      if (Meteor.isClient) {\n        throw new Error(\n          'The oauthSecretKey option may only be specified on the server'\n        );\n      }\n      if (!Package['oauth-encryption']) {\n        throw new Error(\n          'The oauth-encryption package must be loaded to set oauthSecretKey'\n        );\n      }\n      Package['oauth-encryption'].OAuthEncryption.loadKey(\n        options.oauthSecretKey\n      );\n      options = { ...options };\n      delete options.oauthSecretKey;\n    }\n\n    // Validate config options keys\n    for (const key of Object.keys(options)) {\n      if (!VALID_CONFIG_KEYS.includes(key)) {\n        console.error(`Accounts.config: Invalid key: ${key}`);\n      }\n    }\n\n    // set values in Accounts._options\n    for (const key of VALID_CONFIG_KEYS) {\n      if (key in options) {\n        if (key in this._options) {\n          if (key !== 'collection' && (Meteor.isTest && key !== 'clientStorage')) {\n            throw new Meteor.Error(`Can't set \\`${key}\\` more than once`);\n          }\n        }\n        this._options[key] = options[key];\n      }\n    }\n\n    if (options.collection && options.collection !== this.users._name && options.collection !== this.users) {\n      this.users = this._initializeCollection(options);\n    }\n  }\n\n  /**\n   * @summary Register a callback to be called after a login attempt succeeds.\n   * @locus Anywhere\n   * @param {Function} func The callback to be called when login is successful.\n   *                        The callback receives a single object that\n   *                        holds login details. This object contains the login\n   *                        result type (password, resume, etc.) on both the\n   *                        client and server. `onLogin` callbacks registered\n   *                        on the server also receive extra data, such\n   *                        as user details, connection information, etc.\n   */\n  onLogin(func) {\n    let ret = this._onLoginHook.register(func);\n    // call the just registered callback if already logged in\n    this._startupCallback(ret.callback);\n    return ret;\n  }\n\n  /**\n   * @summary Register a callback to be called after a login attempt fails.\n   * @locus Anywhere\n   * @param {Function} func The callback to be called after the login has failed.\n   */\n  onLoginFailure(func) {\n    return this._onLoginFailureHook.register(func);\n  }\n\n  /**\n   * @summary Register a callback to be called after a logout attempt succeeds.\n   * @locus Anywhere\n   * @param {Function} func The callback to be called when logout is successful.\n   */\n  onLogout(func) {\n    return this._onLogoutHook.register(func);\n  }\n\n  _initConnection(options) {\n    if (!Meteor.isClient) {\n      return;\n    }\n\n    // The connection used by the Accounts system. This is the connection\n    // that will get logged in by Meteor.login(), and this is the\n    // connection whose login state will be reflected by Meteor.userId().\n    //\n    // It would be much preferable for this to be in accounts_client.js,\n    // but it has to be here because it's needed to create the\n    // Meteor.users collection.\n    if (options.connection) {\n      this.connection = options.connection;\n    } else if (options.ddpUrl) {\n      this.connection = DDP.connect(options.ddpUrl);\n    } else if (\n      typeof __meteor_runtime_config__ !== 'undefined' &&\n      __meteor_runtime_config__.ACCOUNTS_CONNECTION_URL\n    ) {\n      // Temporary, internal hook to allow the server to point the client\n      // to a different authentication server. This is for a very\n      // particular use case that comes up when implementing a oauth\n      // server. Unsupported and may go away at any point in time.\n      //\n      // We will eventually provide a general way to use account-base\n      // against any DDP connection, not just one special one.\n      this.connection = DDP.connect(\n        __meteor_runtime_config__.ACCOUNTS_CONNECTION_URL\n      );\n    } else {\n      this.connection = Meteor.connection;\n    }\n  }\n\n  _getTokenLifetimeMs() {\n    // When loginExpirationInDays is set to null, we'll use a really high\n    // number of days (LOGIN_UNEXPIRABLE_TOKEN_DAYS) to simulate an\n    // unexpiring token.\n    const loginExpirationInDays =\n      this._options.loginExpirationInDays === null\n        ? LOGIN_UNEXPIRING_TOKEN_DAYS\n        : this._options.loginExpirationInDays;\n    return (\n      this._options.loginExpiration ||\n      (loginExpirationInDays || DEFAULT_LOGIN_EXPIRATION_DAYS) * 86400000\n    );\n  }\n\n  _getPasswordResetTokenLifetimeMs() {\n    return (\n      this._options.passwordResetTokenExpiration ||\n      (this._options.passwordResetTokenExpirationInDays ||\n        DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS) * 86400000\n    );\n  }\n\n  _getPasswordEnrollTokenLifetimeMs() {\n    return (\n      this._options.passwordEnrollTokenExpiration ||\n      (this._options.passwordEnrollTokenExpirationInDays ||\n        DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS) * 86400000\n    );\n  }\n\n  _tokenExpiration(when) {\n    // We pass when through the Date constructor for backwards compatibility;\n    // `when` used to be a number.\n    return new Date(new Date(when).getTime() + this._getTokenLifetimeMs());\n  }\n\n  _tokenExpiresSoon(when) {\n    let minLifetimeMs = 0.1 * this._getTokenLifetimeMs();\n    const minLifetimeCapMs = MIN_TOKEN_LIFETIME_CAP_SECS * 1000;\n    if (minLifetimeMs > minLifetimeCapMs) {\n      minLifetimeMs = minLifetimeCapMs;\n    }\n    return new Date() > new Date(when) - minLifetimeMs;\n  }\n\n  // No-op on the server, overridden on the client.\n  _startupCallback(callback) {}\n}\n\n// Note that Accounts is defined separately in accounts_client.js and\n// accounts_server.js.\n\n/**\n * @summary Get the current user id, or `null` if no user is logged in. A reactive data source.\n * @locus Anywhere\n * @importFromPackage meteor\n */\nMeteor.userId = () => Accounts.userId();\n\n/**\n * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n * @locus Anywhere\n * @importFromPackage meteor\n * @param {Object} [options]\n * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n */\nMeteor.user = options => Accounts.user(options);\n\n/**\n * @summary Get the current user record, or `null` if no user is logged in. A reactive data source.\n * @locus Anywhere\n * @importFromPackage meteor\n * @param {Object} [options]\n * @param {MongoFieldSpecifier} options.fields Dictionary of fields to return or exclude.\n */\nMeteor.userAsync = options => Accounts.userAsync(options);\n\n// how long (in days) until a login token expires\nconst DEFAULT_LOGIN_EXPIRATION_DAYS = 90;\n// how long (in days) until reset password token expires\nconst DEFAULT_PASSWORD_RESET_TOKEN_EXPIRATION_DAYS = 3;\n// how long (in days) until enrol password token expires\nconst DEFAULT_PASSWORD_ENROLL_TOKEN_EXPIRATION_DAYS = 30;\n// Clients don't try to auto-login with a token that is going to expire within\n// .1 * DEFAULT_LOGIN_EXPIRATION_DAYS, capped at MIN_TOKEN_LIFETIME_CAP_SECS.\n// Tries to avoid abrupt disconnects from expiring tokens.\nconst MIN_TOKEN_LIFETIME_CAP_SECS = 3600; // one hour\n// how often (in milliseconds) we check for expired tokens\nexport const EXPIRE_TOKENS_INTERVAL_MS = 600 * 1000; // 10 minutes\n// A large number of expiration days (approximately 100 years worth) that is\n// used when creating unexpiring tokens.\nconst LOGIN_UNEXPIRING_TOKEN_DAYS = 365 * 100;\n"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"71c654ef7b691862c3d5a27f6b6e071da3b06773"}
