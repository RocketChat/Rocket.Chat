{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/mongo/doc_fetcher.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"packages/mongo/doc_fetcher.js","filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/mongo/doc_fetcher.js","targets":{"android":"125.0.0","chrome":"125.0.0","edge":"125.0.0","firefox":"115.0.0","ie":"10.0.0","ios":"17.4.0","opera":"110.0.0","opera_mobile":"80.0.0","safari":"17.4.0","samsung":"24.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","root":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"/Users/guilhermegazzo/dev/Rocket.Chat/apps/meteor/packages/mongo/doc_fetcher.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/mongo/doc_fetcher.js"}},"code":"module.export({\n  DocFetcher: () => DocFetcher\n});\nclass DocFetcher {\n  constructor(mongoConnection) {\n    this._mongoConnection = mongoConnection;\n    // Map from op -> [callback]\n    this._callbacksForOp = new Map();\n  }\n\n  // Fetches document \"id\" from collectionName, returning it or null if not\n  // found.\n  //\n  // If you make multiple calls to fetch() with the same op reference,\n  // DocFetcher may assume that they all return the same document. (It does\n  // not check to see if collectionName/id match.)\n  //\n  // You may assume that callback is never called synchronously (and in fact\n  // OplogObserveDriver does so).\n  async fetch(collectionName, id, op, callback) {\n    const self = this;\n    check(collectionName, String);\n    check(op, Object);\n\n    // If there's already an in-progress fetch for this cache key, yield until\n    // it's done and return whatever it returns.\n    if (self._callbacksForOp.has(op)) {\n      self._callbacksForOp.get(op).push(callback);\n      return;\n    }\n    const callbacks = [callback];\n    self._callbacksForOp.set(op, callbacks);\n    try {\n      var doc = (await self._mongoConnection.findOneAsync(collectionName, {\n        _id: id\n      })) || null;\n      // Return doc to all relevant callbacks. Note that this array can\n      // continue to grow during callback excecution.\n      while (callbacks.length > 0) {\n        // Clone the document so that the various calls to fetch don't return\n        // objects that are intertwingled with each other. Clone before\n        // popping the future, so that if clone throws, the error gets passed\n        // to the next callback.\n        callbacks.pop()(null, EJSON.clone(doc));\n      }\n    } catch (e) {\n      while (callbacks.length > 0) {\n        callbacks.pop()(e);\n      }\n    } finally {\n      // XXX consider keeping the doc around for a period of time before\n      // removing from the cache\n      self._callbacksForOp.delete(op);\n    }\n  }\n}","map":{"version":3,"names":["module","export","DocFetcher","constructor","mongoConnection","_mongoConnection","_callbacksForOp","Map","fetch","collectionName","id","op","callback","self","check","String","Object","has","get","push","callbacks","set","doc","findOneAsync","_id","length","pop","EJSON","clone","e","delete"],"sources":["packages/mongo/doc_fetcher.js"],"sourcesContent":["export class DocFetcher {\n  constructor(mongoConnection) {\n    this._mongoConnection = mongoConnection;\n    // Map from op -> [callback]\n    this._callbacksForOp = new Map();\n  }\n\n  // Fetches document \"id\" from collectionName, returning it or null if not\n  // found.\n  //\n  // If you make multiple calls to fetch() with the same op reference,\n  // DocFetcher may assume that they all return the same document. (It does\n  // not check to see if collectionName/id match.)\n  //\n  // You may assume that callback is never called synchronously (and in fact\n  // OplogObserveDriver does so).\n  async fetch(collectionName, id, op, callback) {\n    const self = this;\n\n    \n    check(collectionName, String);\n    check(op, Object);\n\n\n    // If there's already an in-progress fetch for this cache key, yield until\n    // it's done and return whatever it returns.\n    if (self._callbacksForOp.has(op)) {\n      self._callbacksForOp.get(op).push(callback);\n      return;\n    }\n\n    const callbacks = [callback];\n    self._callbacksForOp.set(op, callbacks);\n\n    try {\n      var doc =\n        (await self._mongoConnection.findOneAsync(collectionName, {\n          _id: id,\n        })) || null;\n      // Return doc to all relevant callbacks. Note that this array can\n      // continue to grow during callback excecution.\n      while (callbacks.length > 0) {\n        // Clone the document so that the various calls to fetch don't return\n        // objects that are intertwingled with each other. Clone before\n        // popping the future, so that if clone throws, the error gets passed\n        // to the next callback.\n        callbacks.pop()(null, EJSON.clone(doc));\n      }\n    } catch (e) {\n      while (callbacks.length > 0) {\n        callbacks.pop()(e);\n      }\n    } finally {\n      // XXX consider keeping the doc around for a period of time before\n      // removing from the cache\n      self._callbacksForOp.delete(op);\n    }\n  }\n}\n"],"mappings":"AAAAA,MAAM,CAACC,MAAM,CAAC;EAACC,UAAU,EAACA,CAAA,KAAIA;AAAU,CAAC,CAAC;AAAnC,MAAMA,UAAU,CAAC;EACtBC,WAAWA,CAACC,eAAe,EAAE;IAC3B,IAAI,CAACC,gBAAgB,GAAGD,eAAe;IACvC;IACA,IAAI,CAACE,eAAe,GAAG,IAAIC,GAAG,CAAC,CAAC;EAClC;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA,MAAMC,KAAKA,CAACC,cAAc,EAAEC,EAAE,EAAEC,EAAE,EAAEC,QAAQ,EAAE;IAC5C,MAAMC,IAAI,GAAG,IAAI;IAGjBC,KAAK,CAACL,cAAc,EAAEM,MAAM,CAAC;IAC7BD,KAAK,CAACH,EAAE,EAAEK,MAAM,CAAC;;IAGjB;IACA;IACA,IAAIH,IAAI,CAACP,eAAe,CAACW,GAAG,CAACN,EAAE,CAAC,EAAE;MAChCE,IAAI,CAACP,eAAe,CAACY,GAAG,CAACP,EAAE,CAAC,CAACQ,IAAI,CAACP,QAAQ,CAAC;MAC3C;IACF;IAEA,MAAMQ,SAAS,GAAG,CAACR,QAAQ,CAAC;IAC5BC,IAAI,CAACP,eAAe,CAACe,GAAG,CAACV,EAAE,EAAES,SAAS,CAAC;IAEvC,IAAI;MACF,IAAIE,GAAG,GACL,CAAC,MAAMT,IAAI,CAACR,gBAAgB,CAACkB,YAAY,CAACd,cAAc,EAAE;QACxDe,GAAG,EAAEd;MACP,CAAC,CAAC,KAAK,IAAI;MACb;MACA;MACA,OAAOU,SAAS,CAACK,MAAM,GAAG,CAAC,EAAE;QAC3B;QACA;QACA;QACA;QACAL,SAAS,CAACM,GAAG,CAAC,CAAC,CAAC,IAAI,EAAEC,KAAK,CAACC,KAAK,CAACN,GAAG,CAAC,CAAC;MACzC;IACF,CAAC,CAAC,OAAOO,CAAC,EAAE;MACV,OAAOT,SAAS,CAACK,MAAM,GAAG,CAAC,EAAE;QAC3BL,SAAS,CAACM,GAAG,CAAC,CAAC,CAACG,CAAC,CAAC;MACpB;IACF,CAAC,SAAS;MACR;MACA;MACAhB,IAAI,CAACP,eAAe,CAACwB,MAAM,CAACnB,EAAE,CAAC;IACjC;EACF;AACF","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"72ca5d34e0e5d89f6b6e52f44a476c949a041e1a"}
