[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar DDPCommon = Package['ddp-common'].DDPCommon;\nvar ECMAScript = Package.ecmascript.ECMAScript;\nvar check = Package.check.check;\nvar Match = Package.check.Match;\nvar Tracker = Package.tracker.Tracker;\nvar Deps = Package.tracker.Deps;\nvar meteorInstall = Package.modules.meteorInstall;\nvar Promise = Package.promise.Promise;\n\n/* Package-scope variables */\nvar EV, fn, eventName, Streamer;\n\nvar require = meteorInstall({\"node_modules\":{\"meteor\":{\"rocketchat:streamer\":{\"lib\":{\"ev.js\":function module(){\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/rocketchat_streamer/lib/ev.js                                                                         //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\n/* globals EV:true */\n\n/* exported EV */\nEV = class EV {\n  constructor() {\n    this.handlers = {};\n  }\n\n  emit(event) {\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n\n    return this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(this, args));\n  }\n\n  emitWithScope(event, scope) {\n    for (var _len2 = arguments.length, args = new Array(_len2 > 2 ? _len2 - 2 : 0), _key2 = 2; _key2 < _len2; _key2++) {\n      args[_key2 - 2] = arguments[_key2];\n    }\n\n    return this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(scope, args));\n  }\n\n  listenerCount(event) {\n    return this.handlers[event] && this.handlers[event].length || 0;\n  }\n\n  on(event, callback) {\n    if (!this.handlers[event]) {\n      this.handlers[event] = [];\n    }\n\n    this.handlers[event].push(callback);\n  }\n\n  once(event, callback) {\n    const self = this;\n    this.on(event, function onetimeCallback() {\n      self.removeListener(event, onetimeCallback);\n      callback.apply(this, arguments);\n    });\n  }\n\n  removeListener(event, callback) {\n    if (!this.handlers[event]) {\n      return;\n    }\n\n    const index = this.handlers[event].indexOf(callback);\n\n    if (index > -1) {\n      this.handlers[event].splice(index, 1);\n    }\n  }\n\n  removeAllListeners(event) {\n    this.handlers[event] = undefined;\n  }\n\n};\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}},\"server\":{\"server.js\":function module(require,exports,module){\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/rocketchat_streamer/server/server.js                                                                  //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nlet DDPCommon;\nmodule.link(\"meteor/ddp-common\", {\n  DDPCommon(v) {\n    DDPCommon = v;\n  }\n\n}, 0);\n\nclass StreamerCentral extends EV {\n  constructor() {\n    super();\n    this.instances = {};\n  }\n\n}\n\nMeteor.StreamerCentral = new StreamerCentral();\n\nconst changedPayload = function (collection, id, fields) {\n  if (_.isEmpty(fields)) {\n    return;\n  }\n\n  return DDPCommon.stringifyDDP({\n    msg: 'changed',\n    collection,\n    id,\n    fields\n  });\n};\n\nconst send = function (self, msg) {\n  if (!self.socket) {\n    return;\n  }\n\n  self.socket.send(msg);\n};\n\nMeteor.Streamer = class Streamer extends EV {\n  constructor(name) {\n    let {\n      retransmit = true,\n      retransmitToSelf = false\n    } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    if (Meteor.StreamerCentral.instances[name]) {\n      console.warn('Streamer instance already exists:', name);\n      return Meteor.StreamerCentral.instances[name];\n    }\n\n    super();\n    Meteor.StreamerCentral.instances[name] = this;\n    this.name = name;\n    this.retransmit = retransmit;\n    this.retransmitToSelf = retransmitToSelf;\n    this.subscriptions = [];\n    this.subscriptionsByEventName = {};\n    this.transformers = {};\n    this.iniPublication();\n    this.initMethod();\n    this._allowRead = {};\n    this._allowEmit = {};\n    this._allowWrite = {};\n    this.allowRead('none');\n    this.allowEmit('all');\n    this.allowWrite('none');\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  set name(name) {\n    check(name, String);\n    this._name = name;\n  }\n\n  get subscriptionName() {\n    return \"stream-\".concat(this.name);\n  }\n\n  get retransmit() {\n    return this._retransmit;\n  }\n\n  set retransmit(retransmit) {\n    check(retransmit, Boolean);\n    this._retransmit = retransmit;\n  }\n\n  get retransmitToSelf() {\n    return this._retransmitToSelf;\n  }\n\n  set retransmitToSelf(retransmitToSelf) {\n    check(retransmitToSelf, Boolean);\n    this._retransmitToSelf = retransmitToSelf;\n  }\n\n  allowRead(eventName, fn) {\n    if (fn === undefined) {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (typeof fn === 'function') {\n      return this._allowRead[eventName] = fn;\n    }\n\n    if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n      console.error(\"allowRead shortcut '\".concat(fn, \"' is invalid\"));\n    }\n\n    if (fn === 'all' || fn === true) {\n      return this._allowRead[eventName] = function () {\n        return true;\n      };\n    }\n\n    if (fn === 'none' || fn === false) {\n      return this._allowRead[eventName] = function () {\n        return false;\n      };\n    }\n\n    if (fn === 'logged') {\n      return this._allowRead[eventName] = function () {\n        return Boolean(this.userId);\n      };\n    }\n  }\n\n  allowEmit(eventName, fn) {\n    if (fn === undefined) {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (typeof fn === 'function') {\n      return this._allowEmit[eventName] = fn;\n    }\n\n    if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n      console.error(\"allowRead shortcut '\".concat(fn, \"' is invalid\"));\n    }\n\n    if (fn === 'all' || fn === true) {\n      return this._allowEmit[eventName] = function () {\n        return true;\n      };\n    }\n\n    if (fn === 'none' || fn === false) {\n      return this._allowEmit[eventName] = function () {\n        return false;\n      };\n    }\n\n    if (fn === 'logged') {\n      return this._allowEmit[eventName] = function () {\n        return Boolean(this.userId);\n      };\n    }\n  }\n\n  allowWrite(eventName, fn) {\n    if (fn === undefined) {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (typeof fn === 'function') {\n      return this._allowWrite[eventName] = fn;\n    }\n\n    if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n      console.error(\"allowWrite shortcut '\".concat(fn, \"' is invalid\"));\n    }\n\n    if (fn === 'all' || fn === true) {\n      return this._allowWrite[eventName] = function () {\n        return true;\n      };\n    }\n\n    if (fn === 'none' || fn === false) {\n      return this._allowWrite[eventName] = function () {\n        return false;\n      };\n    }\n\n    if (fn === 'logged') {\n      return this._allowWrite[eventName] = function () {\n        return Boolean(this.userId);\n      };\n    }\n  }\n\n  isReadAllowed(scope, eventName, args) {\n    if (this._allowRead[eventName]) {\n      return this._allowRead[eventName].call(scope, eventName, ...args);\n    }\n\n    return this._allowRead['__all__'].call(scope, eventName, ...args);\n  }\n\n  isEmitAllowed(scope, eventName) {\n    for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n      args[_key - 2] = arguments[_key];\n    }\n\n    if (this._allowEmit[eventName]) {\n      return this._allowEmit[eventName].call(scope, eventName, ...args);\n    }\n\n    return this._allowEmit['__all__'].call(scope, eventName, ...args);\n  }\n\n  isWriteAllowed(scope, eventName, args) {\n    if (this._allowWrite[eventName]) {\n      return this._allowWrite[eventName].call(scope, eventName, ...args);\n    }\n\n    return this._allowWrite['__all__'].call(scope, eventName, ...args);\n  }\n\n  addSubscription(subscription, eventName) {\n    this.subscriptions.push(subscription);\n\n    if (!this.subscriptionsByEventName[eventName]) {\n      this.subscriptionsByEventName[eventName] = [];\n    }\n\n    this.subscriptionsByEventName[eventName].push(subscription);\n  }\n\n  removeSubscription(subscription, eventName) {\n    const index = this.subscriptions.indexOf(subscription);\n\n    if (index > -1) {\n      this.subscriptions.splice(index, 1);\n    }\n\n    if (this.subscriptionsByEventName[eventName]) {\n      const index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\n      if (index > -1) {\n        this.subscriptionsByEventName[eventName].splice(index, 1);\n      }\n    }\n  }\n\n  transform(eventName, fn) {\n    if (typeof eventName === 'function') {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (!this.transformers[eventName]) {\n      this.transformers[eventName] = [];\n    }\n\n    this.transformers[eventName].push(fn);\n  }\n\n  applyTransformers(methodScope, eventName, args) {\n    if (this.transformers['__all__']) {\n      this.transformers['__all__'].forEach(transform => {\n        args = transform.call(methodScope, eventName, args);\n        methodScope.tranformed = true;\n\n        if (!Array.isArray(args)) {\n          args = [args];\n        }\n      });\n    }\n\n    if (this.transformers[eventName]) {\n      this.transformers[eventName].forEach(transform => {\n        args = transform.call(methodScope, ...args);\n        methodScope.tranformed = true;\n\n        if (!Array.isArray(args)) {\n          args = [args];\n        }\n      });\n    }\n\n    return args;\n  }\n\n  _publish(publication, eventName, options) {\n    check(eventName, String);\n    check(options, Match.OneOf(Boolean, {\n      useCollection: Boolean,\n      args: Array\n    }));\n    let useCollection,\n        args = [];\n\n    if (typeof options === 'boolean') {\n      useCollection = options;\n    } else {\n      if (options.useCollection) {\n        useCollection = options.useCollection;\n      }\n\n      if (options.args) {\n        args = options.args;\n      }\n    }\n\n    if (eventName.length === 0) {\n      publication.stop();\n      throw new Meteor.Error('invalid-event-name');\n    }\n\n    if (this.isReadAllowed(publication, eventName, args) !== true) {\n      publication.stop();\n      throw new Meteor.Error('not-allowed');\n    }\n\n    const subscription = {\n      subscription: publication,\n      eventName: eventName\n    };\n    this.addSubscription(subscription, eventName);\n    publication.onStop(() => {\n      this.removeSubscription(subscription, eventName);\n    });\n\n    if (useCollection === true) {\n      // Collection compatibility\n      publication._session.sendAdded(this.subscriptionName, 'id', {\n        eventName: eventName\n      });\n    }\n\n    publication.ready();\n  }\n\n  iniPublication() {\n    const stream = this;\n    Meteor.publish(this.subscriptionName, function () {\n      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n        args[_key2] = arguments[_key2];\n      }\n\n      return stream._publish.apply(stream, [this, ...args]);\n    });\n  }\n\n  initMethod() {\n    const stream = this;\n    const method = {};\n\n    method[this.subscriptionName] = function (eventName) {\n      for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n        args[_key3 - 1] = arguments[_key3];\n      }\n\n      check(eventName, String);\n      check(args, Array);\n      this.unblock();\n\n      if (stream.isWriteAllowed(this, eventName, args) !== true) {\n        return;\n      }\n\n      const methodScope = {\n        userId: this.userId,\n        connection: this.connection,\n        originalParams: args,\n        tranformed: false\n      };\n      args = stream.applyTransformers(methodScope, eventName, args);\n      stream.emitWithScope(eventName, methodScope, ...args);\n\n      if (stream.retransmit === true) {\n        stream._emit(eventName, args, this.connection, true);\n      }\n    };\n\n    try {\n      Meteor.methods(method);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  _emit(eventName, args, origin, broadcast) {\n    if (broadcast === true) {\n      Meteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n    }\n\n    const subscriptions = this.subscriptionsByEventName[eventName];\n\n    if (!Array.isArray(subscriptions)) {\n      return;\n    }\n\n    const msg = changedPayload(this.subscriptionName, 'id', {\n      eventName,\n      args\n    });\n\n    if (!msg) {\n      return;\n    }\n\n    subscriptions.forEach(subscription => {\n      if (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n        return;\n      }\n\n      if (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n        send(subscription.subscription._session, msg);\n      }\n    });\n  }\n\n  emit(eventName) {\n    for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n      args[_key4 - 1] = arguments[_key4];\n    }\n\n    this._emit(eventName, args, undefined, true);\n  }\n\n  __emit() {\n    return super.emit(...arguments);\n  }\n\n  emitWithoutBroadcast(eventName) {\n    for (var _len5 = arguments.length, args = new Array(_len5 > 1 ? _len5 - 1 : 0), _key5 = 1; _key5 < _len5; _key5++) {\n      args[_key5 - 1] = arguments[_key5];\n    }\n\n    this._emit(eventName, args, undefined, false);\n  }\n\n};\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}}}}}},{\n  \"extensions\": [\n    \".js\",\n    \".json\"\n  ]\n});\n\nrequire(\"/node_modules/meteor/rocketchat:streamer/lib/ev.js\");\nrequire(\"/node_modules/meteor/rocketchat:streamer/server/server.js\");\n\n/* Exports */\nPackage._define(\"rocketchat:streamer\", {\n  Streamer: Streamer\n});\n\n})();\n","servePath":"/packages/rocketchat_streamer.js","sourceMap":{"version":3,"sources":["packages/rocketchat:streamer/lib/ev.js","packages/rocketchat:streamer/server/server.js"],"names":["EV","constructor","handlers","emit","event","args","forEach","handler","apply","emitWithScope","scope","listenerCount","length","on","callback","push","once","self","onetimeCallback","removeListener","arguments","index","indexOf","splice","removeAllListeners","undefined","DDPCommon","module","link","v","StreamerCentral","instances","Meteor","changedPayload","collection","id","fields","_","isEmpty","stringifyDDP","msg","send","socket","Streamer","name","retransmit","retransmitToSelf","console","warn","subscriptions","subscriptionsByEventName","transformers","iniPublication","initMethod","_allowRead","_allowEmit","_allowWrite","allowRead","allowEmit","allowWrite","_name","check","String","subscriptionName","_retransmit","Boolean","_retransmitToSelf","eventName","fn","error","userId","isReadAllowed","call","isEmitAllowed","isWriteAllowed","addSubscription","subscription","removeSubscription","transform","applyTransformers","methodScope","tranformed","Array","isArray","_publish","publication","options","Match","OneOf","useCollection","stop","Error","onStop","_session","sendAdded","ready","stream","publish","method","unblock","connection","originalParams","_emit","methods","e","origin","broadcast","__emit","emitWithoutBroadcast"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(this, args));\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(scope, args));\n\t}\n\n\tlistenerCount(event) {\n\t\treturn (this.handlers[event] && this.handlers[event].length) || 0;\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tconst self = this;\n\t\tthis.on(event, function onetimeCallback() {\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t\tcallback.apply(this, arguments);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\treturn;\n\t\t}\n\t\tconst index = this.handlers[event].indexOf(callback);\n\t\tif (index > -1) {\n\t\t\tthis.handlers[event].splice(index, 1);\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals EV */\n/* eslint new-cap: false */\nimport { DDPCommon } from 'meteor/ddp-common';\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nconst changedPayload = function (collection, id, fields) {\n\tif (_.isEmpty(fields)) {\n\t\treturn;\n\t}\n\treturn DDPCommon.stringifyDDP({\n\t\tmsg: 'changed',\n\t\tcollection,\n\t\tid,\n\t\tfields\n\t});\n};\n\nconst send = function (self, msg) {\n\tif (!self.socket) {\n\t\treturn;\n\t}\n\tself.socket.send(msg);\n};\n\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {retransmit = true, retransmitToSelf = false} = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\n\t\tsuper();\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.subscriptions = [];\n\t\tthis.subscriptionsByEventName = {};\n\t\tthis.transformers = {};\n\n\t\tthis.iniPublication();\n\t\tthis.initMethod();\n\n\t\tthis._allowRead = {};\n\t\tthis._allowEmit = {};\n\t\tthis._allowWrite = {};\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget retransmit() {\n\t\treturn this._retransmit;\n\t}\n\n\tset retransmit(retransmit) {\n\t\tcheck(retransmit, Boolean);\n\t\tthis._retransmit = retransmit;\n\t}\n\n\tget retransmitToSelf() {\n\t\treturn this._retransmitToSelf;\n\t}\n\n\tset retransmitToSelf(retransmitToSelf) {\n\t\tcheck(retransmitToSelf, Boolean);\n\t\tthis._retransmitToSelf = retransmitToSelf;\n\t}\n\n\tallowRead(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowRead[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowEmit(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowEmit[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowWrite(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowWrite[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowWrite shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tisReadAllowed(scope, eventName, args) {\n\t\tif (this._allowRead[eventName]) {\n\t\t\treturn this._allowRead[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowRead['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisEmitAllowed(scope, eventName, ...args) {\n\t\tif (this._allowEmit[eventName]) {\n\t\t\treturn this._allowEmit[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowEmit['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisWriteAllowed(scope, eventName, args) {\n\t\tif (this._allowWrite[eventName]) {\n\t\t\treturn this._allowWrite[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowWrite['__all__'].call(scope, eventName, ...args);\n\t}\n\n\taddSubscription(subscription, eventName) {\n\t\tthis.subscriptions.push(subscription);\n\n\t\tif (!this.subscriptionsByEventName[eventName]) {\n\t\t\tthis.subscriptionsByEventName[eventName] = [];\n\t\t}\n\n\t\tthis.subscriptionsByEventName[eventName].push(subscription);\n\t}\n\n\tremoveSubscription(subscription, eventName) {\n\t\tconst index = this.subscriptions.indexOf(subscription);\n\t\tif (index > -1) {\n\t\t\tthis.subscriptions.splice(index, 1);\n\t\t}\n\n\t\tif (this.subscriptionsByEventName[eventName]) {\n\t\t\tconst index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.subscriptionsByEventName[eventName].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\ttransform(eventName, fn) {\n\t\tif (typeof eventName === 'function') {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (!this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName] = [];\n\t\t}\n\n\t\tthis.transformers[eventName].push(fn);\n\t}\n\n\tapplyTransformers(methodScope, eventName, args) {\n\t\tif (this.transformers['__all__']) {\n\t\t\tthis.transformers['__all__'].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, eventName, args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, ...args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn args;\n\t}\n\n\n\t_publish(publication, eventName, options) {\n\t\tcheck(eventName, String);\n\t\tcheck(options, Match.OneOf(Boolean, {\n\t\t\tuseCollection: Boolean,\n\t\t\targs: Array,\n\t\t}));\n\n\t\tlet useCollection, args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('invalid-event-name');\n\t\t}\n\n\t\tif (this.isReadAllowed(publication, eventName, args) !== true) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName: eventName\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName: eventName\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\t}\n\n\tiniPublication() {\n\t\tconst stream = this;\n\t\tMeteor.publish(this.subscriptionName, function (...args) { return stream._publish.apply(stream, [this, ...args]); });\n\t}\n\n\tinitMethod() {\n\t\tconst stream = this;\n\t\tconst method = {};\n\n\t\tmethod[this.subscriptionName] = function(eventName, ...args) {\n\t\t\tcheck(eventName, String);\n\t\t\tcheck(args, Array);\n\n\t\t\tthis.unblock();\n\n\t\t\tif (stream.isWriteAllowed(this, eventName, args) !== true) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst methodScope = {\n\t\t\t\tuserId: this.userId,\n\t\t\t\tconnection: this.connection,\n\t\t\t\toriginalParams: args,\n\t\t\t\ttranformed: false\n\t\t\t};\n\n\t\t\targs = stream.applyTransformers(methodScope, eventName, args);\n\n\t\t\tstream.emitWithScope(eventName, methodScope, ...args);\n\n\t\t\tif (stream.retransmit === true) {\n\t\t\t\tstream._emit(eventName, args, this.connection, true);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tMeteor.methods(method);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n\n\t_emit(eventName, args, origin, broadcast) {\n\t\tif (broadcast === true) {\n\t\t\tMeteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName[eventName];\n\t\tif (!Array.isArray(subscriptions)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msg = changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs\n\t\t});\n\n\t\tif(!msg) {\n\t\t\treturn;\n\t\t}\n\n\t\tsubscriptions.forEach((subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n\t\t\t\tsend(subscription.subscription._session, msg);\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, true);\n\t}\n\n\t__emit(...args) {\n\t\treturn super.emit(...args);\n\t}\n\n\temitWithoutBroadcast(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n};\n"]}}]