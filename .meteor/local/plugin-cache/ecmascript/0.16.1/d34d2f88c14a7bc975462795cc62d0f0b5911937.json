{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/oauth/oauth_client.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/oauth/oauth_client.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/oauth/oauth_client.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/oauth/oauth_client.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/oauth/oauth_client.js"}},"code":"// credentialToken -> credentialSecret. You must provide both the\n// credentialToken and the credentialSecret to retrieve an access token from\n// the _pendingCredentials collection.\nconst credentialSecrets = {};\nOAuth = {};\n\nOAuth.showPopup = (url, callback, dimensions) => {\n  throw new Error(\"OAuth.showPopup must be implemented on this arch.\");\n}; // Determine the login style (popup or redirect) for this login flow.\n//\n//\n\n\nOAuth._loginStyle = (service, config, options) => {\n  if (Meteor.isCordova) {\n    return \"popup\";\n  }\n\n  let loginStyle = options && options.loginStyle || config.loginStyle || 'popup';\n  if (![\"popup\", \"redirect\"].includes(loginStyle)) throw new Error(\"Invalid login style: \".concat(loginStyle)); // If we don't have session storage (for example, Safari in private\n  // mode), the redirect login flow won't work, so fallback to the\n  // popup style.\n\n  if (loginStyle === 'redirect') {\n    try {\n      sessionStorage.setItem('Meteor.oauth.test', 'test');\n      sessionStorage.removeItem('Meteor.oauth.test');\n    } catch (e) {\n      loginStyle = 'popup';\n    }\n  }\n\n  return loginStyle;\n};\n\nOAuth._stateParam = (loginStyle, credentialToken, redirectUrl) => {\n  var _Meteor$settings, _Meteor$settings$publ, _Meteor$settings$publ2, _Meteor$settings$publ3;\n\n  const state = {\n    loginStyle,\n    credentialToken,\n    isCordova: Meteor.isCordova\n  };\n\n  if (loginStyle === 'redirect' || (_Meteor$settings = Meteor.settings) !== null && _Meteor$settings !== void 0 && (_Meteor$settings$publ = _Meteor$settings.public) !== null && _Meteor$settings$publ !== void 0 && (_Meteor$settings$publ2 = _Meteor$settings$publ.packages) !== null && _Meteor$settings$publ2 !== void 0 && (_Meteor$settings$publ3 = _Meteor$settings$publ2.oauth) !== null && _Meteor$settings$publ3 !== void 0 && _Meteor$settings$publ3.setRedirectUrlWhenLoginStyleIsPopup && loginStyle === 'popup') {\n    state.redirectUrl = redirectUrl || '' + window.location;\n  } // Encode base64 as not all login services URI-encode the state\n  // parameter when they pass it back to us.\n  // Use the 'base64' package here because 'btoa' isn't supported in IE8/9.\n\n\n  return Base64.encode(JSON.stringify(state));\n}; // At the beginning of the redirect login flow, before we redirect to\n// the login service, save the credential token for this login attempt\n// in the reload migration data.\n//\n\n\nOAuth.saveDataForRedirect = (loginService, credentialToken) => {\n  Reload._onMigrate('oauth', () => [true, {\n    loginService,\n    credentialToken\n  }]);\n\n  Reload._migrate(null, {\n    immediateMigration: true\n  });\n}; // At the end of the redirect login flow, when we've redirected back\n// to the application, retrieve the credentialToken and (if the login\n// was successful) the credentialSecret.\n//\n// Called at application startup.  Returns null if this is normal\n// application startup and we weren't just redirected at the end of\n// the login flow.\n//\n\n\nOAuth.getDataAfterRedirect = () => {\n  const migrationData = Reload._migrationData('oauth');\n\n  if (!(migrationData && migrationData.credentialToken)) return null;\n  const {\n    credentialToken\n  } = migrationData;\n  const key = OAuth._storageTokenPrefix + credentialToken;\n  let credentialSecret;\n\n  try {\n    credentialSecret = sessionStorage.getItem(key);\n    sessionStorage.removeItem(key);\n  } catch (e) {\n    Meteor._debug('error retrieving credentialSecret', e);\n  }\n\n  return {\n    loginService: migrationData.loginService,\n    credentialToken,\n    credentialSecret\n  };\n}; // Launch an OAuth login flow.  For the popup login style, show the\n// popup.  For the redirect login style, save the credential token for\n// this login attempt in the reload migration data, and redirect to\n// the service for the login.\n//\n// options:\n//  loginService: \"facebook\", \"google\", etc.\n//  loginStyle: \"popup\" or \"redirect\"\n//  loginUrl: The URL at the login service provider to start the OAuth flow.\n//  credentialRequestCompleteCallback: for the popup flow, call when the popup\n//    is closed and we have the credential from the login service.\n//  credentialToken: our identifier for this login flow.\n//\n\n\nOAuth.launchLogin = options => {\n  if (!options.loginService) throw new Error('loginService required');\n\n  if (options.loginStyle === 'popup') {\n    OAuth.showPopup(options.loginUrl, options.credentialRequestCompleteCallback.bind(null, options.credentialToken), options.popupOptions);\n  } else if (options.loginStyle === 'redirect') {\n    OAuth.saveDataForRedirect(options.loginService, options.credentialToken);\n    window.location = options.loginUrl;\n  } else {\n    throw new Error('invalid login style');\n  }\n}; // Called by the popup when the OAuth flow is completed, right before\n// the popup closes.\n\n\nOAuth._handleCredentialSecret = (credentialToken, secret) => {\n  check(credentialToken, String);\n  check(secret, String);\n\n  if (!Object.prototype.hasOwnProperty.call(credentialSecrets, credentialToken)) {\n    credentialSecrets[credentialToken] = secret;\n  } else {\n    throw new Error(\"Duplicate credential token from OAuth login\");\n  }\n}; // Used by accounts-oauth, which needs both a credentialToken and the\n// corresponding to credential secret to call the `login` method over DDP.\n\n\nOAuth._retrieveCredentialSecret = credentialToken => {\n  // First check the secrets collected by OAuth._handleCredentialSecret,\n  // then check localStorage. This matches what we do in\n  // end_of_login_response.html.\n  let secret = credentialSecrets[credentialToken];\n\n  if (!secret) {\n    const localStorageKey = OAuth._storageTokenPrefix + credentialToken;\n    secret = Meteor._localStorage.getItem(localStorageKey);\n\n    Meteor._localStorage.removeItem(localStorageKey);\n  } else {\n    delete credentialSecrets[credentialToken];\n  }\n\n  return secret;\n};","map":{"version":3,"sources":["packages/oauth/oauth_client.js"],"names":["credentialSecrets","OAuth","showPopup","url","callback","dimensions","Error","_loginStyle","service","config","options","Meteor","isCordova","loginStyle","includes","sessionStorage","setItem","removeItem","e","_stateParam","credentialToken","redirectUrl","state","settings","public","packages","oauth","setRedirectUrlWhenLoginStyleIsPopup","window","location","Base64","encode","JSON","stringify","saveDataForRedirect","loginService","Reload","_onMigrate","_migrate","immediateMigration","getDataAfterRedirect","migrationData","_migrationData","key","_storageTokenPrefix","credentialSecret","getItem","_debug","launchLogin","loginUrl","credentialRequestCompleteCallback","bind","popupOptions","_handleCredentialSecret","secret","check","String","Object","prototype","hasOwnProperty","call","_retrieveCredentialSecret","localStorageKey","_localStorage"],"mappings":"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","sourcesContent":["// credentialToken -> credentialSecret. You must provide both the\n// credentialToken and the credentialSecret to retrieve an access token from\n// the _pendingCredentials collection.\nconst credentialSecrets = {};\n\nOAuth = {};\n\nOAuth.showPopup = (url, callback, dimensions) => {\n  throw new Error(\"OAuth.showPopup must be implemented on this arch.\");\n};\n\n// Determine the login style (popup or redirect) for this login flow.\n//\n//\nOAuth._loginStyle = (service, config, options) => {\n\n  if (Meteor.isCordova) {\n    return \"popup\";\n  }\n\n  let loginStyle = (options && options.loginStyle) || config.loginStyle || 'popup';\n\n  if (! [\"popup\", \"redirect\"].includes(loginStyle))\n    throw new Error(`Invalid login style: ${loginStyle}`);\n\n  // If we don't have session storage (for example, Safari in private\n  // mode), the redirect login flow won't work, so fallback to the\n  // popup style.\n  if (loginStyle === 'redirect') {\n    try {\n      sessionStorage.setItem('Meteor.oauth.test', 'test');\n      sessionStorage.removeItem('Meteor.oauth.test');\n    } catch (e) {\n      loginStyle = 'popup';\n    }\n  }\n\n  return loginStyle;\n};\n\nOAuth._stateParam = (loginStyle, credentialToken, redirectUrl) => {\n  const state = {\n    loginStyle,\n    credentialToken,\n    isCordova: Meteor.isCordova\n  };\n\n  if (loginStyle === 'redirect' ||\n    (Meteor.settings?.public?.packages?.oauth?.setRedirectUrlWhenLoginStyleIsPopup && loginStyle === 'popup')\n  ) {\n    state.redirectUrl = redirectUrl || ('' + window.location);\n  }\n\n  // Encode base64 as not all login services URI-encode the state\n  // parameter when they pass it back to us.\n  // Use the 'base64' package here because 'btoa' isn't supported in IE8/9.\n  return Base64.encode(JSON.stringify(state));\n};\n\n\n// At the beginning of the redirect login flow, before we redirect to\n// the login service, save the credential token for this login attempt\n// in the reload migration data.\n//\nOAuth.saveDataForRedirect = (loginService, credentialToken) => {\n  Reload._onMigrate('oauth', () => [true, { loginService, credentialToken }]);\n  Reload._migrate(null, {immediateMigration: true});\n};\n\n// At the end of the redirect login flow, when we've redirected back\n// to the application, retrieve the credentialToken and (if the login\n// was successful) the credentialSecret.\n//\n// Called at application startup.  Returns null if this is normal\n// application startup and we weren't just redirected at the end of\n// the login flow.\n//\nOAuth.getDataAfterRedirect = () => {\n  const migrationData = Reload._migrationData('oauth');\n\n  if (! (migrationData && migrationData.credentialToken))\n    return null;\n\n  const { credentialToken } = migrationData;\n  const key = OAuth._storageTokenPrefix + credentialToken;\n  let credentialSecret;\n  try {\n    credentialSecret = sessionStorage.getItem(key);\n    sessionStorage.removeItem(key);\n  } catch (e) {\n    Meteor._debug('error retrieving credentialSecret', e);\n  }\n  return {\n    loginService: migrationData.loginService,\n    credentialToken,\n    credentialSecret,\n  };\n};\n\n// Launch an OAuth login flow.  For the popup login style, show the\n// popup.  For the redirect login style, save the credential token for\n// this login attempt in the reload migration data, and redirect to\n// the service for the login.\n//\n// options:\n//  loginService: \"facebook\", \"google\", etc.\n//  loginStyle: \"popup\" or \"redirect\"\n//  loginUrl: The URL at the login service provider to start the OAuth flow.\n//  credentialRequestCompleteCallback: for the popup flow, call when the popup\n//    is closed and we have the credential from the login service.\n//  credentialToken: our identifier for this login flow.\n//\nOAuth.launchLogin = options => {\n  if (! options.loginService)\n    throw new Error('loginService required');\n  if (options.loginStyle === 'popup') {\n    OAuth.showPopup(\n      options.loginUrl,\n      options.credentialRequestCompleteCallback.bind(null, options.credentialToken),\n      options.popupOptions);\n  } else if (options.loginStyle === 'redirect') {\n    OAuth.saveDataForRedirect(options.loginService, options.credentialToken);\n    window.location = options.loginUrl;\n  } else {\n    throw new Error('invalid login style');\n  }\n};\n\n// Called by the popup when the OAuth flow is completed, right before\n// the popup closes.\nOAuth._handleCredentialSecret = (credentialToken, secret) => {\n  check(credentialToken, String);\n  check(secret, String);\n  if (! Object.prototype.hasOwnProperty.call(credentialSecrets, credentialToken)) {\n    credentialSecrets[credentialToken] = secret;\n  } else {\n    throw new Error(\"Duplicate credential token from OAuth login\");\n  }\n};\n\n// Used by accounts-oauth, which needs both a credentialToken and the\n// corresponding to credential secret to call the `login` method over DDP.\nOAuth._retrieveCredentialSecret = credentialToken => {\n  // First check the secrets collected by OAuth._handleCredentialSecret,\n  // then check localStorage. This matches what we do in\n  // end_of_login_response.html.\n  let secret = credentialSecrets[credentialToken];\n  if (! secret) {\n    const localStorageKey = OAuth._storageTokenPrefix + credentialToken;\n    secret = Meteor._localStorage.getItem(localStorageKey);\n    Meteor._localStorage.removeItem(localStorageKey);\n  } else {\n    delete credentialSecrets[credentialToken];\n  }\n  return secret;\n};\n"]},"sourceType":"module","hash":"d34d2f88c14a7bc975462795cc62d0f0b5911937"}
