{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/sendMessage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/lib/server/functions/sendMessage.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/sendMessage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/functions/sendMessage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/sendMessage.js"}},"code":"module.export({\n  validateMessage: () => validateMessage,\n  prepareMessageObject: () => prepareMessageObject,\n  sendMessage: () => sendMessage\n});\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 0);\nlet parser;\nmodule.link(\"@rocket.chat/message-parser\", {\n  parser(v) {\n    parser = v;\n  }\n\n}, 1);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 2);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 3);\nlet Messages;\nmodule.link(\"../../../models\", {\n  Messages(v) {\n    Messages = v;\n  }\n\n}, 4);\nlet Apps;\nmodule.link(\"../../../apps/server\", {\n  Apps(v) {\n    Apps = v;\n  }\n\n}, 5);\nlet isURL, isRelativeURL;\nmodule.link(\"../../../utils/lib/isURL\", {\n  isURL(v) {\n    isURL = v;\n  },\n\n  isRelativeURL(v) {\n    isRelativeURL = v;\n  }\n\n}, 6);\nlet FileUpload;\nmodule.link(\"../../../file-upload/server\", {\n  FileUpload(v) {\n    FileUpload = v;\n  }\n\n}, 7);\nlet hasPermission;\nmodule.link(\"../../../authorization/server\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 8);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 9);\nlet parseUrlsInMessage;\nmodule.link(\"./parseUrlsInMessage\", {\n  parseUrlsInMessage(v) {\n    parseUrlsInMessage = v;\n  }\n\n}, 10);\nconst {\n  DISABLE_MESSAGE_PARSER = 'false'\n} = process.env;\n/**\n * IMPORTANT\n *\n * This validator prevents malicious href values\n * intending to run arbitrary js code in anchor tags.\n * You should use it whenever the value you're checking\n * is going to be rendered in the href attribute of a\n * link.\n */\n\nconst validFullURLParam = Match.Where(value => {\n  check(value, String);\n\n  if (!isURL(value) && !value.startsWith(FileUpload.getPath())) {\n    throw new Error('Invalid href value provided');\n  }\n\n  if (/^javascript:/i.test(value)) {\n    throw new Error('Invalid href value provided');\n  }\n\n  return true;\n});\nconst validPartialURLParam = Match.Where(value => {\n  check(value, String);\n\n  if (!isRelativeURL(value) && !isURL(value) && !value.startsWith(FileUpload.getPath())) {\n    throw new Error('Invalid href value provided');\n  }\n\n  if (/^javascript:/i.test(value)) {\n    throw new Error('Invalid href value provided');\n  }\n\n  return true;\n});\n\nconst objectMaybeIncluding = types => Match.Where(value => {\n  Object.keys(types).forEach(field => {\n    if (value[field] != null) {\n      try {\n        check(value[field], types[field]);\n      } catch (error) {\n        error.path = field;\n        throw error;\n      }\n    }\n  });\n  return true;\n});\n\nconst validateAttachmentsFields = attachmentField => {\n  check(attachmentField, objectMaybeIncluding({\n    short: Boolean,\n    title: String,\n    value: Match.OneOf(String, Number, Boolean)\n  }));\n\n  if (typeof attachmentField.value !== 'undefined') {\n    attachmentField.value = String(attachmentField.value);\n  }\n};\n\nconst validateAttachmentsActions = attachmentActions => {\n  check(attachmentActions, objectMaybeIncluding({\n    type: String,\n    text: String,\n    url: validFullURLParam,\n    image_url: validFullURLParam,\n    is_webview: Boolean,\n    webview_height_ratio: String,\n    msg: String,\n    msg_in_chat_window: Boolean\n  }));\n};\n\nconst validateAttachment = attachment => {\n  check(attachment, objectMaybeIncluding({\n    color: String,\n    text: String,\n    ts: Match.OneOf(String, Number),\n    thumb_url: validFullURLParam,\n    button_alignment: String,\n    actions: [Match.Any],\n    message_link: validFullURLParam,\n    collapsed: Boolean,\n    author_name: String,\n    author_link: validFullURLParam,\n    author_icon: validFullURLParam,\n    title: String,\n    title_link: validFullURLParam,\n    title_link_download: Boolean,\n    image_dimensions: Object,\n    image_url: validFullURLParam,\n    image_preview: String,\n    image_type: String,\n    image_size: Number,\n    audio_url: validFullURLParam,\n    audio_type: String,\n    audio_size: Number,\n    video_url: validFullURLParam,\n    video_type: String,\n    video_size: Number,\n    fields: [Match.Any]\n  }));\n\n  if (attachment.fields && attachment.fields.length) {\n    attachment.fields.map(validateAttachmentsFields);\n  }\n\n  if (attachment.actions && attachment.actions.length) {\n    attachment.actions.map(validateAttachmentsActions);\n  }\n};\n\nconst validateBodyAttachments = attachments => attachments.map(validateAttachment);\n\nconst validateMessage = (message, room, user) => {\n  check(message, objectMaybeIncluding({\n    _id: String,\n    msg: String,\n    text: String,\n    alias: String,\n    emoji: String,\n    tmid: String,\n    tshow: Boolean,\n    avatar: validPartialURLParam,\n    attachments: [Match.Any],\n    blocks: [Match.Any]\n  }));\n\n  if (message.alias || message.avatar) {\n    var _room$v;\n\n    const isLiveChatGuest = !message.avatar && user.token && user.token === ((_room$v = room.v) === null || _room$v === void 0 ? void 0 : _room$v.token);\n\n    if (!isLiveChatGuest && !hasPermission(user._id, 'message-impersonate', room._id)) {\n      throw new Error('Not enough permission');\n    }\n  }\n\n  if (Array.isArray(message.attachments) && message.attachments.length) {\n    validateBodyAttachments(message.attachments);\n  }\n};\n\nconst prepareMessageObject = function (message, rid, user) {\n  if (!message.ts) {\n    message.ts = new Date();\n  }\n\n  if (message.tshow !== true) {\n    delete message.tshow;\n  }\n\n  const {\n    _id,\n    username,\n    name\n  } = user;\n  message.u = {\n    _id,\n    username,\n    name\n  };\n  message.rid = rid;\n\n  if (!Match.test(message.msg, String)) {\n    message.msg = '';\n  }\n\n  if (message.ts == null) {\n    message.ts = new Date();\n  }\n};\n\n/**\n * Clean up the message object before saving on db\n * @param {IMessage} message\n */\nfunction cleanupMessageObject(message) {\n  ['customClass'].forEach(field => delete message[field]);\n}\n\nconst sendMessage = function (user, message, room) {\n  let upsert = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n\n  if (!user || !message || !room._id) {\n    return false;\n  }\n\n  validateMessage(message, room, user);\n  prepareMessageObject(message, room._id, user);\n\n  if (settings.get('Message_Read_Receipt_Enabled')) {\n    message.unread = true;\n  } // For the Rocket.Chat Apps :)\n\n\n  if (Apps && Apps.isLoaded()) {\n    const prevent = Promise.await(Apps.getBridges().getListenerBridge().messageEvent('IPreMessageSentPrevent', message));\n\n    if (prevent) {\n      if (settings.get('Apps_Framework_Development_Mode')) {\n        SystemLogger.info({\n          msg: 'A Rocket.Chat App prevented the message sending.',\n          message\n        });\n      }\n\n      return;\n    }\n\n    let result;\n    result = Promise.await(Apps.getBridges().getListenerBridge().messageEvent('IPreMessageSentExtend', message));\n    result = Promise.await(Apps.getBridges().getListenerBridge().messageEvent('IPreMessageSentModify', result));\n\n    if (typeof result === 'object') {\n      message = Object.assign(message, result); // Some app may have inserted malicious/invalid values in the message, let's check it again\n\n      validateMessage(message, room, user);\n    }\n  }\n\n  cleanupMessageObject(message);\n  parseUrlsInMessage(message);\n  message = callbacks.run('beforeSaveMessage', message, room);\n\n  try {\n    if (message.msg && DISABLE_MESSAGE_PARSER !== 'true') {\n      message.md = parser(message.msg);\n    }\n  } catch (e) {\n    SystemLogger.error(e); // errors logged while the parser is at experimental stage\n  }\n\n  if (message) {\n    if (message._id && upsert) {\n      const {\n        _id\n      } = message;\n      delete message._id;\n      Messages.upsert({\n        _id,\n        'u._id': message.u._id\n      }, message);\n      message._id = _id;\n    } else {\n      const messageAlreadyExists = message._id && Messages.findOneById(message._id, {\n        fields: {\n          _id: 1\n        }\n      });\n\n      if (messageAlreadyExists) {\n        return;\n      }\n\n      message._id = Messages.insert(message);\n    }\n\n    if (Apps && Apps.isLoaded()) {\n      // This returns a promise, but it won't mutate anything about the message\n      // so, we don't really care if it is successful or fails\n      Apps.getBridges().getListenerBridge().messageEvent('IPostMessageSent', message);\n    }\n    /*\n    Defer other updates as their return is not interesting to the user\n    */\n    // Execute all callbacks\n\n\n    callbacks.runAsync('afterSaveMessage', message, room);\n    return message;\n  }\n};","map":{"version":3,"sources":["app/lib/server/functions/sendMessage.js"],"names":["module","export","validateMessage","prepareMessageObject","sendMessage","Match","check","link","v","parser","settings","callbacks","Messages","Apps","isURL","isRelativeURL","FileUpload","hasPermission","SystemLogger","parseUrlsInMessage","DISABLE_MESSAGE_PARSER","process","env","validFullURLParam","Where","value","String","startsWith","getPath","Error","test","validPartialURLParam","objectMaybeIncluding","types","Object","keys","forEach","field","error","path","validateAttachmentsFields","attachmentField","short","Boolean","title","OneOf","Number","validateAttachmentsActions","attachmentActions","type","text","url","image_url","is_webview","webview_height_ratio","msg","msg_in_chat_window","validateAttachment","attachment","color","ts","thumb_url","button_alignment","actions","Any","message_link","collapsed","author_name","author_link","author_icon","title_link","title_link_download","image_dimensions","image_preview","image_type","image_size","audio_url","audio_type","audio_size","video_url","video_type","video_size","fields","length","map","validateBodyAttachments","attachments","message","room","user","_id","alias","emoji","tmid","tshow","avatar","blocks","isLiveChatGuest","token","Array","isArray","rid","Date","username","name","u","cleanupMessageObject","upsert","get","unread","isLoaded","prevent","Promise","await","getBridges","getListenerBridge","messageEvent","info","result","assign","run","md","e","messageAlreadyExists","findOneById","insert","runAsync"],"mappings":"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","sourcesContent":["import { Match, check } from 'meteor/check';\nimport { parser } from '@rocket.chat/message-parser';\n\nimport { settings } from '../../../settings';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { Messages } from '../../../models';\nimport { Apps } from '../../../apps/server';\nimport { isURL, isRelativeURL } from '../../../utils/lib/isURL';\nimport { FileUpload } from '../../../file-upload/server';\nimport { hasPermission } from '../../../authorization/server';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { parseUrlsInMessage } from './parseUrlsInMessage';\n\nconst { DISABLE_MESSAGE_PARSER = 'false' } = process.env;\n\n/**\n * IMPORTANT\n *\n * This validator prevents malicious href values\n * intending to run arbitrary js code in anchor tags.\n * You should use it whenever the value you're checking\n * is going to be rendered in the href attribute of a\n * link.\n */\nconst validFullURLParam = Match.Where((value) => {\n\tcheck(value, String);\n\n\tif (!isURL(value) && !value.startsWith(FileUpload.getPath())) {\n\t\tthrow new Error('Invalid href value provided');\n\t}\n\n\tif (/^javascript:/i.test(value)) {\n\t\tthrow new Error('Invalid href value provided');\n\t}\n\n\treturn true;\n});\n\nconst validPartialURLParam = Match.Where((value) => {\n\tcheck(value, String);\n\n\tif (!isRelativeURL(value) && !isURL(value) && !value.startsWith(FileUpload.getPath())) {\n\t\tthrow new Error('Invalid href value provided');\n\t}\n\n\tif (/^javascript:/i.test(value)) {\n\t\tthrow new Error('Invalid href value provided');\n\t}\n\n\treturn true;\n});\n\nconst objectMaybeIncluding = (types) =>\n\tMatch.Where((value) => {\n\t\tObject.keys(types).forEach((field) => {\n\t\t\tif (value[field] != null) {\n\t\t\t\ttry {\n\t\t\t\t\tcheck(value[field], types[field]);\n\t\t\t\t} catch (error) {\n\t\t\t\t\terror.path = field;\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn true;\n\t});\n\nconst validateAttachmentsFields = (attachmentField) => {\n\tcheck(\n\t\tattachmentField,\n\t\tobjectMaybeIncluding({\n\t\t\tshort: Boolean,\n\t\t\ttitle: String,\n\t\t\tvalue: Match.OneOf(String, Number, Boolean),\n\t\t}),\n\t);\n\n\tif (typeof attachmentField.value !== 'undefined') {\n\t\tattachmentField.value = String(attachmentField.value);\n\t}\n};\n\nconst validateAttachmentsActions = (attachmentActions) => {\n\tcheck(\n\t\tattachmentActions,\n\t\tobjectMaybeIncluding({\n\t\t\ttype: String,\n\t\t\ttext: String,\n\t\t\turl: validFullURLParam,\n\t\t\timage_url: validFullURLParam,\n\t\t\tis_webview: Boolean,\n\t\t\twebview_height_ratio: String,\n\t\t\tmsg: String,\n\t\t\tmsg_in_chat_window: Boolean,\n\t\t}),\n\t);\n};\n\nconst validateAttachment = (attachment) => {\n\tcheck(\n\t\tattachment,\n\t\tobjectMaybeIncluding({\n\t\t\tcolor: String,\n\t\t\ttext: String,\n\t\t\tts: Match.OneOf(String, Number),\n\t\t\tthumb_url: validFullURLParam,\n\t\t\tbutton_alignment: String,\n\t\t\tactions: [Match.Any],\n\t\t\tmessage_link: validFullURLParam,\n\t\t\tcollapsed: Boolean,\n\t\t\tauthor_name: String,\n\t\t\tauthor_link: validFullURLParam,\n\t\t\tauthor_icon: validFullURLParam,\n\t\t\ttitle: String,\n\t\t\ttitle_link: validFullURLParam,\n\t\t\ttitle_link_download: Boolean,\n\t\t\timage_dimensions: Object,\n\t\t\timage_url: validFullURLParam,\n\t\t\timage_preview: String,\n\t\t\timage_type: String,\n\t\t\timage_size: Number,\n\t\t\taudio_url: validFullURLParam,\n\t\t\taudio_type: String,\n\t\t\taudio_size: Number,\n\t\t\tvideo_url: validFullURLParam,\n\t\t\tvideo_type: String,\n\t\t\tvideo_size: Number,\n\t\t\tfields: [Match.Any],\n\t\t}),\n\t);\n\n\tif (attachment.fields && attachment.fields.length) {\n\t\tattachment.fields.map(validateAttachmentsFields);\n\t}\n\n\tif (attachment.actions && attachment.actions.length) {\n\t\tattachment.actions.map(validateAttachmentsActions);\n\t}\n};\n\nconst validateBodyAttachments = (attachments) => attachments.map(validateAttachment);\n\nexport const validateMessage = (message, room, user) => {\n\tcheck(\n\t\tmessage,\n\t\tobjectMaybeIncluding({\n\t\t\t_id: String,\n\t\t\tmsg: String,\n\t\t\ttext: String,\n\t\t\talias: String,\n\t\t\temoji: String,\n\t\t\ttmid: String,\n\t\t\ttshow: Boolean,\n\t\t\tavatar: validPartialURLParam,\n\t\t\tattachments: [Match.Any],\n\t\t\tblocks: [Match.Any],\n\t\t}),\n\t);\n\n\tif (message.alias || message.avatar) {\n\t\tconst isLiveChatGuest = !message.avatar && user.token && user.token === room.v?.token;\n\n\t\tif (!isLiveChatGuest && !hasPermission(user._id, 'message-impersonate', room._id)) {\n\t\t\tthrow new Error('Not enough permission');\n\t\t}\n\t}\n\n\tif (Array.isArray(message.attachments) && message.attachments.length) {\n\t\tvalidateBodyAttachments(message.attachments);\n\t}\n};\n\nexport const prepareMessageObject = function (message, rid, user) {\n\tif (!message.ts) {\n\t\tmessage.ts = new Date();\n\t}\n\n\tif (message.tshow !== true) {\n\t\tdelete message.tshow;\n\t}\n\n\tconst { _id, username, name } = user;\n\tmessage.u = {\n\t\t_id,\n\t\tusername,\n\t\tname,\n\t};\n\tmessage.rid = rid;\n\n\tif (!Match.test(message.msg, String)) {\n\t\tmessage.msg = '';\n\t}\n\n\tif (message.ts == null) {\n\t\tmessage.ts = new Date();\n\t}\n};\n\n/**\n * Clean up the message object before saving on db\n * @param {IMessage} message\n */\nfunction cleanupMessageObject(message) {\n\t['customClass'].forEach((field) => delete message[field]);\n}\n\nexport const sendMessage = function (user, message, room, upsert = false) {\n\tif (!user || !message || !room._id) {\n\t\treturn false;\n\t}\n\n\tvalidateMessage(message, room, user);\n\tprepareMessageObject(message, room._id, user);\n\n\tif (settings.get('Message_Read_Receipt_Enabled')) {\n\t\tmessage.unread = true;\n\t}\n\n\t// For the Rocket.Chat Apps :)\n\tif (Apps && Apps.isLoaded()) {\n\t\tconst prevent = Promise.await(Apps.getBridges().getListenerBridge().messageEvent('IPreMessageSentPrevent', message));\n\t\tif (prevent) {\n\t\t\tif (settings.get('Apps_Framework_Development_Mode')) {\n\t\t\t\tSystemLogger.info({ msg: 'A Rocket.Chat App prevented the message sending.', message });\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tlet result;\n\t\tresult = Promise.await(Apps.getBridges().getListenerBridge().messageEvent('IPreMessageSentExtend', message));\n\t\tresult = Promise.await(Apps.getBridges().getListenerBridge().messageEvent('IPreMessageSentModify', result));\n\n\t\tif (typeof result === 'object') {\n\t\t\tmessage = Object.assign(message, result);\n\n\t\t\t// Some app may have inserted malicious/invalid values in the message, let's check it again\n\t\t\tvalidateMessage(message, room, user);\n\t\t}\n\t}\n\n\tcleanupMessageObject(message);\n\n\tparseUrlsInMessage(message);\n\n\tmessage = callbacks.run('beforeSaveMessage', message, room);\n\ttry {\n\t\tif (message.msg && DISABLE_MESSAGE_PARSER !== 'true') {\n\t\t\tmessage.md = parser(message.msg);\n\t\t}\n\t} catch (e) {\n\t\tSystemLogger.error(e); // errors logged while the parser is at experimental stage\n\t}\n\tif (message) {\n\t\tif (message._id && upsert) {\n\t\t\tconst { _id } = message;\n\t\t\tdelete message._id;\n\t\t\tMessages.upsert(\n\t\t\t\t{\n\t\t\t\t\t_id,\n\t\t\t\t\t'u._id': message.u._id,\n\t\t\t\t},\n\t\t\t\tmessage,\n\t\t\t);\n\t\t\tmessage._id = _id;\n\t\t} else {\n\t\t\tconst messageAlreadyExists = message._id && Messages.findOneById(message._id, { fields: { _id: 1 } });\n\t\t\tif (messageAlreadyExists) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmessage._id = Messages.insert(message);\n\t\t}\n\n\t\tif (Apps && Apps.isLoaded()) {\n\t\t\t// This returns a promise, but it won't mutate anything about the message\n\t\t\t// so, we don't really care if it is successful or fails\n\t\t\tApps.getBridges().getListenerBridge().messageEvent('IPostMessageSent', message);\n\t\t}\n\n\t\t/*\n\t\tDefer other updates as their return is not interesting to the user\n\t\t*/\n\t\t// Execute all callbacks\n\t\tcallbacks.runAsync('afterSaveMessage', message, room);\n\t\treturn message;\n\t}\n};\n"]},"sourceType":"module","hash":"6450a33094d6c107c2d7870d85bae5b12eeaaf55"}
