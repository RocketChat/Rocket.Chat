{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/api/server/v1/integrations.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/api/server/v1/integrations.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/api/server/v1/integrations.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/api/server/v1/integrations.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/api/server/v1/integrations.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 1);\nlet hasAtLeastOnePermission;\nmodule.link(\"../../../authorization/server\", {\n  hasAtLeastOnePermission(v) {\n    hasAtLeastOnePermission = v;\n  }\n\n}, 2);\nlet Integrations, IntegrationHistory;\nmodule.link(\"../../../models/server/raw\", {\n  Integrations(v) {\n    Integrations = v;\n  },\n\n  IntegrationHistory(v) {\n    IntegrationHistory = v;\n  }\n\n}, 3);\nlet API;\nmodule.link(\"../api\", {\n  API(v) {\n    API = v;\n  }\n\n}, 4);\nlet mountIntegrationHistoryQueryBasedOnPermissions, mountIntegrationQueryBasedOnPermissions;\nmodule.link(\"../../../integrations/server/lib/mountQueriesBasedOnPermission\", {\n  mountIntegrationHistoryQueryBasedOnPermissions(v) {\n    mountIntegrationHistoryQueryBasedOnPermissions = v;\n  },\n\n  mountIntegrationQueryBasedOnPermissions(v) {\n    mountIntegrationQueryBasedOnPermissions = v;\n  }\n\n}, 5);\nlet findOneIntegration;\nmodule.link(\"../lib/integrations\", {\n  findOneIntegration(v) {\n    findOneIntegration = v;\n  }\n\n}, 6);\nAPI.v1.addRoute('integrations.create', {\n  authRequired: true\n}, {\n  post() {\n    check(this.bodyParams, Match.ObjectIncluding({\n      type: String,\n      name: String,\n      enabled: Boolean,\n      username: String,\n      urls: Match.Maybe([String]),\n      channel: String,\n      event: Match.Maybe(String),\n      triggerWords: Match.Maybe([String]),\n      alias: Match.Maybe(String),\n      avatar: Match.Maybe(String),\n      emoji: Match.Maybe(String),\n      token: Match.Maybe(String),\n      scriptEnabled: Boolean,\n      script: Match.Maybe(String),\n      targetChannel: Match.Maybe(String)\n    }));\n    let integration;\n\n    switch (this.bodyParams.type) {\n      case 'webhook-outgoing':\n        Meteor.runAsUser(this.userId, () => {\n          integration = Meteor.call('addOutgoingIntegration', this.bodyParams);\n        });\n        break;\n\n      case 'webhook-incoming':\n        Meteor.runAsUser(this.userId, () => {\n          integration = Meteor.call('addIncomingIntegration', this.bodyParams);\n        });\n        break;\n\n      default:\n        return API.v1.failure('Invalid integration type.');\n    }\n\n    return API.v1.success({\n      integration\n    });\n  }\n\n});\nAPI.v1.addRoute('integrations.history', {\n  authRequired: true\n}, {\n  get() {\n    if (!hasAtLeastOnePermission(this.userId, ['manage-outgoing-integrations', 'manage-own-outgoing-integrations'])) {\n      return API.v1.unauthorized();\n    }\n\n    if (!this.queryParams.id || this.queryParams.id.trim() === '') {\n      return API.v1.failure('Invalid integration id.');\n    }\n\n    const {\n      id\n    } = this.queryParams;\n    const {\n      offset,\n      count\n    } = this.getPaginationItems();\n    const {\n      sort,\n      fields: projection,\n      query\n    } = this.parseJsonQuery();\n    const ourQuery = Object.assign(mountIntegrationHistoryQueryBasedOnPermissions(this.userId, id), query);\n    const cursor = IntegrationHistory.find(ourQuery, {\n      sort: sort || {\n        _updatedAt: -1\n      },\n      skip: offset,\n      limit: count,\n      projection\n    });\n    const history = Promise.await(cursor.toArray());\n    const total = Promise.await(cursor.count());\n    return API.v1.success({\n      history,\n      offset,\n      items: history.length,\n      total\n    });\n  }\n\n});\nAPI.v1.addRoute('integrations.list', {\n  authRequired: true\n}, {\n  get() {\n    if (!hasAtLeastOnePermission(this.userId, ['manage-outgoing-integrations', 'manage-own-outgoing-integrations', 'manage-incoming-integrations', 'manage-own-incoming-integrations'])) {\n      return API.v1.unauthorized();\n    }\n\n    const {\n      offset,\n      count\n    } = this.getPaginationItems();\n    const {\n      sort,\n      fields: projection,\n      query\n    } = this.parseJsonQuery();\n    const ourQuery = Object.assign(mountIntegrationQueryBasedOnPermissions(this.userId), query);\n    const cursor = Integrations.find(ourQuery, {\n      sort: sort || {\n        ts: -1\n      },\n      skip: offset,\n      limit: count,\n      projection\n    });\n    const total = Promise.await(cursor.count());\n    const integrations = Promise.await(cursor.toArray());\n    return API.v1.success({\n      integrations,\n      offset,\n      items: integrations.length,\n      total\n    });\n  }\n\n});\nAPI.v1.addRoute('integrations.remove', {\n  authRequired: true\n}, {\n  post() {\n    if (!hasAtLeastOnePermission(this.userId, ['manage-outgoing-integrations', 'manage-own-outgoing-integrations', 'manage-incoming-integrations', 'manage-own-incoming-integrations'])) {\n      return API.v1.unauthorized();\n    }\n\n    check(this.bodyParams, Match.ObjectIncluding({\n      type: String,\n      target_url: Match.Maybe(String),\n      integrationId: Match.Maybe(String)\n    }));\n\n    if (!this.bodyParams.target_url && !this.bodyParams.integrationId) {\n      return API.v1.failure('An integrationId or target_url needs to be provided.');\n    }\n\n    let integration;\n\n    switch (this.bodyParams.type) {\n      case 'webhook-outgoing':\n        if (this.bodyParams.target_url) {\n          integration = Promise.await(Integrations.findOne({\n            urls: this.bodyParams.target_url\n          }));\n        } else if (this.bodyParams.integrationId) {\n          integration = Promise.await(Integrations.findOne({\n            _id: this.bodyParams.integrationId\n          }));\n        }\n\n        if (!integration) {\n          return API.v1.failure('No integration found.');\n        }\n\n        Meteor.runAsUser(this.userId, () => {\n          Meteor.call('deleteOutgoingIntegration', integration._id);\n        });\n        return API.v1.success({\n          integration\n        });\n\n      case 'webhook-incoming':\n        integration = Promise.await(Integrations.findOne({\n          _id: this.bodyParams.integrationId\n        }));\n\n        if (!integration) {\n          return API.v1.failure('No integration found.');\n        }\n\n        Meteor.runAsUser(this.userId, () => {\n          Meteor.call('deleteIncomingIntegration', integration._id);\n        });\n        return API.v1.success({\n          integration\n        });\n\n      default:\n        return API.v1.failure('Invalid integration type.');\n    }\n  }\n\n});\nAPI.v1.addRoute('integrations.get', {\n  authRequired: true\n}, {\n  get() {\n    const {\n      integrationId,\n      createdBy\n    } = this.queryParams;\n\n    if (!integrationId) {\n      return API.v1.failure('The query parameter \"integrationId\" is required.');\n    }\n\n    return API.v1.success({\n      integration: Promise.await(findOneIntegration({\n        userId: this.userId,\n        integrationId,\n        createdBy\n      }))\n    });\n  }\n\n});\nAPI.v1.addRoute('integrations.update', {\n  authRequired: true\n}, {\n  put() {\n    check(this.bodyParams, Match.ObjectIncluding({\n      type: String,\n      name: String,\n      enabled: Boolean,\n      username: String,\n      urls: Match.Maybe([String]),\n      channel: String,\n      event: Match.Maybe(String),\n      triggerWords: Match.Maybe([String]),\n      alias: Match.Maybe(String),\n      avatar: Match.Maybe(String),\n      emoji: Match.Maybe(String),\n      token: Match.Maybe(String),\n      scriptEnabled: Boolean,\n      script: Match.Maybe(String),\n      targetChannel: Match.Maybe(String),\n      integrationId: Match.Maybe(String),\n      target_url: Match.Maybe(String)\n    }));\n    let integration;\n\n    switch (this.bodyParams.type) {\n      case 'webhook-outgoing':\n        if (this.bodyParams.target_url) {\n          integration = Promise.await(Integrations.findOne({\n            urls: this.bodyParams.target_url\n          }));\n        } else if (this.bodyParams.integrationId) {\n          integration = Promise.await(Integrations.findOne({\n            _id: this.bodyParams.integrationId\n          }));\n        }\n\n        if (!integration) {\n          return API.v1.failure('No integration found.');\n        }\n\n        Meteor.call('updateOutgoingIntegration', integration._id, this.bodyParams);\n        return API.v1.success({\n          integration: Promise.await(Integrations.findOne({\n            _id: integration._id\n          }))\n        });\n\n      case 'webhook-incoming':\n        integration = Promise.await(Integrations.findOne({\n          _id: this.bodyParams.integrationId\n        }));\n\n        if (!integration) {\n          return API.v1.failure('No integration found.');\n        }\n\n        Meteor.call('updateIncomingIntegration', integration._id, this.bodyParams);\n        return API.v1.success({\n          integration: Promise.await(Integrations.findOne({\n            _id: integration._id\n          }))\n        });\n\n      default:\n        return API.v1.failure('Invalid integration type.');\n    }\n  }\n\n});","map":{"version":3,"sources":["app/api/server/v1/integrations.js"],"names":["Meteor","module","link","v","Match","check","hasAtLeastOnePermission","Integrations","IntegrationHistory","API","mountIntegrationHistoryQueryBasedOnPermissions","mountIntegrationQueryBasedOnPermissions","findOneIntegration","v1","addRoute","authRequired","post","bodyParams","ObjectIncluding","type","String","name","enabled","Boolean","username","urls","Maybe","channel","event","triggerWords","alias","avatar","emoji","token","scriptEnabled","script","targetChannel","integration","runAsUser","userId","call","failure","success","get","unauthorized","queryParams","id","trim","offset","count","getPaginationItems","sort","fields","projection","query","parseJsonQuery","ourQuery","Object","assign","cursor","find","_updatedAt","skip","limit","history","Promise","await","toArray","total","items","length","ts","integrations","target_url","integrationId","findOne","_id","createdBy","put"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\n\nimport { hasAtLeastOnePermission } from '../../../authorization/server';\nimport { Integrations, IntegrationHistory } from '../../../models/server/raw';\nimport { API } from '../api';\nimport {\n\tmountIntegrationHistoryQueryBasedOnPermissions,\n\tmountIntegrationQueryBasedOnPermissions,\n} from '../../../integrations/server/lib/mountQueriesBasedOnPermission';\nimport { findOneIntegration } from '../lib/integrations';\n\nAPI.v1.addRoute(\n\t'integrations.create',\n\t{ authRequired: true },\n\t{\n\t\tpost() {\n\t\t\tcheck(\n\t\t\t\tthis.bodyParams,\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\ttype: String,\n\t\t\t\t\tname: String,\n\t\t\t\t\tenabled: Boolean,\n\t\t\t\t\tusername: String,\n\t\t\t\t\turls: Match.Maybe([String]),\n\t\t\t\t\tchannel: String,\n\t\t\t\t\tevent: Match.Maybe(String),\n\t\t\t\t\ttriggerWords: Match.Maybe([String]),\n\t\t\t\t\talias: Match.Maybe(String),\n\t\t\t\t\tavatar: Match.Maybe(String),\n\t\t\t\t\temoji: Match.Maybe(String),\n\t\t\t\t\ttoken: Match.Maybe(String),\n\t\t\t\t\tscriptEnabled: Boolean,\n\t\t\t\t\tscript: Match.Maybe(String),\n\t\t\t\t\ttargetChannel: Match.Maybe(String),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tlet integration;\n\n\t\t\tswitch (this.bodyParams.type) {\n\t\t\t\tcase 'webhook-outgoing':\n\t\t\t\t\tMeteor.runAsUser(this.userId, () => {\n\t\t\t\t\t\tintegration = Meteor.call('addOutgoingIntegration', this.bodyParams);\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'webhook-incoming':\n\t\t\t\t\tMeteor.runAsUser(this.userId, () => {\n\t\t\t\t\t\tintegration = Meteor.call('addIncomingIntegration', this.bodyParams);\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\treturn API.v1.failure('Invalid integration type.');\n\t\t\t}\n\n\t\t\treturn API.v1.success({ integration });\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'integrations.history',\n\t{ authRequired: true },\n\t{\n\t\tget() {\n\t\t\tif (!hasAtLeastOnePermission(this.userId, ['manage-outgoing-integrations', 'manage-own-outgoing-integrations'])) {\n\t\t\t\treturn API.v1.unauthorized();\n\t\t\t}\n\n\t\t\tif (!this.queryParams.id || this.queryParams.id.trim() === '') {\n\t\t\t\treturn API.v1.failure('Invalid integration id.');\n\t\t\t}\n\n\t\t\tconst { id } = this.queryParams;\n\t\t\tconst { offset, count } = this.getPaginationItems();\n\t\t\tconst { sort, fields: projection, query } = this.parseJsonQuery();\n\t\t\tconst ourQuery = Object.assign(mountIntegrationHistoryQueryBasedOnPermissions(this.userId, id), query);\n\n\t\t\tconst cursor = IntegrationHistory.find(ourQuery, {\n\t\t\t\tsort: sort || { _updatedAt: -1 },\n\t\t\t\tskip: offset,\n\t\t\t\tlimit: count,\n\t\t\t\tprojection,\n\t\t\t});\n\n\t\t\tconst history = Promise.await(cursor.toArray());\n\t\t\tconst total = Promise.await(cursor.count());\n\n\t\t\treturn API.v1.success({\n\t\t\t\thistory,\n\t\t\t\toffset,\n\t\t\t\titems: history.length,\n\t\t\t\ttotal,\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'integrations.list',\n\t{ authRequired: true },\n\t{\n\t\tget() {\n\t\t\tif (\n\t\t\t\t!hasAtLeastOnePermission(this.userId, [\n\t\t\t\t\t'manage-outgoing-integrations',\n\t\t\t\t\t'manage-own-outgoing-integrations',\n\t\t\t\t\t'manage-incoming-integrations',\n\t\t\t\t\t'manage-own-incoming-integrations',\n\t\t\t\t])\n\t\t\t) {\n\t\t\t\treturn API.v1.unauthorized();\n\t\t\t}\n\n\t\t\tconst { offset, count } = this.getPaginationItems();\n\t\t\tconst { sort, fields: projection, query } = this.parseJsonQuery();\n\n\t\t\tconst ourQuery = Object.assign(mountIntegrationQueryBasedOnPermissions(this.userId), query);\n\t\t\tconst cursor = Integrations.find(ourQuery, {\n\t\t\t\tsort: sort || { ts: -1 },\n\t\t\t\tskip: offset,\n\t\t\t\tlimit: count,\n\t\t\t\tprojection,\n\t\t\t});\n\n\t\t\tconst total = Promise.await(cursor.count());\n\n\t\t\tconst integrations = Promise.await(cursor.toArray());\n\n\t\t\treturn API.v1.success({\n\t\t\t\tintegrations,\n\t\t\t\toffset,\n\t\t\t\titems: integrations.length,\n\t\t\t\ttotal,\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'integrations.remove',\n\t{ authRequired: true },\n\t{\n\t\tpost() {\n\t\t\tif (\n\t\t\t\t!hasAtLeastOnePermission(this.userId, [\n\t\t\t\t\t'manage-outgoing-integrations',\n\t\t\t\t\t'manage-own-outgoing-integrations',\n\t\t\t\t\t'manage-incoming-integrations',\n\t\t\t\t\t'manage-own-incoming-integrations',\n\t\t\t\t])\n\t\t\t) {\n\t\t\t\treturn API.v1.unauthorized();\n\t\t\t}\n\n\t\t\tcheck(\n\t\t\t\tthis.bodyParams,\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\ttype: String,\n\t\t\t\t\ttarget_url: Match.Maybe(String),\n\t\t\t\t\tintegrationId: Match.Maybe(String),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tif (!this.bodyParams.target_url && !this.bodyParams.integrationId) {\n\t\t\t\treturn API.v1.failure('An integrationId or target_url needs to be provided.');\n\t\t\t}\n\n\t\t\tlet integration;\n\t\t\tswitch (this.bodyParams.type) {\n\t\t\t\tcase 'webhook-outgoing':\n\t\t\t\t\tif (this.bodyParams.target_url) {\n\t\t\t\t\t\tintegration = Promise.await(Integrations.findOne({ urls: this.bodyParams.target_url }));\n\t\t\t\t\t} else if (this.bodyParams.integrationId) {\n\t\t\t\t\t\tintegration = Promise.await(Integrations.findOne({ _id: this.bodyParams.integrationId }));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!integration) {\n\t\t\t\t\t\treturn API.v1.failure('No integration found.');\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(this.userId, () => {\n\t\t\t\t\t\tMeteor.call('deleteOutgoingIntegration', integration._id);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tintegration,\n\t\t\t\t\t});\n\t\t\t\tcase 'webhook-incoming':\n\t\t\t\t\tintegration = Promise.await(Integrations.findOne({ _id: this.bodyParams.integrationId }));\n\n\t\t\t\t\tif (!integration) {\n\t\t\t\t\t\treturn API.v1.failure('No integration found.');\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.runAsUser(this.userId, () => {\n\t\t\t\t\t\tMeteor.call('deleteIncomingIntegration', integration._id);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tintegration,\n\t\t\t\t\t});\n\t\t\t\tdefault:\n\t\t\t\t\treturn API.v1.failure('Invalid integration type.');\n\t\t\t}\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'integrations.get',\n\t{ authRequired: true },\n\t{\n\t\tget() {\n\t\t\tconst { integrationId, createdBy } = this.queryParams;\n\t\t\tif (!integrationId) {\n\t\t\t\treturn API.v1.failure('The query parameter \"integrationId\" is required.');\n\t\t\t}\n\n\t\t\treturn API.v1.success({\n\t\t\t\tintegration: Promise.await(\n\t\t\t\t\tfindOneIntegration({\n\t\t\t\t\t\tuserId: this.userId,\n\t\t\t\t\t\tintegrationId,\n\t\t\t\t\t\tcreatedBy,\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t});\n\t\t},\n\t},\n);\n\nAPI.v1.addRoute(\n\t'integrations.update',\n\t{ authRequired: true },\n\t{\n\t\tput() {\n\t\t\tcheck(\n\t\t\t\tthis.bodyParams,\n\t\t\t\tMatch.ObjectIncluding({\n\t\t\t\t\ttype: String,\n\t\t\t\t\tname: String,\n\t\t\t\t\tenabled: Boolean,\n\t\t\t\t\tusername: String,\n\t\t\t\t\turls: Match.Maybe([String]),\n\t\t\t\t\tchannel: String,\n\t\t\t\t\tevent: Match.Maybe(String),\n\t\t\t\t\ttriggerWords: Match.Maybe([String]),\n\t\t\t\t\talias: Match.Maybe(String),\n\t\t\t\t\tavatar: Match.Maybe(String),\n\t\t\t\t\temoji: Match.Maybe(String),\n\t\t\t\t\ttoken: Match.Maybe(String),\n\t\t\t\t\tscriptEnabled: Boolean,\n\t\t\t\t\tscript: Match.Maybe(String),\n\t\t\t\t\ttargetChannel: Match.Maybe(String),\n\t\t\t\t\tintegrationId: Match.Maybe(String),\n\t\t\t\t\ttarget_url: Match.Maybe(String),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tlet integration;\n\t\t\tswitch (this.bodyParams.type) {\n\t\t\t\tcase 'webhook-outgoing':\n\t\t\t\t\tif (this.bodyParams.target_url) {\n\t\t\t\t\t\tintegration = Promise.await(Integrations.findOne({ urls: this.bodyParams.target_url }));\n\t\t\t\t\t} else if (this.bodyParams.integrationId) {\n\t\t\t\t\t\tintegration = Promise.await(Integrations.findOne({ _id: this.bodyParams.integrationId }));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!integration) {\n\t\t\t\t\t\treturn API.v1.failure('No integration found.');\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.call('updateOutgoingIntegration', integration._id, this.bodyParams);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tintegration: Promise.await(Integrations.findOne({ _id: integration._id })),\n\t\t\t\t\t});\n\t\t\t\tcase 'webhook-incoming':\n\t\t\t\t\tintegration = Promise.await(Integrations.findOne({ _id: this.bodyParams.integrationId }));\n\n\t\t\t\t\tif (!integration) {\n\t\t\t\t\t\treturn API.v1.failure('No integration found.');\n\t\t\t\t\t}\n\n\t\t\t\t\tMeteor.call('updateIncomingIntegration', integration._id, this.bodyParams);\n\n\t\t\t\t\treturn API.v1.success({\n\t\t\t\t\t\tintegration: Promise.await(Integrations.findOne({ _id: integration._id })),\n\t\t\t\t\t});\n\t\t\t\tdefault:\n\t\t\t\t\treturn API.v1.failure('Invalid integration type.');\n\t\t\t}\n\t\t},\n\t},\n);\n"]},"sourceType":"module","hash":"67ad3645fe09c90a8ac3f7434231bd32a854ab1f"}
