{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/integrations/server/api/api.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/integrations/server/api/api.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/integrations/server/api/api.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/integrations/server/api/api.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/integrations/server/api/api.js"}},"code":"let vm;\nmodule.link(\"vm\", {\n  default(v) {\n    vm = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet HTTP;\nmodule.link(\"meteor/http\", {\n  HTTP(v) {\n    HTTP = v;\n  }\n\n}, 2);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 3);\nlet Livechat;\nmodule.link(\"meteor/rocketchat:livechat\", {\n  Livechat(v) {\n    Livechat = v;\n  }\n\n}, 4);\nlet Fiber;\nmodule.link(\"fibers\", {\n  default(v) {\n    Fiber = v;\n  }\n\n}, 5);\nlet Future;\nmodule.link(\"fibers/future\", {\n  default(v) {\n    Future = v;\n  }\n\n}, 6);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 7);\nlet s;\nmodule.link(\"underscore.string\", {\n  default(v) {\n    s = v;\n  }\n\n}, 8);\nlet moment;\nmodule.link(\"moment\", {\n  default(v) {\n    moment = v;\n  }\n\n}, 9);\nlet incomingLogger;\nmodule.link(\"../logger\", {\n  incomingLogger(v) {\n    incomingLogger = v;\n  }\n\n}, 10);\nlet processWebhookMessage;\nmodule.link(\"../../../lib/server\", {\n  processWebhookMessage(v) {\n    processWebhookMessage = v;\n  }\n\n}, 11);\nlet API, APIClass, defaultRateLimiterOptions;\nmodule.link(\"../../../api/server\", {\n  API(v) {\n    API = v;\n  },\n\n  APIClass(v) {\n    APIClass = v;\n  },\n\n  defaultRateLimiterOptions(v) {\n    defaultRateLimiterOptions = v;\n  }\n\n}, 12);\nlet Models;\nmodule.link(\"../../../models/server\", {\n  \"*\"(v) {\n    Models = v;\n  }\n\n}, 13);\nlet Integrations;\nmodule.link(\"../../../models/server/raw\", {\n  Integrations(v) {\n    Integrations = v;\n  }\n\n}, 14);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 15);\nconst compiledScripts = {};\n\nfunction buildSandbox() {\n  let store = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  const sandbox = {\n    scriptTimeout(reject) {\n      return setTimeout(() => reject('timed out'), 3000);\n    },\n\n    _,\n    s,\n    console,\n    moment,\n    Fiber,\n    Promise,\n    Livechat,\n    Store: {\n      set(key, val) {\n        store[key] = val;\n        return val;\n      },\n\n      get(key) {\n        return store[key];\n      }\n\n    },\n\n    HTTP(method, url, options) {\n      try {\n        return {\n          result: HTTP.call(method, url, options)\n        };\n      } catch (error) {\n        return {\n          error\n        };\n      }\n    }\n\n  };\n  Object.keys(Models).filter(k => !k.startsWith('_')).forEach(k => {\n    sandbox[k] = Models[k];\n  });\n  return {\n    store,\n    sandbox\n  };\n}\n\nfunction getIntegrationScript(integration) {\n  const compiledScript = compiledScripts[integration._id];\n\n  if (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n    return compiledScript.script;\n  }\n\n  const script = integration.scriptCompiled;\n  const {\n    sandbox,\n    store\n  } = buildSandbox();\n\n  try {\n    incomingLogger.info({\n      msg: 'Will evaluate script of Trigger',\n      name: integration.name\n    });\n    incomingLogger.debug(script);\n    const vmScript = vm.createScript(script, 'script.js');\n    vmScript.runInNewContext(sandbox);\n\n    if (sandbox.Script) {\n      compiledScripts[integration._id] = {\n        script: new sandbox.Script(),\n        store,\n        _updatedAt: integration._updatedAt\n      };\n      return compiledScripts[integration._id].script;\n    }\n  } catch (err) {\n    incomingLogger.error({\n      msg: 'Error evaluating Script in Trigger',\n      name: integration.name,\n      script,\n      err\n    });\n    throw API.v1.failure('error-evaluating-script');\n  }\n\n  if (!sandbox.Script) {\n    incomingLogger.error({\n      msg: 'Class \"Script\" not in Trigger',\n      name: integration.name\n    });\n    throw API.v1.failure('class-script-not-found');\n  }\n}\n\nfunction createIntegration(options, user) {\n  incomingLogger.info({\n    msg: 'Add integration',\n    name: options.name\n  });\n  incomingLogger.debug(options);\n  Meteor.runAsUser(user._id, function () {\n    switch (options.event) {\n      case 'newMessageOnChannel':\n        if (options.data == null) {\n          options.data = {};\n        }\n\n        if (options.data.channel_name != null && options.data.channel_name.indexOf('#') === -1) {\n          options.data.channel_name = \"#\".concat(options.data.channel_name);\n        }\n\n        return Meteor.call('addOutgoingIntegration', {\n          username: 'rocket.cat',\n          urls: [options.target_url],\n          name: options.name,\n          channel: options.data.channel_name,\n          triggerWords: options.data.trigger_words\n        });\n\n      case 'newMessageToUser':\n        if (options.data.username.indexOf('@') === -1) {\n          options.data.username = \"@\".concat(options.data.username);\n        }\n\n        return Meteor.call('addOutgoingIntegration', {\n          username: 'rocket.cat',\n          urls: [options.target_url],\n          name: options.name,\n          channel: options.data.username,\n          triggerWords: options.data.trigger_words\n        });\n    }\n  });\n  return API.v1.success();\n}\n\nfunction removeIntegration(options, user) {\n  incomingLogger.info('Remove integration');\n  incomingLogger.debug(options);\n  const integrationToRemove = Promise.await(Integrations.findOneByUrl(options.target_url));\n\n  if (!integrationToRemove) {\n    return API.v1.failure('integration-not-found');\n  }\n\n  Meteor.runAsUser(user._id, () => Meteor.call('deleteOutgoingIntegration', integrationToRemove._id));\n  return API.v1.success();\n}\n\nfunction executeIntegrationRest() {\n  incomingLogger.info({\n    msg: 'Post integration:',\n    name: this.integration.name\n  });\n  incomingLogger.debug({\n    urlParams: this.urlParams,\n    bodyParams: this.bodyParams\n  });\n\n  if (this.integration.enabled !== true) {\n    return {\n      statusCode: 503,\n      body: 'Service Unavailable'\n    };\n  }\n\n  const defaultValues = {\n    channel: this.integration.channel,\n    alias: this.integration.alias,\n    avatar: this.integration.avatar,\n    emoji: this.integration.emoji\n  };\n\n  if (this.integration.scriptEnabled && this.integration.scriptCompiled && this.integration.scriptCompiled.trim() !== '') {\n    let script;\n\n    try {\n      script = getIntegrationScript(this.integration);\n    } catch (e) {\n      incomingLogger.error(e);\n      return API.v1.failure(e.message);\n    }\n\n    this.request.setEncoding('utf8');\n    const content_raw = this.request.read();\n    const request = {\n      url: {\n        hash: this.request._parsedUrl.hash,\n        search: this.request._parsedUrl.search,\n        query: this.queryParams,\n        pathname: this.request._parsedUrl.pathname,\n        path: this.request._parsedUrl.path\n      },\n      url_raw: this.request.url,\n      url_params: this.urlParams,\n      content: this.bodyParams,\n      content_raw,\n      headers: this.request.headers,\n      body: this.request.body,\n      user: {\n        _id: this.user._id,\n        name: this.user.name,\n        username: this.user.username\n      }\n    };\n\n    try {\n      const {\n        sandbox\n      } = buildSandbox(compiledScripts[this.integration._id].store);\n      sandbox.script = script;\n      sandbox.request = request;\n      const result = Future.fromPromise(vm.runInNewContext(\"\\n\\t\\t\\t\\tnew Promise((resolve, reject) => {\\n\\t\\t\\t\\t\\tFiber(() => {\\n\\t\\t\\t\\t\\t\\tscriptTimeout(reject);\\n\\t\\t\\t\\t\\t\\ttry {\\n\\t\\t\\t\\t\\t\\t\\tresolve(script.process_incoming_request({ request: request }));\\n\\t\\t\\t\\t\\t\\t} catch(e) {\\n\\t\\t\\t\\t\\t\\t\\treject(e);\\n\\t\\t\\t\\t\\t\\t}\\n\\t\\t\\t\\t\\t}).run();\\n\\t\\t\\t\\t}).catch((error) => { throw new Error(error); });\\n\\t\\t\\t\", sandbox, {\n        timeout: 3000\n      })).wait();\n\n      if (!result) {\n        incomingLogger.debug({\n          msg: 'Process Incoming Request result of Trigger has no data',\n          name: this.integration.name\n        });\n        return API.v1.success();\n      }\n\n      if (result && result.error) {\n        return API.v1.failure(result.error);\n      }\n\n      this.bodyParams = result && result.content;\n      this.scriptResponse = result.response;\n\n      if (result.user) {\n        this.user = result.user;\n      }\n\n      incomingLogger.debug({\n        msg: 'Process Incoming Request result of Trigger',\n        name: this.integration.name,\n        result: this.bodyParams\n      });\n    } catch (err) {\n      incomingLogger.error({\n        msg: 'Error running Script in Trigger',\n        name: this.integration.name,\n        script: this.integration.scriptCompiled,\n        err\n      });\n      return API.v1.failure('error-running-script');\n    }\n  } // TODO: Turn this into an option on the integrations - no body means a success\n  // TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n\n\n  if (!this.bodyParams || _.isEmpty(this.bodyParams) && !this.integration.scriptEnabled) {\n    // return RocketChat.API.v1.failure('body-empty');\n    return API.v1.success();\n  }\n\n  this.bodyParams.bot = {\n    i: this.integration._id\n  };\n\n  try {\n    const message = processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\n    if (_.isEmpty(message)) {\n      return API.v1.failure('unknown-error');\n    }\n\n    if (this.scriptResponse) {\n      incomingLogger.debug({\n        msg: 'response',\n        response: this.scriptResponse\n      });\n    }\n\n    return API.v1.success(this.scriptResponse);\n  } catch ({\n    error,\n    message\n  }) {\n    return API.v1.failure(error || message);\n  }\n}\n\nfunction addIntegrationRest() {\n  return createIntegration(this.bodyParams, this.user);\n}\n\nfunction removeIntegrationRest() {\n  return removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n  incomingLogger.info('Sample Integration');\n  return {\n    statusCode: 200,\n    body: [{\n      token: Random.id(24),\n      channel_id: Random.id(),\n      channel_name: 'general',\n      timestamp: new Date(),\n      user_id: Random.id(),\n      user_name: 'rocket.cat',\n      text: 'Sample text 1',\n      trigger_word: 'Sample'\n    }, {\n      token: Random.id(24),\n      channel_id: Random.id(),\n      channel_name: 'general',\n      timestamp: new Date(),\n      user_id: Random.id(),\n      user_name: 'rocket.cat',\n      text: 'Sample text 2',\n      trigger_word: 'Sample'\n    }, {\n      token: Random.id(24),\n      channel_id: Random.id(),\n      channel_name: 'general',\n      timestamp: new Date(),\n      user_id: Random.id(),\n      user_name: 'rocket.cat',\n      text: 'Sample text 3',\n      trigger_word: 'Sample'\n    }]\n  };\n}\n\nfunction integrationInfoRest() {\n  incomingLogger.info('Info integration');\n  return {\n    statusCode: 200,\n    body: {\n      success: true\n    }\n  };\n}\n\nclass WebHookAPI extends APIClass {\n  /* Webhooks are not versioned, so we must not validate we know a version before adding a rate limiter */\n  shouldAddRateLimitToRoute(options) {\n    const {\n      rateLimiterOptions\n    } = options;\n    return (typeof rateLimiterOptions === 'object' || rateLimiterOptions === undefined) && !process.env.TEST_MODE && Boolean(defaultRateLimiterOptions.numRequestsAllowed && defaultRateLimiterOptions.intervalTimeInMS);\n  }\n\n  shouldVerifyRateLimit() {\n    return settings.get('API_Enable_Rate_Limiter') === true && (process.env.NODE_ENV !== 'development' || settings.get('API_Enable_Rate_Limiter_Dev') === true);\n  }\n  /*\n  There is only one generic route propagated to Restivus which has URL-path-parameters for the integration and the token.\n  Since the rate-limiter operates on absolute routes, we need to add a limiter to the absolute url before we can validate it\n  */\n\n\n  enforceRateLimit(objectForRateLimitMatch, request, response, userId) {\n    const {\n      method,\n      url\n    } = request;\n    const route = url.replace(\"/\".concat(this.apiPath), '');\n    const nameRoute = this.getFullRouteName(route, [method.toLowerCase()]); // We'll be creating rate limiters on demand (when validating for the first time).\n    // This is possible since *all* integration hooks should be rate limited the same way.\n    // This way, we'll not have to add new limiters as new integrations are added\n\n    if (!this.getRateLimiter(nameRoute)) {\n      this.addRateLimiterRuleForRoutes({\n        routes: [route],\n        rateLimiterOptions: defaultRateLimiterOptions,\n        endpoints: {\n          post: executeIntegrationRest,\n          get: executeIntegrationRest\n        }\n      });\n    }\n\n    const integrationForRateLimitMatch = objectForRateLimitMatch;\n    integrationForRateLimitMatch.route = nameRoute;\n    super.enforceRateLimit(integrationForRateLimitMatch, request, response, userId);\n  }\n\n}\n\nconst Api = new WebHookAPI({\n  enableCors: true,\n  apiPath: 'hooks/',\n  auth: {\n    user() {\n      const payloadKeys = Object.keys(this.bodyParams);\n      const payloadIsWrapped = this.bodyParams && this.bodyParams.payload && payloadKeys.length === 1;\n\n      if (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n        try {\n          this.bodyParams = JSON.parse(this.bodyParams.payload);\n        } catch ({\n          message\n        }) {\n          return {\n            error: {\n              statusCode: 400,\n              body: {\n                success: false,\n                error: message\n              }\n            }\n          };\n        }\n      }\n\n      this.integration = Promise.await(Integrations.findOne({\n        _id: this.request.params.integrationId,\n        token: decodeURIComponent(this.request.params.token)\n      }));\n\n      if (!this.integration) {\n        incomingLogger.info(\"Invalid integration id \".concat(this.request.params.integrationId, \" or token \").concat(this.request.params.token));\n        return {\n          error: {\n            statusCode: 404,\n            body: {\n              success: false,\n              error: 'Invalid integration id or token provided.'\n            }\n          }\n        };\n      }\n\n      const user = Models.Users.findOne({\n        _id: this.integration.userId\n      });\n      return {\n        user\n      };\n    }\n\n  }\n});\nApi.addRoute(':integrationId/:userId/:token', {\n  authRequired: true\n}, {\n  post: executeIntegrationRest,\n  get: executeIntegrationRest\n});\nApi.addRoute(':integrationId/:token', {\n  authRequired: true\n}, {\n  post: executeIntegrationRest,\n  get: executeIntegrationRest\n});\nApi.addRoute('sample/:integrationId/:userId/:token', {\n  authRequired: true\n}, {\n  get: integrationSampleRest\n});\nApi.addRoute('sample/:integrationId/:token', {\n  authRequired: true\n}, {\n  get: integrationSampleRest\n});\nApi.addRoute('info/:integrationId/:userId/:token', {\n  authRequired: true\n}, {\n  get: integrationInfoRest\n});\nApi.addRoute('info/:integrationId/:token', {\n  authRequired: true\n}, {\n  get: integrationInfoRest\n});\nApi.addRoute('add/:integrationId/:userId/:token', {\n  authRequired: true\n}, {\n  post: addIntegrationRest\n});\nApi.addRoute('add/:integrationId/:token', {\n  authRequired: true\n}, {\n  post: addIntegrationRest\n});\nApi.addRoute('remove/:integrationId/:userId/:token', {\n  authRequired: true\n}, {\n  post: removeIntegrationRest\n});\nApi.addRoute('remove/:integrationId/:token', {\n  authRequired: true\n}, {\n  post: removeIntegrationRest\n});","map":{"version":3,"sources":["app/integrations/server/api/api.js"],"names":["vm","module","link","default","v","Meteor","HTTP","Random","Livechat","Fiber","Future","_","s","moment","incomingLogger","processWebhookMessage","API","APIClass","defaultRateLimiterOptions","Models","Integrations","settings","compiledScripts","buildSandbox","store","sandbox","scriptTimeout","reject","setTimeout","console","Promise","Store","set","key","val","get","method","url","options","result","call","error","Object","keys","filter","k","startsWith","forEach","getIntegrationScript","integration","compiledScript","_id","_updatedAt","script","scriptCompiled","info","msg","name","debug","vmScript","createScript","runInNewContext","Script","err","v1","failure","createIntegration","user","runAsUser","event","data","channel_name","indexOf","username","urls","target_url","channel","triggerWords","trigger_words","success","removeIntegration","integrationToRemove","await","findOneByUrl","executeIntegrationRest","urlParams","bodyParams","enabled","statusCode","body","defaultValues","alias","avatar","emoji","scriptEnabled","trim","e","message","request","setEncoding","content_raw","read","hash","_parsedUrl","search","query","queryParams","pathname","path","url_raw","url_params","content","headers","fromPromise","timeout","wait","scriptResponse","response","isEmpty","bot","i","addIntegrationRest","removeIntegrationRest","integrationSampleRest","token","id","channel_id","timestamp","Date","user_id","user_name","text","trigger_word","integrationInfoRest","WebHookAPI","shouldAddRateLimitToRoute","rateLimiterOptions","undefined","process","env","TEST_MODE","Boolean","numRequestsAllowed","intervalTimeInMS","shouldVerifyRateLimit","NODE_ENV","enforceRateLimit","objectForRateLimitMatch","userId","route","replace","apiPath","nameRoute","getFullRouteName","toLowerCase","getRateLimiter","addRateLimiterRuleForRoutes","routes","endpoints","post","integrationForRateLimitMatch","Api","enableCors","auth","payloadKeys","payloadIsWrapped","payload","length","JSON","parse","findOne","params","integrationId","decodeURIComponent","Users","addRoute","authRequired"],"mappings":"AAAA,IAAIA,EAAJ;AAAOC,MAAM,CAACC,IAAP,CAAY,IAAZ,EAAiB;AAACC,EAAAA,OAAO,CAACC,CAAD,EAAG;AAACJ,IAAAA,EAAE,GAACI,CAAH;AAAK;;AAAjB,CAAjB,EAAoC,CAApC;AAAuC,IAAIC,MAAJ;AAAWJ,MAAM,CAACC,IAAP,CAAY,eAAZ,EAA4B;AAACG,EAAAA,MAAM,CAACD,CAAD,EAAG;AAACC,IAAAA,MAAM,GAACD,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIE,IAAJ;AAASL,MAAM,CAACC,IAAP,CAAY,aAAZ,EAA0B;AAACI,EAAAA,IAAI,CAACF,CAAD,EAAG;AAACE,IAAAA,IAAI,GAACF,CAAL;AAAO;;AAAhB,CAA1B,EAA4C,CAA5C;AAA+C,IAAIG,MAAJ;AAAWN,MAAM,CAACC,IAAP,CAAY,eAAZ,EAA4B;AAACK,EAAAA,MAAM,CAACH,CAAD,EAAG;AAACG,IAAAA,MAAM,GAACH,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAII,QAAJ;AAAaP,MAAM,CAACC,IAAP,CAAY,4BAAZ,EAAyC;AAACM,EAAAA,QAAQ,CAACJ,CAAD,EAAG;AAACI,IAAAA,QAAQ,GAACJ,CAAT;AAAW;;AAAxB,CAAzC,EAAmE,CAAnE;AAAsE,IAAIK,KAAJ;AAAUR,MAAM,CAACC,IAAP,CAAY,QAAZ,EAAqB;AAACC,EAAAA,OAAO,CAACC,CAAD,EAAG;AAACK,IAAAA,KAAK,GAACL,CAAN;AAAQ;;AAApB,CAArB,EAA2C,CAA3C;AAA8C,IAAIM,MAAJ;AAAWT,MAAM,CAACC,IAAP,CAAY,eAAZ,EAA4B;AAACC,EAAAA,OAAO,CAACC,CAAD,EAAG;AAACM,IAAAA,MAAM,GAACN,CAAP;AAAS;;AAArB,CAA5B,EAAmD,CAAnD;;AAAsD,IAAIO,CAAJ;;AAAMV,MAAM,CAACC,IAAP,CAAY,YAAZ,EAAyB;AAACC,EAAAA,OAAO,CAACC,CAAD,EAAG;AAACO,IAAAA,CAAC,GAACP,CAAF;AAAI;;AAAhB,CAAzB,EAA2C,CAA3C;AAA8C,IAAIQ,CAAJ;AAAMX,MAAM,CAACC,IAAP,CAAY,mBAAZ,EAAgC;AAACC,EAAAA,OAAO,CAACC,CAAD,EAAG;AAACQ,IAAAA,CAAC,GAACR,CAAF;AAAI;;AAAhB,CAAhC,EAAkD,CAAlD;AAAqD,IAAIS,MAAJ;AAAWZ,MAAM,CAACC,IAAP,CAAY,QAAZ,EAAqB;AAACC,EAAAA,OAAO,CAACC,CAAD,EAAG;AAACS,IAAAA,MAAM,GAACT,CAAP;AAAS;;AAArB,CAArB,EAA4C,CAA5C;AAA+C,IAAIU,cAAJ;AAAmBb,MAAM,CAACC,IAAP,CAAY,WAAZ,EAAwB;AAACY,EAAAA,cAAc,CAACV,CAAD,EAAG;AAACU,IAAAA,cAAc,GAACV,CAAf;AAAiB;;AAApC,CAAxB,EAA8D,EAA9D;AAAkE,IAAIW,qBAAJ;AAA0Bd,MAAM,CAACC,IAAP,CAAY,qBAAZ,EAAkC;AAACa,EAAAA,qBAAqB,CAACX,CAAD,EAAG;AAACW,IAAAA,qBAAqB,GAACX,CAAtB;AAAwB;;AAAlD,CAAlC,EAAsF,EAAtF;AAA0F,IAAIY,GAAJ,EAAQC,QAAR,EAAiBC,yBAAjB;AAA2CjB,MAAM,CAACC,IAAP,CAAY,qBAAZ,EAAkC;AAACc,EAAAA,GAAG,CAACZ,CAAD,EAAG;AAACY,IAAAA,GAAG,GAACZ,CAAJ;AAAM,GAAd;;AAAea,EAAAA,QAAQ,CAACb,CAAD,EAAG;AAACa,IAAAA,QAAQ,GAACb,CAAT;AAAW,GAAtC;;AAAuCc,EAAAA,yBAAyB,CAACd,CAAD,EAAG;AAACc,IAAAA,yBAAyB,GAACd,CAA1B;AAA4B;;AAAhG,CAAlC,EAAoI,EAApI;AAAwI,IAAIe,MAAJ;AAAWlB,MAAM,CAACC,IAAP,CAAY,wBAAZ,EAAqC;AAAC,MAAIE,CAAJ,EAAM;AAACe,IAAAA,MAAM,GAACf,CAAP;AAAS;;AAAjB,CAArC,EAAwD,EAAxD;AAA4D,IAAIgB,YAAJ;AAAiBnB,MAAM,CAACC,IAAP,CAAY,4BAAZ,EAAyC;AAACkB,EAAAA,YAAY,CAAChB,CAAD,EAAG;AAACgB,IAAAA,YAAY,GAAChB,CAAb;AAAe;;AAAhC,CAAzC,EAA2E,EAA3E;AAA+E,IAAIiB,QAAJ;AAAapB,MAAM,CAACC,IAAP,CAAY,0BAAZ,EAAuC;AAACmB,EAAAA,QAAQ,CAACjB,CAAD,EAAG;AAACiB,IAAAA,QAAQ,GAACjB,CAAT;AAAW;;AAAxB,CAAvC,EAAiE,EAAjE;AAmB3oC,MAAMkB,eAAe,GAAG,EAAxB;;AACA,SAASC,YAAT,GAAkC;AAAA,MAAZC,KAAY,uEAAJ,EAAI;AACjC,QAAMC,OAAO,GAAG;AACfC,IAAAA,aAAa,CAACC,MAAD,EAAS;AACrB,aAAOC,UAAU,CAAC,MAAMD,MAAM,CAAC,WAAD,CAAb,EAA4B,IAA5B,CAAjB;AACA,KAHc;;AAIfhB,IAAAA,CAJe;AAKfC,IAAAA,CALe;AAMfiB,IAAAA,OANe;AAOfhB,IAAAA,MAPe;AAQfJ,IAAAA,KARe;AASfqB,IAAAA,OATe;AAUftB,IAAAA,QAVe;AAWfuB,IAAAA,KAAK,EAAE;AACNC,MAAAA,GAAG,CAACC,GAAD,EAAMC,GAAN,EAAW;AACbV,QAAAA,KAAK,CAACS,GAAD,CAAL,GAAaC,GAAb;AACA,eAAOA,GAAP;AACA,OAJK;;AAKNC,MAAAA,GAAG,CAACF,GAAD,EAAM;AACR,eAAOT,KAAK,CAACS,GAAD,CAAZ;AACA;;AAPK,KAXQ;;AAoBf3B,IAAAA,IAAI,CAAC8B,MAAD,EAASC,GAAT,EAAcC,OAAd,EAAuB;AAC1B,UAAI;AACH,eAAO;AACNC,UAAAA,MAAM,EAAEjC,IAAI,CAACkC,IAAL,CAAUJ,MAAV,EAAkBC,GAAlB,EAAuBC,OAAvB;AADF,SAAP;AAGA,OAJD,CAIE,OAAOG,KAAP,EAAc;AACf,eAAO;AACNA,UAAAA;AADM,SAAP;AAGA;AACD;;AA9Bc,GAAhB;AAgCAC,EAAAA,MAAM,CAACC,IAAP,CAAYxB,MAAZ,EACEyB,MADF,CACUC,CAAD,IAAO,CAACA,CAAC,CAACC,UAAF,CAAa,GAAb,CADjB,EAEEC,OAFF,CAEWF,CAAD,IAAO;AACfpB,IAAAA,OAAO,CAACoB,CAAD,CAAP,GAAa1B,MAAM,CAAC0B,CAAD,CAAnB;AACA,GAJF;AAKA,SAAO;AAAErB,IAAAA,KAAF;AAASC,IAAAA;AAAT,GAAP;AACA;;AAED,SAASuB,oBAAT,CAA8BC,WAA9B,EAA2C;AAC1C,QAAMC,cAAc,GAAG5B,eAAe,CAAC2B,WAAW,CAACE,GAAb,CAAtC;;AACA,MAAID,cAAc,IAAI,CAACA,cAAc,CAACE,UAAhB,KAA+B,CAACH,WAAW,CAACG,UAAlE,EAA8E;AAC7E,WAAOF,cAAc,CAACG,MAAtB;AACA;;AAED,QAAMA,MAAM,GAAGJ,WAAW,CAACK,cAA3B;AACA,QAAM;AAAE7B,IAAAA,OAAF;AAAWD,IAAAA;AAAX,MAAqBD,YAAY,EAAvC;;AACA,MAAI;AACHT,IAAAA,cAAc,CAACyC,IAAf,CAAoB;AAAEC,MAAAA,GAAG,EAAE,iCAAP;AAA0CC,MAAAA,IAAI,EAAER,WAAW,CAACQ;AAA5D,KAApB;AACA3C,IAAAA,cAAc,CAAC4C,KAAf,CAAqBL,MAArB;AAEA,UAAMM,QAAQ,GAAG3D,EAAE,CAAC4D,YAAH,CAAgBP,MAAhB,EAAwB,WAAxB,CAAjB;AACAM,IAAAA,QAAQ,CAACE,eAAT,CAAyBpC,OAAzB;;AACA,QAAIA,OAAO,CAACqC,MAAZ,EAAoB;AACnBxC,MAAAA,eAAe,CAAC2B,WAAW,CAACE,GAAb,CAAf,GAAmC;AAClCE,QAAAA,MAAM,EAAE,IAAI5B,OAAO,CAACqC,MAAZ,EAD0B;AAElCtC,QAAAA,KAFkC;AAGlC4B,QAAAA,UAAU,EAAEH,WAAW,CAACG;AAHU,OAAnC;AAMA,aAAO9B,eAAe,CAAC2B,WAAW,CAACE,GAAb,CAAf,CAAiCE,MAAxC;AACA;AACD,GAfD,CAeE,OAAOU,GAAP,EAAY;AACbjD,IAAAA,cAAc,CAAC2B,KAAf,CAAqB;AACpBe,MAAAA,GAAG,EAAE,oCADe;AAEpBC,MAAAA,IAAI,EAAER,WAAW,CAACQ,IAFE;AAGpBJ,MAAAA,MAHoB;AAIpBU,MAAAA;AAJoB,KAArB;AAMA,UAAM/C,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe,yBAAf,CAAN;AACA;;AAED,MAAI,CAACxC,OAAO,CAACqC,MAAb,EAAqB;AACpBhD,IAAAA,cAAc,CAAC2B,KAAf,CAAqB;AAAEe,MAAAA,GAAG,EAAE,+BAAP;AAAwCC,MAAAA,IAAI,EAAER,WAAW,CAACQ;AAA1D,KAArB;AACA,UAAMzC,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe,wBAAf,CAAN;AACA;AACD;;AAED,SAASC,iBAAT,CAA2B5B,OAA3B,EAAoC6B,IAApC,EAA0C;AACzCrD,EAAAA,cAAc,CAACyC,IAAf,CAAoB;AAAEC,IAAAA,GAAG,EAAE,iBAAP;AAA0BC,IAAAA,IAAI,EAAEnB,OAAO,CAACmB;AAAxC,GAApB;AACA3C,EAAAA,cAAc,CAAC4C,KAAf,CAAqBpB,OAArB;AAEAjC,EAAAA,MAAM,CAAC+D,SAAP,CAAiBD,IAAI,CAAChB,GAAtB,EAA2B,YAAY;AACtC,YAAQb,OAAO,CAAC+B,KAAhB;AACC,WAAK,qBAAL;AACC,YAAI/B,OAAO,CAACgC,IAAR,IAAgB,IAApB,EAA0B;AACzBhC,UAAAA,OAAO,CAACgC,IAAR,GAAe,EAAf;AACA;;AACD,YAAIhC,OAAO,CAACgC,IAAR,CAAaC,YAAb,IAA6B,IAA7B,IAAqCjC,OAAO,CAACgC,IAAR,CAAaC,YAAb,CAA0BC,OAA1B,CAAkC,GAAlC,MAA2C,CAAC,CAArF,EAAwF;AACvFlC,UAAAA,OAAO,CAACgC,IAAR,CAAaC,YAAb,cAAgCjC,OAAO,CAACgC,IAAR,CAAaC,YAA7C;AACA;;AACD,eAAOlE,MAAM,CAACmC,IAAP,CAAY,wBAAZ,EAAsC;AAC5CiC,UAAAA,QAAQ,EAAE,YADkC;AAE5CC,UAAAA,IAAI,EAAE,CAACpC,OAAO,CAACqC,UAAT,CAFsC;AAG5ClB,UAAAA,IAAI,EAAEnB,OAAO,CAACmB,IAH8B;AAI5CmB,UAAAA,OAAO,EAAEtC,OAAO,CAACgC,IAAR,CAAaC,YAJsB;AAK5CM,UAAAA,YAAY,EAAEvC,OAAO,CAACgC,IAAR,CAAaQ;AALiB,SAAtC,CAAP;;AAOD,WAAK,kBAAL;AACC,YAAIxC,OAAO,CAACgC,IAAR,CAAaG,QAAb,CAAsBD,OAAtB,CAA8B,GAA9B,MAAuC,CAAC,CAA5C,EAA+C;AAC9ClC,UAAAA,OAAO,CAACgC,IAAR,CAAaG,QAAb,cAA4BnC,OAAO,CAACgC,IAAR,CAAaG,QAAzC;AACA;;AACD,eAAOpE,MAAM,CAACmC,IAAP,CAAY,wBAAZ,EAAsC;AAC5CiC,UAAAA,QAAQ,EAAE,YADkC;AAE5CC,UAAAA,IAAI,EAAE,CAACpC,OAAO,CAACqC,UAAT,CAFsC;AAG5ClB,UAAAA,IAAI,EAAEnB,OAAO,CAACmB,IAH8B;AAI5CmB,UAAAA,OAAO,EAAEtC,OAAO,CAACgC,IAAR,CAAaG,QAJsB;AAK5CI,UAAAA,YAAY,EAAEvC,OAAO,CAACgC,IAAR,CAAaQ;AALiB,SAAtC,CAAP;AAnBF;AA2BA,GA5BD;AA8BA,SAAO9D,GAAG,CAACgD,EAAJ,CAAOe,OAAP,EAAP;AACA;;AAED,SAASC,iBAAT,CAA2B1C,OAA3B,EAAoC6B,IAApC,EAA0C;AACzCrD,EAAAA,cAAc,CAACyC,IAAf,CAAoB,oBAApB;AACAzC,EAAAA,cAAc,CAAC4C,KAAf,CAAqBpB,OAArB;AAEA,QAAM2C,mBAAmB,GAAGnD,OAAO,CAACoD,KAAR,CAAc9D,YAAY,CAAC+D,YAAb,CAA0B7C,OAAO,CAACqC,UAAlC,CAAd,CAA5B;;AACA,MAAI,CAACM,mBAAL,EAA0B;AACzB,WAAOjE,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe,uBAAf,CAAP;AACA;;AAED5D,EAAAA,MAAM,CAAC+D,SAAP,CAAiBD,IAAI,CAAChB,GAAtB,EAA2B,MAAM9C,MAAM,CAACmC,IAAP,CAAY,2BAAZ,EAAyCyC,mBAAmB,CAAC9B,GAA7D,CAAjC;AAEA,SAAOnC,GAAG,CAACgD,EAAJ,CAAOe,OAAP,EAAP;AACA;;AAED,SAASK,sBAAT,GAAkC;AACjCtE,EAAAA,cAAc,CAACyC,IAAf,CAAoB;AAAEC,IAAAA,GAAG,EAAE,mBAAP;AAA4BC,IAAAA,IAAI,EAAE,KAAKR,WAAL,CAAiBQ;AAAnD,GAApB;AACA3C,EAAAA,cAAc,CAAC4C,KAAf,CAAqB;AAAE2B,IAAAA,SAAS,EAAE,KAAKA,SAAlB;AAA6BC,IAAAA,UAAU,EAAE,KAAKA;AAA9C,GAArB;;AAEA,MAAI,KAAKrC,WAAL,CAAiBsC,OAAjB,KAA6B,IAAjC,EAAuC;AACtC,WAAO;AACNC,MAAAA,UAAU,EAAE,GADN;AAENC,MAAAA,IAAI,EAAE;AAFA,KAAP;AAIA;;AAED,QAAMC,aAAa,GAAG;AACrBd,IAAAA,OAAO,EAAE,KAAK3B,WAAL,CAAiB2B,OADL;AAErBe,IAAAA,KAAK,EAAE,KAAK1C,WAAL,CAAiB0C,KAFH;AAGrBC,IAAAA,MAAM,EAAE,KAAK3C,WAAL,CAAiB2C,MAHJ;AAIrBC,IAAAA,KAAK,EAAE,KAAK5C,WAAL,CAAiB4C;AAJH,GAAtB;;AAOA,MAAI,KAAK5C,WAAL,CAAiB6C,aAAjB,IAAkC,KAAK7C,WAAL,CAAiBK,cAAnD,IAAqE,KAAKL,WAAL,CAAiBK,cAAjB,CAAgCyC,IAAhC,OAA2C,EAApH,EAAwH;AACvH,QAAI1C,MAAJ;;AACA,QAAI;AACHA,MAAAA,MAAM,GAAGL,oBAAoB,CAAC,KAAKC,WAAN,CAA7B;AACA,KAFD,CAEE,OAAO+C,CAAP,EAAU;AACXlF,MAAAA,cAAc,CAAC2B,KAAf,CAAqBuD,CAArB;AACA,aAAOhF,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe+B,CAAC,CAACC,OAAjB,CAAP;AACA;;AAED,SAAKC,OAAL,CAAaC,WAAb,CAAyB,MAAzB;AACA,UAAMC,WAAW,GAAG,KAAKF,OAAL,CAAaG,IAAb,EAApB;AAEA,UAAMH,OAAO,GAAG;AACf7D,MAAAA,GAAG,EAAE;AACJiE,QAAAA,IAAI,EAAE,KAAKJ,OAAL,CAAaK,UAAb,CAAwBD,IAD1B;AAEJE,QAAAA,MAAM,EAAE,KAAKN,OAAL,CAAaK,UAAb,CAAwBC,MAF5B;AAGJC,QAAAA,KAAK,EAAE,KAAKC,WAHR;AAIJC,QAAAA,QAAQ,EAAE,KAAKT,OAAL,CAAaK,UAAb,CAAwBI,QAJ9B;AAKJC,QAAAA,IAAI,EAAE,KAAKV,OAAL,CAAaK,UAAb,CAAwBK;AAL1B,OADU;AAQfC,MAAAA,OAAO,EAAE,KAAKX,OAAL,CAAa7D,GARP;AASfyE,MAAAA,UAAU,EAAE,KAAKzB,SATF;AAUf0B,MAAAA,OAAO,EAAE,KAAKzB,UAVC;AAWfc,MAAAA,WAXe;AAYfY,MAAAA,OAAO,EAAE,KAAKd,OAAL,CAAac,OAZP;AAafvB,MAAAA,IAAI,EAAE,KAAKS,OAAL,CAAaT,IAbJ;AAcftB,MAAAA,IAAI,EAAE;AACLhB,QAAAA,GAAG,EAAE,KAAKgB,IAAL,CAAUhB,GADV;AAELM,QAAAA,IAAI,EAAE,KAAKU,IAAL,CAAUV,IAFX;AAGLgB,QAAAA,QAAQ,EAAE,KAAKN,IAAL,CAAUM;AAHf;AAdS,KAAhB;;AAqBA,QAAI;AACH,YAAM;AAAEhD,QAAAA;AAAF,UAAcF,YAAY,CAACD,eAAe,CAAC,KAAK2B,WAAL,CAAiBE,GAAlB,CAAf,CAAsC3B,KAAvC,CAAhC;AACAC,MAAAA,OAAO,CAAC4B,MAAR,GAAiBA,MAAjB;AACA5B,MAAAA,OAAO,CAACyE,OAAR,GAAkBA,OAAlB;AAEA,YAAM3D,MAAM,GAAG7B,MAAM,CAACuG,WAAP,CACdjH,EAAE,CAAC6D,eAAH,2WAaCpC,OAbD,EAcC;AACCyF,QAAAA,OAAO,EAAE;AADV,OAdD,CADc,EAmBbC,IAnBa,EAAf;;AAqBA,UAAI,CAAC5E,MAAL,EAAa;AACZzB,QAAAA,cAAc,CAAC4C,KAAf,CAAqB;AACpBF,UAAAA,GAAG,EAAE,wDADe;AAEpBC,UAAAA,IAAI,EAAE,KAAKR,WAAL,CAAiBQ;AAFH,SAArB;AAIA,eAAOzC,GAAG,CAACgD,EAAJ,CAAOe,OAAP,EAAP;AACA;;AACD,UAAIxC,MAAM,IAAIA,MAAM,CAACE,KAArB,EAA4B;AAC3B,eAAOzB,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe1B,MAAM,CAACE,KAAtB,CAAP;AACA;;AAED,WAAK6C,UAAL,GAAkB/C,MAAM,IAAIA,MAAM,CAACwE,OAAnC;AACA,WAAKK,cAAL,GAAsB7E,MAAM,CAAC8E,QAA7B;;AACA,UAAI9E,MAAM,CAAC4B,IAAX,EAAiB;AAChB,aAAKA,IAAL,GAAY5B,MAAM,CAAC4B,IAAnB;AACA;;AAEDrD,MAAAA,cAAc,CAAC4C,KAAf,CAAqB;AACpBF,QAAAA,GAAG,EAAE,4CADe;AAEpBC,QAAAA,IAAI,EAAE,KAAKR,WAAL,CAAiBQ,IAFH;AAGpBlB,QAAAA,MAAM,EAAE,KAAK+C;AAHO,OAArB;AAKA,KAhDD,CAgDE,OAAOvB,GAAP,EAAY;AACbjD,MAAAA,cAAc,CAAC2B,KAAf,CAAqB;AACpBe,QAAAA,GAAG,EAAE,iCADe;AAEpBC,QAAAA,IAAI,EAAE,KAAKR,WAAL,CAAiBQ,IAFH;AAGpBJ,QAAAA,MAAM,EAAE,KAAKJ,WAAL,CAAiBK,cAHL;AAIpBS,QAAAA;AAJoB,OAArB;AAMA,aAAO/C,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe,sBAAf,CAAP;AACA;AACD,GA5GgC,CA8GjC;AACA;;;AACA,MAAI,CAAC,KAAKqB,UAAN,IAAqB3E,CAAC,CAAC2G,OAAF,CAAU,KAAKhC,UAAf,KAA8B,CAAC,KAAKrC,WAAL,CAAiB6C,aAAzE,EAAyF;AACxF;AACA,WAAO9E,GAAG,CAACgD,EAAJ,CAAOe,OAAP,EAAP;AACA;;AAED,OAAKO,UAAL,CAAgBiC,GAAhB,GAAsB;AAAEC,IAAAA,CAAC,EAAE,KAAKvE,WAAL,CAAiBE;AAAtB,GAAtB;;AAEA,MAAI;AACH,UAAM8C,OAAO,GAAGlF,qBAAqB,CAAC,KAAKuE,UAAN,EAAkB,KAAKnB,IAAvB,EAA6BuB,aAA7B,CAArC;;AACA,QAAI/E,CAAC,CAAC2G,OAAF,CAAUrB,OAAV,CAAJ,EAAwB;AACvB,aAAOjF,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAe,eAAf,CAAP;AACA;;AAED,QAAI,KAAKmD,cAAT,EAAyB;AACxBtG,MAAAA,cAAc,CAAC4C,KAAf,CAAqB;AAAEF,QAAAA,GAAG,EAAE,UAAP;AAAmB6D,QAAAA,QAAQ,EAAE,KAAKD;AAAlC,OAArB;AACA;;AAED,WAAOpG,GAAG,CAACgD,EAAJ,CAAOe,OAAP,CAAe,KAAKqC,cAApB,CAAP;AACA,GAXD,CAWE,OAAO;AAAE3E,IAAAA,KAAF;AAASwD,IAAAA;AAAT,GAAP,EAA2B;AAC5B,WAAOjF,GAAG,CAACgD,EAAJ,CAAOC,OAAP,CAAexB,KAAK,IAAIwD,OAAxB,CAAP;AACA;AACD;;AAED,SAASwB,kBAAT,GAA8B;AAC7B,SAAOvD,iBAAiB,CAAC,KAAKoB,UAAN,EAAkB,KAAKnB,IAAvB,CAAxB;AACA;;AAED,SAASuD,qBAAT,GAAiC;AAChC,SAAO1C,iBAAiB,CAAC,KAAKM,UAAN,EAAkB,KAAKnB,IAAvB,CAAxB;AACA;;AAED,SAASwD,qBAAT,GAAiC;AAChC7G,EAAAA,cAAc,CAACyC,IAAf,CAAoB,oBAApB;AACA,SAAO;AACNiC,IAAAA,UAAU,EAAE,GADN;AAENC,IAAAA,IAAI,EAAE,CACL;AACCmC,MAAAA,KAAK,EAAErH,MAAM,CAACsH,EAAP,CAAU,EAAV,CADR;AAECC,MAAAA,UAAU,EAAEvH,MAAM,CAACsH,EAAP,EAFb;AAGCtD,MAAAA,YAAY,EAAE,SAHf;AAICwD,MAAAA,SAAS,EAAE,IAAIC,IAAJ,EAJZ;AAKCC,MAAAA,OAAO,EAAE1H,MAAM,CAACsH,EAAP,EALV;AAMCK,MAAAA,SAAS,EAAE,YANZ;AAOCC,MAAAA,IAAI,EAAE,eAPP;AAQCC,MAAAA,YAAY,EAAE;AARf,KADK,EAWL;AACCR,MAAAA,KAAK,EAAErH,MAAM,CAACsH,EAAP,CAAU,EAAV,CADR;AAECC,MAAAA,UAAU,EAAEvH,MAAM,CAACsH,EAAP,EAFb;AAGCtD,MAAAA,YAAY,EAAE,SAHf;AAICwD,MAAAA,SAAS,EAAE,IAAIC,IAAJ,EAJZ;AAKCC,MAAAA,OAAO,EAAE1H,MAAM,CAACsH,EAAP,EALV;AAMCK,MAAAA,SAAS,EAAE,YANZ;AAOCC,MAAAA,IAAI,EAAE,eAPP;AAQCC,MAAAA,YAAY,EAAE;AARf,KAXK,EAqBL;AACCR,MAAAA,KAAK,EAAErH,MAAM,CAACsH,EAAP,CAAU,EAAV,CADR;AAECC,MAAAA,UAAU,EAAEvH,MAAM,CAACsH,EAAP,EAFb;AAGCtD,MAAAA,YAAY,EAAE,SAHf;AAICwD,MAAAA,SAAS,EAAE,IAAIC,IAAJ,EAJZ;AAKCC,MAAAA,OAAO,EAAE1H,MAAM,CAACsH,EAAP,EALV;AAMCK,MAAAA,SAAS,EAAE,YANZ;AAOCC,MAAAA,IAAI,EAAE,eAPP;AAQCC,MAAAA,YAAY,EAAE;AARf,KArBK;AAFA,GAAP;AAmCA;;AAED,SAASC,mBAAT,GAA+B;AAC9BvH,EAAAA,cAAc,CAACyC,IAAf,CAAoB,kBAApB;AACA,SAAO;AACNiC,IAAAA,UAAU,EAAE,GADN;AAENC,IAAAA,IAAI,EAAE;AACLV,MAAAA,OAAO,EAAE;AADJ;AAFA,GAAP;AAMA;;AAED,MAAMuD,UAAN,SAAyBrH,QAAzB,CAAkC;AACjC;AACAsH,EAAAA,yBAAyB,CAACjG,OAAD,EAAU;AAClC,UAAM;AAAEkG,MAAAA;AAAF,QAAyBlG,OAA/B;AACA,WACC,CAAC,OAAOkG,kBAAP,KAA8B,QAA9B,IAA0CA,kBAAkB,KAAKC,SAAlE,KACA,CAACC,OAAO,CAACC,GAAR,CAAYC,SADb,IAEAC,OAAO,CAAC3H,yBAAyB,CAAC4H,kBAA1B,IAAgD5H,yBAAyB,CAAC6H,gBAA3E,CAHR;AAKA;;AAEDC,EAAAA,qBAAqB,GAAc;AAClC,WACC3H,QAAQ,CAACc,GAAT,CAAa,yBAAb,MAA4C,IAA5C,KACCuG,OAAO,CAACC,GAAR,CAAYM,QAAZ,KAAyB,aAAzB,IAA0C5H,QAAQ,CAACc,GAAT,CAAa,6BAAb,MAAgD,IAD3F,CADD;AAIA;AAED;AACD;AACA;AACA;;;AACC+G,EAAAA,gBAAgB,CAACC,uBAAD,EAA0BjD,OAA1B,EAAmCmB,QAAnC,EAA6C+B,MAA7C,EAAqD;AACpE,UAAM;AAAEhH,MAAAA,MAAF;AAAUC,MAAAA;AAAV,QAAkB6D,OAAxB;AACA,UAAMmD,KAAK,GAAGhH,GAAG,CAACiH,OAAJ,YAAgB,KAAKC,OAArB,GAAgC,EAAhC,CAAd;AACA,UAAMC,SAAS,GAAG,KAAKC,gBAAL,CAAsBJ,KAAtB,EAA6B,CAACjH,MAAM,CAACsH,WAAP,EAAD,CAA7B,CAAlB,CAHoE,CAIpE;AACA;AACA;;AACA,QAAI,CAAC,KAAKC,cAAL,CAAoBH,SAApB,CAAL,EAAqC;AACpC,WAAKI,2BAAL,CAAiC;AAChCC,QAAAA,MAAM,EAAE,CAACR,KAAD,CADwB;AAEhCb,QAAAA,kBAAkB,EAAEtH,yBAFY;AAGhC4I,QAAAA,SAAS,EAAE;AACVC,UAAAA,IAAI,EAAE3E,sBADI;AAEVjD,UAAAA,GAAG,EAAEiD;AAFK;AAHqB,OAAjC;AAQA;;AAED,UAAM4E,4BAA4B,GAAGb,uBAArC;AACAa,IAAAA,4BAA4B,CAACX,KAA7B,GAAqCG,SAArC;AAEA,UAAMN,gBAAN,CAAuBc,4BAAvB,EAAqD9D,OAArD,EAA8DmB,QAA9D,EAAwE+B,MAAxE;AACA;;AA5CgC;;AA+ClC,MAAMa,GAAG,GAAG,IAAI3B,UAAJ,CAAe;AAC1B4B,EAAAA,UAAU,EAAE,IADc;AAE1BX,EAAAA,OAAO,EAAE,QAFiB;AAG1BY,EAAAA,IAAI,EAAE;AACLhG,IAAAA,IAAI,GAAG;AACN,YAAMiG,WAAW,GAAG1H,MAAM,CAACC,IAAP,CAAY,KAAK2C,UAAjB,CAApB;AACA,YAAM+E,gBAAgB,GAAG,KAAK/E,UAAL,IAAmB,KAAKA,UAAL,CAAgBgF,OAAnC,IAA8CF,WAAW,CAACG,MAAZ,KAAuB,CAA9F;;AACA,UAAIF,gBAAgB,IAAI,KAAKnE,OAAL,CAAac,OAAb,CAAqB,cAArB,MAAyC,mCAAjE,EAAsG;AACrG,YAAI;AACH,eAAK1B,UAAL,GAAkBkF,IAAI,CAACC,KAAL,CAAW,KAAKnF,UAAL,CAAgBgF,OAA3B,CAAlB;AACA,SAFD,CAEE,OAAO;AAAErE,UAAAA;AAAF,SAAP,EAAoB;AACrB,iBAAO;AACNxD,YAAAA,KAAK,EAAE;AACN+C,cAAAA,UAAU,EAAE,GADN;AAENC,cAAAA,IAAI,EAAE;AACLV,gBAAAA,OAAO,EAAE,KADJ;AAELtC,gBAAAA,KAAK,EAAEwD;AAFF;AAFA;AADD,WAAP;AASA;AACD;;AAED,WAAKhD,WAAL,GAAmBnB,OAAO,CAACoD,KAAR,CAClB9D,YAAY,CAACsJ,OAAb,CAAqB;AACpBvH,QAAAA,GAAG,EAAE,KAAK+C,OAAL,CAAayE,MAAb,CAAoBC,aADL;AAEpBhD,QAAAA,KAAK,EAAEiD,kBAAkB,CAAC,KAAK3E,OAAL,CAAayE,MAAb,CAAoB/C,KAArB;AAFL,OAArB,CADkB,CAAnB;;AAOA,UAAI,CAAC,KAAK3E,WAAV,EAAuB;AACtBnC,QAAAA,cAAc,CAACyC,IAAf,kCAA8C,KAAK2C,OAAL,CAAayE,MAAb,CAAoBC,aAAlE,uBAA4F,KAAK1E,OAAL,CAAayE,MAAb,CAAoB/C,KAAhH;AAEA,eAAO;AACNnF,UAAAA,KAAK,EAAE;AACN+C,YAAAA,UAAU,EAAE,GADN;AAENC,YAAAA,IAAI,EAAE;AACLV,cAAAA,OAAO,EAAE,KADJ;AAELtC,cAAAA,KAAK,EAAE;AAFF;AAFA;AADD,SAAP;AASA;;AAED,YAAM0B,IAAI,GAAGhD,MAAM,CAAC2J,KAAP,CAAaJ,OAAb,CAAqB;AACjCvH,QAAAA,GAAG,EAAE,KAAKF,WAAL,CAAiBmG;AADW,OAArB,CAAb;AAIA,aAAO;AAAEjF,QAAAA;AAAF,OAAP;AACA;;AA9CI;AAHoB,CAAf,CAAZ;AAqDA8F,GAAG,CAACc,QAAJ,CACC,+BADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACCjB,EAAAA,IAAI,EAAE3E,sBADP;AAECjD,EAAAA,GAAG,EAAEiD;AAFN,CAHD;AASA6E,GAAG,CAACc,QAAJ,CACC,uBADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACCjB,EAAAA,IAAI,EAAE3E,sBADP;AAECjD,EAAAA,GAAG,EAAEiD;AAFN,CAHD;AASA6E,GAAG,CAACc,QAAJ,CACC,sCADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACC7I,EAAAA,GAAG,EAAEwF;AADN,CAHD;AAQAsC,GAAG,CAACc,QAAJ,CACC,8BADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACC7I,EAAAA,GAAG,EAAEwF;AADN,CAHD;AAQAsC,GAAG,CAACc,QAAJ,CACC,oCADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACC7I,EAAAA,GAAG,EAAEkG;AADN,CAHD;AAQA4B,GAAG,CAACc,QAAJ,CACC,4BADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACC7I,EAAAA,GAAG,EAAEkG;AADN,CAHD;AAQA4B,GAAG,CAACc,QAAJ,CACC,mCADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACCjB,EAAAA,IAAI,EAAEtC;AADP,CAHD;AAQAwC,GAAG,CAACc,QAAJ,CACC,2BADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACCjB,EAAAA,IAAI,EAAEtC;AADP,CAHD;AAQAwC,GAAG,CAACc,QAAJ,CACC,sCADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACCjB,EAAAA,IAAI,EAAErC;AADP,CAHD;AAQAuC,GAAG,CAACc,QAAJ,CACC,8BADD,EAEC;AAAEC,EAAAA,YAAY,EAAE;AAAhB,CAFD,EAGC;AACCjB,EAAAA,IAAI,EAAErC;AADP,CAHD","sourcesContent":["import vm from 'vm';\n\nimport { Meteor } from 'meteor/meteor';\nimport { HTTP } from 'meteor/http';\nimport { Random } from 'meteor/random';\nimport { Livechat } from 'meteor/rocketchat:livechat';\nimport Fiber from 'fibers';\nimport Future from 'fibers/future';\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\n\nimport { incomingLogger } from '../logger';\nimport { processWebhookMessage } from '../../../lib/server';\nimport { API, APIClass, defaultRateLimiterOptions } from '../../../api/server';\nimport * as Models from '../../../models/server';\nimport { Integrations } from '../../../models/server/raw';\nimport { settings } from '../../../settings/server';\n\nconst compiledScripts = {};\nfunction buildSandbox(store = {}) {\n\tconst sandbox = {\n\t\tscriptTimeout(reject) {\n\t\t\treturn setTimeout(() => reject('timed out'), 3000);\n\t\t},\n\t\t_,\n\t\ts,\n\t\tconsole,\n\t\tmoment,\n\t\tFiber,\n\t\tPromise,\n\t\tLivechat,\n\t\tStore: {\n\t\t\tset(key, val) {\n\t\t\t\tstore[key] = val;\n\t\t\t\treturn val;\n\t\t\t},\n\t\t\tget(key) {\n\t\t\t\treturn store[key];\n\t\t\t},\n\t\t},\n\t\tHTTP(method, url, options) {\n\t\t\ttry {\n\t\t\t\treturn {\n\t\t\t\t\tresult: HTTP.call(method, url, options),\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\treturn {\n\t\t\t\t\terror,\n\t\t\t\t};\n\t\t\t}\n\t\t},\n\t};\n\tObject.keys(Models)\n\t\t.filter((k) => !k.startsWith('_'))\n\t\t.forEach((k) => {\n\t\t\tsandbox[k] = Models[k];\n\t\t});\n\treturn { store, sandbox };\n}\n\nfunction getIntegrationScript(integration) {\n\tconst compiledScript = compiledScripts[integration._id];\n\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\treturn compiledScript.script;\n\t}\n\n\tconst script = integration.scriptCompiled;\n\tconst { sandbox, store } = buildSandbox();\n\ttry {\n\t\tincomingLogger.info({ msg: 'Will evaluate script of Trigger', name: integration.name });\n\t\tincomingLogger.debug(script);\n\n\t\tconst vmScript = vm.createScript(script, 'script.js');\n\t\tvmScript.runInNewContext(sandbox);\n\t\tif (sandbox.Script) {\n\t\t\tcompiledScripts[integration._id] = {\n\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\tstore,\n\t\t\t\t_updatedAt: integration._updatedAt,\n\t\t\t};\n\n\t\t\treturn compiledScripts[integration._id].script;\n\t\t}\n\t} catch (err) {\n\t\tincomingLogger.error({\n\t\t\tmsg: 'Error evaluating Script in Trigger',\n\t\t\tname: integration.name,\n\t\t\tscript,\n\t\t\terr,\n\t\t});\n\t\tthrow API.v1.failure('error-evaluating-script');\n\t}\n\n\tif (!sandbox.Script) {\n\t\tincomingLogger.error({ msg: 'Class \"Script\" not in Trigger', name: integration.name });\n\t\tthrow API.v1.failure('class-script-not-found');\n\t}\n}\n\nfunction createIntegration(options, user) {\n\tincomingLogger.info({ msg: 'Add integration', name: options.name });\n\tincomingLogger.debug(options);\n\n\tMeteor.runAsUser(user._id, function () {\n\t\tswitch (options.event) {\n\t\t\tcase 'newMessageOnChannel':\n\t\t\t\tif (options.data == null) {\n\t\t\t\t\toptions.data = {};\n\t\t\t\t}\n\t\t\t\tif (options.data.channel_name != null && options.data.channel_name.indexOf('#') === -1) {\n\t\t\t\t\toptions.data.channel_name = `#${options.data.channel_name}`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.channel_name,\n\t\t\t\t\ttriggerWords: options.data.trigger_words,\n\t\t\t\t});\n\t\t\tcase 'newMessageToUser':\n\t\t\t\tif (options.data.username.indexOf('@') === -1) {\n\t\t\t\t\toptions.data.username = `@${options.data.username}`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.username,\n\t\t\t\t\ttriggerWords: options.data.trigger_words,\n\t\t\t\t});\n\t\t}\n\t});\n\n\treturn API.v1.success();\n}\n\nfunction removeIntegration(options, user) {\n\tincomingLogger.info('Remove integration');\n\tincomingLogger.debug(options);\n\n\tconst integrationToRemove = Promise.await(Integrations.findOneByUrl(options.target_url));\n\tif (!integrationToRemove) {\n\t\treturn API.v1.failure('integration-not-found');\n\t}\n\n\tMeteor.runAsUser(user._id, () => Meteor.call('deleteOutgoingIntegration', integrationToRemove._id));\n\n\treturn API.v1.success();\n}\n\nfunction executeIntegrationRest() {\n\tincomingLogger.info({ msg: 'Post integration:', name: this.integration.name });\n\tincomingLogger.debug({ urlParams: this.urlParams, bodyParams: this.bodyParams });\n\n\tif (this.integration.enabled !== true) {\n\t\treturn {\n\t\t\tstatusCode: 503,\n\t\t\tbody: 'Service Unavailable',\n\t\t};\n\t}\n\n\tconst defaultValues = {\n\t\tchannel: this.integration.channel,\n\t\talias: this.integration.alias,\n\t\tavatar: this.integration.avatar,\n\t\temoji: this.integration.emoji,\n\t};\n\n\tif (this.integration.scriptEnabled && this.integration.scriptCompiled && this.integration.scriptCompiled.trim() !== '') {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = getIntegrationScript(this.integration);\n\t\t} catch (e) {\n\t\t\tincomingLogger.error(e);\n\t\t\treturn API.v1.failure(e.message);\n\t\t}\n\n\t\tthis.request.setEncoding('utf8');\n\t\tconst content_raw = this.request.read();\n\n\t\tconst request = {\n\t\t\turl: {\n\t\t\t\thash: this.request._parsedUrl.hash,\n\t\t\t\tsearch: this.request._parsedUrl.search,\n\t\t\t\tquery: this.queryParams,\n\t\t\t\tpathname: this.request._parsedUrl.pathname,\n\t\t\t\tpath: this.request._parsedUrl.path,\n\t\t\t},\n\t\t\turl_raw: this.request.url,\n\t\t\turl_params: this.urlParams,\n\t\t\tcontent: this.bodyParams,\n\t\t\tcontent_raw,\n\t\t\theaders: this.request.headers,\n\t\t\tbody: this.request.body,\n\t\t\tuser: {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name,\n\t\t\t\tusername: this.user.username,\n\t\t\t},\n\t\t};\n\n\t\ttry {\n\t\t\tconst { sandbox } = buildSandbox(compiledScripts[this.integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.request = request;\n\n\t\t\tconst result = Future.fromPromise(\n\t\t\t\tvm.runInNewContext(\n\t\t\t\t\t`\n\t\t\t\tnew Promise((resolve, reject) => {\n\t\t\t\t\tFiber(() => {\n\t\t\t\t\t\tscriptTimeout(reject);\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tresolve(script.process_incoming_request({ request: request }));\n\t\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}).run();\n\t\t\t\t}).catch((error) => { throw new Error(error); });\n\t\t\t`,\n\t\t\t\t\tsandbox,\n\t\t\t\t\t{\n\t\t\t\t\t\ttimeout: 3000,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t).wait();\n\n\t\t\tif (!result) {\n\t\t\t\tincomingLogger.debug({\n\t\t\t\t\tmsg: 'Process Incoming Request result of Trigger has no data',\n\t\t\t\t\tname: this.integration.name,\n\t\t\t\t});\n\t\t\t\treturn API.v1.success();\n\t\t\t}\n\t\t\tif (result && result.error) {\n\t\t\t\treturn API.v1.failure(result.error);\n\t\t\t}\n\n\t\t\tthis.bodyParams = result && result.content;\n\t\t\tthis.scriptResponse = result.response;\n\t\t\tif (result.user) {\n\t\t\t\tthis.user = result.user;\n\t\t\t}\n\n\t\t\tincomingLogger.debug({\n\t\t\t\tmsg: 'Process Incoming Request result of Trigger',\n\t\t\t\tname: this.integration.name,\n\t\t\t\tresult: this.bodyParams,\n\t\t\t});\n\t\t} catch (err) {\n\t\t\tincomingLogger.error({\n\t\t\t\tmsg: 'Error running Script in Trigger',\n\t\t\t\tname: this.integration.name,\n\t\t\t\tscript: this.integration.scriptCompiled,\n\t\t\t\terr,\n\t\t\t});\n\t\t\treturn API.v1.failure('error-running-script');\n\t\t}\n\t}\n\n\t// TODO: Turn this into an option on the integrations - no body means a success\n\t// TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n\tif (!this.bodyParams || (_.isEmpty(this.bodyParams) && !this.integration.scriptEnabled)) {\n\t\t// return RocketChat.API.v1.failure('body-empty');\n\t\treturn API.v1.success();\n\t}\n\n\tthis.bodyParams.bot = { i: this.integration._id };\n\n\ttry {\n\t\tconst message = processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\t\tif (_.isEmpty(message)) {\n\t\t\treturn API.v1.failure('unknown-error');\n\t\t}\n\n\t\tif (this.scriptResponse) {\n\t\t\tincomingLogger.debug({ msg: 'response', response: this.scriptResponse });\n\t\t}\n\n\t\treturn API.v1.success(this.scriptResponse);\n\t} catch ({ error, message }) {\n\t\treturn API.v1.failure(error || message);\n\t}\n}\n\nfunction addIntegrationRest() {\n\treturn createIntegration(this.bodyParams, this.user);\n}\n\nfunction removeIntegrationRest() {\n\treturn removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n\tincomingLogger.info('Sample Integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: [\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 1',\n\t\t\t\ttrigger_word: 'Sample',\n\t\t\t},\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 2',\n\t\t\t\ttrigger_word: 'Sample',\n\t\t\t},\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 3',\n\t\t\t\ttrigger_word: 'Sample',\n\t\t\t},\n\t\t],\n\t};\n}\n\nfunction integrationInfoRest() {\n\tincomingLogger.info('Info integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: {\n\t\t\tsuccess: true,\n\t\t},\n\t};\n}\n\nclass WebHookAPI extends APIClass {\n\t/* Webhooks are not versioned, so we must not validate we know a version before adding a rate limiter */\n\tshouldAddRateLimitToRoute(options) {\n\t\tconst { rateLimiterOptions } = options;\n\t\treturn (\n\t\t\t(typeof rateLimiterOptions === 'object' || rateLimiterOptions === undefined) &&\n\t\t\t!process.env.TEST_MODE &&\n\t\t\tBoolean(defaultRateLimiterOptions.numRequestsAllowed && defaultRateLimiterOptions.intervalTimeInMS)\n\t\t);\n\t}\n\n\tshouldVerifyRateLimit(/* route */) {\n\t\treturn (\n\t\t\tsettings.get('API_Enable_Rate_Limiter') === true &&\n\t\t\t(process.env.NODE_ENV !== 'development' || settings.get('API_Enable_Rate_Limiter_Dev') === true)\n\t\t);\n\t}\n\n\t/*\n\tThere is only one generic route propagated to Restivus which has URL-path-parameters for the integration and the token.\n\tSince the rate-limiter operates on absolute routes, we need to add a limiter to the absolute url before we can validate it\n\t*/\n\tenforceRateLimit(objectForRateLimitMatch, request, response, userId) {\n\t\tconst { method, url } = request;\n\t\tconst route = url.replace(`/${this.apiPath}`, '');\n\t\tconst nameRoute = this.getFullRouteName(route, [method.toLowerCase()]);\n\t\t// We'll be creating rate limiters on demand (when validating for the first time).\n\t\t// This is possible since *all* integration hooks should be rate limited the same way.\n\t\t// This way, we'll not have to add new limiters as new integrations are added\n\t\tif (!this.getRateLimiter(nameRoute)) {\n\t\t\tthis.addRateLimiterRuleForRoutes({\n\t\t\t\troutes: [route],\n\t\t\t\trateLimiterOptions: defaultRateLimiterOptions,\n\t\t\t\tendpoints: {\n\t\t\t\t\tpost: executeIntegrationRest,\n\t\t\t\t\tget: executeIntegrationRest,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tconst integrationForRateLimitMatch = objectForRateLimitMatch;\n\t\tintegrationForRateLimitMatch.route = nameRoute;\n\n\t\tsuper.enforceRateLimit(integrationForRateLimitMatch, request, response, userId);\n\t}\n}\n\nconst Api = new WebHookAPI({\n\tenableCors: true,\n\tapiPath: 'hooks/',\n\tauth: {\n\t\tuser() {\n\t\t\tconst payloadKeys = Object.keys(this.bodyParams);\n\t\t\tconst payloadIsWrapped = this.bodyParams && this.bodyParams.payload && payloadKeys.length === 1;\n\t\t\tif (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n\t\t\t\ttry {\n\t\t\t\t\tthis.bodyParams = JSON.parse(this.bodyParams.payload);\n\t\t\t\t} catch ({ message }) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tstatusCode: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\terror: message,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.integration = Promise.await(\n\t\t\t\tIntegrations.findOne({\n\t\t\t\t\t_id: this.request.params.integrationId,\n\t\t\t\t\ttoken: decodeURIComponent(this.request.params.token),\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\tif (!this.integration) {\n\t\t\t\tincomingLogger.info(`Invalid integration id ${this.request.params.integrationId} or token ${this.request.params.token}`);\n\n\t\t\t\treturn {\n\t\t\t\t\terror: {\n\t\t\t\t\t\tstatusCode: 404,\n\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: 'Invalid integration id or token provided.',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst user = Models.Users.findOne({\n\t\t\t\t_id: this.integration.userId,\n\t\t\t});\n\n\t\t\treturn { user };\n\t\t},\n\t},\n});\n\nApi.addRoute(\n\t':integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: executeIntegrationRest,\n\t\tget: executeIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t':integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: executeIntegrationRest,\n\t\tget: executeIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'sample/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationSampleRest,\n\t},\n);\n\nApi.addRoute(\n\t'sample/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationSampleRest,\n\t},\n);\n\nApi.addRoute(\n\t'info/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationInfoRest,\n\t},\n);\n\nApi.addRoute(\n\t'info/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tget: integrationInfoRest,\n\t},\n);\n\nApi.addRoute(\n\t'add/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: addIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'add/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: addIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'remove/:integrationId/:userId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: removeIntegrationRest,\n\t},\n);\n\nApi.addRoute(\n\t'remove/:integrationId/:token',\n\t{ authRequired: true },\n\t{\n\t\tpost: removeIntegrationRest,\n\t},\n);\n"]},"sourceType":"module","hash":"6f3bd004a7ae14c8024a6090126691110fd7fc2c"}
