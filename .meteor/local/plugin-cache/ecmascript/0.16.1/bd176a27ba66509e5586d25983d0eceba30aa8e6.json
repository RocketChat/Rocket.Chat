{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/file/server/file.server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/file/server/file.server.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/file/server/file.server.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/file/server/file.server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file/server/file.server.js"}},"code":"module.export({\n  RocketChatFile: () => RocketChatFile\n});\nlet stream;\nmodule.link(\"stream\", {\n  default(v) {\n    stream = v;\n  }\n\n}, 0);\nlet fs;\nmodule.link(\"fs\", {\n  default(v) {\n    fs = v;\n  }\n\n}, 1);\nlet path;\nmodule.link(\"path\", {\n  default(v) {\n    path = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet MongoInternals;\nmodule.link(\"meteor/mongo\", {\n  MongoInternals(v) {\n    MongoInternals = v;\n  }\n\n}, 4);\nlet Grid;\nmodule.link(\"gridfs-stream\", {\n  default(v) {\n    Grid = v;\n  }\n\n}, 5);\nlet mkdirp;\nmodule.link(\"mkdirp\", {\n  default(v) {\n    mkdirp = v;\n  }\n\n}, 6);\n\n// Fix problem with usernames being converted to object id\nGrid.prototype.tryParseObjectId = function () {\n  return false;\n};\n\nconst RocketChatFile = {};\n\nRocketChatFile.bufferToStream = function (buffer) {\n  const bufferStream = new stream.PassThrough();\n  bufferStream.end(buffer);\n  return bufferStream;\n};\n\nRocketChatFile.dataURIParse = function (dataURI) {\n  const imageData = dataURI.split(';base64,');\n  return {\n    image: imageData[1],\n    contentType: imageData[0].replace('data:', '')\n  };\n};\n\nRocketChatFile.addPassThrough = function (st, fn) {\n  const pass = new stream.PassThrough();\n  fn(pass, st);\n  return pass;\n};\n\nRocketChatFile.GridFS = class {\n  constructor() {\n    let config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const {\n      name = 'file',\n      transformWrite\n    } = config;\n    this.name = name;\n    this.transformWrite = transformWrite;\n    const mongo = MongoInternals.NpmModule;\n    const {\n      db\n    } = MongoInternals.defaultRemoteCollectionDriver().mongo;\n    this.store = new Grid(db, mongo);\n    this.findOneSync = Meteor.wrapAsync(this.store.collection(this.name).findOne.bind(this.store.collection(this.name)));\n    this.removeSync = Meteor.wrapAsync(this.store.remove.bind(this.store));\n    this.countSync = Meteor.wrapAsync(this.store._col.count.bind(this.store._col));\n    this.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n  }\n\n  findOne(fileName) {\n    return this.findOneSync({\n      _id: fileName\n    });\n  }\n\n  remove(fileName) {\n    return this.removeSync({\n      _id: fileName,\n      root: this.name\n    });\n  }\n\n  createWriteStream(fileName, contentType) {\n    const self = this;\n    let ws = this.store.createWriteStream({\n      _id: fileName,\n      filename: fileName,\n      mode: 'w',\n      root: this.name,\n      content_type: contentType\n    });\n\n    if (self.transformWrite != null) {\n      ws = RocketChatFile.addPassThrough(ws, function (rs, ws) {\n        const file = {\n          name: self.name,\n          fileName,\n          contentType\n        };\n        return self.transformWrite(file, rs, ws);\n      });\n    }\n\n    ws.on('close', function () {\n      return ws.emit('end');\n    });\n    return ws;\n  }\n\n  createReadStream(fileName) {\n    return this.store.createReadStream({\n      _id: fileName,\n      root: this.name\n    });\n  }\n\n  getFileWithReadStream(fileName) {\n    const file = this.findOne(fileName);\n\n    if (file == null) {\n      return null;\n    }\n\n    const rs = this.createReadStream(fileName);\n    return {\n      readStream: rs,\n      contentType: file.contentType,\n      length: file.length,\n      uploadDate: file.uploadDate\n    };\n  }\n\n  getFile(fileName, cb) {\n    const file = this.getFileWithReadStream(fileName);\n\n    if (!file) {\n      return cb();\n    }\n\n    const data = [];\n    file.readStream.on('data', Meteor.bindEnvironment(function (chunk) {\n      return data.push(chunk);\n    }));\n    return file.readStream.on('end', Meteor.bindEnvironment(function () {\n      return cb(null, {\n        buffer: Buffer.concat(data),\n        contentType: file.contentType,\n        length: file.length,\n        uploadDate: file.uploadDate\n      });\n    }));\n  }\n\n  deleteFile(fileName) {\n    const file = this.findOne(fileName);\n\n    if (file == null) {\n      return undefined;\n    }\n\n    return this.remove(fileName);\n  }\n\n};\nRocketChatFile.FileSystem = class {\n  constructor() {\n    let config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    let {\n      absolutePath = '~/uploads'\n    } = config;\n    const {\n      transformWrite\n    } = config;\n    this.transformWrite = transformWrite;\n\n    if (absolutePath.split(path.sep)[0] === '~') {\n      const homepath = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;\n\n      if (homepath != null) {\n        absolutePath = absolutePath.replace('~', homepath);\n      } else {\n        throw new Error('Unable to resolve \"~\" in path');\n      }\n    }\n\n    this.absolutePath = path.resolve(absolutePath);\n    mkdirp.sync(this.absolutePath);\n    this.statSync = Meteor.wrapAsync(fs.stat.bind(fs));\n    this.unlinkSync = Meteor.wrapAsync(fs.unlink.bind(fs));\n    this.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n  }\n\n  createWriteStream(fileName, contentType) {\n    const self = this;\n    let ws = fs.createWriteStream(path.join(this.absolutePath, fileName));\n\n    if (self.transformWrite != null) {\n      ws = RocketChatFile.addPassThrough(ws, function (rs, ws) {\n        const file = {\n          fileName,\n          contentType\n        };\n        return self.transformWrite(file, rs, ws);\n      });\n    }\n\n    ws.on('close', function () {\n      return ws.emit('end');\n    });\n    return ws;\n  }\n\n  createReadStream(fileName) {\n    return fs.createReadStream(path.join(this.absolutePath, fileName));\n  }\n\n  stat(fileName) {\n    return this.statSync(path.join(this.absolutePath, fileName));\n  }\n\n  remove(fileName) {\n    return this.unlinkSync(path.join(this.absolutePath, fileName));\n  }\n\n  getFileWithReadStream(fileName) {\n    try {\n      const stat = this.stat(fileName);\n      const rs = this.createReadStream(fileName);\n      return {\n        readStream: rs,\n        // contentType: file.contentType\n        length: stat.size\n      };\n    } catch (error1) {\n      return null;\n    }\n  }\n\n  getFile(fileName, cb) {\n    const file = this.getFileWithReadStream(fileName);\n\n    if (!file) {\n      return cb();\n    }\n\n    const data = [];\n    file.readStream.on('data', Meteor.bindEnvironment(function (chunk) {\n      return data.push(chunk);\n    }));\n    return file.readStream.on('end', Meteor.bindEnvironment(function () {\n      return {\n        buffer: Buffer.concat(data)({\n          contentType: file.contentType,\n          length: file.length,\n          uploadDate: file.uploadDate\n        })\n      };\n    }));\n  }\n\n  deleteFile(fileName) {\n    try {\n      return this.remove(fileName);\n    } catch (error1) {\n      return null;\n    }\n  }\n\n};","map":{"version":3,"sources":["app/file/server/file.server.js"],"names":["module","export","RocketChatFile","stream","link","default","v","fs","path","Meteor","MongoInternals","Grid","mkdirp","prototype","tryParseObjectId","bufferToStream","buffer","bufferStream","PassThrough","end","dataURIParse","dataURI","imageData","split","image","contentType","replace","addPassThrough","st","fn","pass","GridFS","constructor","config","name","transformWrite","mongo","NpmModule","db","defaultRemoteCollectionDriver","store","findOneSync","wrapAsync","collection","findOne","bind","removeSync","remove","countSync","_col","count","getFileSync","getFile","fileName","_id","root","createWriteStream","self","ws","filename","mode","content_type","rs","file","on","emit","createReadStream","getFileWithReadStream","readStream","length","uploadDate","cb","data","bindEnvironment","chunk","push","Buffer","concat","deleteFile","undefined","FileSystem","absolutePath","sep","homepath","process","env","HOME","HOMEPATH","USERPROFILE","Error","resolve","sync","statSync","stat","unlinkSync","unlink","join","size","error1"],"mappings":"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","sourcesContent":["import stream from 'stream';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { Meteor } from 'meteor/meteor';\nimport { MongoInternals } from 'meteor/mongo';\nimport Grid from 'gridfs-stream';\nimport mkdirp from 'mkdirp';\n\n// Fix problem with usernames being converted to object id\nGrid.prototype.tryParseObjectId = function () {\n\treturn false;\n};\n\nconst RocketChatFile = {};\n\nRocketChatFile.bufferToStream = function (buffer) {\n\tconst bufferStream = new stream.PassThrough();\n\tbufferStream.end(buffer);\n\treturn bufferStream;\n};\n\nRocketChatFile.dataURIParse = function (dataURI) {\n\tconst imageData = dataURI.split(';base64,');\n\treturn {\n\t\timage: imageData[1],\n\t\tcontentType: imageData[0].replace('data:', ''),\n\t};\n};\n\nRocketChatFile.addPassThrough = function (st, fn) {\n\tconst pass = new stream.PassThrough();\n\tfn(pass, st);\n\treturn pass;\n};\n\nRocketChatFile.GridFS = class {\n\tconstructor(config = {}) {\n\t\tconst { name = 'file', transformWrite } = config;\n\n\t\tthis.name = name;\n\t\tthis.transformWrite = transformWrite;\n\t\tconst mongo = MongoInternals.NpmModule;\n\t\tconst { db } = MongoInternals.defaultRemoteCollectionDriver().mongo;\n\t\tthis.store = new Grid(db, mongo);\n\t\tthis.findOneSync = Meteor.wrapAsync(this.store.collection(this.name).findOne.bind(this.store.collection(this.name)));\n\t\tthis.removeSync = Meteor.wrapAsync(this.store.remove.bind(this.store));\n\t\tthis.countSync = Meteor.wrapAsync(this.store._col.count.bind(this.store._col));\n\t\tthis.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n\t}\n\n\tfindOne(fileName) {\n\t\treturn this.findOneSync({\n\t\t\t_id: fileName,\n\t\t});\n\t}\n\n\tremove(fileName) {\n\t\treturn this.removeSync({\n\t\t\t_id: fileName,\n\t\t\troot: this.name,\n\t\t});\n\t}\n\n\tcreateWriteStream(fileName, contentType) {\n\t\tconst self = this;\n\t\tlet ws = this.store.createWriteStream({\n\t\t\t_id: fileName,\n\t\t\tfilename: fileName,\n\t\t\tmode: 'w',\n\t\t\troot: this.name,\n\t\t\tcontent_type: contentType,\n\t\t});\n\t\tif (self.transformWrite != null) {\n\t\t\tws = RocketChatFile.addPassThrough(ws, function (rs, ws) {\n\t\t\t\tconst file = {\n\t\t\t\t\tname: self.name,\n\t\t\t\t\tfileName,\n\t\t\t\t\tcontentType,\n\t\t\t\t};\n\t\t\t\treturn self.transformWrite(file, rs, ws);\n\t\t\t});\n\t\t}\n\t\tws.on('close', function () {\n\t\t\treturn ws.emit('end');\n\t\t});\n\t\treturn ws;\n\t}\n\n\tcreateReadStream(fileName) {\n\t\treturn this.store.createReadStream({\n\t\t\t_id: fileName,\n\t\t\troot: this.name,\n\t\t});\n\t}\n\n\tgetFileWithReadStream(fileName) {\n\t\tconst file = this.findOne(fileName);\n\t\tif (file == null) {\n\t\t\treturn null;\n\t\t}\n\t\tconst rs = this.createReadStream(fileName);\n\t\treturn {\n\t\t\treadStream: rs,\n\t\t\tcontentType: file.contentType,\n\t\t\tlength: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t};\n\t}\n\n\tgetFile(fileName, cb) {\n\t\tconst file = this.getFileWithReadStream(fileName);\n\t\tif (!file) {\n\t\t\treturn cb();\n\t\t}\n\t\tconst data = [];\n\t\tfile.readStream.on(\n\t\t\t'data',\n\t\t\tMeteor.bindEnvironment(function (chunk) {\n\t\t\t\treturn data.push(chunk);\n\t\t\t}),\n\t\t);\n\t\treturn file.readStream.on(\n\t\t\t'end',\n\t\t\tMeteor.bindEnvironment(function () {\n\t\t\t\treturn cb(null, {\n\t\t\t\t\tbuffer: Buffer.concat(data),\n\t\t\t\t\tcontentType: file.contentType,\n\t\t\t\t\tlength: file.length,\n\t\t\t\t\tuploadDate: file.uploadDate,\n\t\t\t\t});\n\t\t\t}),\n\t\t);\n\t}\n\n\tdeleteFile(fileName) {\n\t\tconst file = this.findOne(fileName);\n\t\tif (file == null) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.remove(fileName);\n\t}\n};\n\nRocketChatFile.FileSystem = class {\n\tconstructor(config = {}) {\n\t\tlet { absolutePath = '~/uploads' } = config;\n\t\tconst { transformWrite } = config;\n\n\t\tthis.transformWrite = transformWrite;\n\t\tif (absolutePath.split(path.sep)[0] === '~') {\n\t\t\tconst homepath = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;\n\t\t\tif (homepath != null) {\n\t\t\t\tabsolutePath = absolutePath.replace('~', homepath);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Unable to resolve \"~\" in path');\n\t\t\t}\n\t\t}\n\t\tthis.absolutePath = path.resolve(absolutePath);\n\t\tmkdirp.sync(this.absolutePath);\n\t\tthis.statSync = Meteor.wrapAsync(fs.stat.bind(fs));\n\t\tthis.unlinkSync = Meteor.wrapAsync(fs.unlink.bind(fs));\n\t\tthis.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n\t}\n\n\tcreateWriteStream(fileName, contentType) {\n\t\tconst self = this;\n\t\tlet ws = fs.createWriteStream(path.join(this.absolutePath, fileName));\n\t\tif (self.transformWrite != null) {\n\t\t\tws = RocketChatFile.addPassThrough(ws, function (rs, ws) {\n\t\t\t\tconst file = {\n\t\t\t\t\tfileName,\n\t\t\t\t\tcontentType,\n\t\t\t\t};\n\t\t\t\treturn self.transformWrite(file, rs, ws);\n\t\t\t});\n\t\t}\n\t\tws.on('close', function () {\n\t\t\treturn ws.emit('end');\n\t\t});\n\t\treturn ws;\n\t}\n\n\tcreateReadStream(fileName) {\n\t\treturn fs.createReadStream(path.join(this.absolutePath, fileName));\n\t}\n\n\tstat(fileName) {\n\t\treturn this.statSync(path.join(this.absolutePath, fileName));\n\t}\n\n\tremove(fileName) {\n\t\treturn this.unlinkSync(path.join(this.absolutePath, fileName));\n\t}\n\n\tgetFileWithReadStream(fileName) {\n\t\ttry {\n\t\t\tconst stat = this.stat(fileName);\n\t\t\tconst rs = this.createReadStream(fileName);\n\t\t\treturn {\n\t\t\t\treadStream: rs,\n\t\t\t\t// contentType: file.contentType\n\t\t\t\tlength: stat.size,\n\t\t\t};\n\t\t} catch (error1) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetFile(fileName, cb) {\n\t\tconst file = this.getFileWithReadStream(fileName);\n\t\tif (!file) {\n\t\t\treturn cb();\n\t\t}\n\t\tconst data = [];\n\t\tfile.readStream.on(\n\t\t\t'data',\n\t\t\tMeteor.bindEnvironment(function (chunk) {\n\t\t\t\treturn data.push(chunk);\n\t\t\t}),\n\t\t);\n\t\treturn file.readStream.on(\n\t\t\t'end',\n\t\t\tMeteor.bindEnvironment(function () {\n\t\t\t\treturn {\n\t\t\t\t\tbuffer: Buffer.concat(data)({\n\t\t\t\t\t\tcontentType: file.contentType,\n\t\t\t\t\t\tlength: file.length,\n\t\t\t\t\t\tuploadDate: file.uploadDate,\n\t\t\t\t\t}),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t}\n\n\tdeleteFile(fileName) {\n\t\ttry {\n\t\t\treturn this.remove(fileName);\n\t\t} catch (error1) {\n\t\t\treturn null;\n\t\t}\n\t}\n};\n\nexport { RocketChatFile };\n"]},"sourceType":"module","hash":"bd176a27ba66509e5586d25983d0eceba30aa8e6"}
