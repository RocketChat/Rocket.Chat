{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/importer/server/methods/downloadPublicImportFile.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/importer/server/methods/downloadPublicImportFile.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/importer/server/methods/downloadPublicImportFile.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/importer/server/methods/downloadPublicImportFile.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/importer/server/methods/downloadPublicImportFile.js"}},"code":"let http;\nmodule.link(\"http\", {\n  default(v) {\n    http = v;\n  }\n\n}, 0);\nlet https;\nmodule.link(\"https\", {\n  default(v) {\n    https = v;\n  }\n\n}, 1);\nlet fs;\nmodule.link(\"fs\", {\n  default(v) {\n    fs = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet RocketChatImportFileInstance;\nmodule.link(\"../startup/store\", {\n  RocketChatImportFileInstance(v) {\n    RocketChatImportFileInstance = v;\n  }\n\n}, 4);\nlet ProgressStep;\nmodule.link(\"../../lib/ImporterProgressStep\", {\n  ProgressStep(v) {\n    ProgressStep = v;\n  }\n\n}, 5);\nlet hasPermission;\nmodule.link(\"../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 6);\nlet Importers;\nmodule.link(\"..\", {\n  Importers(v) {\n    Importers = v;\n  }\n\n}, 7);\n\nfunction downloadHttpFile(fileUrl, writeStream) {\n  const protocol = fileUrl.startsWith('https') ? https : http;\n  protocol.get(fileUrl, function (response) {\n    response.pipe(writeStream);\n  });\n}\n\nfunction copyLocalFile(filePath, writeStream) {\n  const readStream = fs.createReadStream(filePath);\n  readStream.pipe(writeStream);\n}\n\nMeteor.methods({\n  downloadPublicImportFile(fileUrl, importerKey) {\n    const userId = Meteor.userId();\n\n    if (!userId) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'downloadPublicImportFile'\n      });\n    }\n\n    if (!hasPermission(userId, 'run-import')) {\n      throw new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', {\n        method: 'downloadPublicImportFile'\n      });\n    }\n\n    const importer = Importers.get(importerKey);\n\n    if (!importer) {\n      throw new Meteor.Error('error-importer-not-defined', \"The importer (\".concat(importerKey, \") has no import class defined.\"), {\n        method: 'downloadPublicImportFile'\n      });\n    }\n\n    const isUrl = fileUrl.startsWith('http'); // Check if it's a valid url or path before creating a new import record\n\n    if (!isUrl) {\n      if (!fs.existsSync(fileUrl)) {\n        throw new Meteor.Error('error-import-file-missing', fileUrl, {\n          method: 'downloadPublicImportFile'\n        });\n      }\n    }\n\n    importer.instance = new importer.importer(importer); // eslint-disable-line new-cap\n\n    const oldFileName = fileUrl.substring(fileUrl.lastIndexOf('/') + 1);\n    const date = new Date();\n    const dateStr = \"\".concat(date.getUTCFullYear()).concat(date.getUTCMonth()).concat(date.getUTCDate()).concat(date.getUTCHours()).concat(date.getUTCMinutes()).concat(date.getUTCSeconds());\n    const newFileName = \"\".concat(dateStr, \"_\").concat(userId, \"_\").concat(oldFileName); // Store the file name on the imports collection\n\n    importer.instance.startFileUpload(newFileName);\n    importer.instance.updateProgress(ProgressStep.DOWNLOADING_FILE);\n    const writeStream = RocketChatImportFileInstance.createWriteStream(newFileName);\n    writeStream.on('error', Meteor.bindEnvironment(() => {\n      importer.instance.updateProgress(ProgressStep.ERROR);\n    }));\n    writeStream.on('end', Meteor.bindEnvironment(() => {\n      importer.instance.updateProgress(ProgressStep.FILE_LOADED);\n    }));\n\n    if (isUrl) {\n      downloadHttpFile(fileUrl, writeStream);\n    } else {\n      // If the url is actually a folder path on the current machine, skip moving it to the file store\n      if (fs.statSync(fileUrl).isDirectory()) {\n        importer.instance.updateRecord({\n          file: fileUrl\n        });\n        importer.instance.updateProgress(ProgressStep.FILE_LOADED);\n        return;\n      }\n\n      copyLocalFile(fileUrl, writeStream);\n    }\n  }\n\n});","map":{"version":3,"sources":["app/importer/server/methods/downloadPublicImportFile.js"],"names":["http","module","link","default","v","https","fs","Meteor","RocketChatImportFileInstance","ProgressStep","hasPermission","Importers","downloadHttpFile","fileUrl","writeStream","protocol","startsWith","get","response","pipe","copyLocalFile","filePath","readStream","createReadStream","methods","downloadPublicImportFile","importerKey","userId","Error","method","importer","isUrl","existsSync","instance","oldFileName","substring","lastIndexOf","date","Date","dateStr","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","newFileName","startFileUpload","updateProgress","DOWNLOADING_FILE","createWriteStream","on","bindEnvironment","ERROR","FILE_LOADED","statSync","isDirectory","updateRecord","file"],"mappings":"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","sourcesContent":["import http from 'http';\nimport https from 'https';\nimport fs from 'fs';\n\nimport { Meteor } from 'meteor/meteor';\n\nimport { RocketChatImportFileInstance } from '../startup/store';\nimport { ProgressStep } from '../../lib/ImporterProgressStep';\nimport { hasPermission } from '../../../authorization';\nimport { Importers } from '..';\n\nfunction downloadHttpFile(fileUrl, writeStream) {\n\tconst protocol = fileUrl.startsWith('https') ? https : http;\n\tprotocol.get(fileUrl, function (response) {\n\t\tresponse.pipe(writeStream);\n\t});\n}\n\nfunction copyLocalFile(filePath, writeStream) {\n\tconst readStream = fs.createReadStream(filePath);\n\treadStream.pipe(writeStream);\n}\n\nMeteor.methods({\n\tdownloadPublicImportFile(fileUrl, importerKey) {\n\t\tconst userId = Meteor.userId();\n\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'downloadPublicImportFile',\n\t\t\t});\n\t\t}\n\n\t\tif (!hasPermission(userId, 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', {\n\t\t\t\tmethod: 'downloadPublicImportFile',\n\t\t\t});\n\t\t}\n\n\t\tconst importer = Importers.get(importerKey);\n\t\tif (!importer) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${importerKey}) has no import class defined.`, {\n\t\t\t\tmethod: 'downloadPublicImportFile',\n\t\t\t});\n\t\t}\n\n\t\tconst isUrl = fileUrl.startsWith('http');\n\n\t\t// Check if it's a valid url or path before creating a new import record\n\t\tif (!isUrl) {\n\t\t\tif (!fs.existsSync(fileUrl)) {\n\t\t\t\tthrow new Meteor.Error('error-import-file-missing', fileUrl, {\n\t\t\t\t\tmethod: 'downloadPublicImportFile',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\timporter.instance = new importer.importer(importer); // eslint-disable-line new-cap\n\n\t\tconst oldFileName = fileUrl.substring(fileUrl.lastIndexOf('/') + 1);\n\t\tconst date = new Date();\n\t\tconst dateStr = `${date.getUTCFullYear()}${date.getUTCMonth()}${date.getUTCDate()}${date.getUTCHours()}${date.getUTCMinutes()}${date.getUTCSeconds()}`;\n\t\tconst newFileName = `${dateStr}_${userId}_${oldFileName}`;\n\n\t\t// Store the file name on the imports collection\n\t\timporter.instance.startFileUpload(newFileName);\n\t\timporter.instance.updateProgress(ProgressStep.DOWNLOADING_FILE);\n\n\t\tconst writeStream = RocketChatImportFileInstance.createWriteStream(newFileName);\n\n\t\twriteStream.on(\n\t\t\t'error',\n\t\t\tMeteor.bindEnvironment(() => {\n\t\t\t\timporter.instance.updateProgress(ProgressStep.ERROR);\n\t\t\t}),\n\t\t);\n\n\t\twriteStream.on(\n\t\t\t'end',\n\t\t\tMeteor.bindEnvironment(() => {\n\t\t\t\timporter.instance.updateProgress(ProgressStep.FILE_LOADED);\n\t\t\t}),\n\t\t);\n\n\t\tif (isUrl) {\n\t\t\tdownloadHttpFile(fileUrl, writeStream);\n\t\t} else {\n\t\t\t// If the url is actually a folder path on the current machine, skip moving it to the file store\n\t\t\tif (fs.statSync(fileUrl).isDirectory()) {\n\t\t\t\timporter.instance.updateRecord({ file: fileUrl });\n\t\t\t\timporter.instance.updateProgress(ProgressStep.FILE_LOADED);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcopyLocalFile(fileUrl, writeStream);\n\t\t}\n\t},\n});\n"]},"sourceType":"module","hash":"388092dd8a10bab26fbaab24ad82fd114d9becb4"}
