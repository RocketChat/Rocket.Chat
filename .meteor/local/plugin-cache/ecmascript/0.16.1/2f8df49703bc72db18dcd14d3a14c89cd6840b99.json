{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/ee/app/livechat-enterprise/server/hooks/beforeRoutingChat.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"ee/app/livechat-enterprise/server/hooks/beforeRoutingChat.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/ee/app/livechat-enterprise/server/hooks/beforeRoutingChat.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/ee/app/livechat-enterprise/server/hooks/beforeRoutingChat.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/livechat-enterprise/server/hooks/beforeRoutingChat.js"}},"code":"let callbacks;\nmodule.link(\"../../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 0);\nlet settings;\nmodule.link(\"../../../../../app/settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 1);\nlet LivechatInquiry;\nmodule.link(\"../../../../../app/models/server\", {\n  LivechatInquiry(v) {\n    LivechatInquiry = v;\n  }\n\n}, 2);\nlet dispatchInquiryPosition;\nmodule.link(\"../lib/Helper\", {\n  dispatchInquiryPosition(v) {\n    dispatchInquiryPosition = v;\n  }\n\n}, 3);\nlet allowAgentSkipQueue;\nmodule.link(\"../../../../../app/livechat/server/lib/Helper\", {\n  allowAgentSkipQueue(v) {\n    allowAgentSkipQueue = v;\n  }\n\n}, 4);\nlet Livechat;\nmodule.link(\"../../../../../app/livechat/server/lib/Livechat\", {\n  Livechat(v) {\n    Livechat = v;\n  }\n\n}, 5);\nlet LivechatDepartment, LivechatInquiryRaw, LivechatRooms;\nmodule.link(\"../../../../../app/models/server/raw\", {\n  LivechatDepartment(v) {\n    LivechatDepartment = v;\n  },\n\n  LivechatInquiry(v) {\n    LivechatInquiryRaw = v;\n  },\n\n  LivechatRooms(v) {\n    LivechatRooms = v;\n  }\n\n}, 6);\nlet online;\nmodule.link(\"../../../../../app/livechat/server/api/lib/livechat\", {\n  online(v) {\n    online = v;\n  }\n\n}, 7);\nlet saveQueueInquiry;\nmodule.link(\"../../../../../app/livechat/server/lib/QueueManager\", {\n  saveQueueInquiry(v) {\n    saveQueueInquiry = v;\n  }\n\n}, 8);\nlet cbLogger;\nmodule.link(\"../lib/logger\", {\n  cbLogger(v) {\n    cbLogger = v;\n  }\n\n}, 9);\ncallbacks.add('livechat.beforeRouteChat', (inquiry, agent) => Promise.asyncApply(() => {\n  var _inquiry;\n\n  // check here if department has fallback before queueing\n  if ((_inquiry = inquiry) !== null && _inquiry !== void 0 && _inquiry.department && !online(inquiry.department, true, true)) {\n    cbLogger.debug('No agents online on selected department. Inquiry will use fallback department');\n    const department = Promise.await(LivechatDepartment.findOneById(inquiry.department));\n\n    if (department.fallbackForwardDepartment) {\n      var _inquiry2, _inquiry2$v;\n\n      cbLogger.debug(\"Inquiry \".concat(inquiry._id, \" will be moved from department \").concat(department._id, \" to fallback department \").concat(department.fallbackForwardDepartment)); // update visitor\n\n      Livechat.setDepartmentForGuest({\n        token: (_inquiry2 = inquiry) === null || _inquiry2 === void 0 ? void 0 : (_inquiry2$v = _inquiry2.v) === null || _inquiry2$v === void 0 ? void 0 : _inquiry2$v.token,\n        department: department.fallbackForwardDepartment\n      }); // update inquiry\n\n      inquiry = Promise.await(LivechatInquiryRaw.setDepartmentByInquiryId(inquiry._id, department.fallbackForwardDepartment)); // update room\n\n      Promise.await(LivechatRooms.setDepartmentByRoomId(inquiry.rid, department.fallbackForwardDepartment));\n      cbLogger.debug(\"Inquiry \".concat(inquiry._id, \" moved. Continue normal queue process\"));\n    } else {\n      cbLogger.debug('No fallback department configured. Skipping');\n    }\n  }\n\n  if (!settings.get('Livechat_waiting_queue')) {\n    cbLogger.debug('Skipping callback. Waiting queue disabled by setting');\n    return inquiry;\n  }\n\n  if (!inquiry) {\n    cbLogger.debug('Skipping callback. No inquiry provided');\n    return inquiry;\n  }\n\n  const {\n    _id,\n    status,\n    department\n  } = inquiry;\n\n  if (status !== 'ready') {\n    cbLogger.debug(\"Skipping callback. Inquiry \".concat(_id, \" is not ready\"));\n    return inquiry;\n  }\n\n  if (agent && allowAgentSkipQueue(agent)) {\n    cbLogger.debug(\"Skipping callback. Agent \".concat(agent.agentId, \" can skip queue\"));\n    return inquiry;\n  }\n\n  saveQueueInquiry(inquiry);\n\n  if (settings.get('Omnichannel_calculate_dispatch_service_queue_statistics')) {\n    const [inq] = Promise.await(LivechatInquiry.getCurrentSortedQueueAsync({\n      _id,\n      department\n    }));\n\n    if (inq) {\n      dispatchInquiryPosition(inq);\n      cbLogger.debug(\"Callback success. Inquiry \".concat(_id, \" position has been notified\"));\n    }\n  }\n\n  return LivechatInquiry.findOneById(_id);\n}), callbacks.priority.HIGH, 'livechat-before-routing-chat');","map":{"version":3,"sources":["ee/app/livechat-enterprise/server/hooks/beforeRoutingChat.js"],"names":["callbacks","module","link","v","settings","LivechatInquiry","dispatchInquiryPosition","allowAgentSkipQueue","Livechat","LivechatDepartment","LivechatInquiryRaw","LivechatRooms","online","saveQueueInquiry","cbLogger","add","inquiry","agent","department","debug","findOneById","fallbackForwardDepartment","_id","setDepartmentForGuest","token","setDepartmentByInquiryId","setDepartmentByRoomId","rid","get","status","agentId","inq","getCurrentSortedQueueAsync","priority","HIGH"],"mappings":"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","sourcesContent":["import { callbacks } from '../../../../../lib/callbacks';\nimport { settings } from '../../../../../app/settings/server';\nimport { LivechatInquiry } from '../../../../../app/models/server';\nimport { dispatchInquiryPosition } from '../lib/Helper';\nimport { allowAgentSkipQueue } from '../../../../../app/livechat/server/lib/Helper';\nimport { Livechat } from '../../../../../app/livechat/server/lib/Livechat';\nimport { LivechatDepartment, LivechatInquiry as LivechatInquiryRaw, LivechatRooms } from '../../../../../app/models/server/raw';\nimport { online } from '../../../../../app/livechat/server/api/lib/livechat';\nimport { saveQueueInquiry } from '../../../../../app/livechat/server/lib/QueueManager';\nimport { cbLogger } from '../lib/logger';\n\ncallbacks.add(\n\t'livechat.beforeRouteChat',\n\tasync (inquiry, agent) => {\n\t\t// check here if department has fallback before queueing\n\t\tif (inquiry?.department && !online(inquiry.department, true, true)) {\n\t\t\tcbLogger.debug('No agents online on selected department. Inquiry will use fallback department');\n\t\t\tconst department = await LivechatDepartment.findOneById(inquiry.department);\n\t\t\tif (department.fallbackForwardDepartment) {\n\t\t\t\tcbLogger.debug(\n\t\t\t\t\t`Inquiry ${inquiry._id} will be moved from department ${department._id} to fallback department ${department.fallbackForwardDepartment}`,\n\t\t\t\t);\n\t\t\t\t// update visitor\n\t\t\t\tLivechat.setDepartmentForGuest({\n\t\t\t\t\ttoken: inquiry?.v?.token,\n\t\t\t\t\tdepartment: department.fallbackForwardDepartment,\n\t\t\t\t});\n\t\t\t\t// update inquiry\n\t\t\t\tinquiry = await LivechatInquiryRaw.setDepartmentByInquiryId(inquiry._id, department.fallbackForwardDepartment);\n\t\t\t\t// update room\n\t\t\t\tawait LivechatRooms.setDepartmentByRoomId(inquiry.rid, department.fallbackForwardDepartment);\n\t\t\t\tcbLogger.debug(`Inquiry ${inquiry._id} moved. Continue normal queue process`);\n\t\t\t} else {\n\t\t\t\tcbLogger.debug('No fallback department configured. Skipping');\n\t\t\t}\n\t\t}\n\n\t\tif (!settings.get('Livechat_waiting_queue')) {\n\t\t\tcbLogger.debug('Skipping callback. Waiting queue disabled by setting');\n\t\t\treturn inquiry;\n\t\t}\n\n\t\tif (!inquiry) {\n\t\t\tcbLogger.debug('Skipping callback. No inquiry provided');\n\t\t\treturn inquiry;\n\t\t}\n\n\t\tconst { _id, status, department } = inquiry;\n\n\t\tif (status !== 'ready') {\n\t\t\tcbLogger.debug(`Skipping callback. Inquiry ${_id} is not ready`);\n\t\t\treturn inquiry;\n\t\t}\n\n\t\tif (agent && allowAgentSkipQueue(agent)) {\n\t\t\tcbLogger.debug(`Skipping callback. Agent ${agent.agentId} can skip queue`);\n\t\t\treturn inquiry;\n\t\t}\n\n\t\tsaveQueueInquiry(inquiry);\n\n\t\tif (settings.get('Omnichannel_calculate_dispatch_service_queue_statistics')) {\n\t\t\tconst [inq] = await LivechatInquiry.getCurrentSortedQueueAsync({ _id, department });\n\t\t\tif (inq) {\n\t\t\t\tdispatchInquiryPosition(inq);\n\t\t\t\tcbLogger.debug(`Callback success. Inquiry ${_id} position has been notified`);\n\t\t\t}\n\t\t}\n\n\t\treturn LivechatInquiry.findOneById(_id);\n\t},\n\tcallbacks.priority.HIGH,\n\t'livechat-before-routing-chat',\n);\n"]},"sourceType":"module","hash":"2f8df49703bc72db18dcd14d3a14c89cd6840b99"}
