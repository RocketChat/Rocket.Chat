{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/cloud/server/functions/getUserCloudAccessToken.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/cloud/server/functions/getUserCloudAccessToken.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/cloud/server/functions/getUserCloudAccessToken.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/cloud/server/functions/getUserCloudAccessToken.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/cloud/server/functions/getUserCloudAccessToken.js"}},"code":"module.export({\n  getUserCloudAccessToken: () => getUserCloudAccessToken\n});\nlet HTTP;\nmodule.link(\"meteor/http\", {\n  HTTP(v) {\n    HTTP = v;\n  }\n\n}, 0);\nlet getRedirectUri;\nmodule.link(\"./getRedirectUri\", {\n  getRedirectUri(v) {\n    getRedirectUri = v;\n  }\n\n}, 1);\nlet retrieveRegistrationStatus;\nmodule.link(\"./retrieveRegistrationStatus\", {\n  retrieveRegistrationStatus(v) {\n    retrieveRegistrationStatus = v;\n  }\n\n}, 2);\nlet unregisterWorkspace;\nmodule.link(\"./unregisterWorkspace\", {\n  unregisterWorkspace(v) {\n    unregisterWorkspace = v;\n  }\n\n}, 3);\nlet userLoggedOut;\nmodule.link(\"./userLoggedOut\", {\n  userLoggedOut(v) {\n    userLoggedOut = v;\n  }\n\n}, 4);\nlet Users;\nmodule.link(\"../../../models\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 5);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 6);\nlet userScopes;\nmodule.link(\"../oauthScopes\", {\n  userScopes(v) {\n    userScopes = v;\n  }\n\n}, 7);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 8);\n\nfunction getUserCloudAccessToken(userId) {\n  let forceNew = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n  let scope = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';\n  let save = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n  const {\n    connectToCloud,\n    workspaceRegistered\n  } = retrieveRegistrationStatus();\n\n  if (!connectToCloud || !workspaceRegistered) {\n    return '';\n  }\n\n  if (!userId) {\n    return '';\n  }\n\n  const user = Users.findOneById(userId);\n\n  if (!user || !user.services || !user.services.cloud || !user.services.cloud.accessToken || !user.services.cloud.refreshToken) {\n    return '';\n  }\n\n  const {\n    accessToken,\n    refreshToken\n  } = user.services.cloud;\n  const client_id = settings.get('Cloud_Workspace_Client_Id');\n\n  if (!client_id) {\n    return '';\n  }\n\n  const expires = user.services.cloud.expiresAt;\n  const now = new Date();\n\n  if (now < expires.value && !forceNew) {\n    return accessToken;\n  }\n\n  const cloudUrl = settings.get('Cloud_Url');\n  const client_secret = settings.get('Cloud_Workspace_Client_Secret');\n  const redirectUri = getRedirectUri();\n\n  if (scope === '') {\n    scope = userScopes.join(' ');\n  }\n\n  let authTokenResult;\n\n  try {\n    authTokenResult = HTTP.post(\"\".concat(cloudUrl, \"/api/oauth/token\"), {\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded'\n      },\n      params: {\n        client_id,\n        client_secret,\n        refresh_token: refreshToken,\n        scope,\n        grant_type: 'refresh_token',\n        redirect_uri: redirectUri\n      }\n    });\n  } catch (e) {\n    if (e.response && e.response.data && e.response.data.error) {\n      SystemLogger.error(\"Failed to get User AccessToken from Rocket.Chat Cloud.  Error: \".concat(e.response.data.error));\n\n      if (e.response.data.error === 'oauth_invalid_client_credentials') {\n        SystemLogger.error('Server has been unregistered from cloud');\n        unregisterWorkspace();\n      }\n\n      if (e.response.data.error === 'unauthorized') {\n        userLoggedOut(userId);\n      }\n    } else {\n      SystemLogger.error(e);\n    }\n\n    return '';\n  }\n\n  if (save) {\n    const expiresAt = new Date();\n    expiresAt.setSeconds(expiresAt.getSeconds() + authTokenResult.data.expires_in);\n    Users.update(user._id, {\n      $set: {\n        services: {\n          cloud: {\n            accessToken: authTokenResult.data.access_token,\n            expiresAt\n          }\n        }\n      }\n    });\n  }\n\n  return authTokenResult.data.access_token;\n}","map":{"version":3,"sources":["app/cloud/server/functions/getUserCloudAccessToken.js"],"names":["module","export","getUserCloudAccessToken","HTTP","link","v","getRedirectUri","retrieveRegistrationStatus","unregisterWorkspace","userLoggedOut","Users","settings","userScopes","SystemLogger","userId","forceNew","scope","save","connectToCloud","workspaceRegistered","user","findOneById","services","cloud","accessToken","refreshToken","client_id","get","expires","expiresAt","now","Date","value","cloudUrl","client_secret","redirectUri","join","authTokenResult","post","headers","params","refresh_token","grant_type","redirect_uri","e","response","data","error","setSeconds","getSeconds","expires_in","update","_id","$set","access_token"],"mappings":"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","sourcesContent":["import { HTTP } from 'meteor/http';\n\nimport { getRedirectUri } from './getRedirectUri';\nimport { retrieveRegistrationStatus } from './retrieveRegistrationStatus';\nimport { unregisterWorkspace } from './unregisterWorkspace';\nimport { userLoggedOut } from './userLoggedOut';\nimport { Users } from '../../../models';\nimport { settings } from '../../../settings';\nimport { userScopes } from '../oauthScopes';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\n\nexport function getUserCloudAccessToken(userId, forceNew = false, scope = '', save = true) {\n\tconst { connectToCloud, workspaceRegistered } = retrieveRegistrationStatus();\n\n\tif (!connectToCloud || !workspaceRegistered) {\n\t\treturn '';\n\t}\n\n\tif (!userId) {\n\t\treturn '';\n\t}\n\n\tconst user = Users.findOneById(userId);\n\n\tif (!user || !user.services || !user.services.cloud || !user.services.cloud.accessToken || !user.services.cloud.refreshToken) {\n\t\treturn '';\n\t}\n\n\tconst { accessToken, refreshToken } = user.services.cloud;\n\n\tconst client_id = settings.get('Cloud_Workspace_Client_Id');\n\tif (!client_id) {\n\t\treturn '';\n\t}\n\n\tconst expires = user.services.cloud.expiresAt;\n\tconst now = new Date();\n\n\tif (now < expires.value && !forceNew) {\n\t\treturn accessToken;\n\t}\n\n\tconst cloudUrl = settings.get('Cloud_Url');\n\tconst client_secret = settings.get('Cloud_Workspace_Client_Secret');\n\tconst redirectUri = getRedirectUri();\n\n\tif (scope === '') {\n\t\tscope = userScopes.join(' ');\n\t}\n\n\tlet authTokenResult;\n\ttry {\n\t\tauthTokenResult = HTTP.post(`${cloudUrl}/api/oauth/token`, {\n\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\n\t\t\tparams: {\n\t\t\t\tclient_id,\n\t\t\t\tclient_secret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tscope,\n\t\t\t\tgrant_type: 'refresh_token',\n\t\t\t\tredirect_uri: redirectUri,\n\t\t\t},\n\t\t});\n\t} catch (e) {\n\t\tif (e.response && e.response.data && e.response.data.error) {\n\t\t\tSystemLogger.error(`Failed to get User AccessToken from Rocket.Chat Cloud.  Error: ${e.response.data.error}`);\n\n\t\t\tif (e.response.data.error === 'oauth_invalid_client_credentials') {\n\t\t\t\tSystemLogger.error('Server has been unregistered from cloud');\n\t\t\t\tunregisterWorkspace();\n\t\t\t}\n\n\t\t\tif (e.response.data.error === 'unauthorized') {\n\t\t\t\tuserLoggedOut(userId);\n\t\t\t}\n\t\t} else {\n\t\t\tSystemLogger.error(e);\n\t\t}\n\n\t\treturn '';\n\t}\n\n\tif (save) {\n\t\tconst expiresAt = new Date();\n\t\texpiresAt.setSeconds(expiresAt.getSeconds() + authTokenResult.data.expires_in);\n\n\t\tUsers.update(user._id, {\n\t\t\t$set: {\n\t\t\t\tservices: {\n\t\t\t\t\tcloud: {\n\t\t\t\t\t\taccessToken: authTokenResult.data.access_token,\n\t\t\t\t\t\texpiresAt,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\treturn authTokenResult.data.access_token;\n}\n"]},"sourceType":"module","hash":"9754c1c711c904c7fc2f53d9de93b4afc3ef44ee"}
