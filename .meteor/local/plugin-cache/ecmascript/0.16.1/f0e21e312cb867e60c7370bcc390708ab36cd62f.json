{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/packages/oauth1/oauth1_server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/oauth1/oauth1_server.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/packages/oauth1/oauth1_server.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/packages/oauth1/oauth1_server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/oauth1/oauth1_server.js"}},"code":"!function (module1) {\n  let _objectSpread;\n\n  module1.link(\"@babel/runtime/helpers/objectSpread2\", {\n    default(v) {\n      _objectSpread = v;\n    }\n\n  }, 0);\n  let url;\n  module1.link(\"url\", {\n    default(v) {\n      url = v;\n    }\n\n  }, 0);\n  let OAuth1Binding;\n  module1.link(\"./oauth1_binding\", {\n    OAuth1Binding(v) {\n      OAuth1Binding = v;\n    }\n\n  }, 1);\n\n  OAuth._queryParamsWithAuthTokenUrl = function (authUrl, oauthBinding) {\n    let params = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    let whitelistedQueryParams = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : [];\n    const redirectUrlObj = url.parse(authUrl, true);\n    Object.assign(redirectUrlObj.query, whitelistedQueryParams.reduce((prev, param) => params.query[param] ? _objectSpread(_objectSpread({}, prev), {}, {\n      param: params.query[param]\n    }) : prev, {}), {\n      oauth_token: oauthBinding.requestToken\n    }); // Clear the `search` so it is rebuilt by Node's `url` from the `query` above.\n    // Using previous versions of the Node `url` module, this was just set to \"\"\n    // However, Node 6 docs seem to indicate that this should be `undefined`.\n\n    delete redirectUrlObj.search; // Reconstruct the URL back with provided query parameters merged with oauth_token\n\n    return url.format(redirectUrlObj);\n  }; // connect middleware\n\n\n  OAuth._requestHandlers['1'] = (service, query, res) => {\n    const config = ServiceConfiguration.configurations.findOne({\n      service: service.serviceName\n    });\n\n    if (!config) {\n      throw new ServiceConfiguration.ConfigError(service.serviceName);\n    }\n\n    const {\n      urls\n    } = service;\n    const oauthBinding = new OAuth1Binding(config, urls);\n    let credentialSecret;\n\n    if (query.requestTokenAndRedirect) {\n      // step 1 - get and store a request token\n      const callbackUrl = OAuth._redirectUri(service.serviceName, config, {\n        state: query.state,\n        cordova: query.cordova === \"true\",\n        android: query.android === \"true\"\n      }); // Get a request token to start auth process\n\n\n      oauthBinding.prepareRequestToken(callbackUrl); // Keep track of request token so we can verify it on the next step\n\n      OAuth._storeRequestToken(OAuth._credentialTokenFromQuery(query), oauthBinding.requestToken, oauthBinding.requestTokenSecret); // support for scope/name parameters\n\n\n      let redirectUrl;\n      const authParams = {\n        query\n      };\n\n      if (typeof urls.authenticate === \"function\") {\n        redirectUrl = urls.authenticate(oauthBinding, authParams);\n      } else {\n        redirectUrl = OAuth._queryParamsWithAuthTokenUrl(urls.authenticate, oauthBinding, authParams);\n      } // redirect to provider login, which will redirect back to \"step 2\" below\n\n\n      res.writeHead(302, {\n        'Location': redirectUrl\n      });\n      res.end();\n    } else {\n      // step 2, redirected from provider login - store the result\n      // and close the window to allow the login handler to proceed\n      // Get the user's request token so we can verify it and clear it\n      const requestTokenInfo = OAuth._retrieveRequestToken(OAuth._credentialTokenFromQuery(query));\n\n      if (!requestTokenInfo) {\n        throw new Error(\"Unable to retrieve request token\");\n      } // Verify user authorized access and the oauth_token matches\n      // the requestToken from previous step\n\n\n      if (query.oauth_token && query.oauth_token === requestTokenInfo.requestToken) {\n        // Prepare the login results before returning.  This way the\n        // subsequent call to the `login` method will be immediate.\n        // Get the access token for signing requests\n        oauthBinding.prepareAccessToken(query, requestTokenInfo.requestTokenSecret); // Run service-specific handler.\n\n        const oauthResult = service.handleOauthRequest(oauthBinding, {\n          query: query\n        });\n\n        const credentialToken = OAuth._credentialTokenFromQuery(query);\n\n        credentialSecret = Random.secret(); // Store the login result so it can be retrieved in another\n        // browser tab by the result handler\n\n        OAuth._storePendingCredential(credentialToken, {\n          serviceName: service.serviceName,\n          serviceData: oauthResult.serviceData,\n          options: oauthResult.options\n        }, credentialSecret);\n      } // Either close the window, redirect, or render nothing\n      // if all else fails\n\n\n      OAuth._renderOauthResults(res, query, credentialSecret);\n    }\n  };\n}.call(this, module);","map":{"version":3,"sources":["packages/oauth1/oauth1_server.js"],"names":["_objectSpread","module1","link","default","v","url","OAuth1Binding","OAuth","_queryParamsWithAuthTokenUrl","authUrl","oauthBinding","params","whitelistedQueryParams","redirectUrlObj","parse","Object","assign","query","reduce","prev","param","oauth_token","requestToken","search","format","_requestHandlers","service","res","config","ServiceConfiguration","configurations","findOne","serviceName","ConfigError","urls","credentialSecret","requestTokenAndRedirect","callbackUrl","_redirectUri","state","cordova","android","prepareRequestToken","_storeRequestToken","_credentialTokenFromQuery","requestTokenSecret","redirectUrl","authParams","authenticate","writeHead","end","requestTokenInfo","_retrieveRequestToken","Error","prepareAccessToken","oauthResult","handleOauthRequest","credentialToken","Random","secret","_storePendingCredential","serviceData","options","_renderOauthResults"],"mappings":"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","sourcesContent":["import url from 'url';\nimport { OAuth1Binding } from './oauth1_binding';\n\nOAuth._queryParamsWithAuthTokenUrl = (authUrl, oauthBinding, params = {}, whitelistedQueryParams = []) => {\n  const redirectUrlObj = url.parse(authUrl, true);\n\n  Object.assign(\n    redirectUrlObj.query,\n    whitelistedQueryParams.reduce((prev, param) => \n      params.query[param] ? { ...prev, param: params.query[param] } : prev,\n      {}\n    ),\n    {\n      oauth_token: oauthBinding.requestToken,\n    }\n  );\n\n  // Clear the `search` so it is rebuilt by Node's `url` from the `query` above.\n  // Using previous versions of the Node `url` module, this was just set to \"\"\n  // However, Node 6 docs seem to indicate that this should be `undefined`.\n  delete redirectUrlObj.search;\n\n  // Reconstruct the URL back with provided query parameters merged with oauth_token\n  return url.format(redirectUrlObj);\n};\n\n// connect middleware\nOAuth._requestHandlers['1'] = (service, query, res) => {\n  const config = ServiceConfiguration.configurations.findOne({service: service.serviceName});\n  if (! config) {\n    throw new ServiceConfiguration.ConfigError(service.serviceName);\n  }\n\n  const { urls } = service;\n  const oauthBinding = new OAuth1Binding(config, urls);\n\n  let credentialSecret;\n\n  if (query.requestTokenAndRedirect) {\n    // step 1 - get and store a request token\n    const callbackUrl = OAuth._redirectUri(service.serviceName, config, {\n      state: query.state,\n      cordova: (query.cordova === \"true\"),\n      android: (query.android === \"true\")\n    });\n\n    // Get a request token to start auth process\n    oauthBinding.prepareRequestToken(callbackUrl);\n\n    // Keep track of request token so we can verify it on the next step\n    OAuth._storeRequestToken(\n      OAuth._credentialTokenFromQuery(query),\n      oauthBinding.requestToken,\n      oauthBinding.requestTokenSecret);\n\n    // support for scope/name parameters\n    let redirectUrl;\n    const authParams = { query };\n\n    if(typeof urls.authenticate === \"function\") {\n      redirectUrl = urls.authenticate(oauthBinding, authParams);\n    } else {\n      redirectUrl = OAuth._queryParamsWithAuthTokenUrl(\n        urls.authenticate,\n        oauthBinding,\n        authParams\n      );\n    }\n\n    // redirect to provider login, which will redirect back to \"step 2\" below\n\n    res.writeHead(302, {'Location': redirectUrl});\n    res.end();\n  } else {\n    // step 2, redirected from provider login - store the result\n    // and close the window to allow the login handler to proceed\n\n    // Get the user's request token so we can verify it and clear it\n    const requestTokenInfo = OAuth._retrieveRequestToken(\n      OAuth._credentialTokenFromQuery(query));\n\n    if (! requestTokenInfo) {\n      throw new Error(\"Unable to retrieve request token\");\n    }\n\n    // Verify user authorized access and the oauth_token matches\n    // the requestToken from previous step\n    if (query.oauth_token && query.oauth_token === requestTokenInfo.requestToken) {\n\n      // Prepare the login results before returning.  This way the\n      // subsequent call to the `login` method will be immediate.\n\n      // Get the access token for signing requests\n      oauthBinding.prepareAccessToken(query, requestTokenInfo.requestTokenSecret);\n\n      // Run service-specific handler.\n      const oauthResult = service.handleOauthRequest(\n        oauthBinding, { query: query });\n\n      const credentialToken = OAuth._credentialTokenFromQuery(query);\n      credentialSecret = Random.secret();\n\n      // Store the login result so it can be retrieved in another\n      // browser tab by the result handler\n      OAuth._storePendingCredential(credentialToken, {\n        serviceName: service.serviceName,\n        serviceData: oauthResult.serviceData,\n        options: oauthResult.options\n      }, credentialSecret);\n    }\n\n    // Either close the window, redirect, or render nothing\n    // if all else fails\n    OAuth._renderOauthResults(res, query, credentialSecret);\n  }\n};\n"]},"sourceType":"module","hash":"f0e21e312cb867e60c7370bcc390708ab36cd62f"}
