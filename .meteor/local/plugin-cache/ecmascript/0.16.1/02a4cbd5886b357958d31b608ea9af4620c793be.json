{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/cors/server/cors.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/cors/server/cors.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/cors/server/cors.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/cors/server/cors.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/cors/server/cors.js"}},"code":"let url;\nmodule.link(\"url\", {\n  default(v) {\n    url = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet WebApp, WebAppInternals;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  },\n\n  WebAppInternals(v) {\n    WebAppInternals = v;\n  }\n\n}, 2);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 3);\nlet settings;\nmodule.link(\"../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 4);\nlet Logger;\nmodule.link(\"../../logger\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 5);\nconst logger = new Logger('CORS');\nsettings.watch('Enable_CSP', enabled => {\n  WebAppInternals.setInlineScriptsAllowed(!enabled);\n});\nWebApp.rawConnectHandlers.use(function (req, res, next) {\n  // XSS Protection for old browsers (IE)\n  res.setHeader('X-XSS-Protection', '1'); // X-Content-Type-Options header to prevent MIME Sniffing\n\n  res.setHeader('X-Content-Type-Options', 'nosniff');\n\n  if (settings.get('Iframe_Restrict_Access')) {\n    res.setHeader('X-Frame-Options', settings.get('Iframe_X_Frame_Options'));\n  }\n\n  if (settings.get('Enable_CSP')) {\n    const cdn_prefixes = [settings.get('CDN_PREFIX'), settings.get('CDN_PREFIX_ALL') ? null : settings.get('CDN_JSCSS_PREFIX')].filter(Boolean).join(' ');\n    const inlineHashes = [// Hash for `window.close()`, required by the CAS login popup.\n    \"'sha256-jqxtvDkBbRAl9Hpqv68WdNOieepg8tJSYu1xIy7zT34='\"].filter(Boolean).join(' ');\n    const external = [settings.get('Accounts_OAuth_Apple') && 'https://appleid.cdn-apple.com'].filter(Boolean).join(' ');\n    res.setHeader('Content-Security-Policy', [\"default-src 'self' \".concat(cdn_prefixes), 'connect-src *', \"font-src 'self' \".concat(cdn_prefixes, \" data:\"), 'frame-src *', 'img-src * data: blob:', 'media-src * data:', \"script-src 'self' 'unsafe-eval' \".concat(inlineHashes, \" \").concat(cdn_prefixes, \" \").concat(external), \"style-src 'self' 'unsafe-inline' \".concat(cdn_prefixes)].join('; '));\n  }\n\n  return next();\n});\nconst _staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function (staticFiles, req, res, next) {\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  return _staticFilesMiddleware(staticFiles, req, res, next);\n};\n\nconst oldHttpServerListeners = WebApp.httpServer.listeners('request').slice(0);\nWebApp.httpServer.removeAllListeners('request');\nWebApp.httpServer.addListener('request', function (req, res) {\n  for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n    args[_key - 2] = arguments[_key];\n  }\n\n  const next = () => {\n    for (const oldListener of oldHttpServerListeners) {\n      oldListener.apply(WebApp.httpServer, [req, res, ...args]);\n    }\n  };\n\n  if (settings.get('Force_SSL') !== true) {\n    next();\n    return;\n  }\n\n  const remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;\n  const localhostRegexp = /^\\s*(127\\.0\\.0\\.1|::1)\\s*$/;\n\n  const localhostTest = function (x) {\n    return localhostRegexp.test(x);\n  };\n\n  const isLocal = localhostRegexp.test(remoteAddress) && (!req.headers['x-forwarded-for'] || _.all(req.headers['x-forwarded-for'].split(','), localhostTest));\n\n  const isSsl = req.connection.pair || req.headers['x-forwarded-proto'] && req.headers['x-forwarded-proto'].indexOf('https') !== -1;\n  logger.debug('req.url', req.url);\n  logger.debug('remoteAddress', remoteAddress);\n  logger.debug('isLocal', isLocal);\n  logger.debug('isSsl', isSsl);\n  logger.debug('req.headers', req.headers);\n\n  if (!isLocal && !isSsl) {\n    let host = req.headers.host || url.parse(Meteor.absoluteUrl()).hostname;\n    host = host.replace(/:\\d+$/, '');\n    res.writeHead(302, {\n      Location: \"https://\".concat(host).concat(req.url)\n    });\n    res.end();\n    return;\n  }\n\n  return next();\n});","map":{"version":3,"sources":["app/cors/server/cors.js"],"names":["url","module","link","default","v","Meteor","WebApp","WebAppInternals","_","settings","Logger","logger","watch","enabled","setInlineScriptsAllowed","rawConnectHandlers","use","req","res","next","setHeader","get","cdn_prefixes","filter","Boolean","join","inlineHashes","external","_staticFilesMiddleware","staticFilesMiddleware","staticFiles","oldHttpServerListeners","httpServer","listeners","slice","removeAllListeners","addListener","args","oldListener","apply","remoteAddress","connection","socket","localhostRegexp","localhostTest","x","test","isLocal","headers","all","split","isSsl","pair","indexOf","debug","host","parse","absoluteUrl","hostname","replace","writeHead","Location","end"],"mappings":"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","sourcesContent":["import url from 'url';\n\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp, WebAppInternals } from 'meteor/webapp';\nimport _ from 'underscore';\n\nimport { settings } from '../../settings/server';\nimport { Logger } from '../../logger';\n\nconst logger = new Logger('CORS');\n\nsettings.watch('Enable_CSP', (enabled) => {\n\tWebAppInternals.setInlineScriptsAllowed(!enabled);\n});\n\nWebApp.rawConnectHandlers.use(function (req, res, next) {\n\t// XSS Protection for old browsers (IE)\n\tres.setHeader('X-XSS-Protection', '1');\n\n\t// X-Content-Type-Options header to prevent MIME Sniffing\n\tres.setHeader('X-Content-Type-Options', 'nosniff');\n\n\tif (settings.get('Iframe_Restrict_Access')) {\n\t\tres.setHeader('X-Frame-Options', settings.get('Iframe_X_Frame_Options'));\n\t}\n\n\tif (settings.get('Enable_CSP')) {\n\t\tconst cdn_prefixes = [settings.get('CDN_PREFIX'), settings.get('CDN_PREFIX_ALL') ? null : settings.get('CDN_JSCSS_PREFIX')]\n\t\t\t.filter(Boolean)\n\t\t\t.join(' ');\n\n\t\tconst inlineHashes = [\n\t\t\t// Hash for `window.close()`, required by the CAS login popup.\n\t\t\t\"'sha256-jqxtvDkBbRAl9Hpqv68WdNOieepg8tJSYu1xIy7zT34='\",\n\t\t]\n\t\t\t.filter(Boolean)\n\t\t\t.join(' ');\n\t\tconst external = [settings.get('Accounts_OAuth_Apple') && 'https://appleid.cdn-apple.com'].filter(Boolean).join(' ');\n\t\tres.setHeader(\n\t\t\t'Content-Security-Policy',\n\t\t\t[\n\t\t\t\t`default-src 'self' ${cdn_prefixes}`,\n\t\t\t\t'connect-src *',\n\t\t\t\t`font-src 'self' ${cdn_prefixes} data:`,\n\t\t\t\t'frame-src *',\n\t\t\t\t'img-src * data: blob:',\n\t\t\t\t'media-src * data:',\n\t\t\t\t`script-src 'self' 'unsafe-eval' ${inlineHashes} ${cdn_prefixes} ${external}`,\n\t\t\t\t`style-src 'self' 'unsafe-inline' ${cdn_prefixes}`,\n\t\t\t].join('; '),\n\t\t);\n\t}\n\n\treturn next();\n});\n\nconst _staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function (staticFiles, req, res, next) {\n\tres.setHeader('Access-Control-Allow-Origin', '*');\n\treturn _staticFilesMiddleware(staticFiles, req, res, next);\n};\n\nconst oldHttpServerListeners = WebApp.httpServer.listeners('request').slice(0);\n\nWebApp.httpServer.removeAllListeners('request');\n\nWebApp.httpServer.addListener('request', function (req, res, ...args) {\n\tconst next = () => {\n\t\tfor (const oldListener of oldHttpServerListeners) {\n\t\t\toldListener.apply(WebApp.httpServer, [req, res, ...args]);\n\t\t}\n\t};\n\n\tif (settings.get('Force_SSL') !== true) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;\n\tconst localhostRegexp = /^\\s*(127\\.0\\.0\\.1|::1)\\s*$/;\n\tconst localhostTest = function (x) {\n\t\treturn localhostRegexp.test(x);\n\t};\n\n\tconst isLocal =\n\t\tlocalhostRegexp.test(remoteAddress) &&\n\t\t(!req.headers['x-forwarded-for'] || _.all(req.headers['x-forwarded-for'].split(','), localhostTest));\n\tconst isSsl = req.connection.pair || (req.headers['x-forwarded-proto'] && req.headers['x-forwarded-proto'].indexOf('https') !== -1);\n\n\tlogger.debug('req.url', req.url);\n\tlogger.debug('remoteAddress', remoteAddress);\n\tlogger.debug('isLocal', isLocal);\n\tlogger.debug('isSsl', isSsl);\n\tlogger.debug('req.headers', req.headers);\n\n\tif (!isLocal && !isSsl) {\n\t\tlet host = req.headers.host || url.parse(Meteor.absoluteUrl()).hostname;\n\t\thost = host.replace(/:\\d+$/, '');\n\t\tres.writeHead(302, {\n\t\t\tLocation: `https://${host}${req.url}`,\n\t\t});\n\t\tres.end();\n\t\treturn;\n\t}\n\n\treturn next();\n});\n"]},"sourceType":"module","hash":"02a4cbd5886b357958d31b608ea9af4620c793be"}
