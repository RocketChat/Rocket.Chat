{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/upsert.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/matb33:collection-hooks/upsert.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/upsert.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/upsert.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/matb33:collection-hooks/upsert.js"}},"code":"var _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 0);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 1);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 0);\nvar CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks: function (v) {\n    CollectionHooks = v;\n  }\n}, 1);\n\nvar isEmpty = function (a) {\n  return !Array.isArray(a) || !a.length;\n};\n\nCollectionHooks.defineAdvice('upsert', function (userId, _super, instance, aspectGroup, getTransform, args, suppressAspects) {\n  var _this = this;\n\n  args[0] = CollectionHooks.normalizeSelector(instance._getFindSelector(args));\n  var ctx = {\n    context: this,\n    _super: _super,\n    args: args\n  };\n\n  var _args = _slicedToArray(args, 4),\n      selector = _args[0],\n      mutator = _args[1],\n      options = _args[2],\n      callback = _args[3];\n\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  var async = typeof callback === 'function';\n  var docs;\n  var docIds;\n  var abort;\n  var prev = {};\n\n  if (!suppressAspects) {\n    if (!isEmpty(aspectGroup.upsert.before) || !isEmpty(aspectGroup.update.after)) {\n      docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch();\n      docIds = docs.map(function (doc) {\n        return doc._id;\n      });\n    } // copy originals for convenience for the 'after' pointcut\n\n\n    if (!isEmpty(aspectGroup.update.after)) {\n      if (aspectGroup.update.after.some(function (o) {\n        return o.options.fetchPrevious !== false;\n      }) && CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n        prev.mutator = EJSON.clone(mutator);\n        prev.options = EJSON.clone(options);\n        prev.docs = {};\n        docs.forEach(function (doc) {\n          prev.docs[doc._id] = EJSON.clone(doc);\n        });\n      }\n    } // before\n\n\n    aspectGroup.upsert.before.forEach(function (o) {\n      var r = o.aspect.call(ctx, userId, selector, mutator, options);\n      if (r === false) abort = true;\n    });\n    if (abort) return {\n      numberAffected: 0\n    };\n  }\n\n  var afterUpdate = function (affected, err) {\n    if (!suppressAspects && !isEmpty(aspectGroup.update.after)) {\n      var fields = CollectionHooks.getFields(mutator);\n\n      var _docs = CollectionHooks.getDocs.call(_this, instance, {\n        _id: {\n          $in: docIds\n        }\n      }, options).fetch();\n\n      aspectGroup.update.after.forEach(function (o) {\n        _docs.forEach(function (doc) {\n          o.aspect.call(_objectSpread({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected: affected,\n            err: err\n          }, ctx), userId, doc, fields, prev.mutator, prev.options);\n        });\n      });\n    }\n  };\n\n  var afterInsert = function (_id, err) {\n    if (!suppressAspects && !isEmpty(aspectGroup.insert.after)) {\n      var doc = CollectionHooks.getDocs.call(_this, instance, {\n        _id: _id\n      }, selector, {}).fetch()[0]; // 3rd argument passes empty object which causes magic logic to imply limit:1\n\n      var lctx = _objectSpread({\n        transform: getTransform(doc),\n        _id: _id,\n        err: err\n      }, ctx);\n\n      aspectGroup.insert.after.forEach(function (o) {\n        o.aspect.call(lctx, userId, doc);\n      });\n    }\n  };\n\n  if (async) {\n    var wrappedCallback = function (err, ret) {\n      if (err || ret && ret.insertedId) {\n        // Send any errors to afterInsert\n        afterInsert(ret.insertedId, err);\n      } else {\n        afterUpdate(ret && ret.numberAffected, err); // Note that err can never reach here\n      }\n\n      return CollectionHooks.hookedOp(function () {\n        return callback.call(this, err, ret);\n      });\n    };\n\n    return CollectionHooks.directOp(function () {\n      return _super.call(_this, selector, mutator, options, wrappedCallback);\n    });\n  } else {\n    var ret = CollectionHooks.directOp(function () {\n      return _super.call(_this, selector, mutator, options, callback);\n    });\n\n    if (ret && ret.insertedId) {\n      afterInsert(ret.insertedId);\n    } else {\n      afterUpdate(ret && ret.numberAffected);\n    }\n\n    return ret;\n  }\n});","map":{"version":3,"sources":["packages/matb33:collection-hooks/upsert.js"],"names":["_objectSpread","module","link","default","v","_slicedToArray","EJSON","CollectionHooks","isEmpty","a","Array","isArray","length","defineAdvice","userId","_super","instance","aspectGroup","getTransform","args","suppressAspects","normalizeSelector","_getFindSelector","ctx","context","selector","mutator","options","callback","async","docs","docIds","abort","prev","upsert","before","update","after","getDocs","call","fetch","map","doc","_id","some","o","fetchPrevious","extendOptions","hookOptions","clone","forEach","r","aspect","numberAffected","afterUpdate","affected","err","fields","getFields","$in","transform","previous","afterInsert","insert","lctx","wrappedCallback","ret","insertedId","hookedOp","directOp"],"mappings":"AAAA,IAAIA,aAAJ;;AAAkBC,MAAM,CAACC,IAAP,CAAY,sCAAZ,EAAmD;AAACC,EAAAA,OAAO,EAAC,UAASC,CAAT,EAAW;AAACJ,IAAAA,aAAa,GAACI,CAAd;AAAgB;AAArC,CAAnD,EAA0F,CAA1F;;AAA6F,IAAIC,cAAJ;;AAAmBJ,MAAM,CAACC,IAAP,CAAY,sCAAZ,EAAmD;AAACC,EAAAA,OAAO,EAAC,UAASC,CAAT,EAAW;AAACC,IAAAA,cAAc,GAACD,CAAf;AAAiB;AAAtC,CAAnD,EAA2F,CAA3F;AAAlI,IAAIE,KAAJ;AAAUL,MAAM,CAACC,IAAP,CAAY,cAAZ,EAA2B;AAACI,EAAAA,KAAK,EAAC,UAASF,CAAT,EAAW;AAACE,IAAAA,KAAK,GAACF,CAAN;AAAQ;AAA3B,CAA3B,EAAwD,CAAxD;AAA2D,IAAIG,eAAJ;AAAoBN,MAAM,CAACC,IAAP,CAAY,oBAAZ,EAAiC;AAACK,EAAAA,eAAe,EAAC,UAASH,CAAT,EAAW;AAACG,IAAAA,eAAe,GAACH,CAAhB;AAAkB;AAA/C,CAAjC,EAAkF,CAAlF;;AAGzF,IAAMI,OAAO,GAAG,UAAAC,CAAC;AAAA,SAAI,CAACC,KAAK,CAACC,OAAN,CAAcF,CAAd,CAAD,IAAqB,CAACA,CAAC,CAACG,MAA5B;AAAA,CAAjB;;AAEAL,eAAe,CAACM,YAAhB,CAA6B,QAA7B,EAAuC,UAAUC,MAAV,EAAkBC,MAAlB,EAA0BC,QAA1B,EAAoCC,WAApC,EAAiDC,YAAjD,EAA+DC,IAA/D,EAAqEC,eAArE,EAAsF;AAAA;;AAC3HD,EAAAA,IAAI,CAAC,CAAD,CAAJ,GAAUZ,eAAe,CAACc,iBAAhB,CAAkCL,QAAQ,CAACM,gBAAT,CAA0BH,IAA1B,CAAlC,CAAV;AAEA,MAAMI,GAAG,GAAG;AAAEC,IAAAA,OAAO,EAAE,IAAX;AAAiBT,IAAAA,MAAM,EAANA,MAAjB;AAAyBI,IAAAA,IAAI,EAAJA;AAAzB,GAAZ;;AACA,6BAA6CA,IAA7C;AAAA,MAAKM,QAAL;AAAA,MAAeC,OAAf;AAAA,MAAwBC,OAAxB;AAAA,MAAiCC,QAAjC;;AACA,MAAI,OAAOD,OAAP,KAAmB,UAAvB,EAAmC;AACjCC,IAAAA,QAAQ,GAAGD,OAAX;AACAA,IAAAA,OAAO,GAAG,EAAV;AACD;;AAED,MAAME,KAAK,GAAG,OAAOD,QAAP,KAAoB,UAAlC;AACA,MAAIE,IAAJ;AACA,MAAIC,MAAJ;AACA,MAAIC,KAAJ;AACA,MAAMC,IAAI,GAAG,EAAb;;AAEA,MAAI,CAACb,eAAL,EAAsB;AACpB,QAAI,CAACZ,OAAO,CAACS,WAAW,CAACiB,MAAZ,CAAmBC,MAApB,CAAR,IAAuC,CAAC3B,OAAO,CAACS,WAAW,CAACmB,MAAZ,CAAmBC,KAApB,CAAnD,EAA+E;AAC7EP,MAAAA,IAAI,GAAGvB,eAAe,CAAC+B,OAAhB,CAAwBC,IAAxB,CAA6B,IAA7B,EAAmCvB,QAAnC,EAA6CS,QAA7C,EAAuDE,OAAvD,EAAgEa,KAAhE,EAAP;AACAT,MAAAA,MAAM,GAAGD,IAAI,CAACW,GAAL,CAAS,UAAAC,GAAG;AAAA,eAAIA,GAAG,CAACC,GAAR;AAAA,OAAZ,CAAT;AACD,KAJmB,CAMpB;;;AACA,QAAI,CAACnC,OAAO,CAACS,WAAW,CAACmB,MAAZ,CAAmBC,KAApB,CAAZ,EAAwC;AACtC,UAAIpB,WAAW,CAACmB,MAAZ,CAAmBC,KAAnB,CAAyBO,IAAzB,CAA8B,UAAAC,CAAC;AAAA,eAAIA,CAAC,CAAClB,OAAF,CAAUmB,aAAV,KAA4B,KAAhC;AAAA,OAA/B,KACFvC,eAAe,CAACwC,aAAhB,CAA8B/B,QAAQ,CAACgC,WAAvC,EAAoD,EAApD,EAAwD,OAAxD,EAAiE,QAAjE,EAA2EF,aAA3E,KAA6F,KAD/F,EACsG;AACpGb,QAAAA,IAAI,CAACP,OAAL,GAAepB,KAAK,CAAC2C,KAAN,CAAYvB,OAAZ,CAAf;AACAO,QAAAA,IAAI,CAACN,OAAL,GAAerB,KAAK,CAAC2C,KAAN,CAAYtB,OAAZ,CAAf;AAEAM,QAAAA,IAAI,CAACH,IAAL,GAAY,EAAZ;AACAA,QAAAA,IAAI,CAACoB,OAAL,CAAa,UAACR,GAAD,EAAS;AACpBT,UAAAA,IAAI,CAACH,IAAL,CAAUY,GAAG,CAACC,GAAd,IAAqBrC,KAAK,CAAC2C,KAAN,CAAYP,GAAZ,CAArB;AACD,SAFD;AAGD;AACF,KAlBmB,CAoBpB;;;AACAzB,IAAAA,WAAW,CAACiB,MAAZ,CAAmBC,MAAnB,CAA0Be,OAA1B,CAAkC,UAACL,CAAD,EAAO;AACvC,UAAMM,CAAC,GAAGN,CAAC,CAACO,MAAF,CAASb,IAAT,CAAchB,GAAd,EAAmBT,MAAnB,EAA2BW,QAA3B,EAAqCC,OAArC,EAA8CC,OAA9C,CAAV;AACA,UAAIwB,CAAC,KAAK,KAAV,EAAiBnB,KAAK,GAAG,IAAR;AAClB,KAHD;AAKA,QAAIA,KAAJ,EAAW,OAAO;AAAEqB,MAAAA,cAAc,EAAE;AAAlB,KAAP;AACZ;;AAED,MAAMC,WAAW,GAAG,UAACC,QAAD,EAAWC,GAAX,EAAmB;AACrC,QAAI,CAACpC,eAAD,IAAoB,CAACZ,OAAO,CAACS,WAAW,CAACmB,MAAZ,CAAmBC,KAApB,CAAhC,EAA4D;AAC1D,UAAMoB,MAAM,GAAGlD,eAAe,CAACmD,SAAhB,CAA0BhC,OAA1B,CAAf;;AACA,UAAMI,KAAI,GAAGvB,eAAe,CAAC+B,OAAhB,CAAwBC,IAAxB,CAA6B,KAA7B,EAAmCvB,QAAnC,EAA6C;AAAE2B,QAAAA,GAAG,EAAE;AAAEgB,UAAAA,GAAG,EAAE5B;AAAP;AAAP,OAA7C,EAAuEJ,OAAvE,EAAgFa,KAAhF,EAAb;;AAEAvB,MAAAA,WAAW,CAACmB,MAAZ,CAAmBC,KAAnB,CAAyBa,OAAzB,CAAiC,UAACL,CAAD,EAAO;AACtCf,QAAAA,KAAI,CAACoB,OAAL,CAAa,UAACR,GAAD,EAAS;AACpBG,UAAAA,CAAC,CAACO,MAAF,CAASb,IAAT;AACEqB,YAAAA,SAAS,EAAE1C,YAAY,CAACwB,GAAD,CADzB;AAEEmB,YAAAA,QAAQ,EAAE5B,IAAI,CAACH,IAAL,IAAaG,IAAI,CAACH,IAAL,CAAUY,GAAG,CAACC,GAAd,CAFzB;AAGEY,YAAAA,QAAQ,EAARA,QAHF;AAIEC,YAAAA,GAAG,EAAHA;AAJF,aAKKjC,GALL,GAMGT,MANH,EAMW4B,GANX,EAMgBe,MANhB,EAMwBxB,IAAI,CAACP,OAN7B,EAMsCO,IAAI,CAACN,OAN3C;AAOD,SARD;AASD,OAVD;AAWD;AACF,GAjBD;;AAmBA,MAAMmC,WAAW,GAAG,UAACnB,GAAD,EAAMa,GAAN,EAAc;AAChC,QAAI,CAACpC,eAAD,IAAoB,CAACZ,OAAO,CAACS,WAAW,CAAC8C,MAAZ,CAAmB1B,KAApB,CAAhC,EAA4D;AAC1D,UAAMK,GAAG,GAAGnC,eAAe,CAAC+B,OAAhB,CAAwBC,IAAxB,CAA6B,KAA7B,EAAmCvB,QAAnC,EAA6C;AAAE2B,QAAAA,GAAG,EAAHA;AAAF,OAA7C,EAAsDlB,QAAtD,EAAgE,EAAhE,EAAoEe,KAApE,GAA4E,CAA5E,CAAZ,CAD0D,CACiC;;AAC3F,UAAMwB,IAAI;AAAKJ,QAAAA,SAAS,EAAE1C,YAAY,CAACwB,GAAD,CAA5B;AAAmCC,QAAAA,GAAG,EAAHA,GAAnC;AAAwCa,QAAAA,GAAG,EAAHA;AAAxC,SAAgDjC,GAAhD,CAAV;;AAEAN,MAAAA,WAAW,CAAC8C,MAAZ,CAAmB1B,KAAnB,CAAyBa,OAAzB,CAAiC,UAACL,CAAD,EAAO;AACtCA,QAAAA,CAAC,CAACO,MAAF,CAASb,IAAT,CAAcyB,IAAd,EAAoBlD,MAApB,EAA4B4B,GAA5B;AACD,OAFD;AAGD;AACF,GATD;;AAWA,MAAIb,KAAJ,EAAW;AACT,QAAMoC,eAAe,GAAG,UAAUT,GAAV,EAAeU,GAAf,EAAoB;AAC1C,UAAIV,GAAG,IAAKU,GAAG,IAAIA,GAAG,CAACC,UAAvB,EAAoC;AAClC;AACAL,QAAAA,WAAW,CAACI,GAAG,CAACC,UAAL,EAAiBX,GAAjB,CAAX;AACD,OAHD,MAGO;AACLF,QAAAA,WAAW,CAACY,GAAG,IAAIA,GAAG,CAACb,cAAZ,EAA4BG,GAA5B,CAAX,CADK,CACuC;AAC7C;;AAED,aAAOjD,eAAe,CAAC6D,QAAhB,CAAyB,YAAY;AAC1C,eAAOxC,QAAQ,CAACW,IAAT,CAAc,IAAd,EAAoBiB,GAApB,EAAyBU,GAAzB,CAAP;AACD,OAFM,CAAP;AAGD,KAXD;;AAaA,WAAO3D,eAAe,CAAC8D,QAAhB,CAAyB;AAAA,aAAMtD,MAAM,CAACwB,IAAP,CAAY,KAAZ,EAAkBd,QAAlB,EAA4BC,OAA5B,EAAqCC,OAArC,EAA8CsC,eAA9C,CAAN;AAAA,KAAzB,CAAP;AACD,GAfD,MAeO;AACL,QAAMC,GAAG,GAAG3D,eAAe,CAAC8D,QAAhB,CAAyB;AAAA,aAAMtD,MAAM,CAACwB,IAAP,CAAY,KAAZ,EAAkBd,QAAlB,EAA4BC,OAA5B,EAAqCC,OAArC,EAA8CC,QAA9C,CAAN;AAAA,KAAzB,CAAZ;;AAEA,QAAIsC,GAAG,IAAIA,GAAG,CAACC,UAAf,EAA2B;AACzBL,MAAAA,WAAW,CAACI,GAAG,CAACC,UAAL,CAAX;AACD,KAFD,MAEO;AACLb,MAAAA,WAAW,CAACY,GAAG,IAAIA,GAAG,CAACb,cAAZ,CAAX;AACD;;AAED,WAAOa,GAAP;AACD;AACF,CArGD","sourcesContent":["import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('upsert', function (userId, _super, instance, aspectGroup, getTransform, args, suppressAspects) {\n  args[0] = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n\n  const ctx = { context: this, _super, args }\n  let [selector, mutator, options, callback] = args\n  if (typeof options === 'function') {\n    callback = options\n    options = {}\n  }\n\n  const async = typeof callback === 'function'\n  let docs\n  let docIds\n  let abort\n  const prev = {}\n\n  if (!suppressAspects) {\n    if (!isEmpty(aspectGroup.upsert.before) || !isEmpty(aspectGroup.update.after)) {\n      docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch()\n      docIds = docs.map(doc => doc._id)\n    }\n\n    // copy originals for convenience for the 'after' pointcut\n    if (!isEmpty(aspectGroup.update.after)) {\n      if (aspectGroup.update.after.some(o => o.options.fetchPrevious !== false) &&\n        CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n        prev.mutator = EJSON.clone(mutator)\n        prev.options = EJSON.clone(options)\n\n        prev.docs = {}\n        docs.forEach((doc) => {\n          prev.docs[doc._id] = EJSON.clone(doc)\n        })\n      }\n    }\n\n    // before\n    aspectGroup.upsert.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, mutator, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return { numberAffected: 0 }\n  }\n\n  const afterUpdate = (affected, err) => {\n    if (!suppressAspects && !isEmpty(aspectGroup.update.after)) {\n      const fields = CollectionHooks.getFields(mutator)\n      const docs = CollectionHooks.getDocs.call(this, instance, { _id: { $in: docIds } }, options).fetch()\n\n      aspectGroup.update.after.forEach((o) => {\n        docs.forEach((doc) => {\n          o.aspect.call({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err,\n            ...ctx\n          }, userId, doc, fields, prev.mutator, prev.options)\n        })\n      })\n    }\n  }\n\n  const afterInsert = (_id, err) => {\n    if (!suppressAspects && !isEmpty(aspectGroup.insert.after)) {\n      const doc = CollectionHooks.getDocs.call(this, instance, { _id }, selector, {}).fetch()[0] // 3rd argument passes empty object which causes magic logic to imply limit:1\n      const lctx = { transform: getTransform(doc), _id, err, ...ctx }\n\n      aspectGroup.insert.after.forEach((o) => {\n        o.aspect.call(lctx, userId, doc)\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, ret) {\n      if (err || (ret && ret.insertedId)) {\n        // Send any errors to afterInsert\n        afterInsert(ret.insertedId, err)\n      } else {\n        afterUpdate(ret && ret.numberAffected, err) // Note that err can never reach here\n      }\n\n      return CollectionHooks.hookedOp(function () {\n        return callback.call(this, err, ret)\n      })\n    }\n\n    return CollectionHooks.directOp(() => _super.call(this, selector, mutator, options, wrappedCallback))\n  } else {\n    const ret = CollectionHooks.directOp(() => _super.call(this, selector, mutator, options, callback))\n\n    if (ret && ret.insertedId) {\n      afterInsert(ret.insertedId)\n    } else {\n      afterUpdate(ret && ret.numberAffected)\n    }\n\n    return ret\n  }\n})\n"]},"sourceType":"module","hash":"c9ecea7dbd7ad28e3c756e65ce2bc7543cb44f11"}
