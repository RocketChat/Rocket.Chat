{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/views/app/room.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"app/ui/client/views/app/room.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/views/app/room.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/app/ui/client/views/app/room.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/ui/client/views/app/room.js"}},"code":"var _toConsumableArray;\n\nmodule.link(\"@babel/runtime/helpers/toConsumableArray\", {\n  default: function (v) {\n    _toConsumableArray = v;\n  }\n}, 0);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\n\nvar _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 2);\nmodule.export({\n  chatMessages: function () {\n    return chatMessages;\n  },\n  dropzoneHelpers: function () {\n    return dropzoneHelpers;\n  },\n  dropzoneEvents: function () {\n    return dropzoneEvents;\n  }\n});\n\nvar _;\n\nmodule.link(\"underscore\", {\n  \"default\": function (v) {\n    _ = v;\n  }\n}, 0);\nvar moment;\nmodule.link(\"moment\", {\n  \"default\": function (v) {\n    moment = v;\n  }\n}, 1);\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 3);\nvar ReactiveDict;\nmodule.link(\"meteor/reactive-dict\", {\n  ReactiveDict: function (v) {\n    ReactiveDict = v;\n  }\n}, 4);\nvar ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 5);\nvar Random;\nmodule.link(\"meteor/random\", {\n  Random: function (v) {\n    Random = v;\n  }\n}, 6);\nvar Blaze;\nmodule.link(\"meteor/blaze\", {\n  Blaze: function (v) {\n    Blaze = v;\n  }\n}, 7);\nvar FlowRouter;\nmodule.link(\"meteor/kadira:flow-router\", {\n  FlowRouter: function (v) {\n    FlowRouter = v;\n  }\n}, 8);\nvar Session;\nmodule.link(\"meteor/session\", {\n  Session: function (v) {\n    Session = v;\n  }\n}, 9);\nvar Template;\nmodule.link(\"meteor/templating\", {\n  Template: function (v) {\n    Template = v;\n  }\n}, 10);\nvar t, getUserPreference;\nmodule.link(\"../../../../utils/client\", {\n  t: function (v) {\n    t = v;\n  },\n  getUserPreference: function (v) {\n    getUserPreference = v;\n  }\n}, 11);\nvar WebRTC;\nmodule.link(\"../../../../webrtc/client\", {\n  WebRTC: function (v) {\n    WebRTC = v;\n  }\n}, 12);\nvar ChatMessage, RoomRoles, Users, Subscriptions, Rooms;\nmodule.link(\"../../../../models\", {\n  ChatMessage: function (v) {\n    ChatMessage = v;\n  },\n  RoomRoles: function (v) {\n    RoomRoles = v;\n  },\n  Users: function (v) {\n    Users = v;\n  },\n  Subscriptions: function (v) {\n    Subscriptions = v;\n  },\n  Rooms: function (v) {\n    Rooms = v;\n  }\n}, 13);\nvar RoomHistoryManager, RoomManager, readMessage;\nmodule.link(\"../../../../ui-utils/client\", {\n  RoomHistoryManager: function (v) {\n    RoomHistoryManager = v;\n  },\n  RoomManager: function (v) {\n    RoomManager = v;\n  },\n  readMessage: function (v) {\n    readMessage = v;\n  }\n}, 14);\nvar messageContext;\nmodule.link(\"../../../../ui-utils/client/lib/messageContext\", {\n  messageContext: function (v) {\n    messageContext = v;\n  }\n}, 15);\nvar messageArgs;\nmodule.link(\"../../../../ui-utils/client/lib/messageArgs\", {\n  messageArgs: function (v) {\n    messageArgs = v;\n  }\n}, 16);\nvar settings;\nmodule.link(\"../../../../settings/client\", {\n  settings: function (v) {\n    settings = v;\n  }\n}, 17);\nvar callbacks;\nmodule.link(\"../../../../../lib/callbacks\", {\n  callbacks: function (v) {\n    callbacks = v;\n  }\n}, 18);\nvar hasAllPermission, hasRole;\nmodule.link(\"../../../../authorization/client\", {\n  hasAllPermission: function (v) {\n    hasAllPermission = v;\n  },\n  hasRole: function (v) {\n    hasRole = v;\n  }\n}, 19);\nvar ChatMessages;\nmodule.link(\"../../lib/chatMessages\", {\n  ChatMessages: function (v) {\n    ChatMessages = v;\n  }\n}, 20);\nvar fileUpload;\nmodule.link(\"../../lib/fileUpload\", {\n  fileUpload: function (v) {\n    fileUpload = v;\n  }\n}, 21);\nmodule.link(\"./room.html\");\nvar getCommonRoomEvents;\nmodule.link(\"./lib/getCommonRoomEvents\", {\n  getCommonRoomEvents: function (v) {\n    getCommonRoomEvents = v;\n  }\n}, 22);\nvar NewRoomManager;\nmodule.link(\"../../../../../client/lib/RoomManager\", {\n  RoomManager: function (v) {\n    NewRoomManager = v;\n  }\n}, 23);\nvar isLayoutEmbedded;\nmodule.link(\"../../../../../client/lib/utils/isLayoutEmbedded\", {\n  isLayoutEmbedded: function (v) {\n    isLayoutEmbedded = v;\n  }\n}, 24);\nvar handleError;\nmodule.link(\"../../../../../client/lib/utils/handleError\", {\n  handleError: function (v) {\n    handleError = v;\n  }\n}, 25);\nvar roomCoordinator;\nmodule.link(\"../../../../../client/lib/rooms/roomCoordinator\", {\n  roomCoordinator: function (v) {\n    roomCoordinator = v;\n  }\n}, 26);\nvar chatMessages = {};\n\nvar userCanDrop = function (_id) {\n  return !roomCoordinator.readOnly(_id, Users.findOne({\n    _id: Meteor.userId()\n  }, {\n    fields: {\n      username: 1\n    }\n  }));\n};\n\nvar wipeFailedUploads = function () {\n  var uploads = Session.get('uploading');\n\n  if (uploads) {\n    Session.set('uploading', uploads.filter(function (upload) {\n      return !upload.error;\n    }));\n  }\n};\n\nfunction roomHasGlobalPurge(room) {\n  if (!settings.get('RetentionPolicy_Enabled')) {\n    return false;\n  }\n\n  switch (room.t) {\n    case 'c':\n      return settings.get('RetentionPolicy_AppliesToChannels');\n\n    case 'p':\n      return settings.get('RetentionPolicy_AppliesToGroups');\n\n    case 'd':\n      return settings.get('RetentionPolicy_AppliesToDMs');\n  }\n\n  return false;\n}\n\nfunction roomHasPurge(room) {\n  if (!room || !settings.get('RetentionPolicy_Enabled')) {\n    return false;\n  }\n\n  if (room.retention && room.retention.enabled !== undefined) {\n    return room.retention.enabled;\n  }\n\n  return roomHasGlobalPurge(room);\n}\n\nfunction roomFilesOnly(room) {\n  if (!room) {\n    return false;\n  }\n\n  if (room.retention && room.retention.overrideGlobal) {\n    return room.retention.filesOnly;\n  }\n\n  return settings.get('RetentionPolicy_FilesOnly');\n}\n\nfunction roomExcludePinned(room) {\n  if (!room) {\n    return false;\n  }\n\n  if (room.retention && room.retention.overrideGlobal) {\n    return room.retention.excludePinned;\n  }\n\n  return settings.get('RetentionPolicy_DoNotPrunePinned');\n}\n\nfunction roomMaxAge(room) {\n  if (!room) {\n    return;\n  }\n\n  if (!roomHasPurge(room)) {\n    return;\n  }\n\n  if (room.retention && room.retention.overrideGlobal) {\n    return room.retention.maxAge;\n  }\n\n  if (room.t === 'c') {\n    return settings.get('RetentionPolicy_MaxAge_Channels');\n  }\n\n  if (room.t === 'p') {\n    return settings.get('RetentionPolicy_MaxAge_Groups');\n  }\n\n  if (room.t === 'd') {\n    return settings.get('RetentionPolicy_MaxAge_DMs');\n  }\n}\n\nfunction createFileFromUrl(url) {\n  var response, data, metadata, _await$module$dynamic, mime, file;\n\n  return _regeneratorRuntime.async(function () {\n    function createFileFromUrl$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _context.prev = 0;\n            _context.next = 3;\n            return _regeneratorRuntime.awrap(fetch(url));\n\n          case 3:\n            response = _context.sent;\n            _context.next = 9;\n            break;\n\n          case 6:\n            _context.prev = 6;\n            _context.t0 = _context[\"catch\"](0);\n            throw _context.t0;\n\n          case 9:\n            _context.next = 11;\n            return _regeneratorRuntime.awrap(response.blob());\n\n          case 11:\n            data = _context.sent;\n            metadata = {\n              type: data.type\n            };\n            _context.next = 15;\n            return _regeneratorRuntime.awrap(module.dynamicImport('../../../../utils/lib/mimeTypes'));\n\n          case 15:\n            _await$module$dynamic = _context.sent;\n            mime = _await$module$dynamic.mime;\n            file = new File([data], \"File - \" + moment().format(settings.get('Message_TimeAndDateFormat')) + \".\" + mime.extension(data.type), metadata);\n            return _context.abrupt(\"return\", file);\n\n          case 19:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }\n\n    return createFileFromUrl$;\n  }(), null, null, [[0, 6]], Promise);\n}\n\nfunction addToInput(text) {\n  var input = chatMessages[RoomManager.openedRoom].input;\n  var initText = input.value.slice(0, input.selectionStart);\n  var finalText = input.value.slice(input.selectionEnd, input.value.length);\n  input.value = initText + text + finalText;\n  $(input).change().trigger('input');\n}\n\ncallbacks.add('enter-room', wipeFailedUploads);\nvar dropzoneHelpers = {\n  dragAndDrop: function () {\n    return settings.get('FileUpload_Enabled') && 'dropzone--disabled';\n  },\n  isDropzoneDisabled: function () {\n    return settings.get('FileUpload_Enabled') ? 'dropzone-overlay--enabled' : 'dropzone-overlay--disabled';\n  },\n  dragAndDropLabel: function () {\n    if (!userCanDrop(this._id)) {\n      return 'error-not-allowed';\n    }\n\n    if (!settings.get('FileUpload_Enabled')) {\n      return 'FileUpload_Disabled';\n    }\n\n    return 'Drop_to_upload_file';\n  }\n};\nTemplate.roomOld.helpers(_objectSpread(_objectSpread({}, dropzoneHelpers), {}, {\n  tabBar: function () {\n    return Template.instance().tabBar;\n  },\n  subscribed: function () {\n    var _Template$instance = Template.instance(),\n        state = _Template$instance.state;\n\n    return state.get('subscribed');\n  },\n  messagesHistory: function () {\n    var showInMainThread = getUserPreference(Meteor.userId(), 'showMessageInMainThread', false);\n\n    var _Template$instance2 = Template.instance(),\n        rid = _Template$instance2.rid;\n\n    var room = Rooms.findOne(rid, {\n      fields: {\n        sysMes: 1\n      }\n    });\n    var hideSettings = settings.collection.findOne('Hide_System_Messages') || {};\n    var settingValues = Array.isArray(room === null || room === void 0 ? void 0 : room.sysMes) ? room.sysMes : hideSettings.value || [];\n    var hideMessagesOfType = new Set(settingValues.reduce(function (array, value) {\n      return [].concat(_toConsumableArray(array), _toConsumableArray(value === 'mute_unmute' ? ['user-muted', 'user-unmuted'] : [value]));\n    }, []));\n\n    var query = _objectSpread({\n      rid: rid,\n      _hidden: {\n        $ne: true\n      }\n    }, !showInMainThread && {\n      $or: [{\n        tmid: {\n          $exists: 0\n        }\n      }, {\n        tshow: {\n          $eq: true\n        }\n      }]\n    });\n\n    if (hideMessagesOfType.size) {\n      query.t = {\n        $nin: Array.from(hideMessagesOfType.values())\n      };\n    }\n\n    var options = {\n      sort: {\n        ts: 1\n      }\n    };\n    return ChatMessage.find(query, options);\n  },\n  hasMore: function () {\n    return RoomHistoryManager.hasMore(this._id);\n  },\n  hasMoreNext: function () {\n    return RoomHistoryManager.hasMoreNext(this._id);\n  },\n  isLoading: function () {\n    return RoomHistoryManager.isLoading(this._id);\n  },\n  windowId: function () {\n    return \"chat-window-\" + this._id;\n  },\n  uploading: function () {\n    return Session.get('uploading');\n  },\n  roomLeader: function () {\n    var roles = RoomRoles.findOne({\n      'rid': this._id,\n      'roles': 'leader',\n      'u._id': {\n        $ne: Meteor.userId()\n      }\n    });\n\n    if (roles) {\n      var leader = Users.findOne({\n        _id: roles.u._id\n      }, {\n        fields: {\n          status: 1,\n          statusText: 1\n        }\n      }) || {};\n      return _objectSpread(_objectSpread({}, roles.u), {}, {\n        name: settings.get('UI_Use_Real_Name') ? roles.u.name || roles.u.username : roles.u.username,\n        status: leader.status || 'offline',\n        statusDisplay: leader.statusText || t(leader.status || 'offline')\n      });\n    }\n  },\n  chatNowLink: function () {\n    return roomCoordinator.getRouteLink('d', {\n      name: this.username\n    });\n  },\n  announcement: function () {\n    return Template.instance().state.get('announcement');\n  },\n  announcementDetails: function () {\n    var _this = this;\n\n    var roomData = Session.get(\"roomData\" + this._id);\n\n    if (!roomData) {\n      return false;\n    }\n\n    if (roomData.announcementDetails != null && roomData.announcementDetails.callback != null) {\n      return function () {\n        return callbacks.run(roomData.announcementDetails.callback, _this._id);\n      };\n    }\n  },\n  messageboxData: function () {\n    var _Template$instance3 = Template.instance(),\n        sendToBottomIfNecessary = _Template$instance3.sendToBottomIfNecessary,\n        subscription = _Template$instance3.subscription;\n\n    var rid = this._id;\n    var isEmbedded = isLayoutEmbedded();\n    var showFormattingTips = settings.get('Message_ShowFormattingTips');\n    return {\n      rid: rid,\n      subscription: subscription.get(),\n      isEmbedded: isEmbedded,\n      showFormattingTips: showFormattingTips && !isEmbedded,\n      onInputChanged: function (input) {\n        if (!chatMessages[rid]) {\n          return;\n        }\n\n        chatMessages[rid].initializeInput(input, {\n          rid: rid\n        });\n      },\n      onResize: function () {\n        return sendToBottomIfNecessary && sendToBottomIfNecessary();\n      },\n      onKeyUp: function () {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        return chatMessages[rid] && chatMessages[rid].keyup.apply(chatMessages[rid], args);\n      },\n      onKeyDown: function () {\n        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n          args[_key2] = arguments[_key2];\n        }\n\n        return chatMessages[rid] && chatMessages[rid].keydown.apply(chatMessages[rid], args);\n      },\n      onSend: function () {\n        for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n          args[_key3] = arguments[_key3];\n        }\n\n        return chatMessages[rid] && chatMessages[rid].send.apply(chatMessages[rid], args);\n      }\n    };\n  },\n  getAnnouncementStyle: function () {\n    var _Template$instance4 = Template.instance(),\n        room = _Template$instance4.room;\n\n    if (!room) {\n      return '';\n    }\n\n    return room.announcementDetails && room.announcementDetails.style !== undefined ? room.announcementDetails.style : '';\n  },\n  maxMessageLength: function () {\n    return settings.get('Message_MaxAllowedSize');\n  },\n  unreadData: function () {\n    var data = {\n      count: Template.instance().state.get('count')\n    };\n    var room = RoomManager.getOpenedRoomByRid(this._id);\n\n    if (room) {\n      data.since = room.unreadSince.get();\n    }\n\n    return data;\n  },\n  containerBarsShow: function (unreadData, uploading) {\n    var hasUnreadData = unreadData && unreadData.count && unreadData.since;\n    var isUploading = uploading && uploading.length;\n\n    if (hasUnreadData || isUploading) {\n      return 'show';\n    }\n  },\n  formatUnreadSince: function () {\n    if (!this.since) {\n      return;\n    }\n\n    return moment(this.since).calendar(null, {\n      sameDay: 'LT'\n    });\n  },\n  adminClass: function () {\n    if (hasRole(Meteor.userId(), 'admin')) {\n      return 'admin';\n    }\n  },\n  messageViewMode: function () {\n    var viewMode = getUserPreference(Meteor.userId(), 'messageViewMode');\n    var modes = ['', 'cozy', 'compact'];\n    return modes[viewMode] || modes[0];\n  },\n  selectable: function () {\n    return Template.instance().selectable.get();\n  },\n  hideUsername: function () {\n    return getUserPreference(Meteor.userId(), 'hideUsernames') ? 'hide-usernames' : undefined;\n  },\n  hideAvatar: function () {\n    return getUserPreference(Meteor.userId(), 'displayAvatars') ? undefined : 'hide-avatars';\n  },\n  canPreview: function () {\n    var _Template$instance5 = Template.instance(),\n        room = _Template$instance5.room,\n        state = _Template$instance5.state;\n\n    if (room && room.t !== 'c') {\n      return true;\n    }\n\n    if (settings.get('Accounts_AllowAnonymousRead') === true) {\n      return true;\n    }\n\n    if (hasAllPermission('preview-c-room')) {\n      return true;\n    }\n\n    return state.get('subscribed');\n  },\n  hideLeaderHeader: function () {\n    return Template.instance().hideLeaderHeader.get() ? 'animated-hidden' : '';\n  },\n  hasLeader: function () {\n    if (RoomRoles.findOne({\n      'rid': this._id,\n      'roles': 'leader',\n      'u._id': {\n        $ne: Meteor.userId()\n      }\n    }, {\n      fields: {\n        _id: 1\n      }\n    })) {\n      return 'has-leader';\n    }\n  },\n  hasPurge: function () {\n    var _Template$instance6 = Template.instance(),\n        room = _Template$instance6.room;\n\n    return roomHasPurge(room);\n  },\n  filesOnly: function () {\n    var _Template$instance7 = Template.instance(),\n        room = _Template$instance7.room;\n\n    return roomFilesOnly(room);\n  },\n  excludePinned: function () {\n    var _Template$instance8 = Template.instance(),\n        room = _Template$instance8.room;\n\n    return roomExcludePinned(room);\n  },\n  purgeTimeout: function () {\n    var _Template$instance9 = Template.instance(),\n        room = _Template$instance9.room;\n\n    moment.relativeTimeThreshold('s', 60);\n    moment.relativeTimeThreshold('ss', 0);\n    moment.relativeTimeThreshold('m', 60);\n    moment.relativeTimeThreshold('h', 24);\n    moment.relativeTimeThreshold('d', 31);\n    moment.relativeTimeThreshold('M', 12);\n    return moment.duration(roomMaxAge(room) * 1000 * 60 * 60 * 24).humanize();\n  },\n  messageContext: messageContext,\n  openedThread: function () {\n    FlowRouter.watchPathChange();\n    var tab = FlowRouter.getParam('tab');\n    var mid = FlowRouter.getParam('context');\n\n    var rid = Template.currentData()._id;\n\n    var jump = FlowRouter.getQueryParam('jump');\n    var subscription = Template.instance().subscription.get();\n\n    if (tab !== 'thread' || !mid || rid !== Session.get('openedRoom')) {\n      return;\n    }\n\n    var room = Rooms.findOne({\n      _id: rid\n    }, {\n      fields: {\n        t: 1,\n        usernames: 1,\n        uids: 1,\n        name: 1\n      }\n    });\n    return {\n      rid: rid,\n      mid: mid,\n      room: room,\n      jump: jump,\n      subscription: subscription\n    };\n  }\n}));\nvar dropzoneEvents = {\n  'dragenter .dropzone': function (e) {\n    var types = e.originalEvent && e.originalEvent.dataTransfer && e.originalEvent.dataTransfer.types;\n\n    if (types != null && types.length > 0 && _.some(types, function (type) {\n      return type.indexOf('text/') === -1 || type.indexOf('text/uri-list') !== -1 || type.indexOf('text/plain') !== -1;\n    }) && userCanDrop(this._id)) {\n      e.currentTarget.classList.add('over');\n    }\n\n    e.stopPropagation();\n  },\n  'dragleave .dropzone-overlay': function (e) {\n    e.currentTarget.parentNode.classList.remove('over');\n    e.stopPropagation();\n  },\n  'dragover .dropzone-overlay': function (e) {\n    document.querySelectorAll('.over.dropzone').forEach(function (dropzone) {\n      if (dropzone !== e.currentTarget.parentNode) {\n        dropzone.classList.remove('over');\n      }\n    });\n    e = e.originalEvent || e;\n\n    if (['move', 'linkMove'].includes(e.dataTransfer.effectAllowed)) {\n      e.dataTransfer.dropEffect = 'move';\n    } else {\n      e.dataTransfer.dropEffect = 'copy';\n    }\n\n    e.stopPropagation();\n  },\n  'dropped .dropzone-overlay': function () {\n    function _callee(event, instance) {\n      var e, files, transferData, url, imgURL, file, _await$module$dynamic2, mime, filesToUpload;\n\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                event.currentTarget.parentNode.classList.remove('over');\n                e = event.originalEvent || event;\n                e.stopPropagation();\n                e.preventDefault();\n\n                if (!(!userCanDrop(this._id) || !settings.get('FileUpload_Enabled'))) {\n                  _context2.next = 6;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", false);\n\n              case 6:\n                files = e.dataTransfer && e.dataTransfer.files || [];\n\n                if (!(files.length < 1)) {\n                  _context2.next = 22;\n                  break;\n                }\n\n                transferData = e.dataTransfer.getData('text') || e.dataTransfer.getData('url');\n\n                if (!e.dataTransfer.types.includes('text/uri-list')) {\n                  _context2.next = 20;\n                  break;\n                }\n\n                url = e.dataTransfer.getData('text/html').match('<img.+src=(?:\"|\\')(.+?)(?:\"|\\')(?:.+?)>');\n                imgURL = url && url[1];\n\n                if (imgURL) {\n                  _context2.next = 14;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 14:\n                _context2.next = 16;\n                return _regeneratorRuntime.awrap(createFileFromUrl(imgURL));\n\n              case 16:\n                file = _context2.sent;\n\n                if (!(typeof file === 'string')) {\n                  _context2.next = 19;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", addToInput(file));\n\n              case 19:\n                files = [file];\n\n              case 20:\n                if (!(e.dataTransfer.types.includes('text/plain') && !e.dataTransfer.types.includes('text/x-moz-url'))) {\n                  _context2.next = 22;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", addToInput(transferData.trim()));\n\n              case 22:\n                _context2.next = 24;\n                return _regeneratorRuntime.awrap(module.dynamicImport('../../../../utils/lib/mimeTypes'));\n\n              case 24:\n                _await$module$dynamic2 = _context2.sent;\n                mime = _await$module$dynamic2.mime;\n                filesToUpload = Array.from(files).map(function (file) {\n                  Object.defineProperty(file, 'type', {\n                    value: mime.lookup(file.name)\n                  });\n                  return {\n                    file: file,\n                    name: file.name\n                  };\n                });\n                return _context2.abrupt(\"return\", instance.onFile && instance.onFile(filesToUpload));\n\n              case 28:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }\n\n        return _callee$;\n      }(), null, this, null, Promise);\n    }\n\n    return _callee;\n  }()\n};\nMeteor.startup(function () {\n  Template.roomOld.events(_objectSpread(_objectSpread(_objectSpread({}, getCommonRoomEvents()), dropzoneEvents), {}, {\n    'click .toggle-hidden': function (e) {\n      var id = e.currentTarget.dataset.message;\n      document.querySelector(\"#\" + id).classList.toggle('message--ignored');\n    },\n    'click .message': function (e, template) {\n      if (template.selectable.get()) {\n        (document.selection != null ? document.selection.empty() : undefined) || (typeof window.getSelection === 'function' ? window.getSelection().removeAllRanges() : undefined);\n        var data = Blaze.getData(e.currentTarget);\n\n        var _messageArgs = messageArgs(data),\n            _id = _messageArgs.msg._id;\n\n        if (!template.selectablePointer) {\n          template.selectablePointer = _id;\n        }\n\n        if (!e.shiftKey) {\n          template.selectedMessages = template.getSelectedMessages();\n          template.selectedRange = [];\n          template.selectablePointer = _id;\n        }\n\n        template.selectMessages(_id);\n        var selectedMessages = $('.messages-box .message.selected').map(function (i, message) {\n          return message.id;\n        });\n\n        var removeClass = _.difference(selectedMessages, template.getSelectedMessages());\n\n        var addClass = _.difference(template.getSelectedMessages(), selectedMessages);\n\n        removeClass.forEach(function (message) {\n          return $(\".messages-box #\" + message).removeClass('selected');\n        });\n        addClass.forEach(function (message) {\n          return $(\".messages-box #\" + message).addClass('selected');\n        });\n      }\n    },\n    'click .jump-recent button': function (e, template) {\n      e.preventDefault();\n      template.atBottom = true;\n      RoomHistoryManager.clear(template && template.data && template.data._id);\n    },\n    'load .gallery-item': function (e, template) {\n      template.sendToBottomIfNecessary();\n    },\n    'rendered .js-block-wrapper': function (e, template) {\n      template.sendToBottomIfNecessary();\n    },\n    'click .new-message': function (event, instance) {\n      instance.atBottom = true;\n      instance.sendToBottomIfNecessary();\n      chatMessages[RoomManager.openedRoom].input.focus();\n    },\n    'click .upload-progress-close': function (e) {\n      e.preventDefault();\n      Session.set(\"uploading-cancel-\" + this.id, true);\n    },\n    'click .unread-bar > button.mark-read': function (e, t) {\n      readMessage.readNow(t.data._id);\n    },\n    'click .unread-bar > button.jump-to': function (e, t) {\n      var _id = t.data._id;\n      var room = RoomHistoryManager.getRoom(_id);\n      var message = room && room.firstUnread.get();\n\n      if (!message) {\n        var subscription = Subscriptions.findOne({\n          rid: _id\n        });\n        message = ChatMessage.find({\n          rid: _id,\n          ts: {\n            $gt: subscription != null ? subscription.ls : undefined\n          }\n        }, {\n          sort: {\n            ts: 1\n          },\n          limit: 1\n        }).fetch()[0];\n      }\n\n      RoomHistoryManager.getSurroundingMessages(message, 50);\n    },\n    'scroll .wrapper': _.throttle(function (e, t) {\n      var $roomLeader = $('.room-leader');\n\n      if ($roomLeader.length) {\n        if (e.target.scrollTop < t.lastScrollTop) {\n          t.hideLeaderHeader.set(false);\n        } else if (t.isAtBottom(100) === false && e.target.scrollTop > $roomLeader.height()) {\n          t.hideLeaderHeader.set(true);\n        }\n      }\n\n      t.lastScrollTop = e.target.scrollTop;\n      var height = e.target.clientHeight;\n      var isLoading = RoomHistoryManager.isLoading(this._id);\n      var hasMore = RoomHistoryManager.hasMore(this._id);\n      var hasMoreNext = RoomHistoryManager.hasMoreNext(this._id);\n\n      if (isLoading === false && hasMore === true || hasMoreNext === true) {\n        if (hasMore === true && t.lastScrollTop <= height / 3) {\n          RoomHistoryManager.getMore(this._id);\n        } else if (hasMoreNext === true && Math.ceil(t.lastScrollTop) >= e.target.scrollHeight - height) {\n          RoomHistoryManager.getMoreNext(this._id);\n        }\n      }\n    }, 100),\n    'click .time a': function (e) {\n      e.preventDefault();\n\n      var _messageArgs2 = messageArgs(this),\n          msg = _messageArgs2.msg;\n\n      var repliedMessageId = msg.attachments[0].message_link.split('?msg=')[1];\n      FlowRouter.go(FlowRouter.current().context.pathname, null, {\n        msg: repliedMessageId,\n        hash: Random.id()\n      });\n    }\n  }));\n  Template.roomOld.onCreated(function () {\n    var _this2 = this;\n\n    // this.scrollOnBottom = true\n    // this.typing = new msgTyping this.data._id\n    var rid = this.data._id;\n    this.tabBar = this.data.tabBar;\n\n    this.onFile = function (filesToUpload) {\n      fileUpload(filesToUpload, chatMessages[rid].input, {\n        rid: rid\n      });\n    };\n\n    this.rid = rid;\n    this.subscription = new ReactiveVar();\n    this.state = new ReactiveDict();\n    this.userDetail = new ReactiveVar('');\n    var user = Meteor.user();\n    this.autorun(function (c) {\n      var _roomCoordinator$getR;\n\n      var room = Rooms.findOne({\n        _id: rid\n      }, {\n        fields: {\n          t: 1,\n          usernames: 1,\n          uids: 1\n        }\n      });\n\n      if (room.t !== 'd') {\n        return c.stop();\n      }\n\n      if ((_roomCoordinator$getR = roomCoordinator.getRoomDirectives(room.t)) !== null && _roomCoordinator$getR !== void 0 && _roomCoordinator$getR.isGroupChat(room)) {\n        return;\n      }\n\n      var usernames = Array.from(new Set(room.usernames));\n\n      _this2.userDetail.set(_this2.userDetail.get() || (usernames.length === 1 ? usernames[0] : usernames.filter(function (username) {\n        return username !== user.username;\n      })[0]));\n    });\n    this.autorun(function () {\n      var rid = Template.currentData()._id;\n\n      var room = Rooms.findOne({\n        _id: rid\n      }, {\n        fields: {\n          announcement: 1\n        }\n      });\n\n      _this2.state.set('announcement', room.announcement);\n    });\n    this.autorun(function () {\n      var subscription = Subscriptions.findOne({\n        rid: rid\n      });\n\n      _this2.subscription.set(subscription);\n\n      _this2.state.set({\n        subscribed: !!subscription,\n        autoTranslate: subscription && subscription.autoTranslate,\n        autoTranslateLanguage: subscription && subscription.autoTranslateLanguage\n      });\n    });\n    this.showUsersOffline = new ReactiveVar(false);\n    this.atBottom = !FlowRouter.getQueryParam('msg');\n    this.unreadCount = new ReactiveVar(0);\n    this.selectable = new ReactiveVar(false);\n    this.selectedMessages = [];\n    this.selectedRange = [];\n    this.selectablePointer = null;\n    this.flexTemplate = new ReactiveVar();\n    this.groupDetail = new ReactiveVar();\n    this.hideLeaderHeader = new ReactiveVar(false);\n\n    this.resetSelection = function (enabled) {\n      _this2.selectable.set(enabled);\n\n      $('.messages-box .message.selected').removeClass('selected');\n      _this2.selectedMessages = [];\n      _this2.selectedRange = [];\n      _this2.selectablePointer = null;\n    };\n\n    this.selectMessages = function (to) {\n      if (_this2.selectablePointer === to && _this2.selectedRange.length > 0) {\n        _this2.selectedRange = [];\n      } else {\n        var message1 = ChatMessage.findOne(_this2.selectablePointer);\n        var message2 = ChatMessage.findOne(to);\n\n        var minTs = _.min([message1.ts, message2.ts]);\n\n        var maxTs = _.max([message1.ts, message2.ts]);\n\n        _this2.selectedRange = _.pluck(ChatMessage.find({\n          rid: message1.rid,\n          ts: {\n            $gte: minTs,\n            $lte: maxTs\n          }\n        }).fetch(), '_id');\n      }\n    };\n\n    this.getSelectedMessages = function () {\n      var previewMessages;\n      var messages = _this2.selectedMessages;\n      var addMessages = false;\n\n      for (var _i = 0, _Array$from = Array.from(_this2.selectedRange); _i < _Array$from.length; _i++) {\n        var message = _Array$from[_i];\n\n        if (messages.indexOf(message) === -1) {\n          addMessages = true;\n          break;\n        }\n      }\n\n      if (addMessages) {\n        previewMessages = _.compact(_.uniq(_this2.selectedMessages.concat(_this2.selectedRange)));\n      } else {\n        previewMessages = _.compact(_.difference(_this2.selectedMessages, _this2.selectedRange));\n      }\n\n      return previewMessages;\n    };\n\n    this.clearUserDetail = function () {\n      _this2.userDetail.set(null);\n\n      _this2.tabBar.setData({});\n\n      _this2.tabBar.close();\n    };\n\n    Meteor.call('getRoomRoles', this.data._id, function (error, results) {\n      if (error) {\n        handleError(error);\n      }\n\n      return Array.from(results).forEach(function (record) {\n        delete record._id;\n        RoomRoles.upsert({\n          'rid': record.rid,\n          'u._id': record.u._id\n        }, record);\n      });\n    });\n    this.rolesObserve = RoomRoles.find({\n      rid: this.data._id\n    }).observe({\n      added: function (role) {\n        if (!role.u || !role.u._id) {\n          return;\n        }\n\n        ChatMessage.update({\n          'rid': _this2.data._id,\n          'u._id': role.u._id\n        }, {\n          $addToSet: {\n            roles: role._id\n          }\n        }, {\n          multi: true\n        });\n      },\n      // Update message to re-render DOM\n      changed: function (role) {\n        if (!role.u || !role.u._id) {\n          return;\n        }\n\n        ChatMessage.update({\n          'rid': _this2.data._id,\n          'u._id': role.u._id\n        }, {\n          $inc: {\n            rerender: 1\n          }\n        }, {\n          multi: true\n        });\n      },\n      // Update message to re-render DOM\n      removed: function (role) {\n        if (!role.u || !role.u._id) {\n          return;\n        }\n\n        ChatMessage.update({\n          'rid': _this2.data._id,\n          'u._id': role.u._id\n        }, {\n          $pull: {\n            roles: role._id\n          }\n        }, {\n          multi: true\n        });\n      }\n    });\n\n    this.sendToBottomIfNecessary = function () {\n      if (_this2.atBottom === true) {\n        _this2.sendToBottom();\n      }\n    };\n  }); // Update message to re-render DOM\n\n  Template.roomOld.onDestroyed(function () {\n    if (this.rolesObserve) {\n      this.rolesObserve.stop();\n    }\n\n    readMessage.off(this.data._id);\n    window.removeEventListener('resize', this.onWindowResize);\n    this.observer && this.observer.disconnect();\n    var chatMessage = chatMessages[this.data._id];\n    chatMessage.onDestroyed && chatMessage.onDestroyed(this.data._id);\n    callbacks.remove('streamNewMessage', this.data._id);\n  });\n\n  var isAtBottom = function (element) {\n    var scrollThreshold = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n    return element.scrollTop + scrollThreshold >= element.scrollHeight - element.clientHeight;\n  };\n\n  Template.roomOld.onRendered(function () {\n    var _this3 = this;\n\n    var rid = this.data._id;\n\n    if (!chatMessages[rid]) {\n      chatMessages[rid] = new ChatMessages();\n    }\n\n    var wrapper = this.find('.wrapper');\n    var store = NewRoomManager.getStore(rid);\n\n    var afterMessageGroup = function () {\n      if (store.scroll && !store.atBottom) {\n        wrapper.scrollTop = store.scroll;\n      } else {\n        _this3.sendToBottom();\n      }\n\n      wrapper.removeEventListener('MessageGroup', afterMessageGroup);\n      wrapper.addEventListener('scroll', _.throttle(function () {\n        store.update({\n          scroll: wrapper.scrollTop,\n          atBottom: isAtBottom(wrapper, 50)\n        });\n      }, 30));\n    };\n\n    wrapper.addEventListener('MessageGroup', afterMessageGroup);\n    chatMessages[rid].initializeWrapper(this.find('.wrapper'));\n    chatMessages[rid].initializeInput(this.find('.js-input-message'), {\n      rid: rid\n    });\n    var wrapperUl = this.find('.wrapper > ul');\n    var newMessage = this.find('.new-message');\n    var template = this;\n    var messageBox = $('.messages-box');\n\n    template.isAtBottom = function () {\n      var scrollThreshold = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n\n      if (isAtBottom(wrapper, scrollThreshold)) {\n        newMessage.className = 'new-message background-primary-action-color color-content-background-color not';\n        return true;\n      }\n\n      return false;\n    };\n\n    template.sendToBottom = function () {\n      wrapper.scrollTo(30, wrapper.scrollHeight);\n      newMessage.className = 'new-message background-primary-action-color color-content-background-color not';\n    };\n\n    template.checkIfScrollIsAtBottom = function () {\n      template.atBottom = template.isAtBottom(100);\n    };\n\n    template.observer = new ResizeObserver(function () {\n      return template.sendToBottomIfNecessary();\n    });\n    template.observer.observe(wrapperUl);\n\n    var wheelHandler = _.throttle(function () {\n      template.checkIfScrollIsAtBottom();\n    }, 100);\n\n    wrapper.addEventListener('mousewheel', wheelHandler);\n    wrapper.addEventListener('wheel', wheelHandler);\n    wrapper.addEventListener('touchstart', function () {\n      template.atBottom = false;\n    });\n    wrapper.addEventListener('touchend', function () {\n      template.checkIfScrollIsAtBottom();\n      setTimeout(function () {\n        return template.checkIfScrollIsAtBottom();\n      }, 1000);\n      setTimeout(function () {\n        return template.checkIfScrollIsAtBottom();\n      }, 2000);\n    });\n    Tracker.afterFlush(function () {\n      wrapper.addEventListener('scroll', wheelHandler);\n    });\n    this.lastScrollTop = $('.messages-box .wrapper').scrollTop();\n    var rtl = $('html').hasClass('rtl');\n\n    var getElementFromPoint = function () {\n      var topOffset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n      var messageBoxOffset = messageBox.offset();\n      var element;\n\n      if (rtl) {\n        element = document.elementFromPoint(messageBoxOffset.left + messageBox.width() - 1, messageBoxOffset.top + topOffset + 1);\n      } else {\n        element = document.elementFromPoint(messageBoxOffset.left + 1, messageBoxOffset.top + topOffset + 1);\n      }\n\n      if (element && element.classList.contains('message')) {\n        return element;\n      }\n    };\n\n    var updateUnreadCount = _.throttle(function () {\n      Tracker.afterFlush(function () {\n        var lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n        if (!lastInvisibleMessageOnScreen || !lastInvisibleMessageOnScreen.id) {\n          return _this3.unreadCount.set(0);\n        }\n\n        var lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\n        if (!lastMessage) {\n          return _this3.unreadCount.set(0);\n        }\n\n        _this3.state.set('lastMessage', lastMessage.ts);\n      });\n    }, 300);\n\n    var read = _.debounce(function () {\n      if (rid !== Session.get('openedRoom')) {\n        return;\n      }\n\n      readMessage.read(rid);\n    }, 500);\n\n    this.autorun(function () {\n      var _room;\n\n      if (rid !== Session.get('openedRoom')) {\n        return;\n      }\n\n      var room = Rooms.findOne({\n        _id: rid\n      }, {\n        fields: {\n          t: 1\n        }\n      });\n\n      if (((_room = room) === null || _room === void 0 ? void 0 : _room.t) === 'l') {\n        var _roomCoordinator$getR2;\n\n        room = Tracker.nonreactive(function () {\n          return Rooms.findOne({\n            _id: rid\n          });\n        });\n        (_roomCoordinator$getR2 = roomCoordinator.getRoomDirectives(room.t)) === null || _roomCoordinator$getR2 === void 0 ? void 0 : _roomCoordinator$getR2.openCustomProfileTab(_this3, room, room.v.username);\n      }\n    });\n    this.autorun(function () {\n      if (!roomCoordinator.isRouteNameKnown(FlowRouter.getRouteName())) {\n        return;\n      }\n\n      if (rid !== Session.get('openedRoom')) {\n        return;\n      }\n\n      var subscription = Subscriptions.findOne({\n        rid: rid\n      }, {\n        fields: {\n          alert: 1,\n          unread: 1\n        }\n      });\n      read();\n      return subscription && (subscription.alert || subscription.unread) && readMessage.refreshUnreadMark(rid);\n    });\n    this.autorun(function () {\n      var lastMessage = _this3.state.get('lastMessage');\n\n      var subscription = Subscriptions.findOne({\n        rid: rid\n      }, {\n        fields: {\n          ls: 1\n        }\n      });\n\n      if (!subscription) {\n        _this3.unreadCount.set(0);\n\n        return;\n      }\n\n      var count = ChatMessage.find({\n        rid: rid,\n        ts: {\n          $lte: lastMessage,\n          $gt: subscription && subscription.ls\n        }\n      }).count();\n\n      _this3.unreadCount.set(count);\n    });\n    this.autorun(function () {\n      var count = RoomHistoryManager.getRoom(rid).unreadNotLoaded.get() + _this3.unreadCount.get();\n\n      _this3.state.set('count', count);\n    });\n    this.autorun(function () {\n      Rooms.findOne(rid);\n\n      var count = _this3.state.get('count');\n\n      if (count === 0) {\n        return read();\n      }\n\n      readMessage.refreshUnreadMark(rid);\n    });\n    readMessage.on(template.data._id, function () {\n      return _this3.unreadCount.set(0);\n    });\n    wrapper.addEventListener('scroll', updateUnreadCount); // salva a data da renderizao para exibir alertas de novas mensagens\n\n    $.data(this.firstNode, 'renderedAt', new Date());\n    var webrtc = WebRTC.getInstanceByRoomId(template.data._id);\n\n    if (webrtc) {\n      this.autorun(function () {\n        var remoteItems = webrtc.remoteItems.get();\n\n        if (remoteItems && remoteItems.length > 0 || webrtc.localUrl.get()) {\n          return _this3.tabBar.openUserInfo();\n        }\n      });\n    }\n\n    callbacks.add('streamNewMessage', function (msg) {\n      if (rid !== msg.rid || msg.editedAt || msg.tmid) {\n        return;\n      }\n\n      if (msg.u._id === Meteor.userId()) {\n        return template.sendToBottom();\n      }\n\n      if (!template.isAtBottom()) {\n        newMessage.classList.remove('not');\n      }\n    }, callbacks.priority.MEDIUM, rid);\n    this.autorun(function () {\n      if (template.data._id !== RoomManager.openedRoom) {\n        return;\n      }\n\n      var room = Rooms.findOne({\n        _id: template.data._id\n      });\n\n      if (!room) {\n        return FlowRouter.go('home');\n      }\n    });\n  });\n});\ncallbacks.add('enter-room', function (sub) {\n  if (!sub) {\n    return;\n  }\n\n  var isAReplyInDMFromChannel = FlowRouter.getQueryParam('reply') && sub.t === 'd';\n\n  if (isAReplyInDMFromChannel && chatMessages[sub.rid]) {\n    chatMessages[sub.rid].restoreReplies();\n  }\n\n  setTimeout(function () {\n    return readMessage.read(sub.rid);\n  }, 1000);\n});","map":{"version":3,"sources":["app/ui/client/views/app/room.js"],"names":["_toConsumableArray","module","link","default","v","_objectSpread","_regeneratorRuntime","export","chatMessages","dropzoneHelpers","dropzoneEvents","_","moment","Meteor","Tracker","ReactiveDict","ReactiveVar","Random","Blaze","FlowRouter","Session","Template","t","getUserPreference","WebRTC","ChatMessage","RoomRoles","Users","Subscriptions","Rooms","RoomHistoryManager","RoomManager","readMessage","messageContext","messageArgs","settings","callbacks","hasAllPermission","hasRole","ChatMessages","fileUpload","getCommonRoomEvents","NewRoomManager","isLayoutEmbedded","handleError","roomCoordinator","userCanDrop","_id","readOnly","findOne","userId","fields","username","wipeFailedUploads","uploads","get","set","filter","upload","error","roomHasGlobalPurge","room","roomHasPurge","retention","enabled","undefined","roomFilesOnly","overrideGlobal","filesOnly","roomExcludePinned","excludePinned","roomMaxAge","maxAge","createFileFromUrl","url","fetch","response","blob","data","metadata","type","mime","file","File","format","extension","addToInput","text","input","openedRoom","initText","value","slice","selectionStart","finalText","selectionEnd","length","$","change","trigger","add","dragAndDrop","isDropzoneDisabled","dragAndDropLabel","roomOld","helpers","tabBar","instance","subscribed","state","messagesHistory","showInMainThread","rid","sysMes","hideSettings","collection","settingValues","Array","isArray","hideMessagesOfType","Set","reduce","array","query","_hidden","$ne","$or","tmid","$exists","tshow","$eq","size","$nin","from","values","options","sort","ts","find","hasMore","hasMoreNext","isLoading","windowId","uploading","roomLeader","roles","leader","u","status","statusText","name","statusDisplay","chatNowLink","getRouteLink","announcement","announcementDetails","roomData","callback","run","messageboxData","sendToBottomIfNecessary","subscription","isEmbedded","showFormattingTips","onInputChanged","initializeInput","onResize","onKeyUp","args","keyup","apply","onKeyDown","keydown","onSend","send","getAnnouncementStyle","style","maxMessageLength","unreadData","count","getOpenedRoomByRid","since","unreadSince","containerBarsShow","hasUnreadData","isUploading","formatUnreadSince","calendar","sameDay","adminClass","messageViewMode","viewMode","modes","selectable","hideUsername","hideAvatar","canPreview","hideLeaderHeader","hasLeader","hasPurge","purgeTimeout","relativeTimeThreshold","duration","humanize","openedThread","watchPathChange","tab","getParam","mid","currentData","jump","getQueryParam","usernames","uids","e","types","originalEvent","dataTransfer","some","indexOf","currentTarget","classList","stopPropagation","parentNode","remove","document","querySelectorAll","forEach","dropzone","includes","effectAllowed","dropEffect","event","preventDefault","files","transferData","getData","match","imgURL","trim","filesToUpload","map","Object","defineProperty","lookup","onFile","startup","events","id","dataset","message","querySelector","toggle","template","selection","empty","window","getSelection","removeAllRanges","msg","selectablePointer","shiftKey","selectedMessages","getSelectedMessages","selectedRange","selectMessages","i","removeClass","difference","addClass","atBottom","clear","focus","readNow","getRoom","firstUnread","$gt","ls","limit","getSurroundingMessages","throttle","$roomLeader","target","scrollTop","lastScrollTop","isAtBottom","height","clientHeight","getMore","Math","ceil","scrollHeight","getMoreNext","repliedMessageId","attachments","message_link","split","go","current","context","pathname","hash","onCreated","userDetail","user","autorun","c","stop","getRoomDirectives","isGroupChat","autoTranslate","autoTranslateLanguage","showUsersOffline","unreadCount","flexTemplate","groupDetail","resetSelection","to","message1","message2","minTs","min","maxTs","max","pluck","$gte","$lte","previewMessages","messages","addMessages","compact","uniq","concat","clearUserDetail","setData","close","call","results","record","upsert","rolesObserve","observe","added","role","update","$addToSet","multi","changed","$inc","rerender","removed","$pull","sendToBottom","onDestroyed","off","removeEventListener","onWindowResize","observer","disconnect","chatMessage","element","scrollThreshold","onRendered","wrapper","store","getStore","afterMessageGroup","scroll","addEventListener","initializeWrapper","wrapperUl","newMessage","messageBox","className","scrollTo","checkIfScrollIsAtBottom","ResizeObserver","wheelHandler","setTimeout","afterFlush","rtl","hasClass","getElementFromPoint","topOffset","messageBoxOffset","offset","elementFromPoint","left","width","top","contains","updateUnreadCount","lastInvisibleMessageOnScreen","lastMessage","read","debounce","nonreactive","openCustomProfileTab","isRouteNameKnown","getRouteName","alert","unread","refreshUnreadMark","unreadNotLoaded","on","firstNode","Date","webrtc","getInstanceByRoomId","remoteItems","localUrl","openUserInfo","editedAt","priority","MEDIUM","sub","isAReplyInDMFromChannel","restoreReplies"],"mappings":"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","sourcesContent":["import _ from 'underscore';\nimport moment from 'moment';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { ReactiveDict } from 'meteor/reactive-dict';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { Random } from 'meteor/random';\nimport { Blaze } from 'meteor/blaze';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\nimport { Session } from 'meteor/session';\nimport { Template } from 'meteor/templating';\n\nimport { t, getUserPreference } from '../../../../utils/client';\nimport { WebRTC } from '../../../../webrtc/client';\nimport { ChatMessage, RoomRoles, Users, Subscriptions, Rooms } from '../../../../models';\nimport { RoomHistoryManager, RoomManager, readMessage } from '../../../../ui-utils/client';\nimport { messageContext } from '../../../../ui-utils/client/lib/messageContext';\nimport { messageArgs } from '../../../../ui-utils/client/lib/messageArgs';\nimport { settings } from '../../../../settings/client';\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { hasAllPermission, hasRole } from '../../../../authorization/client';\nimport { ChatMessages } from '../../lib/chatMessages';\nimport { fileUpload } from '../../lib/fileUpload';\nimport './room.html';\nimport { getCommonRoomEvents } from './lib/getCommonRoomEvents';\nimport { RoomManager as NewRoomManager } from '../../../../../client/lib/RoomManager';\nimport { isLayoutEmbedded } from '../../../../../client/lib/utils/isLayoutEmbedded';\nimport { handleError } from '../../../../../client/lib/utils/handleError';\nimport { roomCoordinator } from '../../../../../client/lib/rooms/roomCoordinator';\n\nexport const chatMessages = {};\n\nconst userCanDrop = (_id) => !roomCoordinator.readOnly(_id, Users.findOne({ _id: Meteor.userId() }, { fields: { username: 1 } }));\n\nconst wipeFailedUploads = () => {\n\tconst uploads = Session.get('uploading');\n\n\tif (uploads) {\n\t\tSession.set(\n\t\t\t'uploading',\n\t\t\tuploads.filter((upload) => !upload.error),\n\t\t);\n\t}\n};\n\nfunction roomHasGlobalPurge(room) {\n\tif (!settings.get('RetentionPolicy_Enabled')) {\n\t\treturn false;\n\t}\n\n\tswitch (room.t) {\n\t\tcase 'c':\n\t\t\treturn settings.get('RetentionPolicy_AppliesToChannels');\n\t\tcase 'p':\n\t\t\treturn settings.get('RetentionPolicy_AppliesToGroups');\n\t\tcase 'd':\n\t\t\treturn settings.get('RetentionPolicy_AppliesToDMs');\n\t}\n\treturn false;\n}\n\nfunction roomHasPurge(room) {\n\tif (!room || !settings.get('RetentionPolicy_Enabled')) {\n\t\treturn false;\n\t}\n\n\tif (room.retention && room.retention.enabled !== undefined) {\n\t\treturn room.retention.enabled;\n\t}\n\n\treturn roomHasGlobalPurge(room);\n}\n\nfunction roomFilesOnly(room) {\n\tif (!room) {\n\t\treturn false;\n\t}\n\n\tif (room.retention && room.retention.overrideGlobal) {\n\t\treturn room.retention.filesOnly;\n\t}\n\n\treturn settings.get('RetentionPolicy_FilesOnly');\n}\n\nfunction roomExcludePinned(room) {\n\tif (!room) {\n\t\treturn false;\n\t}\n\n\tif (room.retention && room.retention.overrideGlobal) {\n\t\treturn room.retention.excludePinned;\n\t}\n\n\treturn settings.get('RetentionPolicy_DoNotPrunePinned');\n}\n\nfunction roomMaxAge(room) {\n\tif (!room) {\n\t\treturn;\n\t}\n\tif (!roomHasPurge(room)) {\n\t\treturn;\n\t}\n\n\tif (room.retention && room.retention.overrideGlobal) {\n\t\treturn room.retention.maxAge;\n\t}\n\n\tif (room.t === 'c') {\n\t\treturn settings.get('RetentionPolicy_MaxAge_Channels');\n\t}\n\tif (room.t === 'p') {\n\t\treturn settings.get('RetentionPolicy_MaxAge_Groups');\n\t}\n\tif (room.t === 'd') {\n\t\treturn settings.get('RetentionPolicy_MaxAge_DMs');\n\t}\n}\n\nasync function createFileFromUrl(url) {\n\tlet response;\n\ttry {\n\t\tresponse = await fetch(url);\n\t} catch (error) {\n\t\tthrow error;\n\t}\n\n\tconst data = await response.blob();\n\tconst metadata = {\n\t\ttype: data.type,\n\t};\n\tconst { mime } = await import('../../../../utils/lib/mimeTypes');\n\tconst file = new File(\n\t\t[data],\n\t\t`File - ${moment().format(settings.get('Message_TimeAndDateFormat'))}.${mime.extension(data.type)}`,\n\t\tmetadata,\n\t);\n\treturn file;\n}\n\nfunction addToInput(text) {\n\tconst { input } = chatMessages[RoomManager.openedRoom];\n\tconst initText = input.value.slice(0, input.selectionStart);\n\tconst finalText = input.value.slice(input.selectionEnd, input.value.length);\n\n\tinput.value = initText + text + finalText;\n\t$(input).change().trigger('input');\n}\n\ncallbacks.add('enter-room', wipeFailedUploads);\n\nexport const dropzoneHelpers = {\n\tdragAndDrop() {\n\t\treturn settings.get('FileUpload_Enabled') && 'dropzone--disabled';\n\t},\n\n\tisDropzoneDisabled() {\n\t\treturn settings.get('FileUpload_Enabled') ? 'dropzone-overlay--enabled' : 'dropzone-overlay--disabled';\n\t},\n\n\tdragAndDropLabel() {\n\t\tif (!userCanDrop(this._id)) {\n\t\t\treturn 'error-not-allowed';\n\t\t}\n\t\tif (!settings.get('FileUpload_Enabled')) {\n\t\t\treturn 'FileUpload_Disabled';\n\t\t}\n\t\treturn 'Drop_to_upload_file';\n\t},\n};\n\nTemplate.roomOld.helpers({\n\t...dropzoneHelpers,\n\ttabBar() {\n\t\treturn Template.instance().tabBar;\n\t},\n\tsubscribed() {\n\t\tconst { state } = Template.instance();\n\t\treturn state.get('subscribed');\n\t},\n\tmessagesHistory() {\n\t\tconst showInMainThread = getUserPreference(Meteor.userId(), 'showMessageInMainThread', false);\n\t\tconst { rid } = Template.instance();\n\t\tconst room = Rooms.findOne(rid, { fields: { sysMes: 1 } });\n\t\tconst hideSettings = settings.collection.findOne('Hide_System_Messages') || {};\n\t\tconst settingValues = Array.isArray(room?.sysMes) ? room.sysMes : hideSettings.value || [];\n\t\tconst hideMessagesOfType = new Set(\n\t\t\tsettingValues.reduce((array, value) => [...array, ...(value === 'mute_unmute' ? ['user-muted', 'user-unmuted'] : [value])], []),\n\t\t);\n\t\tconst query = {\n\t\t\trid,\n\t\t\t_hidden: { $ne: true },\n\t\t\t...(!showInMainThread && {\n\t\t\t\t$or: [{ tmid: { $exists: 0 } }, { tshow: { $eq: true } }],\n\t\t\t}),\n\t\t};\n\n\t\tif (hideMessagesOfType.size) {\n\t\t\tquery.t = { $nin: Array.from(hideMessagesOfType.values()) };\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tts: 1,\n\t\t\t},\n\t\t};\n\n\t\treturn ChatMessage.find(query, options);\n\t},\n\n\thasMore() {\n\t\treturn RoomHistoryManager.hasMore(this._id);\n\t},\n\n\thasMoreNext() {\n\t\treturn RoomHistoryManager.hasMoreNext(this._id);\n\t},\n\n\tisLoading() {\n\t\treturn RoomHistoryManager.isLoading(this._id);\n\t},\n\n\twindowId() {\n\t\treturn `chat-window-${this._id}`;\n\t},\n\n\tuploading() {\n\t\treturn Session.get('uploading');\n\t},\n\n\troomLeader() {\n\t\tconst roles = RoomRoles.findOne({\n\t\t\t'rid': this._id,\n\t\t\t'roles': 'leader',\n\t\t\t'u._id': { $ne: Meteor.userId() },\n\t\t});\n\t\tif (roles) {\n\t\t\tconst leader = Users.findOne({ _id: roles.u._id }, { fields: { status: 1, statusText: 1 } }) || {};\n\n\t\t\treturn {\n\t\t\t\t...roles.u,\n\t\t\t\tname: settings.get('UI_Use_Real_Name') ? roles.u.name || roles.u.username : roles.u.username,\n\t\t\t\tstatus: leader.status || 'offline',\n\t\t\t\tstatusDisplay: leader.statusText || t(leader.status || 'offline'),\n\t\t\t};\n\t\t}\n\t},\n\n\tchatNowLink() {\n\t\treturn roomCoordinator.getRouteLink('d', { name: this.username });\n\t},\n\n\tannouncement() {\n\t\treturn Template.instance().state.get('announcement');\n\t},\n\n\tannouncementDetails() {\n\t\tconst roomData = Session.get(`roomData${this._id}`);\n\t\tif (!roomData) {\n\t\t\treturn false;\n\t\t}\n\t\tif (roomData.announcementDetails != null && roomData.announcementDetails.callback != null) {\n\t\t\treturn () => callbacks.run(roomData.announcementDetails.callback, this._id);\n\t\t}\n\t},\n\n\tmessageboxData() {\n\t\tconst { sendToBottomIfNecessary, subscription } = Template.instance();\n\t\tconst { _id: rid } = this;\n\t\tconst isEmbedded = isLayoutEmbedded();\n\t\tconst showFormattingTips = settings.get('Message_ShowFormattingTips');\n\n\t\treturn {\n\t\t\trid,\n\t\t\tsubscription: subscription.get(),\n\t\t\tisEmbedded,\n\t\t\tshowFormattingTips: showFormattingTips && !isEmbedded,\n\t\t\tonInputChanged: (input) => {\n\t\t\t\tif (!chatMessages[rid]) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tchatMessages[rid].initializeInput(input, { rid });\n\t\t\t},\n\t\t\tonResize: () => sendToBottomIfNecessary && sendToBottomIfNecessary(),\n\t\t\tonKeyUp: (...args) => chatMessages[rid] && chatMessages[rid].keyup.apply(chatMessages[rid], args),\n\t\t\tonKeyDown: (...args) => chatMessages[rid] && chatMessages[rid].keydown.apply(chatMessages[rid], args),\n\t\t\tonSend: (...args) => chatMessages[rid] && chatMessages[rid].send.apply(chatMessages[rid], args),\n\t\t};\n\t},\n\n\tgetAnnouncementStyle() {\n\t\tconst { room } = Template.instance();\n\t\tif (!room) {\n\t\t\treturn '';\n\t\t}\n\t\treturn room.announcementDetails && room.announcementDetails.style !== undefined ? room.announcementDetails.style : '';\n\t},\n\n\tmaxMessageLength() {\n\t\treturn settings.get('Message_MaxAllowedSize');\n\t},\n\n\tunreadData() {\n\t\tconst data = { count: Template.instance().state.get('count') };\n\n\t\tconst room = RoomManager.getOpenedRoomByRid(this._id);\n\t\tif (room) {\n\t\t\tdata.since = room.unreadSince.get();\n\t\t}\n\n\t\treturn data;\n\t},\n\n\tcontainerBarsShow(unreadData, uploading) {\n\t\tconst hasUnreadData = unreadData && unreadData.count && unreadData.since;\n\t\tconst isUploading = uploading && uploading.length;\n\n\t\tif (hasUnreadData || isUploading) {\n\t\t\treturn 'show';\n\t\t}\n\t},\n\n\tformatUnreadSince() {\n\t\tif (!this.since) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn moment(this.since).calendar(null, { sameDay: 'LT' });\n\t},\n\tadminClass() {\n\t\tif (hasRole(Meteor.userId(), 'admin')) {\n\t\t\treturn 'admin';\n\t\t}\n\t},\n\n\tmessageViewMode() {\n\t\tconst viewMode = getUserPreference(Meteor.userId(), 'messageViewMode');\n\t\tconst modes = ['', 'cozy', 'compact'];\n\t\treturn modes[viewMode] || modes[0];\n\t},\n\n\tselectable() {\n\t\treturn Template.instance().selectable.get();\n\t},\n\n\thideUsername() {\n\t\treturn getUserPreference(Meteor.userId(), 'hideUsernames') ? 'hide-usernames' : undefined;\n\t},\n\n\thideAvatar() {\n\t\treturn getUserPreference(Meteor.userId(), 'displayAvatars') ? undefined : 'hide-avatars';\n\t},\n\tcanPreview() {\n\t\tconst { room, state } = Template.instance();\n\n\t\tif (room && room.t !== 'c') {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (settings.get('Accounts_AllowAnonymousRead') === true) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (hasAllPermission('preview-c-room')) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn state.get('subscribed');\n\t},\n\thideLeaderHeader() {\n\t\treturn Template.instance().hideLeaderHeader.get() ? 'animated-hidden' : '';\n\t},\n\thasLeader() {\n\t\tif (RoomRoles.findOne({ 'rid': this._id, 'roles': 'leader', 'u._id': { $ne: Meteor.userId() } }, { fields: { _id: 1 } })) {\n\t\t\treturn 'has-leader';\n\t\t}\n\t},\n\thasPurge() {\n\t\tconst { room } = Template.instance();\n\t\treturn roomHasPurge(room);\n\t},\n\tfilesOnly() {\n\t\tconst { room } = Template.instance();\n\t\treturn roomFilesOnly(room);\n\t},\n\texcludePinned() {\n\t\tconst { room } = Template.instance();\n\t\treturn roomExcludePinned(room);\n\t},\n\tpurgeTimeout() {\n\t\tconst { room } = Template.instance();\n\t\tmoment.relativeTimeThreshold('s', 60);\n\t\tmoment.relativeTimeThreshold('ss', 0);\n\t\tmoment.relativeTimeThreshold('m', 60);\n\t\tmoment.relativeTimeThreshold('h', 24);\n\t\tmoment.relativeTimeThreshold('d', 31);\n\t\tmoment.relativeTimeThreshold('M', 12);\n\n\t\treturn moment.duration(roomMaxAge(room) * 1000 * 60 * 60 * 24).humanize();\n\t},\n\tmessageContext,\n\topenedThread() {\n\t\tFlowRouter.watchPathChange();\n\t\tconst tab = FlowRouter.getParam('tab');\n\t\tconst mid = FlowRouter.getParam('context');\n\t\tconst rid = Template.currentData()._id;\n\t\tconst jump = FlowRouter.getQueryParam('jump');\n\t\tconst subscription = Template.instance().subscription.get();\n\n\t\tif (tab !== 'thread' || !mid || rid !== Session.get('openedRoom')) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst room = Rooms.findOne(\n\t\t\t{ _id: rid },\n\t\t\t{\n\t\t\t\tfields: {\n\t\t\t\t\tt: 1,\n\t\t\t\t\tusernames: 1,\n\t\t\t\t\tuids: 1,\n\t\t\t\t\tname: 1,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\treturn {\n\t\t\trid,\n\t\t\tmid,\n\t\t\troom,\n\t\t\tjump,\n\t\t\tsubscription,\n\t\t};\n\t},\n});\n\nexport const dropzoneEvents = {\n\t'dragenter .dropzone'(e) {\n\t\tconst types = e.originalEvent && e.originalEvent.dataTransfer && e.originalEvent.dataTransfer.types;\n\n\t\tif (\n\t\t\ttypes != null &&\n\t\t\ttypes.length > 0 &&\n\t\t\t_.some(types, (type) => type.indexOf('text/') === -1 || type.indexOf('text/uri-list') !== -1 || type.indexOf('text/plain') !== -1) &&\n\t\t\tuserCanDrop(this._id)\n\t\t) {\n\t\t\te.currentTarget.classList.add('over');\n\t\t}\n\t\te.stopPropagation();\n\t},\n\n\t'dragleave .dropzone-overlay'(e) {\n\t\te.currentTarget.parentNode.classList.remove('over');\n\t\te.stopPropagation();\n\t},\n\n\t'dragover .dropzone-overlay'(e) {\n\t\tdocument.querySelectorAll('.over.dropzone').forEach((dropzone) => {\n\t\t\tif (dropzone !== e.currentTarget.parentNode) {\n\t\t\t\tdropzone.classList.remove('over');\n\t\t\t}\n\t\t});\n\t\te = e.originalEvent || e;\n\t\tif (['move', 'linkMove'].includes(e.dataTransfer.effectAllowed)) {\n\t\t\te.dataTransfer.dropEffect = 'move';\n\t\t} else {\n\t\t\te.dataTransfer.dropEffect = 'copy';\n\t\t}\n\t\te.stopPropagation();\n\t},\n\n\tasync 'dropped .dropzone-overlay'(event, instance) {\n\t\tevent.currentTarget.parentNode.classList.remove('over');\n\n\t\tconst e = event.originalEvent || event;\n\n\t\te.stopPropagation();\n\t\te.preventDefault();\n\n\t\tif (!userCanDrop(this._id) || !settings.get('FileUpload_Enabled')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet files = (e.dataTransfer && e.dataTransfer.files) || [];\n\n\t\tif (files.length < 1) {\n\t\t\tconst transferData = e.dataTransfer.getData('text') || e.dataTransfer.getData('url');\n\n\t\t\tif (e.dataTransfer.types.includes('text/uri-list')) {\n\t\t\t\tconst url = e.dataTransfer.getData('text/html').match('<img.+src=(?:\"|\\')(.+?)(?:\"|\\')(?:.+?)>');\n\t\t\t\tconst imgURL = url && url[1];\n\n\t\t\t\tif (!imgURL) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst file = await createFileFromUrl(imgURL);\n\t\t\t\tif (typeof file === 'string') {\n\t\t\t\t\treturn addToInput(file);\n\t\t\t\t}\n\t\t\t\tfiles = [file];\n\t\t\t}\n\t\t\tif (e.dataTransfer.types.includes('text/plain') && !e.dataTransfer.types.includes('text/x-moz-url')) {\n\t\t\t\treturn addToInput(transferData.trim());\n\t\t\t}\n\t\t}\n\t\tconst { mime } = await import('../../../../utils/lib/mimeTypes');\n\t\tconst filesToUpload = Array.from(files).map((file) => {\n\t\t\tObject.defineProperty(file, 'type', { value: mime.lookup(file.name) });\n\t\t\treturn {\n\t\t\t\tfile,\n\t\t\t\tname: file.name,\n\t\t\t};\n\t\t});\n\n\t\treturn instance.onFile && instance.onFile(filesToUpload);\n\t},\n};\nMeteor.startup(() => {\n\tTemplate.roomOld.events({\n\t\t...getCommonRoomEvents(),\n\t\t...dropzoneEvents,\n\t\t'click .toggle-hidden'(e) {\n\t\t\tconst id = e.currentTarget.dataset.message;\n\t\t\tdocument.querySelector(`#${id}`).classList.toggle('message--ignored');\n\t\t},\n\n\t\t'click .message'(e, template) {\n\t\t\tif (template.selectable.get()) {\n\t\t\t\t(document.selection != null ? document.selection.empty() : undefined) ||\n\t\t\t\t\t(typeof window.getSelection === 'function' ? window.getSelection().removeAllRanges() : undefined);\n\t\t\t\tconst data = Blaze.getData(e.currentTarget);\n\t\t\t\tconst {\n\t\t\t\t\tmsg: { _id },\n\t\t\t\t} = messageArgs(data);\n\n\t\t\t\tif (!template.selectablePointer) {\n\t\t\t\t\ttemplate.selectablePointer = _id;\n\t\t\t\t}\n\n\t\t\t\tif (!e.shiftKey) {\n\t\t\t\t\ttemplate.selectedMessages = template.getSelectedMessages();\n\t\t\t\t\ttemplate.selectedRange = [];\n\t\t\t\t\ttemplate.selectablePointer = _id;\n\t\t\t\t}\n\n\t\t\t\ttemplate.selectMessages(_id);\n\n\t\t\t\tconst selectedMessages = $('.messages-box .message.selected').map((i, message) => message.id);\n\t\t\t\tconst removeClass = _.difference(selectedMessages, template.getSelectedMessages());\n\t\t\t\tconst addClass = _.difference(template.getSelectedMessages(), selectedMessages);\n\t\t\t\tremoveClass.forEach((message) => $(`.messages-box #${message}`).removeClass('selected'));\n\t\t\t\taddClass.forEach((message) => $(`.messages-box #${message}`).addClass('selected'));\n\t\t\t}\n\t\t},\n\t\t'click .jump-recent button'(e, template) {\n\t\t\te.preventDefault();\n\t\t\ttemplate.atBottom = true;\n\t\t\tRoomHistoryManager.clear(template && template.data && template.data._id);\n\t\t},\n\t\t'load .gallery-item'(e, template) {\n\t\t\ttemplate.sendToBottomIfNecessary();\n\t\t},\n\n\t\t'rendered .js-block-wrapper'(e, template) {\n\t\t\ttemplate.sendToBottomIfNecessary();\n\t\t},\n\t\t'click .new-message'(event, instance) {\n\t\t\tinstance.atBottom = true;\n\t\t\tinstance.sendToBottomIfNecessary();\n\t\t\tchatMessages[RoomManager.openedRoom].input.focus();\n\t\t},\n\t\t'click .upload-progress-close'(e) {\n\t\t\te.preventDefault();\n\t\t\tSession.set(`uploading-cancel-${this.id}`, true);\n\t\t},\n\t\t'click .unread-bar > button.mark-read'(e, t) {\n\t\t\treadMessage.readNow(t.data._id);\n\t\t},\n\n\t\t'click .unread-bar > button.jump-to'(e, t) {\n\t\t\tconst { _id } = t.data;\n\t\t\tconst room = RoomHistoryManager.getRoom(_id);\n\t\t\tlet message = room && room.firstUnread.get();\n\t\t\tif (!message) {\n\t\t\t\tconst subscription = Subscriptions.findOne({ rid: _id });\n\t\t\t\tmessage = ChatMessage.find(\n\t\t\t\t\t{ rid: _id, ts: { $gt: subscription != null ? subscription.ls : undefined } },\n\t\t\t\t\t{ sort: { ts: 1 }, limit: 1 },\n\t\t\t\t).fetch()[0];\n\t\t\t}\n\t\t\tRoomHistoryManager.getSurroundingMessages(message, 50);\n\t\t},\n\t\t'scroll .wrapper': _.throttle(function (e, t) {\n\t\t\tconst $roomLeader = $('.room-leader');\n\t\t\tif ($roomLeader.length) {\n\t\t\t\tif (e.target.scrollTop < t.lastScrollTop) {\n\t\t\t\t\tt.hideLeaderHeader.set(false);\n\t\t\t\t} else if (t.isAtBottom(100) === false && e.target.scrollTop > $roomLeader.height()) {\n\t\t\t\t\tt.hideLeaderHeader.set(true);\n\t\t\t\t}\n\t\t\t}\n\t\t\tt.lastScrollTop = e.target.scrollTop;\n\t\t\tconst height = e.target.clientHeight;\n\t\t\tconst isLoading = RoomHistoryManager.isLoading(this._id);\n\t\t\tconst hasMore = RoomHistoryManager.hasMore(this._id);\n\t\t\tconst hasMoreNext = RoomHistoryManager.hasMoreNext(this._id);\n\n\t\t\tif ((isLoading === false && hasMore === true) || hasMoreNext === true) {\n\t\t\t\tif (hasMore === true && t.lastScrollTop <= height / 3) {\n\t\t\t\t\tRoomHistoryManager.getMore(this._id);\n\t\t\t\t} else if (hasMoreNext === true && Math.ceil(t.lastScrollTop) >= e.target.scrollHeight - height) {\n\t\t\t\t\tRoomHistoryManager.getMoreNext(this._id);\n\t\t\t\t}\n\t\t\t}\n\t\t}, 100),\n\n\t\t'click .time a'(e) {\n\t\t\te.preventDefault();\n\t\t\tconst { msg } = messageArgs(this);\n\t\t\tconst repliedMessageId = msg.attachments[0].message_link.split('?msg=')[1];\n\t\t\tFlowRouter.go(FlowRouter.current().context.pathname, null, {\n\t\t\t\tmsg: repliedMessageId,\n\t\t\t\thash: Random.id(),\n\t\t\t});\n\t\t},\n\t});\n\n\tTemplate.roomOld.onCreated(function () {\n\t\t// this.scrollOnBottom = true\n\t\t// this.typing = new msgTyping this.data._id\n\t\tconst rid = this.data._id;\n\t\tthis.tabBar = this.data.tabBar;\n\n\t\tthis.onFile = (filesToUpload) => {\n\t\t\tfileUpload(filesToUpload, chatMessages[rid].input, { rid });\n\t\t};\n\n\t\tthis.rid = rid;\n\n\t\tthis.subscription = new ReactiveVar();\n\t\tthis.state = new ReactiveDict();\n\t\tthis.userDetail = new ReactiveVar('');\n\t\tconst user = Meteor.user();\n\t\tthis.autorun((c) => {\n\t\t\tconst room = Rooms.findOne(\n\t\t\t\t{ _id: rid },\n\t\t\t\t{\n\t\t\t\t\tfields: {\n\t\t\t\t\t\tt: 1,\n\t\t\t\t\t\tusernames: 1,\n\t\t\t\t\t\tuids: 1,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (room.t !== 'd') {\n\t\t\t\treturn c.stop();\n\t\t\t}\n\n\t\t\tif (roomCoordinator.getRoomDirectives(room.t)?.isGroupChat(room)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst usernames = Array.from(new Set(room.usernames));\n\t\t\tthis.userDetail.set(\n\t\t\t\tthis.userDetail.get() || (usernames.length === 1 ? usernames[0] : usernames.filter((username) => username !== user.username)[0]),\n\t\t\t);\n\t\t});\n\n\t\tthis.autorun(() => {\n\t\t\tconst rid = Template.currentData()._id;\n\t\t\tconst room = Rooms.findOne({ _id: rid }, { fields: { announcement: 1 } });\n\t\t\tthis.state.set('announcement', room.announcement);\n\t\t});\n\n\t\tthis.autorun(() => {\n\t\t\tconst subscription = Subscriptions.findOne({ rid });\n\t\t\tthis.subscription.set(subscription);\n\t\t\tthis.state.set({\n\t\t\t\tsubscribed: !!subscription,\n\t\t\t\tautoTranslate: subscription && subscription.autoTranslate,\n\t\t\t\tautoTranslateLanguage: subscription && subscription.autoTranslateLanguage,\n\t\t\t});\n\t\t});\n\n\t\tthis.showUsersOffline = new ReactiveVar(false);\n\t\tthis.atBottom = !FlowRouter.getQueryParam('msg');\n\t\tthis.unreadCount = new ReactiveVar(0);\n\n\t\tthis.selectable = new ReactiveVar(false);\n\t\tthis.selectedMessages = [];\n\t\tthis.selectedRange = [];\n\t\tthis.selectablePointer = null;\n\n\t\tthis.flexTemplate = new ReactiveVar();\n\n\t\tthis.groupDetail = new ReactiveVar();\n\n\t\tthis.hideLeaderHeader = new ReactiveVar(false);\n\n\t\tthis.resetSelection = (enabled) => {\n\t\t\tthis.selectable.set(enabled);\n\t\t\t$('.messages-box .message.selected').removeClass('selected');\n\t\t\tthis.selectedMessages = [];\n\t\t\tthis.selectedRange = [];\n\t\t\tthis.selectablePointer = null;\n\t\t};\n\n\t\tthis.selectMessages = (to) => {\n\t\t\tif (this.selectablePointer === to && this.selectedRange.length > 0) {\n\t\t\t\tthis.selectedRange = [];\n\t\t\t} else {\n\t\t\t\tconst message1 = ChatMessage.findOne(this.selectablePointer);\n\t\t\t\tconst message2 = ChatMessage.findOne(to);\n\n\t\t\t\tconst minTs = _.min([message1.ts, message2.ts]);\n\t\t\t\tconst maxTs = _.max([message1.ts, message2.ts]);\n\n\t\t\t\tthis.selectedRange = _.pluck(ChatMessage.find({ rid: message1.rid, ts: { $gte: minTs, $lte: maxTs } }).fetch(), '_id');\n\t\t\t}\n\t\t};\n\n\t\tthis.getSelectedMessages = () => {\n\t\t\tlet previewMessages;\n\t\t\tconst messages = this.selectedMessages;\n\t\t\tlet addMessages = false;\n\t\t\tfor (const message of Array.from(this.selectedRange)) {\n\t\t\t\tif (messages.indexOf(message) === -1) {\n\t\t\t\t\taddMessages = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (addMessages) {\n\t\t\t\tpreviewMessages = _.compact(_.uniq(this.selectedMessages.concat(this.selectedRange)));\n\t\t\t} else {\n\t\t\t\tpreviewMessages = _.compact(_.difference(this.selectedMessages, this.selectedRange));\n\t\t\t}\n\n\t\t\treturn previewMessages;\n\t\t};\n\n\t\tthis.clearUserDetail = () => {\n\t\t\tthis.userDetail.set(null);\n\t\t\tthis.tabBar.setData({});\n\t\t\tthis.tabBar.close();\n\t\t};\n\n\t\tMeteor.call('getRoomRoles', this.data._id, function (error, results) {\n\t\t\tif (error) {\n\t\t\t\thandleError(error);\n\t\t\t}\n\n\t\t\treturn Array.from(results).forEach((record) => {\n\t\t\t\tdelete record._id;\n\t\t\t\tRoomRoles.upsert({ 'rid': record.rid, 'u._id': record.u._id }, record);\n\t\t\t});\n\t\t});\n\n\t\tthis.rolesObserve = RoomRoles.find({ rid: this.data._id }).observe({\n\t\t\tadded: (role) => {\n\t\t\t\tif (!role.u || !role.u._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tChatMessage.update({ 'rid': this.data._id, 'u._id': role.u._id }, { $addToSet: { roles: role._id } }, { multi: true });\n\t\t\t}, // Update message to re-render DOM\n\t\t\tchanged: (role) => {\n\t\t\t\tif (!role.u || !role.u._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tChatMessage.update({ 'rid': this.data._id, 'u._id': role.u._id }, { $inc: { rerender: 1 } }, { multi: true });\n\t\t\t}, // Update message to re-render DOM\n\t\t\tremoved: (role) => {\n\t\t\t\tif (!role.u || !role.u._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tChatMessage.update({ 'rid': this.data._id, 'u._id': role.u._id }, { $pull: { roles: role._id } }, { multi: true });\n\t\t\t},\n\t\t});\n\n\t\tthis.sendToBottomIfNecessary = () => {\n\t\t\tif (this.atBottom === true) {\n\t\t\t\tthis.sendToBottom();\n\t\t\t}\n\t\t};\n\t}); // Update message to re-render DOM\n\n\tTemplate.roomOld.onDestroyed(function () {\n\t\tif (this.rolesObserve) {\n\t\t\tthis.rolesObserve.stop();\n\t\t}\n\n\t\treadMessage.off(this.data._id);\n\n\t\twindow.removeEventListener('resize', this.onWindowResize);\n\n\t\tthis.observer && this.observer.disconnect();\n\n\t\tconst chatMessage = chatMessages[this.data._id];\n\t\tchatMessage.onDestroyed && chatMessage.onDestroyed(this.data._id);\n\n\t\tcallbacks.remove('streamNewMessage', this.data._id);\n\t});\n\n\tconst isAtBottom = function (element, scrollThreshold = 0) {\n\t\treturn element.scrollTop + scrollThreshold >= element.scrollHeight - element.clientHeight;\n\t};\n\n\tTemplate.roomOld.onRendered(function () {\n\t\tconst { _id: rid } = this.data;\n\n\t\tif (!chatMessages[rid]) {\n\t\t\tchatMessages[rid] = new ChatMessages();\n\t\t}\n\n\t\tconst wrapper = this.find('.wrapper');\n\n\t\tconst store = NewRoomManager.getStore(rid);\n\n\t\tconst afterMessageGroup = () => {\n\t\t\tif (store.scroll && !store.atBottom) {\n\t\t\t\twrapper.scrollTop = store.scroll;\n\t\t\t} else {\n\t\t\t\tthis.sendToBottom();\n\t\t\t}\n\t\t\twrapper.removeEventListener('MessageGroup', afterMessageGroup);\n\n\t\t\twrapper.addEventListener(\n\t\t\t\t'scroll',\n\t\t\t\t_.throttle(() => {\n\t\t\t\t\tstore.update({ scroll: wrapper.scrollTop, atBottom: isAtBottom(wrapper, 50) });\n\t\t\t\t}, 30),\n\t\t\t);\n\t\t};\n\n\t\twrapper.addEventListener('MessageGroup', afterMessageGroup);\n\n\t\tchatMessages[rid].initializeWrapper(this.find('.wrapper'));\n\t\tchatMessages[rid].initializeInput(this.find('.js-input-message'), { rid });\n\n\t\tconst wrapperUl = this.find('.wrapper > ul');\n\t\tconst newMessage = this.find('.new-message');\n\n\t\tconst template = this;\n\n\t\tconst messageBox = $('.messages-box');\n\n\t\ttemplate.isAtBottom = function (scrollThreshold = 0) {\n\t\t\tif (isAtBottom(wrapper, scrollThreshold)) {\n\t\t\t\tnewMessage.className = 'new-message background-primary-action-color color-content-background-color not';\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t};\n\n\t\ttemplate.sendToBottom = function () {\n\t\t\twrapper.scrollTo(30, wrapper.scrollHeight);\n\t\t\tnewMessage.className = 'new-message background-primary-action-color color-content-background-color not';\n\t\t};\n\n\t\ttemplate.checkIfScrollIsAtBottom = function () {\n\t\t\ttemplate.atBottom = template.isAtBottom(100);\n\t\t};\n\n\t\ttemplate.observer = new ResizeObserver(() => template.sendToBottomIfNecessary());\n\n\t\ttemplate.observer.observe(wrapperUl);\n\n\t\tconst wheelHandler = _.throttle(function () {\n\t\t\ttemplate.checkIfScrollIsAtBottom();\n\t\t}, 100);\n\n\t\twrapper.addEventListener('mousewheel', wheelHandler);\n\n\t\twrapper.addEventListener('wheel', wheelHandler);\n\n\t\twrapper.addEventListener('touchstart', () => {\n\t\t\ttemplate.atBottom = false;\n\t\t});\n\n\t\twrapper.addEventListener('touchend', function () {\n\t\t\ttemplate.checkIfScrollIsAtBottom();\n\t\t\tsetTimeout(() => template.checkIfScrollIsAtBottom(), 1000);\n\t\t\tsetTimeout(() => template.checkIfScrollIsAtBottom(), 2000);\n\t\t});\n\n\t\tTracker.afterFlush(() => {\n\t\t\twrapper.addEventListener('scroll', wheelHandler);\n\t\t});\n\n\t\tthis.lastScrollTop = $('.messages-box .wrapper').scrollTop();\n\n\t\tconst rtl = $('html').hasClass('rtl');\n\n\t\tconst getElementFromPoint = function (topOffset = 0) {\n\t\t\tconst messageBoxOffset = messageBox.offset();\n\n\t\t\tlet element;\n\t\t\tif (rtl) {\n\t\t\t\telement = document.elementFromPoint(messageBoxOffset.left + messageBox.width() - 1, messageBoxOffset.top + topOffset + 1);\n\t\t\t} else {\n\t\t\t\telement = document.elementFromPoint(messageBoxOffset.left + 1, messageBoxOffset.top + topOffset + 1);\n\t\t\t}\n\n\t\t\tif (element && element.classList.contains('message')) {\n\t\t\t\treturn element;\n\t\t\t}\n\t\t};\n\n\t\tconst updateUnreadCount = _.throttle(() => {\n\t\t\tTracker.afterFlush(() => {\n\t\t\t\tconst lastInvisibleMessageOnScreen = getElementFromPoint(0) || getElementFromPoint(20) || getElementFromPoint(40);\n\n\t\t\t\tif (!lastInvisibleMessageOnScreen || !lastInvisibleMessageOnScreen.id) {\n\t\t\t\t\treturn this.unreadCount.set(0);\n\t\t\t\t}\n\n\t\t\t\tconst lastMessage = ChatMessage.findOne(lastInvisibleMessageOnScreen.id);\n\t\t\t\tif (!lastMessage) {\n\t\t\t\t\treturn this.unreadCount.set(0);\n\t\t\t\t}\n\n\t\t\t\tthis.state.set('lastMessage', lastMessage.ts);\n\t\t\t});\n\t\t}, 300);\n\n\t\tconst read = _.debounce(function () {\n\t\t\tif (rid !== Session.get('openedRoom')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treadMessage.read(rid);\n\t\t}, 500);\n\n\t\tthis.autorun(() => {\n\t\t\tif (rid !== Session.get('openedRoom')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet room = Rooms.findOne({ _id: rid }, { fields: { t: 1 } });\n\n\t\t\tif (room?.t === 'l') {\n\t\t\t\troom = Tracker.nonreactive(() => Rooms.findOne({ _id: rid }));\n\t\t\t\troomCoordinator.getRoomDirectives(room.t)?.openCustomProfileTab(this, room, room.v.username);\n\t\t\t}\n\t\t});\n\n\t\tthis.autorun(() => {\n\t\t\tif (!roomCoordinator.isRouteNameKnown(FlowRouter.getRouteName())) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (rid !== Session.get('openedRoom')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst subscription = Subscriptions.findOne({ rid }, { fields: { alert: 1, unread: 1 } });\n\t\t\tread();\n\t\t\treturn subscription && (subscription.alert || subscription.unread) && readMessage.refreshUnreadMark(rid);\n\t\t});\n\n\t\tthis.autorun(() => {\n\t\t\tconst lastMessage = this.state.get('lastMessage');\n\n\t\t\tconst subscription = Subscriptions.findOne({ rid }, { fields: { ls: 1 } });\n\t\t\tif (!subscription) {\n\t\t\t\tthis.unreadCount.set(0);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst count = ChatMessage.find({\n\t\t\t\trid,\n\t\t\t\tts: { $lte: lastMessage, $gt: subscription && subscription.ls },\n\t\t\t}).count();\n\n\t\t\tthis.unreadCount.set(count);\n\t\t});\n\n\t\tthis.autorun(() => {\n\t\t\tconst count = RoomHistoryManager.getRoom(rid).unreadNotLoaded.get() + this.unreadCount.get();\n\t\t\tthis.state.set('count', count);\n\t\t});\n\n\t\tthis.autorun(() => {\n\t\t\tRooms.findOne(rid);\n\t\t\tconst count = this.state.get('count');\n\t\t\tif (count === 0) {\n\t\t\t\treturn read();\n\t\t\t}\n\t\t\treadMessage.refreshUnreadMark(rid);\n\t\t});\n\n\t\treadMessage.on(template.data._id, () => this.unreadCount.set(0));\n\n\t\twrapper.addEventListener('scroll', updateUnreadCount);\n\t\t// salva a data da renderizao para exibir alertas de novas mensagens\n\t\t$.data(this.firstNode, 'renderedAt', new Date());\n\n\t\tconst webrtc = WebRTC.getInstanceByRoomId(template.data._id);\n\t\tif (webrtc) {\n\t\t\tthis.autorun(() => {\n\t\t\t\tconst remoteItems = webrtc.remoteItems.get();\n\t\t\t\tif ((remoteItems && remoteItems.length > 0) || webrtc.localUrl.get()) {\n\t\t\t\t\treturn this.tabBar.openUserInfo();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tcallbacks.add(\n\t\t\t'streamNewMessage',\n\t\t\t(msg) => {\n\t\t\t\tif (rid !== msg.rid || msg.editedAt || msg.tmid) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (msg.u._id === Meteor.userId()) {\n\t\t\t\t\treturn template.sendToBottom();\n\t\t\t\t}\n\n\t\t\t\tif (!template.isAtBottom()) {\n\t\t\t\t\tnewMessage.classList.remove('not');\n\t\t\t\t}\n\t\t\t},\n\t\t\tcallbacks.priority.MEDIUM,\n\t\t\trid,\n\t\t);\n\n\t\tthis.autorun(function () {\n\t\t\tif (template.data._id !== RoomManager.openedRoom) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst room = Rooms.findOne({ _id: template.data._id });\n\t\t\tif (!room) {\n\t\t\t\treturn FlowRouter.go('home');\n\t\t\t}\n\t\t});\n\t});\n});\n\ncallbacks.add('enter-room', (sub) => {\n\tif (!sub) {\n\t\treturn;\n\t}\n\tconst isAReplyInDMFromChannel = FlowRouter.getQueryParam('reply') && sub.t === 'd';\n\tif (isAReplyInDMFromChannel && chatMessages[sub.rid]) {\n\t\tchatMessages[sub.rid].restoreReplies();\n\t}\n\tsetTimeout(() => readMessage.read(sub.rid), 1000);\n});\n"]},"sourceType":"module","hash":"67813217c78c267eb2d8fde6600dbcc18fe84a62"}
