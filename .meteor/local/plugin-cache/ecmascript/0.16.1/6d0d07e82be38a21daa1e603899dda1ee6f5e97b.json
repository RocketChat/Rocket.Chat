{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/theme/server/server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/theme/server/server.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/theme/server/server.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/theme/server/server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/theme/server/server.js"}},"code":"module.export({\n  theme: () => theme\n});\nlet crypto;\nmodule.link(\"crypto\", {\n  default(v) {\n    crypto = v;\n  }\n\n}, 0);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 1);\nlet less;\nmodule.link(\"less\", {\n  default(v) {\n    less = v;\n  }\n\n}, 2);\nlet Autoprefixer;\nmodule.link(\"less-plugin-autoprefixer\", {\n  default(v) {\n    Autoprefixer = v;\n  }\n\n}, 3);\nlet WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 4);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 5);\nlet settings, settingsRegistry;\nmodule.link(\"../../settings/server\", {\n  settings(v) {\n    settings = v;\n  },\n\n  settingsRegistry(v) {\n    settingsRegistry = v;\n  }\n\n}, 6);\nlet Logger;\nmodule.link(\"../../logger\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 7);\nlet addStyle;\nmodule.link(\"../../ui-master/server/inject\", {\n  addStyle(v) {\n    addStyle = v;\n  }\n\n}, 8);\nlet Settings;\nmodule.link(\"../../models/server\", {\n  Settings(v) {\n    Settings = v;\n  }\n\n}, 9);\nconst logger = new Logger('rocketchat:theme');\nlet currentHash = '';\nlet currentSize = 0;\nconst theme = new class {\n  constructor() {\n    this.variables = {};\n    this.packageCallbacks = [];\n    this.customCSS = '';\n    settingsRegistry.add('css', '');\n    settingsRegistry.addGroup('Layout');\n    settings.change('css', () => {\n      process.emit('message', {\n        refresh: 'client'\n      });\n    });\n    this.compileDelayed = _.debounce(Meteor.bindEnvironment(this.compile.bind(this)), 100);\n    settings.watchByRegex(/^theme-./, (key, value) => {\n      if (key === 'theme-custom-css' && value != null) {\n        this.customCSS = value;\n      } else {\n        const name = key.replace(/^theme-[a-z]+-/, '');\n\n        if (this.variables[name] != null) {\n          this.variables[name].value = value;\n        }\n      }\n\n      this.compileDelayed();\n    });\n  }\n\n  compile() {\n    let content = [];\n    content.push(...this.packageCallbacks.map(name => name()));\n    content.push(this.customCSS);\n    content = content.join('\\n');\n    const options = {\n      compress: true,\n      plugins: [new Autoprefixer()]\n    };\n    const start = Date.now();\n    return less.render(content, options, function (err, data) {\n      logger.info({\n        stop_rendering: Date.now() - start\n      });\n\n      if (err != null) {\n        return logger.error(err);\n      }\n\n      Settings.updateValueById('css', data.css);\n      return Meteor.startup(function () {\n        return Meteor.setTimeout(function () {\n          return process.emit('message', {\n            refresh: 'client'\n          });\n        }, 200);\n      });\n    });\n  }\n\n  addColor(name, value, section, properties) {\n    const config = {\n      group: 'Colors',\n      type: 'color',\n      editor: 'color',\n      public: true,\n      properties,\n      section\n    };\n    return settingsRegistry.add(\"theme-color-\".concat(name), value, config);\n  }\n\n  addVariable(type, name, value, section) {\n    let persist = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : true;\n    let editor = arguments.length > 5 ? arguments[5] : undefined;\n    let allowedTypes = arguments.length > 6 ? arguments[6] : undefined;\n    let property = arguments.length > 7 ? arguments[7] : undefined;\n    this.variables[name] = {\n      type,\n      value,\n      editor\n    };\n\n    if (persist) {\n      const config = {\n        group: 'Layout',\n        type,\n        editor: editor || type,\n        section,\n        public: true,\n        allowedTypes,\n        property\n      };\n      return settingsRegistry.add(\"theme-\".concat(type, \"-\").concat(name), value, config);\n    }\n  }\n\n  getVariablesAsObject() {\n    return Object.keys(this.variables).reduce((obj, name) => {\n      obj[name] = this.variables[name].value;\n      return obj;\n    }, {});\n  }\n\n  addPackageAsset(cb) {\n    this.packageCallbacks.push(cb);\n    return this.compileDelayed();\n  }\n\n  getCss() {\n    return settings.get('css') || '';\n  }\n\n}();\nMeteor.startup(() => {\n  settings.watch('css', function () {\n    let value = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';\n    currentHash = crypto.createHash('sha1').update(value).digest('hex');\n    currentSize = value.length;\n    addStyle('css-theme', value);\n  });\n});\nWebApp.rawConnectHandlers.use(function (req, res, next) {\n  const path = req.url.split('?')[0];\n  const prefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX || '';\n\n  if (path !== \"\".concat(prefix, \"/theme.css\")) {\n    return next();\n  }\n\n  res.setHeader('Content-Type', 'text/css; charset=UTF-8');\n  res.setHeader('Content-Length', currentSize);\n  res.setHeader('ETag', \"\\\"\".concat(currentHash, \"\\\"\"));\n  res.write(theme.getCss());\n  res.end();\n});","map":{"version":3,"sources":["app/theme/server/server.js"],"names":["module","export","theme","crypto","link","default","v","_","less","Autoprefixer","WebApp","Meteor","settings","settingsRegistry","Logger","addStyle","Settings","logger","currentHash","currentSize","constructor","variables","packageCallbacks","customCSS","add","addGroup","change","process","emit","refresh","compileDelayed","debounce","bindEnvironment","compile","bind","watchByRegex","key","value","name","replace","content","push","map","join","options","compress","plugins","start","Date","now","render","err","data","info","stop_rendering","error","updateValueById","css","startup","setTimeout","addColor","section","properties","config","group","type","editor","public","addVariable","persist","allowedTypes","property","getVariablesAsObject","Object","keys","reduce","obj","addPackageAsset","cb","getCss","get","watch","createHash","update","digest","length","rawConnectHandlers","use","req","res","next","path","url","split","prefix","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","setHeader","write","end"],"mappings":"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","sourcesContent":["import crypto from 'crypto';\n\nimport _ from 'underscore';\nimport less from 'less';\nimport Autoprefixer from 'less-plugin-autoprefixer';\nimport { WebApp } from 'meteor/webapp';\nimport { Meteor } from 'meteor/meteor';\n\nimport { settings, settingsRegistry } from '../../settings/server';\nimport { Logger } from '../../logger';\nimport { addStyle } from '../../ui-master/server/inject';\nimport { Settings } from '../../models/server';\n\nconst logger = new Logger('rocketchat:theme');\n\nlet currentHash = '';\nlet currentSize = 0;\n\nexport const theme = new (class {\n\tconstructor() {\n\t\tthis.variables = {};\n\t\tthis.packageCallbacks = [];\n\t\tthis.customCSS = '';\n\t\tsettingsRegistry.add('css', '');\n\t\tsettingsRegistry.addGroup('Layout');\n\t\tsettings.change('css', () => {\n\t\t\tprocess.emit('message', {\n\t\t\t\trefresh: 'client',\n\t\t\t});\n\t\t});\n\n\t\tthis.compileDelayed = _.debounce(Meteor.bindEnvironment(this.compile.bind(this)), 100);\n\t\tsettings.watchByRegex(/^theme-./, (key, value) => {\n\t\t\tif (key === 'theme-custom-css' && value != null) {\n\t\t\t\tthis.customCSS = value;\n\t\t\t} else {\n\t\t\t\tconst name = key.replace(/^theme-[a-z]+-/, '');\n\t\t\t\tif (this.variables[name] != null) {\n\t\t\t\t\tthis.variables[name].value = value;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.compileDelayed();\n\t\t});\n\t}\n\n\tcompile() {\n\t\tlet content = [];\n\n\t\tcontent.push(...this.packageCallbacks.map((name) => name()));\n\n\t\tcontent.push(this.customCSS);\n\t\tcontent = content.join('\\n');\n\t\tconst options = {\n\t\t\tcompress: true,\n\t\t\tplugins: [new Autoprefixer()],\n\t\t};\n\t\tconst start = Date.now();\n\t\treturn less.render(content, options, function (err, data) {\n\t\t\tlogger.info({ stop_rendering: Date.now() - start });\n\t\t\tif (err != null) {\n\t\t\t\treturn logger.error(err);\n\t\t\t}\n\t\t\tSettings.updateValueById('css', data.css);\n\n\t\t\treturn Meteor.startup(function () {\n\t\t\t\treturn Meteor.setTimeout(function () {\n\t\t\t\t\treturn process.emit('message', {\n\t\t\t\t\t\trefresh: 'client',\n\t\t\t\t\t});\n\t\t\t\t}, 200);\n\t\t\t});\n\t\t});\n\t}\n\n\taddColor(name, value, section, properties) {\n\t\tconst config = {\n\t\t\tgroup: 'Colors',\n\t\t\ttype: 'color',\n\t\t\teditor: 'color',\n\t\t\tpublic: true,\n\t\t\tproperties,\n\t\t\tsection,\n\t\t};\n\n\t\treturn settingsRegistry.add(`theme-color-${name}`, value, config);\n\t}\n\n\taddVariable(type, name, value, section, persist = true, editor, allowedTypes, property) {\n\t\tthis.variables[name] = {\n\t\t\ttype,\n\t\t\tvalue,\n\t\t\teditor,\n\t\t};\n\t\tif (persist) {\n\t\t\tconst config = {\n\t\t\t\tgroup: 'Layout',\n\t\t\t\ttype,\n\t\t\t\teditor: editor || type,\n\t\t\t\tsection,\n\t\t\t\tpublic: true,\n\t\t\t\tallowedTypes,\n\t\t\t\tproperty,\n\t\t\t};\n\t\t\treturn settingsRegistry.add(`theme-${type}-${name}`, value, config);\n\t\t}\n\t}\n\n\tgetVariablesAsObject() {\n\t\treturn Object.keys(this.variables).reduce((obj, name) => {\n\t\t\tobj[name] = this.variables[name].value;\n\t\t\treturn obj;\n\t\t}, {});\n\t}\n\n\taddPackageAsset(cb) {\n\t\tthis.packageCallbacks.push(cb);\n\t\treturn this.compileDelayed();\n\t}\n\n\tgetCss() {\n\t\treturn settings.get('css') || '';\n\t}\n})();\n\nMeteor.startup(() => {\n\tsettings.watch('css', (value = '') => {\n\t\tcurrentHash = crypto.createHash('sha1').update(value).digest('hex');\n\t\tcurrentSize = value.length;\n\t\taddStyle('css-theme', value);\n\t});\n});\n\nWebApp.rawConnectHandlers.use(function (req, res, next) {\n\tconst path = req.url.split('?')[0];\n\tconst prefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX || '';\n\tif (path !== `${prefix}/theme.css`) {\n\t\treturn next();\n\t}\n\n\tres.setHeader('Content-Type', 'text/css; charset=UTF-8');\n\tres.setHeader('Content-Length', currentSize);\n\tres.setHeader('ETag', `\"${currentHash}\"`);\n\tres.write(theme.getCss());\n\tres.end();\n});\n"]},"sourceType":"module","hash":"6d0d07e82be38a21daa1e603899dda1ee6f5e97b"}
