{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/update.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/matb33:collection-hooks/update.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/update.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/update.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/matb33:collection-hooks/update.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nlet EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON(v) {\n    EJSON = v;\n  }\n\n}, 0);\nlet CollectionHooks;\nmodule.link(\"./collection-hooks\", {\n  CollectionHooks(v) {\n    CollectionHooks = v;\n  }\n\n}, 1);\n\nconst isEmpty = a => !Array.isArray(a) || !a.length;\n\nCollectionHooks.defineAdvice('update', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = {\n    context: this,\n    _super,\n    args\n  };\n  let [selector, mutator, options, callback] = args;\n\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n\n  const async = typeof callback === 'function';\n  let docs;\n  let docIds;\n  let fields;\n  let abort;\n  const prev = {};\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        fields = CollectionHooks.getFields(mutator);\n        docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch();\n        docIds = docs.map(doc => doc._id);\n      } // copy originals for convenience for the 'after' pointcut\n\n\n      if (!isEmpty(aspects.after)) {\n        prev.mutator = EJSON.clone(mutator);\n        prev.options = EJSON.clone(options);\n\n        if (aspects.after.some(o => o.options.fetchPrevious !== false) && CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n          prev.docs = {};\n          docs.forEach(doc => {\n            prev.docs[doc._id] = EJSON.clone(doc);\n          });\n        }\n      } // before\n\n\n      aspects.before.forEach(function (o) {\n        docs.forEach(function (doc) {\n          const r = o.aspect.call(_objectSpread({\n            transform: getTransform(doc)\n          }, ctx), userId, doc, fields, mutator, options);\n          if (r === false) abort = true;\n        });\n      });\n      if (abort) return 0;\n    } catch (e) {\n      if (async) return callback.call(this, e);\n      throw e;\n    }\n  }\n\n  const after = (affected, err) => {\n    if (!suppressAspects && !isEmpty(aspects.after)) {\n      const fields = CollectionHooks.getFields(mutator);\n      const docs = CollectionHooks.getDocs.call(this, instance, {\n        _id: {\n          $in: docIds\n        }\n      }, options).fetch();\n      aspects.after.forEach(o => {\n        docs.forEach(doc => {\n          o.aspect.call(_objectSpread({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err\n          }, ctx), userId, doc, fields, prev.mutator, prev.options);\n        });\n      });\n    }\n  };\n\n  if (async) {\n    const wrappedCallback = function (err, affected) {\n      after(affected, err);\n\n      for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n        args[_key - 2] = arguments[_key];\n      }\n\n      return callback.call(this, err, affected, ...args);\n    };\n\n    return _super.call(this, selector, mutator, options, wrappedCallback);\n  } else {\n    const affected = _super.call(this, selector, mutator, options, callback);\n\n    after(affected);\n    return affected;\n  }\n});","map":{"version":3,"sources":["packages/matb33:collection-hooks/update.js"],"names":["_objectSpread","module","link","default","v","EJSON","CollectionHooks","isEmpty","a","Array","isArray","length","defineAdvice","userId","_super","instance","aspects","getTransform","args","suppressAspects","ctx","context","selector","mutator","options","callback","async","docs","docIds","fields","abort","prev","before","after","getFields","getDocs","call","fetch","map","doc","_id","clone","some","o","fetchPrevious","extendOptions","hookOptions","forEach","r","aspect","transform","e","affected","err","$in","previous","wrappedCallback"],"mappings":"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","sourcesContent":["import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('update', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  let [selector, mutator, options, callback] = args\n  if (typeof options === 'function') {\n    callback = options\n    options = {}\n  }\n  const async = typeof callback === 'function'\n  let docs\n  let docIds\n  let fields\n  let abort\n  const prev = {}\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        fields = CollectionHooks.getFields(mutator)\n        docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch()\n        docIds = docs.map(doc => doc._id)\n      }\n\n      // copy originals for convenience for the 'after' pointcut\n      if (!isEmpty(aspects.after)) {\n        prev.mutator = EJSON.clone(mutator)\n        prev.options = EJSON.clone(options)\n        if (\n          aspects.after.some(o => o.options.fetchPrevious !== false) &&\n          CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false\n        ) {\n          prev.docs = {}\n          docs.forEach((doc) => {\n            prev.docs[doc._id] = EJSON.clone(doc)\n          })\n        }\n      }\n\n      // before\n      aspects.before.forEach(function (o) {\n        docs.forEach(function (doc) {\n          const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc, fields, mutator, options)\n          if (r === false) abort = true\n        })\n      })\n\n      if (abort) return 0\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  const after = (affected, err) => {\n    if (!suppressAspects && !isEmpty(aspects.after)) {\n      const fields = CollectionHooks.getFields(mutator)\n      const docs = CollectionHooks.getDocs.call(this, instance, { _id: { $in: docIds } }, options).fetch()\n\n      aspects.after.forEach((o) => {\n        docs.forEach((doc) => {\n          o.aspect.call({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err,\n            ...ctx\n          }, userId, doc, fields, prev.mutator, prev.options)\n        })\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, affected, ...args) {\n      after(affected, err)\n      return callback.call(this, err, affected, ...args)\n    }\n    return _super.call(this, selector, mutator, options, wrappedCallback)\n  } else {\n    const affected = _super.call(this, selector, mutator, options, callback)\n    after(affected)\n    return affected\n  }\n})\n"]},"sourceType":"module","hash":"b500adfe3a8e1575e9fd3d1331e828ab9cb8ccad"}
