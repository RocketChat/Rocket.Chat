{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/file-upload/server/config/FileSystem.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/file-upload/server/config/FileSystem.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/file-upload/server/config/FileSystem.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/file-upload/server/config/FileSystem.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file-upload/server/config/FileSystem.js"}},"code":"let fs;\nmodule.link(\"fs\", {\n  default(v) {\n    fs = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet UploadFS;\nmodule.link(\"meteor/jalik:ufs\", {\n  UploadFS(v) {\n    UploadFS = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\nlet FileUploadClass, FileUpload;\nmodule.link(\"../lib/FileUpload\", {\n  FileUploadClass(v) {\n    FileUploadClass = v;\n  },\n\n  FileUpload(v) {\n    FileUpload = v;\n  }\n\n}, 4);\nlet getFileRange, setRangeHeaders;\nmodule.link(\"../lib/ranges\", {\n  getFileRange(v) {\n    getFileRange = v;\n  },\n\n  setRangeHeaders(v) {\n    setRangeHeaders = v;\n  }\n\n}, 5);\nconst statSync = Meteor.wrapAsync(fs.stat);\nconst FileSystemUploads = new FileUploadClass({\n  name: 'FileSystem:Uploads',\n\n  // store setted bellow\n  get(file, req, res) {\n    const filePath = this.store.getFilePath(file._id, file);\n    const options = {};\n\n    try {\n      const stat = statSync(filePath);\n\n      if (!(stat !== null && stat !== void 0 && stat.isFile())) {\n        res.writeHead(404);\n        res.end();\n        return;\n      }\n\n      file = FileUpload.addExtensionTo(file);\n      res.setHeader('Content-Disposition', \"attachment; filename*=UTF-8''\".concat(encodeURIComponent(file.name)));\n      res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n      res.setHeader('Content-Type', file.type || 'application/octet-stream');\n\n      if (req.headers.range) {\n        const range = getFileRange(file, req);\n\n        if (range) {\n          setRangeHeaders(range, file, res);\n\n          if (range.outOfRange) {\n            return;\n          }\n\n          options.start = range.start;\n          options.end = range.stop;\n        }\n      } // set content-length if range has not set\n\n\n      if (!res.getHeader('Content-Length')) {\n        res.setHeader('Content-Length', file.size);\n      }\n\n      this.store.getReadStream(file._id, file, options).pipe(res);\n    } catch (e) {\n      res.writeHead(404);\n      res.end();\n    }\n  },\n\n  copy(file, out) {\n    const filePath = this.store.getFilePath(file._id, file);\n\n    try {\n      const stat = statSync(filePath);\n\n      if (stat && stat.isFile()) {\n        file = FileUpload.addExtensionTo(file);\n        this.store.getReadStream(file._id, file).pipe(out);\n      }\n    } catch (e) {\n      out.end();\n    }\n  }\n\n});\nconst FileSystemAvatars = new FileUploadClass({\n  name: 'FileSystem:Avatars',\n\n  // store setted bellow\n  get(file, req, res) {\n    const filePath = this.store.getFilePath(file._id, file);\n\n    try {\n      const stat = statSync(filePath);\n\n      if (stat && stat.isFile()) {\n        file = FileUpload.addExtensionTo(file);\n        this.store.getReadStream(file._id, file).pipe(res);\n      }\n    } catch (e) {\n      res.writeHead(404);\n      res.end();\n    }\n  }\n\n});\nconst FileSystemUserDataFiles = new FileUploadClass({\n  name: 'FileSystem:UserDataFiles',\n\n  get(file, req, res) {\n    const filePath = this.store.getFilePath(file._id, file);\n\n    try {\n      const stat = statSync(filePath);\n\n      if (stat && stat.isFile()) {\n        file = FileUpload.addExtensionTo(file);\n        res.setHeader('Content-Disposition', \"attachment; filename*=UTF-8''\".concat(encodeURIComponent(file.name)));\n        res.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n        res.setHeader('Content-Type', file.type);\n        res.setHeader('Content-Length', file.size);\n        this.store.getReadStream(file._id, file).pipe(res);\n      }\n    } catch (e) {\n      res.writeHead(404);\n      res.end();\n    }\n  }\n\n});\nsettings.watch('FileUpload_FileSystemPath', function () {\n  const options = {\n    path: settings.get('FileUpload_FileSystemPath') // '/tmp/uploads/photos',\n\n  };\n  FileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n  FileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n  FileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options); // DEPRECATED backwards compatibililty (remove)\n\n  UploadFS.getStores().fileSystem = UploadFS.getStores()[FileSystemUploads.name];\n});","map":{"version":3,"sources":["app/file-upload/server/config/FileSystem.js"],"names":["fs","module","link","default","v","Meteor","UploadFS","settings","FileUploadClass","FileUpload","getFileRange","setRangeHeaders","statSync","wrapAsync","stat","FileSystemUploads","name","get","file","req","res","filePath","store","getFilePath","_id","options","isFile","writeHead","end","addExtensionTo","setHeader","encodeURIComponent","uploadedAt","toUTCString","type","headers","range","outOfRange","start","stop","getHeader","size","getReadStream","pipe","e","copy","out","FileSystemAvatars","FileSystemUserDataFiles","watch","path","configureUploadsStore","getStores","fileSystem"],"mappings":"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","sourcesContent":["import fs from 'fs';\n\nimport { Meteor } from 'meteor/meteor';\nimport { UploadFS } from 'meteor/jalik:ufs';\n\nimport { settings } from '../../../settings/server';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport { getFileRange, setRangeHeaders } from '../lib/ranges';\n\nconst statSync = Meteor.wrapAsync(fs.stat);\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\tconst options = {};\n\n\t\ttry {\n\t\t\tconst stat = statSync(filePath);\n\t\t\tif (!stat?.isFile()) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`);\n\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\tres.setHeader('Content-Type', file.type || 'application/octet-stream');\n\n\t\t\tif (req.headers.range) {\n\t\t\t\tconst range = getFileRange(file, req);\n\n\t\t\t\tif (range) {\n\t\t\t\t\tsetRangeHeaders(range, file, res);\n\t\t\t\t\tif (range.outOfRange) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\toptions.start = range.start;\n\t\t\t\t\toptions.end = range.stop;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// set content-length if range has not set\n\t\t\tif (!res.getHeader('Content-Length')) {\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\t\t\t}\n\n\t\t\tthis.store.getReadStream(file._id, file, options).pipe(res);\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n\n\tcopy(file, out) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\t\ttry {\n\t\t\tconst stat = statSync(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(out);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tout.end();\n\t\t}\n\t},\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = statSync(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nconst FileSystemUserDataFiles = new FileUploadClass({\n\tname: 'FileSystem:UserDataFiles',\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = statSync(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\t},\n});\n\nsettings.watch('FileUpload_FileSystemPath', function () {\n\tconst options = {\n\t\tpath: settings.get('FileUpload_FileSystemPath'), // '/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\tFileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores().fileSystem = UploadFS.getStores()[FileSystemUploads.name];\n});\n"]},"sourceType":"module","hash":"9dae5cf12862d8a31ed86d562ca767d3e5ed9ff8"}
