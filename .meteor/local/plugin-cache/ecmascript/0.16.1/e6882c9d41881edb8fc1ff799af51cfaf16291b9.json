{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/packages/facebook-oauth/facebook_server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/facebook-oauth/facebook_server.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/packages/facebook-oauth/facebook_server.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/packages/facebook-oauth/facebook_server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/facebook-oauth/facebook_server.js"}},"code":"var _Meteor$settings, _Meteor$settings$publ, _Meteor$settings$publ2, _Meteor$settings$publ3;\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nlet crypto;\nmodule.link(\"crypto\", {\n  default(v) {\n    crypto = v;\n  }\n\n}, 0);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n\n}, 1);\nFacebook = {};\nconst API_VERSION = ((_Meteor$settings = Meteor.settings) === null || _Meteor$settings === void 0 ? void 0 : (_Meteor$settings$publ = _Meteor$settings.public) === null || _Meteor$settings$publ === void 0 ? void 0 : (_Meteor$settings$publ2 = _Meteor$settings$publ.packages) === null || _Meteor$settings$publ2 === void 0 ? void 0 : (_Meteor$settings$publ3 = _Meteor$settings$publ2['facebook-oauth']) === null || _Meteor$settings$publ3 === void 0 ? void 0 : _Meteor$settings$publ3.apiVersion) || '10.0';\n\nFacebook.handleAuthFromAccessToken = (accessToken, expiresAt) => {\n  // include basic fields from facebook\n  // https://developers.facebook.com/docs/facebook-login/permissions/\n  const whitelisted = ['id', 'email', 'name', 'first_name', 'last_name', 'middle_name', 'name_format', 'picture', 'short_name'];\n  const identity = getIdentity(accessToken, whitelisted);\n  const fields = {};\n  whitelisted.forEach(field => fields[field] = identity[field]);\n\n  const serviceData = _objectSpread({\n    accessToken,\n    expiresAt\n  }, fields);\n\n  return {\n    serviceData,\n    options: {\n      profile: {\n        name: identity.name\n      }\n    }\n  };\n};\n\nAccounts.registerLoginHandler(request => {\n  if (request.facebookSignIn !== true) {\n    return;\n  }\n\n  const facebookData = Facebook.handleAuthFromAccessToken(request.accessToken, +new Date() + 1000 * request.expirationTime);\n  return Accounts.updateOrCreateUserFromExternalService('facebook', facebookData.serviceData, facebookData.options);\n});\nOAuth.registerService('facebook', 2, null, query => {\n  const response = getTokenResponse(query);\n  const {\n    accessToken\n  } = response;\n  const {\n    expiresIn\n  } = response;\n  return Facebook.handleAuthFromAccessToken(accessToken, +new Date() + 1000 * expiresIn);\n});\n\nfunction getAbsoluteUrlOptions(query) {\n  var _Meteor$settings2, _Meteor$settings2$pac, _Meteor$settings2$pac2;\n\n  const overrideRootUrlFromStateRedirectUrl = (_Meteor$settings2 = Meteor.settings) === null || _Meteor$settings2 === void 0 ? void 0 : (_Meteor$settings2$pac = _Meteor$settings2.packages) === null || _Meteor$settings2$pac === void 0 ? void 0 : (_Meteor$settings2$pac2 = _Meteor$settings2$pac['facebook-oauth']) === null || _Meteor$settings2$pac2 === void 0 ? void 0 : _Meteor$settings2$pac2.overrideRootUrlFromStateRedirectUrl;\n\n  if (!overrideRootUrlFromStateRedirectUrl) {\n    return undefined;\n  }\n\n  try {\n    const state = OAuth._stateFromQuery(query) || {};\n    const redirectUrl = new URL(state.redirectUrl);\n    return {\n      rootUrl: redirectUrl.origin\n    };\n  } catch (e) {\n    console.error(\"Failed to complete OAuth handshake with Facebook because it was not able to obtain the redirect url from the state and you are using overrideRootUrlFromStateRedirectUrl.\", e);\n    return undefined;\n  }\n} // returns an object containing:\n// - accessToken\n// - expiresIn: lifetime of token in seconds\n\n\nconst getTokenResponse = query => {\n  const config = ServiceConfiguration.configurations.findOne({\n    service: 'facebook'\n  });\n  if (!config) throw new ServiceConfiguration.ConfigError();\n  let responseContent;\n\n  try {\n    const absoluteUrlOptions = getAbsoluteUrlOptions(query);\n\n    const redirectUri = OAuth._redirectUri('facebook', config, undefined, absoluteUrlOptions); // Request an access token\n\n\n    responseContent = HTTP.get(\"https://graph.facebook.com/v\".concat(API_VERSION, \"/oauth/access_token\"), {\n      params: {\n        client_id: config.appId,\n        redirect_uri: redirectUri,\n        client_secret: OAuth.openSecret(config.secret),\n        code: query.code\n      }\n    }).data;\n  } catch (err) {\n    throw Object.assign(new Error(\"Failed to complete OAuth handshake with Facebook. \".concat(err.message)), {\n      response: err.response\n    });\n  }\n\n  const fbAccessToken = responseContent.access_token;\n  const fbExpires = responseContent.expires_in;\n\n  if (!fbAccessToken) {\n    throw new Error(\"Failed to complete OAuth handshake with facebook \" + \"-- can't find access token in HTTP response. \".concat(responseContent));\n  }\n\n  return {\n    accessToken: fbAccessToken,\n    expiresIn: fbExpires\n  };\n};\n\nconst getIdentity = (accessToken, fields) => {\n  const config = ServiceConfiguration.configurations.findOne({\n    service: 'facebook'\n  });\n  if (!config) throw new ServiceConfiguration.ConfigError(); // Generate app secret proof that is a sha256 hash of the app access token, with the app secret as the key\n  // https://developers.facebook.com/docs/graph-api/securing-requests#appsecret_proof\n\n  const hmac = crypto.createHmac('sha256', OAuth.openSecret(config.secret));\n  hmac.update(accessToken);\n\n  try {\n    return HTTP.get(\"https://graph.facebook.com/v\".concat(API_VERSION, \"/me\"), {\n      params: {\n        access_token: accessToken,\n        appsecret_proof: hmac.digest('hex'),\n        fields: fields.join(\",\")\n      }\n    }).data;\n  } catch (err) {\n    throw Object.assign(new Error(\"Failed to fetch identity from Facebook. \".concat(err.message)), {\n      response: err.response\n    });\n  }\n};\n\nFacebook.retrieveCredential = (credentialToken, credentialSecret) => OAuth.retrieveCredential(credentialToken, credentialSecret);","map":{"version":3,"sources":["packages/facebook-oauth/facebook_server.js"],"names":["_objectSpread","module","link","default","v","crypto","Accounts","Facebook","API_VERSION","Meteor","settings","public","packages","apiVersion","handleAuthFromAccessToken","accessToken","expiresAt","whitelisted","identity","getIdentity","fields","forEach","field","serviceData","options","profile","name","registerLoginHandler","request","facebookSignIn","facebookData","Date","expirationTime","updateOrCreateUserFromExternalService","OAuth","registerService","query","response","getTokenResponse","expiresIn","getAbsoluteUrlOptions","overrideRootUrlFromStateRedirectUrl","undefined","state","_stateFromQuery","redirectUrl","URL","rootUrl","origin","e","console","error","config","ServiceConfiguration","configurations","findOne","service","ConfigError","responseContent","absoluteUrlOptions","redirectUri","_redirectUri","HTTP","get","params","client_id","appId","redirect_uri","client_secret","openSecret","secret","code","data","err","Object","assign","Error","message","fbAccessToken","access_token","fbExpires","expires_in","hmac","createHmac","update","appsecret_proof","digest","join","retrieveCredential","credentialToken","credentialSecret"],"mappings":"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","sourcesContent":["Facebook = {};\nimport crypto from 'crypto';\nimport { Accounts } from 'meteor/accounts-base';\n\nconst API_VERSION = Meteor.settings?.public?.packages?.['facebook-oauth']?.apiVersion || '10.0';\n\nFacebook.handleAuthFromAccessToken = (accessToken, expiresAt) => {\n  // include basic fields from facebook\n  // https://developers.facebook.com/docs/facebook-login/permissions/\n  const whitelisted = ['id', 'email', 'name', 'first_name', 'last_name',\n    'middle_name', 'name_format', 'picture', 'short_name'];\n\n  const identity = getIdentity(accessToken, whitelisted);\n\n  const fields = {};\n  whitelisted.forEach(field => fields[field] = identity[field]);\n  const serviceData = {\n    accessToken,\n    expiresAt,\n    ...fields,\n  };\n\n  return {\n    serviceData,\n    options: {profile: {name: identity.name}}\n  };\n};\n\nAccounts.registerLoginHandler(request => {\n  if (request.facebookSignIn !== true) {\n    return;\n  }\n  const facebookData = Facebook.handleAuthFromAccessToken(request.accessToken, (+new Date) + (1000 * request.expirationTime));\n  return Accounts.updateOrCreateUserFromExternalService('facebook', facebookData.serviceData, facebookData.options);\n});\n\nOAuth.registerService('facebook', 2, null, query => {\n  const response = getTokenResponse(query);\n  const { accessToken } = response;\n  const { expiresIn } = response;\n\n  return Facebook.handleAuthFromAccessToken(accessToken, (+new Date) + (1000 * expiresIn));\n});\n\nfunction getAbsoluteUrlOptions(query) {\n  const overrideRootUrlFromStateRedirectUrl = Meteor.settings?.packages?.['facebook-oauth']?.overrideRootUrlFromStateRedirectUrl;\n  if (!overrideRootUrlFromStateRedirectUrl) {\n    return undefined;\n  }\n  try {\n    const state = OAuth._stateFromQuery(query) || {};\n    const redirectUrl = new URL(state.redirectUrl);\n    return {\n      rootUrl: redirectUrl.origin,\n    }\n  } catch (e) {\n    console.error(\n      `Failed to complete OAuth handshake with Facebook because it was not able to obtain the redirect url from the state and you are using overrideRootUrlFromStateRedirectUrl.`, e\n    );\n    return undefined;\n  }\n}\n\n// returns an object containing:\n// - accessToken\n// - expiresIn: lifetime of token in seconds\nconst getTokenResponse = query => {\n  const config = ServiceConfiguration.configurations.findOne({service: 'facebook'});\n  if (!config)\n    throw new ServiceConfiguration.ConfigError();\n\n  let responseContent;\n  try {\n\n    const absoluteUrlOptions = getAbsoluteUrlOptions(query);\n    const redirectUri = OAuth._redirectUri('facebook', config, undefined, absoluteUrlOptions);\n    // Request an access token\n    responseContent = HTTP.get(\n      `https://graph.facebook.com/v${API_VERSION}/oauth/access_token`, {\n        params: {\n          client_id: config.appId,\n          redirect_uri: redirectUri,\n          client_secret: OAuth.openSecret(config.secret),\n          code: query.code\n        }\n      }).data;\n  } catch (err) {\n    throw Object.assign(\n      new Error(`Failed to complete OAuth handshake with Facebook. ${err.message}`),\n      { response: err.response },\n    );\n  }\n\n  const fbAccessToken = responseContent.access_token;\n  const fbExpires = responseContent.expires_in;\n\n  if (!fbAccessToken) {\n    throw new Error(\"Failed to complete OAuth handshake with facebook \" +\n                    `-- can't find access token in HTTP response. ${responseContent}`);\n  }\n  return {\n    accessToken: fbAccessToken,\n    expiresIn: fbExpires\n  };\n};\n\nconst getIdentity = (accessToken, fields) => {\n  const config = ServiceConfiguration.configurations.findOne({service: 'facebook'});\n  if (!config)\n    throw new ServiceConfiguration.ConfigError();\n\n  // Generate app secret proof that is a sha256 hash of the app access token, with the app secret as the key\n  // https://developers.facebook.com/docs/graph-api/securing-requests#appsecret_proof\n  const hmac = crypto.createHmac('sha256', OAuth.openSecret(config.secret));\n  hmac.update(accessToken);\n\n  try {\n    return HTTP.get(`https://graph.facebook.com/v${API_VERSION}/me`, {\n      params: {\n        access_token: accessToken,\n        appsecret_proof: hmac.digest('hex'),\n        fields: fields.join(\",\")\n      }\n    }).data;\n  } catch (err) {\n    throw Object.assign(\n      new Error(`Failed to fetch identity from Facebook. ${err.message}`),\n      { response: err.response },\n    );\n  }\n};\n\nFacebook.retrieveCredential = (credentialToken, credentialSecret) =>\n  OAuth.retrieveCredential(credentialToken, credentialSecret);\n\n"]},"sourceType":"module","hash":"e6882c9d41881edb8fc1ff799af51cfaf16291b9"}
