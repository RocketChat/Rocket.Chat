{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/irc/server/irc-bridge/index.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/irc/server/irc-bridge/index.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/irc/server/irc-bridge/index.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/irc/server/irc-bridge/index.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/irc/server/irc-bridge/index.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Queue;\nmodule.link(\"queue-fifo\", {\n  default(v) {\n    Queue = v;\n  }\n\n}, 1);\nlet moment;\nmodule.link(\"moment\", {\n  default(v) {\n    moment = v;\n  }\n\n}, 2);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 3);\nlet peerCommandHandlers;\nmodule.link(\"./peerHandlers\", {\n  \"*\"(v) {\n    peerCommandHandlers = v;\n  }\n\n}, 4);\nlet localCommandHandlers;\nmodule.link(\"./localHandlers\", {\n  \"*\"(v) {\n    localCommandHandlers = v;\n  }\n\n}, 5);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 6);\nlet servers;\nmodule.link(\"../servers\", {\n  \"*\"(v) {\n    servers = v;\n  }\n\n}, 7);\nlet Settings;\nmodule.link(\"../../../models/server\", {\n  Settings(v) {\n    Settings = v;\n  }\n\n}, 8);\nlet Logger;\nmodule.link(\"../../../logger/server\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 9);\nconst logger = new Logger('IRC Bridge');\nconst queueLogger = logger.section('Queue');\nlet removed = false;\n\nconst updateLastPing = _.throttle(Meteor.bindEnvironment(() => {\n  if (removed) {\n    return;\n  }\n\n  Settings.upsert({\n    _id: 'IRC_Bridge_Last_Ping'\n  }, {\n    $set: {\n      value: new Date()\n    }\n  });\n}), 1000 * 10);\n\nclass Bridge {\n  constructor(config) {\n    // General\n    this.config = config; // Workaround for Rocket.Chat callbacks being called multiple times\n\n    this.loggedInUsers = []; // Server\n\n    const Server = servers[this.config.server.protocol];\n    this.server = new Server(this.config);\n    this.setupPeerHandlers();\n    this.setupLocalHandlers(); // Command queue\n\n    this.queue = new Queue();\n    this.queueTimeout = 5;\n  }\n\n  init() {\n    this.initTime = new Date();\n    removed = false;\n    this.loggedInUsers = [];\n    const lastPing = Settings.findOneById('IRC_Bridge_Last_Ping');\n\n    if (lastPing) {\n      if (Math.abs(moment(lastPing.value).diff()) < 1000 * 30) {\n        this.log('Not trying to connect.');\n        this.remove();\n        return;\n      }\n    }\n\n    this.log('Connecting.');\n    updateLastPing();\n    this.server.register();\n    this.server.on('registered', () => {\n      this.logQueue('Starting...');\n      this.runQueue();\n    });\n  }\n\n  stop() {\n    this.server.disconnect();\n  }\n\n  remove() {\n    this.log('Removing current connection.');\n    removed = true;\n    this.server = null;\n    this.removeLocalHandlers();\n  }\n  /**\n   * Log helper\n   */\n\n\n  log(message) {\n    // TODO logger: debug?\n    logger.info(message);\n  }\n\n  logQueue(message) {\n    // TODO logger: debug?\n    queueLogger.info(message);\n  }\n  /**\n   *\n   *\n   * Queue\n   *\n   *\n   */\n\n\n  onMessageReceived(from, command) {\n    for (var _len = arguments.length, parameters = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n      parameters[_key - 2] = arguments[_key];\n    }\n\n    this.queue.enqueue({\n      from,\n      command,\n      parameters\n    });\n  }\n\n  runQueue() {\n    return Promise.asyncApply(() => {\n      if (!this.server) {\n        return;\n      }\n\n      const lastResetTime = Settings.findOneById('IRC_Bridge_Reset_Time');\n\n      if (lastResetTime && lastResetTime.value > this.initTime) {\n        this.stop();\n        this.remove();\n        return;\n      }\n\n      updateLastPing(); // If it is empty, skip and keep the queue going\n\n      if (this.queue.isEmpty()) {\n        return setTimeout(this.runQueue.bind(this), this.queueTimeout);\n      } // Get the command\n\n\n      const item = this.queue.dequeue();\n      this.logQueue(\"Processing \\\"\".concat(item.command, \"\\\" command from \\\"\").concat(item.from, \"\\\"\")); // Handle the command accordingly\n\n      try {\n        // Handle the command accordingly\n        switch (item.from) {\n          case 'local':\n            if (!localCommandHandlers[item.command]) {\n              throw new Error(\"Could not find handler for local:\".concat(item.command));\n            }\n\n            Promise.await(localCommandHandlers[item.command].apply(this, item.parameters));\n            break;\n\n          case 'peer':\n            if (!peerCommandHandlers[item.command]) {\n              throw new Error(\"Could not find handler for peer:\".concat(item.command));\n            }\n\n            Promise.await(peerCommandHandlers[item.command].apply(this, item.parameters));\n            break;\n        }\n      } catch (e) {\n        this.logQueue(e);\n      } // Keep the queue going\n\n\n      setTimeout(this.runQueue.bind(this), this.queueTimeout);\n    });\n  }\n  /**\n   *\n   *\n   * Peer\n   *\n   *\n   */\n\n\n  setupPeerHandlers() {\n    this.server.on('peerCommand', cmd => {\n      this.onMessageReceived('peer', cmd.identifier, cmd.args);\n    });\n  }\n  /**\n   *\n   *\n   * Local\n   *\n   *\n   */\n\n\n  setupLocalHandlers() {\n    // Auth\n    callbacks.add('afterValidateLogin', this.onMessageReceived.bind(this, 'local', 'onLogin'), callbacks.priority.LOW, 'irc-on-login');\n    callbacks.add('afterCreateUser', this.onMessageReceived.bind(this, 'local', 'onCreateUser'), callbacks.priority.LOW, 'irc-on-create-user'); // Joining rooms or channels\n\n    callbacks.add('afterCreateChannel', this.onMessageReceived.bind(this, 'local', 'onCreateRoom'), callbacks.priority.LOW, 'irc-on-create-channel');\n    callbacks.add('afterCreateRoom', this.onMessageReceived.bind(this, 'local', 'onCreateRoom'), callbacks.priority.LOW, 'irc-on-create-room');\n    callbacks.add('afterJoinRoom', this.onMessageReceived.bind(this, 'local', 'onJoinRoom'), callbacks.priority.LOW, 'irc-on-join-room'); // Leaving rooms or channels\n\n    callbacks.add('afterLeaveRoom', this.onMessageReceived.bind(this, 'local', 'onLeaveRoom'), callbacks.priority.LOW, 'irc-on-leave-room'); // Chatting\n\n    callbacks.add('afterSaveMessage', this.onMessageReceived.bind(this, 'local', 'onSaveMessage'), callbacks.priority.LOW, 'irc-on-save-message'); // Leaving\n\n    callbacks.add('afterLogoutCleanUp', this.onMessageReceived.bind(this, 'local', 'onLogout'), callbacks.priority.LOW, 'irc-on-logout');\n  }\n\n  removeLocalHandlers() {\n    callbacks.remove('afterValidateLogin', 'irc-on-login');\n    callbacks.remove('afterCreateUser', 'irc-on-create-user');\n    callbacks.remove('afterCreateChannel', 'irc-on-create-channel');\n    callbacks.remove('afterCreateRoom', 'irc-on-create-room');\n    callbacks.remove('afterJoinRoom', 'irc-on-join-room');\n    callbacks.remove('afterLeaveRoom', 'irc-on-leave-room');\n    callbacks.remove('afterSaveMessage', 'irc-on-save-message');\n    callbacks.remove('afterLogoutCleanUp', 'irc-on-logout');\n  }\n\n  sendCommand(command, parameters) {\n    this.server.emit('onReceiveFromLocal', command, parameters);\n  }\n\n}\n\nmodule.exportDefault(Bridge);","map":{"version":3,"sources":["app/irc/server/irc-bridge/index.js"],"names":["Meteor","module","link","v","Queue","default","moment","_","peerCommandHandlers","localCommandHandlers","callbacks","servers","Settings","Logger","logger","queueLogger","section","removed","updateLastPing","throttle","bindEnvironment","upsert","_id","$set","value","Date","Bridge","constructor","config","loggedInUsers","Server","server","protocol","setupPeerHandlers","setupLocalHandlers","queue","queueTimeout","init","initTime","lastPing","findOneById","Math","abs","diff","log","remove","register","on","logQueue","runQueue","stop","disconnect","removeLocalHandlers","message","info","onMessageReceived","from","command","parameters","enqueue","lastResetTime","isEmpty","setTimeout","bind","item","dequeue","Error","apply","e","cmd","identifier","args","add","priority","LOW","sendCommand","emit","exportDefault"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport Queue from 'queue-fifo';\nimport moment from 'moment';\nimport _ from 'underscore';\n\nimport * as peerCommandHandlers from './peerHandlers';\nimport * as localCommandHandlers from './localHandlers';\nimport { callbacks } from '../../../../lib/callbacks';\nimport * as servers from '../servers';\nimport { Settings } from '../../../models/server';\nimport { Logger } from '../../../logger/server';\n\nconst logger = new Logger('IRC Bridge');\nconst queueLogger = logger.section('Queue');\n\nlet removed = false;\nconst updateLastPing = _.throttle(\n\tMeteor.bindEnvironment(() => {\n\t\tif (removed) {\n\t\t\treturn;\n\t\t}\n\t\tSettings.upsert(\n\t\t\t{ _id: 'IRC_Bridge_Last_Ping' },\n\t\t\t{\n\t\t\t\t$set: {\n\t\t\t\t\tvalue: new Date(),\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}),\n\t1000 * 10,\n);\n\nclass Bridge {\n\tconstructor(config) {\n\t\t// General\n\t\tthis.config = config;\n\n\t\t// Workaround for Rocket.Chat callbacks being called multiple times\n\t\tthis.loggedInUsers = [];\n\n\t\t// Server\n\t\tconst Server = servers[this.config.server.protocol];\n\n\t\tthis.server = new Server(this.config);\n\n\t\tthis.setupPeerHandlers();\n\t\tthis.setupLocalHandlers();\n\n\t\t// Command queue\n\t\tthis.queue = new Queue();\n\t\tthis.queueTimeout = 5;\n\t}\n\n\tinit() {\n\t\tthis.initTime = new Date();\n\t\tremoved = false;\n\t\tthis.loggedInUsers = [];\n\n\t\tconst lastPing = Settings.findOneById('IRC_Bridge_Last_Ping');\n\t\tif (lastPing) {\n\t\t\tif (Math.abs(moment(lastPing.value).diff()) < 1000 * 30) {\n\t\t\t\tthis.log('Not trying to connect.');\n\t\t\t\tthis.remove();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.log('Connecting.');\n\t\tupdateLastPing();\n\t\tthis.server.register();\n\n\t\tthis.server.on('registered', () => {\n\t\t\tthis.logQueue('Starting...');\n\n\t\t\tthis.runQueue();\n\t\t});\n\t}\n\n\tstop() {\n\t\tthis.server.disconnect();\n\t}\n\n\tremove() {\n\t\tthis.log('Removing current connection.');\n\t\tremoved = true;\n\t\tthis.server = null;\n\t\tthis.removeLocalHandlers();\n\t}\n\n\t/**\n\t * Log helper\n\t */\n\tlog(message) {\n\t\t// TODO logger: debug?\n\t\tlogger.info(message);\n\t}\n\n\tlogQueue(message) {\n\t\t// TODO logger: debug?\n\t\tqueueLogger.info(message);\n\t}\n\n\t/**\n\t *\n\t *\n\t * Queue\n\t *\n\t *\n\t */\n\tonMessageReceived(from, command, ...parameters) {\n\t\tthis.queue.enqueue({ from, command, parameters });\n\t}\n\n\tasync runQueue() {\n\t\tif (!this.server) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst lastResetTime = Settings.findOneById('IRC_Bridge_Reset_Time');\n\t\tif (lastResetTime && lastResetTime.value > this.initTime) {\n\t\t\tthis.stop();\n\t\t\tthis.remove();\n\t\t\treturn;\n\t\t}\n\n\t\tupdateLastPing();\n\n\t\t// If it is empty, skip and keep the queue going\n\t\tif (this.queue.isEmpty()) {\n\t\t\treturn setTimeout(this.runQueue.bind(this), this.queueTimeout);\n\t\t}\n\n\t\t// Get the command\n\t\tconst item = this.queue.dequeue();\n\n\t\tthis.logQueue(`Processing \"${item.command}\" command from \"${item.from}\"`);\n\n\t\t// Handle the command accordingly\n\t\ttry {\n\t\t\t// Handle the command accordingly\n\t\t\tswitch (item.from) {\n\t\t\t\tcase 'local':\n\t\t\t\t\tif (!localCommandHandlers[item.command]) {\n\t\t\t\t\t\tthrow new Error(`Could not find handler for local:${item.command}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait localCommandHandlers[item.command].apply(this, item.parameters);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'peer':\n\t\t\t\t\tif (!peerCommandHandlers[item.command]) {\n\t\t\t\t\t\tthrow new Error(`Could not find handler for peer:${item.command}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tawait peerCommandHandlers[item.command].apply(this, item.parameters);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis.logQueue(e);\n\t\t}\n\n\t\t// Keep the queue going\n\t\tsetTimeout(this.runQueue.bind(this), this.queueTimeout);\n\t}\n\n\t/**\n\t *\n\t *\n\t * Peer\n\t *\n\t *\n\t */\n\tsetupPeerHandlers() {\n\t\tthis.server.on('peerCommand', (cmd) => {\n\t\t\tthis.onMessageReceived('peer', cmd.identifier, cmd.args);\n\t\t});\n\t}\n\n\t/**\n\t *\n\t *\n\t * Local\n\t *\n\t *\n\t */\n\tsetupLocalHandlers() {\n\t\t// Auth\n\t\tcallbacks.add('afterValidateLogin', this.onMessageReceived.bind(this, 'local', 'onLogin'), callbacks.priority.LOW, 'irc-on-login');\n\t\tcallbacks.add(\n\t\t\t'afterCreateUser',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onCreateUser'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-create-user',\n\t\t);\n\t\t// Joining rooms or channels\n\t\tcallbacks.add(\n\t\t\t'afterCreateChannel',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onCreateRoom'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-create-channel',\n\t\t);\n\t\tcallbacks.add(\n\t\t\t'afterCreateRoom',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onCreateRoom'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-create-room',\n\t\t);\n\t\tcallbacks.add('afterJoinRoom', this.onMessageReceived.bind(this, 'local', 'onJoinRoom'), callbacks.priority.LOW, 'irc-on-join-room');\n\t\t// Leaving rooms or channels\n\t\tcallbacks.add('afterLeaveRoom', this.onMessageReceived.bind(this, 'local', 'onLeaveRoom'), callbacks.priority.LOW, 'irc-on-leave-room');\n\t\t// Chatting\n\t\tcallbacks.add(\n\t\t\t'afterSaveMessage',\n\t\t\tthis.onMessageReceived.bind(this, 'local', 'onSaveMessage'),\n\t\t\tcallbacks.priority.LOW,\n\t\t\t'irc-on-save-message',\n\t\t);\n\t\t// Leaving\n\t\tcallbacks.add('afterLogoutCleanUp', this.onMessageReceived.bind(this, 'local', 'onLogout'), callbacks.priority.LOW, 'irc-on-logout');\n\t}\n\n\tremoveLocalHandlers() {\n\t\tcallbacks.remove('afterValidateLogin', 'irc-on-login');\n\t\tcallbacks.remove('afterCreateUser', 'irc-on-create-user');\n\t\tcallbacks.remove('afterCreateChannel', 'irc-on-create-channel');\n\t\tcallbacks.remove('afterCreateRoom', 'irc-on-create-room');\n\t\tcallbacks.remove('afterJoinRoom', 'irc-on-join-room');\n\t\tcallbacks.remove('afterLeaveRoom', 'irc-on-leave-room');\n\t\tcallbacks.remove('afterSaveMessage', 'irc-on-save-message');\n\t\tcallbacks.remove('afterLogoutCleanUp', 'irc-on-logout');\n\t}\n\n\tsendCommand(command, parameters) {\n\t\tthis.server.emit('onReceiveFromLocal', command, parameters);\n\t}\n}\n\nexport default Bridge;\n"]},"sourceType":"module","hash":"b86d727a723d8c03b5459f5b09139dfe7a78608e"}
