{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/collection-hooks.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/matb33:collection-hooks/collection-hooks.js","filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/collection-hooks.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","root":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/carlosrodrigues/Desktop/work/rocketchat/Rocket.Chat/packages/matb33:collection-hooks/collection-hooks.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/matb33:collection-hooks/collection-hooks.js"}},"code":"var _excluded = [\"multi\", \"upsert\"];\n\nvar _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default: function (v) {\n    _objectWithoutProperties = v;\n  }\n}, 0);\n\nvar _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default: function (v) {\n    _objectSpread = v;\n  }\n}, 1);\n\nvar _slicedToArray;\n\nmodule.link(\"@babel/runtime/helpers/slicedToArray\", {\n  default: function (v) {\n    _slicedToArray = v;\n  }\n}, 2);\nmodule.export({\n  CollectionHooks: function () {\n    return CollectionHooks;\n  }\n});\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo: function (v) {\n    Mongo = v;\n  }\n}, 1);\nvar EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON: function (v) {\n    EJSON = v;\n  }\n}, 2);\nvar LocalCollection;\nmodule.link(\"meteor/minimongo\", {\n  LocalCollection: function (v) {\n    LocalCollection = v;\n  }\n}, 3);\n// Relevant AOP terminology:\n// Aspect: User code that runs before/after (hook)\n// Advice: Wrapper code that knows when to call user code (aspects)\n// Pointcut: before/after\nvar advices = {};\nvar CollectionHooks = {\n  defaults: {\n    before: {\n      insert: {},\n      update: {},\n      remove: {},\n      upsert: {},\n      find: {},\n      findOne: {},\n      all: {}\n    },\n    after: {\n      insert: {},\n      update: {},\n      remove: {},\n      find: {},\n      findOne: {},\n      all: {}\n    },\n    all: {\n      insert: {},\n      update: {},\n      remove: {},\n      find: {},\n      findOne: {},\n      all: {}\n    }\n  },\n  directEnv: new Meteor.EnvironmentVariable(),\n  directOp: function (func) {\n    return this.directEnv.withValue(true, func);\n  },\n  hookedOp: function (func) {\n    return this.directEnv.withValue(false, func);\n  }\n};\n\nCollectionHooks.extendCollectionInstance = function () {\n  function extendCollectionInstance(self, constructor) {\n    // Offer a public API to allow the user to define aspects\n    // Example: collection.before.insert(func);\n    ['before', 'after'].forEach(function (pointcut) {\n      Object.entries(advices).forEach(function (_ref) {\n        var _ref2 = _slicedToArray(_ref, 2),\n            method = _ref2[0],\n            advice = _ref2[1];\n\n        if (advice === 'upsert' && pointcut === 'after') return;\n\n        Meteor._ensure(self, pointcut, method);\n\n        Meteor._ensure(self, '_hookAspects', method);\n\n        self._hookAspects[method][pointcut] = [];\n\n        self[pointcut][method] = function (aspect, options) {\n          var len = self._hookAspects[method][pointcut].push({\n            aspect: aspect,\n            options: CollectionHooks.initOptions(options, pointcut, method)\n          });\n\n          return {\n            replace: function (aspect, options) {\n              self._hookAspects[method][pointcut].splice(len - 1, 1, {\n                aspect: aspect,\n                options: CollectionHooks.initOptions(options, pointcut, method)\n              });\n            },\n            remove: function () {\n              self._hookAspects[method][pointcut].splice(len - 1, 1);\n            }\n          };\n        };\n      });\n    }); // Offer a publicly accessible object to allow the user to define\n    // collection-wide hook options.\n    // Example: collection.hookOptions.after.update = {fetchPrevious: false};\n\n    self.hookOptions = EJSON.clone(CollectionHooks.defaults); // Wrap mutator methods, letting the defined advice do the work\n\n    Object.entries(advices).forEach(function (_ref3) {\n      var _ref4 = _slicedToArray(_ref3, 2),\n          method = _ref4[0],\n          advice = _ref4[1];\n\n      var collection = Meteor.isClient || method === 'upsert' ? self : self._collection; // Store a reference to the original mutator method\n\n      var _super = collection[method];\n\n      Meteor._ensure(self, 'direct', method);\n\n      self.direct[method] = function () {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        return CollectionHooks.directOp(function () {\n          return constructor.prototype[method].apply(self, args);\n        });\n      };\n\n      collection[method] = function () {\n        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n          args[_key2] = arguments[_key2];\n        }\n\n        if (CollectionHooks.directEnv.get() === true) {\n          return _super.apply(collection, args);\n        } // NOTE: should we decide to force `update` with `{upsert:true}` to use\n        // the `upsert` hooks, this is what will accomplish it. It's important to\n        // realize that Meteor won't distinguish between an `update` and an\n        // `insert` though, so we'll end up with `after.update` getting called\n        // even on an `insert`. That's why we've chosen to disable this for now.\n        // if (method === \"update\" && Object(args[2]) === args[2] && args[2].upsert) {\n        //   method = \"upsert\";\n        //   advice = CollectionHooks.getAdvice(method);\n        // }\n\n\n        return advice.call(this, CollectionHooks.getUserId(), _super, self, method === 'upsert' ? {\n          insert: self._hookAspects.insert || {},\n          update: self._hookAspects.update || {},\n          upsert: self._hookAspects.upsert || {}\n        } : self._hookAspects[method] || {}, function (doc) {\n          return typeof self._transform === 'function' ? function (d) {\n            return self._transform(d || doc);\n          } : function (d) {\n            return d || doc;\n          };\n        }, args, false);\n      };\n    });\n  }\n\n  return extendCollectionInstance;\n}();\n\nCollectionHooks.defineAdvice = function (method, advice) {\n  advices[method] = advice;\n};\n\nCollectionHooks.getAdvice = function (method) {\n  return advices[method];\n};\n\nCollectionHooks.initOptions = function (options, pointcut, method) {\n  return CollectionHooks.extendOptions(CollectionHooks.defaults, options, pointcut, method);\n};\n\nCollectionHooks.extendOptions = function (source, options, pointcut, method) {\n  return _objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, options), source.all.all), source[pointcut].all), source.all[method]), source[pointcut][method]);\n};\n\nCollectionHooks.getDocs = function () {\n  function getDocs(collection, selector, options) {\n    var findOptions = {\n      transform: null,\n      reactive: false\n    }; // added reactive: false\n\n    /*\n    // No \"fetch\" support at this time.\n    if (!this._validators.fetchAllFields) {\n      findOptions.fields = {};\n      this._validators.fetch.forEach(function(fieldName) {\n        findOptions.fields[fieldName] = 1;\n      });\n    }\n    */\n    // Bit of a magic condition here... only \"update\" passes options, so this is\n    // only relevant to when update calls getDocs:\n\n    if (options) {\n      // This was added because in our case, we are potentially iterating over\n      // multiple docs. If multi isn't enabled, force a limit (almost like\n      // findOne), as the default for update without multi enabled is to affect\n      // only the first matched document:\n      if (!options.multi) {\n        findOptions.limit = 1;\n      }\n\n      var multi = options.multi,\n          upsert = options.upsert,\n          rest = _objectWithoutProperties(options, _excluded);\n\n      Object.assign(findOptions, rest);\n    } // Unlike validators, we iterate over multiple docs, so use\n    // find instead of findOne:\n\n\n    return collection.find(selector, findOptions);\n  }\n\n  return getDocs;\n}(); // This function normalizes the selector (converting it to an Object)\n\n\nCollectionHooks.normalizeSelector = function (selector) {\n  if (typeof selector === 'string' || selector && selector.constructor === Mongo.ObjectID) {\n    return {\n      _id: selector\n    };\n  } else {\n    return selector;\n  }\n}; // This function contains a snippet of code pulled and modified from:\n// ~/.meteor/packages/mongo-livedata/collection.js\n// It's contained in these utility functions to make updates easier for us in\n// case this code changes.\n\n\nCollectionHooks.getFields = function () {\n  function getFields(mutator) {\n    // compute modified fields\n    var fields = []; // ====ADDED START=======================\n\n    var operators = ['$addToSet', '$bit', '$currentDate', '$inc', '$max', '$min', '$pop', '$pull', '$pullAll', '$push', '$rename', '$set', '$unset']; // ====ADDED END=========================\n\n    Object.entries(mutator).forEach(function (_ref5) {\n      var _ref6 = _slicedToArray(_ref5, 2),\n          op = _ref6[0],\n          params = _ref6[1];\n\n      // ====ADDED START=======================\n      if (operators.includes(op)) {\n        // ====ADDED END=========================\n        Object.keys(params).forEach(function (field) {\n          // treat dotted fields as if they are replacing their\n          // top-level part\n          if (field.indexOf('.') !== -1) {\n            field = field.substring(0, field.indexOf('.'));\n          } // record the field we are trying to change\n\n\n          if (!fields.includes(field)) {\n            fields.push(field);\n          }\n        }); // ====ADDED START=======================\n      } else {\n        fields.push(op);\n      } // ====ADDED END=========================\n\n    });\n    return fields;\n  }\n\n  return getFields;\n}();\n\nCollectionHooks.reassignPrototype = function () {\n  function reassignPrototype(instance, constr) {\n    var hasSetPrototypeOf = typeof Object.setPrototypeOf === 'function';\n    constr = constr || Mongo.Collection; // __proto__ is not available in < IE11\n    // Note: Assigning a prototype dynamically has performance implications\n\n    if (hasSetPrototypeOf) {\n      Object.setPrototypeOf(instance, constr.prototype);\n    } else if (instance.__proto__) {\n      // eslint-disable-line no-proto\n      instance.__proto__ = constr.prototype; // eslint-disable-line no-proto\n    }\n  }\n\n  return reassignPrototype;\n}();\n\nCollectionHooks.wrapCollection = function () {\n  function wrapCollection(ns, as) {\n    if (!as._CollectionConstructor) as._CollectionConstructor = as.Collection;\n    if (!as._CollectionPrototype) as._CollectionPrototype = new as.Collection(null);\n    var constructor = ns._NewCollectionContructor || as._CollectionConstructor;\n    var proto = as._CollectionPrototype;\n\n    ns.Collection = function () {\n      for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n        args[_key3] = arguments[_key3];\n      }\n\n      var ret = constructor.apply(this, args);\n      CollectionHooks.extendCollectionInstance(this, constructor);\n      return ret;\n    }; // Retain a reference to the new constructor to allow further wrapping.\n\n\n    ns._NewCollectionContructor = ns.Collection;\n    ns.Collection.prototype = proto;\n    ns.Collection.prototype.constructor = ns.Collection;\n\n    for (var _i = 0, _Object$keys = Object.keys(constructor); _i < _Object$keys.length; _i++) {\n      var prop = _Object$keys[_i];\n      ns.Collection[prop] = constructor[prop];\n    } // Meteor overrides the apply method which is copied from the constructor in the loop above. Replace it with the\n    // default method which we need if we were to further wrap ns.Collection.\n\n\n    ns.Collection.apply = Function.prototype.apply;\n  }\n\n  return wrapCollection;\n}();\n\nCollectionHooks.modify = LocalCollection._modify;\n\nif (typeof Mongo !== 'undefined') {\n  CollectionHooks.wrapCollection(Meteor, Mongo);\n  CollectionHooks.wrapCollection(Mongo, Mongo);\n} else {\n  CollectionHooks.wrapCollection(Meteor, Meteor);\n}","map":{"version":3,"sources":["packages/matb33:collection-hooks/collection-hooks.js"],"names":["_objectWithoutProperties","module","link","default","v","_objectSpread","_slicedToArray","export","CollectionHooks","Meteor","Mongo","EJSON","LocalCollection","advices","defaults","before","insert","update","remove","upsert","find","findOne","all","after","directEnv","EnvironmentVariable","directOp","func","withValue","hookedOp","extendCollectionInstance","self","constructor","forEach","pointcut","Object","entries","method","advice","_ensure","_hookAspects","aspect","options","len","push","initOptions","replace","splice","hookOptions","clone","collection","isClient","_collection","_super","direct","args","prototype","apply","get","call","getUserId","doc","_transform","d","defineAdvice","getAdvice","extendOptions","source","getDocs","selector","findOptions","transform","reactive","multi","limit","rest","assign","normalizeSelector","ObjectID","_id","getFields","mutator","fields","operators","op","params","includes","keys","field","indexOf","substring","reassignPrototype","instance","constr","hasSetPrototypeOf","setPrototypeOf","Collection","__proto__","wrapCollection","ns","as","_CollectionConstructor","_CollectionPrototype","_NewCollectionContructor","proto","ret","prop","Function","modify","_modify"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor'\nimport { Mongo } from 'meteor/mongo'\nimport { EJSON } from 'meteor/ejson'\nimport { LocalCollection } from 'meteor/minimongo'\n\n// Relevant AOP terminology:\n// Aspect: User code that runs before/after (hook)\n// Advice: Wrapper code that knows when to call user code (aspects)\n// Pointcut: before/after\nconst advices = {}\n\nexport const CollectionHooks = {\n  defaults: {\n    before: { insert: {}, update: {}, remove: {}, upsert: {}, find: {}, findOne: {}, all: {} },\n    after: { insert: {}, update: {}, remove: {}, find: {}, findOne: {}, all: {} },\n    all: { insert: {}, update: {}, remove: {}, find: {}, findOne: {}, all: {} }\n  },\n  directEnv: new Meteor.EnvironmentVariable(),\n  directOp (func) {\n    return this.directEnv.withValue(true, func)\n  },\n  hookedOp (func) {\n    return this.directEnv.withValue(false, func)\n  }\n}\n\nCollectionHooks.extendCollectionInstance = function extendCollectionInstance (self, constructor) {\n  // Offer a public API to allow the user to define aspects\n  // Example: collection.before.insert(func);\n  ['before', 'after'].forEach(function (pointcut) {\n    Object.entries(advices).forEach(function ([method, advice]) {\n      if (advice === 'upsert' && pointcut === 'after') return\n\n      Meteor._ensure(self, pointcut, method)\n      Meteor._ensure(self, '_hookAspects', method)\n\n      self._hookAspects[method][pointcut] = []\n      self[pointcut][method] = function (aspect, options) {\n        const len = self._hookAspects[method][pointcut].push({\n          aspect,\n          options: CollectionHooks.initOptions(options, pointcut, method)\n        })\n\n        return {\n          replace (aspect, options) {\n            self._hookAspects[method][pointcut].splice(len - 1, 1, {\n              aspect,\n              options: CollectionHooks.initOptions(options, pointcut, method)\n            })\n          },\n          remove () {\n            self._hookAspects[method][pointcut].splice(len - 1, 1)\n          }\n        }\n      }\n    })\n  })\n\n  // Offer a publicly accessible object to allow the user to define\n  // collection-wide hook options.\n  // Example: collection.hookOptions.after.update = {fetchPrevious: false};\n  self.hookOptions = EJSON.clone(CollectionHooks.defaults)\n\n  // Wrap mutator methods, letting the defined advice do the work\n  Object.entries(advices).forEach(function ([method, advice]) {\n    const collection = Meteor.isClient || method === 'upsert' ? self : self._collection\n\n    // Store a reference to the original mutator method\n    const _super = collection[method]\n\n    Meteor._ensure(self, 'direct', method)\n    self.direct[method] = function (...args) {\n      return CollectionHooks.directOp(function () {\n        return constructor.prototype[method].apply(self, args)\n      })\n    }\n\n    collection[method] = function (...args) {\n      if (CollectionHooks.directEnv.get() === true) {\n        return _super.apply(collection, args)\n      }\n\n      // NOTE: should we decide to force `update` with `{upsert:true}` to use\n      // the `upsert` hooks, this is what will accomplish it. It's important to\n      // realize that Meteor won't distinguish between an `update` and an\n      // `insert` though, so we'll end up with `after.update` getting called\n      // even on an `insert`. That's why we've chosen to disable this for now.\n      // if (method === \"update\" && Object(args[2]) === args[2] && args[2].upsert) {\n      //   method = \"upsert\";\n      //   advice = CollectionHooks.getAdvice(method);\n      // }\n\n      return advice.call(this,\n        CollectionHooks.getUserId(),\n        _super,\n        self,\n        method === 'upsert' ? {\n          insert: self._hookAspects.insert || {},\n          update: self._hookAspects.update || {},\n          upsert: self._hookAspects.upsert || {}\n        } : self._hookAspects[method] || {},\n        function (doc) {\n          return (\n            typeof self._transform === 'function'\n              ? function (d) { return self._transform(d || doc) }\n              : function (d) { return d || doc }\n          )\n        },\n        args,\n        false\n      )\n    }\n  })\n}\n\nCollectionHooks.defineAdvice = (method, advice) => {\n  advices[method] = advice\n}\n\nCollectionHooks.getAdvice = method => advices[method]\n\nCollectionHooks.initOptions = (options, pointcut, method) =>\n  CollectionHooks.extendOptions(CollectionHooks.defaults, options, pointcut, method)\n\nCollectionHooks.extendOptions = (source, options, pointcut, method) =>\n  ({ ...options, ...source.all.all, ...source[pointcut].all, ...source.all[method], ...source[pointcut][method] })\n\nCollectionHooks.getDocs = function getDocs (collection, selector, options) {\n  const findOptions = { transform: null, reactive: false } // added reactive: false\n\n  /*\n  // No \"fetch\" support at this time.\n  if (!this._validators.fetchAllFields) {\n    findOptions.fields = {};\n    this._validators.fetch.forEach(function(fieldName) {\n      findOptions.fields[fieldName] = 1;\n    });\n  }\n  */\n\n  // Bit of a magic condition here... only \"update\" passes options, so this is\n  // only relevant to when update calls getDocs:\n  if (options) {\n    // This was added because in our case, we are potentially iterating over\n    // multiple docs. If multi isn't enabled, force a limit (almost like\n    // findOne), as the default for update without multi enabled is to affect\n    // only the first matched document:\n    if (!options.multi) {\n      findOptions.limit = 1\n    }\n    const { multi, upsert, ...rest } = options\n    Object.assign(findOptions, rest)\n  }\n\n  // Unlike validators, we iterate over multiple docs, so use\n  // find instead of findOne:\n  return collection.find(selector, findOptions)\n}\n\n// This function normalizes the selector (converting it to an Object)\nCollectionHooks.normalizeSelector = function (selector) {\n  if (typeof selector === 'string' || (selector && selector.constructor === Mongo.ObjectID)) {\n    return {\n      _id: selector\n    }\n  } else {\n    return selector\n  }\n}\n\n// This function contains a snippet of code pulled and modified from:\n// ~/.meteor/packages/mongo-livedata/collection.js\n// It's contained in these utility functions to make updates easier for us in\n// case this code changes.\nCollectionHooks.getFields = function getFields (mutator) {\n  // compute modified fields\n  const fields = []\n  // ====ADDED START=======================\n  const operators = [\n    '$addToSet',\n    '$bit',\n    '$currentDate',\n    '$inc',\n    '$max',\n    '$min',\n    '$pop',\n    '$pull',\n    '$pullAll',\n    '$push',\n    '$rename',\n    '$set',\n    '$unset'\n  ]\n  // ====ADDED END=========================\n\n  Object.entries(mutator).forEach(function ([op, params]) {\n    // ====ADDED START=======================\n    if (operators.includes(op)) {\n    // ====ADDED END=========================\n      Object.keys(params).forEach(function (field) {\n        // treat dotted fields as if they are replacing their\n        // top-level part\n        if (field.indexOf('.') !== -1) {\n          field = field.substring(0, field.indexOf('.'))\n        }\n\n        // record the field we are trying to change\n        if (!fields.includes(field)) {\n          fields.push(field)\n        }\n      })\n      // ====ADDED START=======================\n    } else {\n      fields.push(op)\n    }\n    // ====ADDED END=========================\n  })\n\n  return fields\n}\n\nCollectionHooks.reassignPrototype = function reassignPrototype (instance, constr) {\n  const hasSetPrototypeOf = typeof Object.setPrototypeOf === 'function'\n  constr = constr || Mongo.Collection\n\n  // __proto__ is not available in < IE11\n  // Note: Assigning a prototype dynamically has performance implications\n  if (hasSetPrototypeOf) {\n    Object.setPrototypeOf(instance, constr.prototype)\n  } else if (instance.__proto__) { // eslint-disable-line no-proto\n    instance.__proto__ = constr.prototype // eslint-disable-line no-proto\n  }\n}\n\nCollectionHooks.wrapCollection = function wrapCollection (ns, as) {\n  if (!as._CollectionConstructor) as._CollectionConstructor = as.Collection\n  if (!as._CollectionPrototype) as._CollectionPrototype = new as.Collection(null)\n\n  const constructor = ns._NewCollectionContructor || as._CollectionConstructor\n  const proto = as._CollectionPrototype\n\n  ns.Collection = function (...args) {\n    const ret = constructor.apply(this, args)\n    CollectionHooks.extendCollectionInstance(this, constructor)\n    return ret\n  }\n  // Retain a reference to the new constructor to allow further wrapping.\n  ns._NewCollectionContructor = ns.Collection\n\n  ns.Collection.prototype = proto\n  ns.Collection.prototype.constructor = ns.Collection\n\n  for (const prop of Object.keys(constructor)) {\n    ns.Collection[prop] = constructor[prop]\n  }\n\n  // Meteor overrides the apply method which is copied from the constructor in the loop above. Replace it with the\n  // default method which we need if we were to further wrap ns.Collection.\n  ns.Collection.apply = Function.prototype.apply\n}\n\nCollectionHooks.modify = LocalCollection._modify\n\nif (typeof Mongo !== 'undefined') {\n  CollectionHooks.wrapCollection(Meteor, Mongo)\n  CollectionHooks.wrapCollection(Mongo, Mongo)\n} else {\n  CollectionHooks.wrapCollection(Meteor, Meteor)\n}\n"]},"sourceType":"module","hash":"fac94ed9eb02d1bfa40a20172f50eb3b740242e2"}
