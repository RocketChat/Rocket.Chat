{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/error-handler/server/lib/RocketChat.ErrorHandler.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/error-handler/server/lib/RocketChat.ErrorHandler.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/error-handler/server/lib/RocketChat.ErrorHandler.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/error-handler/server/lib/RocketChat.ErrorHandler.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/error-handler/server/lib/RocketChat.ErrorHandler.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 1);\nlet Users, Rooms;\nmodule.link(\"../../../models\", {\n  Users(v) {\n    Users = v;\n  },\n\n  Rooms(v) {\n    Rooms = v;\n  }\n\n}, 2);\nlet sendMessage;\nmodule.link(\"../../../lib\", {\n  sendMessage(v) {\n    sendMessage = v;\n  }\n\n}, 3);\n\nclass ErrorHandler {\n  constructor() {\n    this.reporting = false;\n    this.rid = null;\n    this.lastError = null;\n    Meteor.startup(() => {\n      this.registerHandlers();\n      settings.watch('Log_Exceptions_to_Channel', value => {\n        this.rid = null;\n        const roomName = value.trim();\n\n        if (roomName) {\n          this.rid = this.getRoomId(roomName);\n        }\n\n        if (this.rid) {\n          this.reporting = true;\n        } else {\n          this.reporting = false;\n        }\n      });\n    });\n  }\n\n  registerHandlers() {\n    process.on('uncaughtException', Meteor.bindEnvironment(error => {\n      if (!this.reporting) {\n        return;\n      }\n\n      this.trackError(error.message, error.stack);\n    }));\n    const self = this;\n    const originalMeteorDebug = Meteor._debug;\n\n    Meteor._debug = function (message, stack) {\n      if (!self.reporting) {\n        return originalMeteorDebug.call(this, message, stack);\n      }\n\n      self.trackError(message, stack);\n\n      for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n        args[_key - 2] = arguments[_key];\n      }\n\n      return originalMeteorDebug.apply(this, [message, stack, ...args]);\n    };\n  }\n\n  getRoomId(roomName) {\n    roomName = roomName.replace('#');\n    const room = Rooms.findOneByName(roomName, {\n      fields: {\n        _id: 1,\n        t: 1\n      }\n    });\n\n    if (!room || room.t !== 'c' && room.t !== 'p') {\n      return;\n    }\n\n    return room._id;\n  }\n\n  trackError(message, stack) {\n    if (!this.reporting || !this.rid || this.lastError === message) {\n      return;\n    }\n\n    this.lastError = message;\n    const user = Users.findOneById('rocket.cat');\n\n    if (stack) {\n      message = \"\".concat(message, \"\\n```\\n\").concat(stack, \"\\n```\");\n    }\n\n    sendMessage(user, {\n      msg: message\n    }, {\n      _id: this.rid\n    });\n  }\n\n}\n\nmodule.exportDefault(new ErrorHandler());","map":{"version":3,"sources":["app/error-handler/server/lib/RocketChat.ErrorHandler.js"],"names":["Meteor","module","link","v","settings","Users","Rooms","sendMessage","ErrorHandler","constructor","reporting","rid","lastError","startup","registerHandlers","watch","value","roomName","trim","getRoomId","process","on","bindEnvironment","error","trackError","message","stack","self","originalMeteorDebug","_debug","call","args","apply","replace","room","findOneByName","fields","_id","t","user","findOneById","msg","exportDefault"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { settings } from '../../../settings/server';\nimport { Users, Rooms } from '../../../models';\nimport { sendMessage } from '../../../lib';\n\nclass ErrorHandler {\n\tconstructor() {\n\t\tthis.reporting = false;\n\t\tthis.rid = null;\n\t\tthis.lastError = null;\n\n\t\tMeteor.startup(() => {\n\t\t\tthis.registerHandlers();\n\n\t\t\tsettings.watch('Log_Exceptions_to_Channel', (value) => {\n\t\t\t\tthis.rid = null;\n\t\t\t\tconst roomName = value.trim();\n\t\t\t\tif (roomName) {\n\t\t\t\t\tthis.rid = this.getRoomId(roomName);\n\t\t\t\t}\n\n\t\t\t\tif (this.rid) {\n\t\t\t\t\tthis.reporting = true;\n\t\t\t\t} else {\n\t\t\t\t\tthis.reporting = false;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tregisterHandlers() {\n\t\tprocess.on(\n\t\t\t'uncaughtException',\n\t\t\tMeteor.bindEnvironment((error) => {\n\t\t\t\tif (!this.reporting) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.trackError(error.message, error.stack);\n\t\t\t}),\n\t\t);\n\n\t\tconst self = this;\n\t\tconst originalMeteorDebug = Meteor._debug;\n\t\tMeteor._debug = function (message, stack, ...args) {\n\t\t\tif (!self.reporting) {\n\t\t\t\treturn originalMeteorDebug.call(this, message, stack);\n\t\t\t}\n\t\t\tself.trackError(message, stack);\n\t\t\treturn originalMeteorDebug.apply(this, [message, stack, ...args]);\n\t\t};\n\t}\n\n\tgetRoomId(roomName) {\n\t\troomName = roomName.replace('#');\n\t\tconst room = Rooms.findOneByName(roomName, { fields: { _id: 1, t: 1 } });\n\t\tif (!room || (room.t !== 'c' && room.t !== 'p')) {\n\t\t\treturn;\n\t\t}\n\t\treturn room._id;\n\t}\n\n\ttrackError(message, stack) {\n\t\tif (!this.reporting || !this.rid || this.lastError === message) {\n\t\t\treturn;\n\t\t}\n\t\tthis.lastError = message;\n\t\tconst user = Users.findOneById('rocket.cat');\n\n\t\tif (stack) {\n\t\t\tmessage = `${message}\\n\\`\\`\\`\\n${stack}\\n\\`\\`\\``;\n\t\t}\n\n\t\tsendMessage(user, { msg: message }, { _id: this.rid });\n\t}\n}\n\nexport default new ErrorHandler();\n"]},"sourceType":"module","hash":"c7abd6cd62567e5ed369a1f808c3044b6fe4c8d9"}
