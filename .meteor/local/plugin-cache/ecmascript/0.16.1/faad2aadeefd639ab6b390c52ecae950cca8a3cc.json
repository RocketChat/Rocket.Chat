{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/lib/debug.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/lib/server/lib/debug.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/lib/debug.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/lib/server/lib/debug.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/lib/debug.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 1);\nlet InstanceStatus;\nmodule.link(\"meteor/konecty:multiple-instances-status\", {\n  InstanceStatus(v) {\n    InstanceStatus = v;\n  }\n\n}, 2);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 3);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 4);\nlet metrics;\nmodule.link(\"../../../metrics/server\", {\n  metrics(v) {\n    metrics = v;\n  }\n\n}, 5);\nlet Logger;\nmodule.link(\"../../../../server/lib/logger/Logger\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 6);\nlet getMethodArgs;\nmodule.link(\"../../../../server/lib/logger/logPayloads\", {\n  getMethodArgs(v) {\n    getMethodArgs = v;\n  }\n\n}, 7);\nconst logger = new Logger('Meteor');\nlet Log_Trace_Methods;\nlet Log_Trace_Subscriptions;\nsettings.watch('Log_Trace_Methods', value => {\n  Log_Trace_Methods = value;\n});\nsettings.watch('Log_Trace_Subscriptions', value => {\n  Log_Trace_Subscriptions = value;\n});\nlet Log_Trace_Methods_Filter;\nlet Log_Trace_Subscriptions_Filter;\nsettings.watch('Log_Trace_Methods_Filter', value => {\n  Log_Trace_Methods_Filter = value ? new RegExp(value) : undefined;\n});\nsettings.watch('Log_Trace_Subscriptions_Filter', value => {\n  Log_Trace_Subscriptions_Filter = value ? new RegExp(value) : undefined;\n});\n\nconst traceConnection = (enable, filter, prefix, name, connection, userId) => {\n  if (!enable) {\n    return;\n  }\n\n  if (filter && !filter.test(name)) {\n    return;\n  }\n\n  if (connection) {\n    console.log(name, {\n      id: connection.id,\n      clientAddress: connection.clientAddress,\n      httpHeaders: connection.httpHeaders,\n      userId\n    });\n  } else {\n    console.log(name, 'no-connection');\n  }\n};\n\nconst wrapMethods = function (name, originalHandler, methodsMap) {\n  methodsMap[name] = function () {\n    var _this$connection, _this$connection2, _this$connection3;\n\n    traceConnection(Log_Trace_Methods, Log_Trace_Methods_Filter, 'method', name, this.connection, this.userId);\n\n    for (var _len = arguments.length, originalArgs = new Array(_len), _key = 0; _key < _len; _key++) {\n      originalArgs[_key] = arguments[_key];\n    }\n\n    const method = name === 'stream' ? \"\".concat(name, \":\").concat(originalArgs[0]) : name;\n    const end = metrics.meteorMethods.startTimer({\n      method,\n      has_connection: this.connection != null,\n      has_user: this.userId != null\n    });\n    logger.method(_objectSpread({\n      method,\n      userId: Meteor.userId(),\n      userAgent: (_this$connection = this.connection) === null || _this$connection === void 0 ? void 0 : _this$connection.httpHeaders['user-agent'],\n      referer: (_this$connection2 = this.connection) === null || _this$connection2 === void 0 ? void 0 : _this$connection2.httpHeaders.referer,\n      remoteIP: (_this$connection3 = this.connection) === null || _this$connection3 === void 0 ? void 0 : _this$connection3.clientAddress,\n      instanceId: InstanceStatus.id()\n    }, getMethodArgs(name, originalArgs)));\n    const result = originalHandler.apply(this, originalArgs);\n    end();\n    return result;\n  };\n};\n\nconst originalMeteorMethods = Meteor.methods;\n\nMeteor.methods = function (methodMap) {\n  _.each(methodMap, function (handler, name) {\n    wrapMethods(name, handler, methodMap);\n  });\n\n  originalMeteorMethods(methodMap);\n};\n\nconst originalMeteorPublish = Meteor.publish;\n\nMeteor.publish = function (name, func) {\n  return originalMeteorPublish(name, function () {\n    var _this$connection4, _this$connection5, _this$connection6;\n\n    for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n      args[_key2] = arguments[_key2];\n    }\n\n    traceConnection(Log_Trace_Subscriptions, Log_Trace_Subscriptions_Filter, 'subscription', name, this.connection, this.userId);\n    logger.subscription({\n      publication: name,\n      userId: this.userId,\n      userAgent: (_this$connection4 = this.connection) === null || _this$connection4 === void 0 ? void 0 : _this$connection4.httpHeaders['user-agent'],\n      referer: (_this$connection5 = this.connection) === null || _this$connection5 === void 0 ? void 0 : _this$connection5.httpHeaders.referer,\n      remoteIP: (_this$connection6 = this.connection) === null || _this$connection6 === void 0 ? void 0 : _this$connection6.clientAddress,\n      instanceId: InstanceStatus.id()\n    });\n    const end = metrics.meteorSubscriptions.startTimer({\n      subscription: name\n    });\n    const originalReady = this.ready;\n\n    this.ready = function () {\n      end();\n      return originalReady.apply(this, args);\n    };\n\n    return func.apply(this, args);\n  });\n};\n\nWebApp.rawConnectHandlers.use(function (req, res, next) {\n  res.setHeader('X-Instance-ID', InstanceStatus.id());\n  return next();\n});","map":{"version":3,"sources":["app/lib/server/lib/debug.js"],"names":["_objectSpread","module","link","default","v","Meteor","WebApp","InstanceStatus","_","settings","metrics","Logger","getMethodArgs","logger","Log_Trace_Methods","Log_Trace_Subscriptions","watch","value","Log_Trace_Methods_Filter","Log_Trace_Subscriptions_Filter","RegExp","undefined","traceConnection","enable","filter","prefix","name","connection","userId","test","console","log","id","clientAddress","httpHeaders","wrapMethods","originalHandler","methodsMap","originalArgs","method","end","meteorMethods","startTimer","has_connection","has_user","userAgent","referer","remoteIP","instanceId","result","apply","originalMeteorMethods","methods","methodMap","each","handler","originalMeteorPublish","publish","func","args","subscription","publication","meteorSubscriptions","originalReady","ready","rawConnectHandlers","use","req","res","next","setHeader"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport { InstanceStatus } from 'meteor/konecty:multiple-instances-status';\nimport _ from 'underscore';\n\nimport { settings } from '../../../settings/server';\nimport { metrics } from '../../../metrics/server';\nimport { Logger } from '../../../../server/lib/logger/Logger';\nimport { getMethodArgs } from '../../../../server/lib/logger/logPayloads';\n\nconst logger = new Logger('Meteor');\n\nlet Log_Trace_Methods;\nlet Log_Trace_Subscriptions;\nsettings.watch('Log_Trace_Methods', (value) => {\n\tLog_Trace_Methods = value;\n});\nsettings.watch('Log_Trace_Subscriptions', (value) => {\n\tLog_Trace_Subscriptions = value;\n});\n\nlet Log_Trace_Methods_Filter;\nlet Log_Trace_Subscriptions_Filter;\nsettings.watch('Log_Trace_Methods_Filter', (value) => {\n\tLog_Trace_Methods_Filter = value ? new RegExp(value) : undefined;\n});\nsettings.watch('Log_Trace_Subscriptions_Filter', (value) => {\n\tLog_Trace_Subscriptions_Filter = value ? new RegExp(value) : undefined;\n});\n\nconst traceConnection = (enable, filter, prefix, name, connection, userId) => {\n\tif (!enable) {\n\t\treturn;\n\t}\n\n\tif (filter && !filter.test(name)) {\n\t\treturn;\n\t}\n\n\tif (connection) {\n\t\tconsole.log(name, {\n\t\t\tid: connection.id,\n\t\t\tclientAddress: connection.clientAddress,\n\t\t\thttpHeaders: connection.httpHeaders,\n\t\t\tuserId,\n\t\t});\n\t} else {\n\t\tconsole.log(name, 'no-connection');\n\t}\n};\n\nconst wrapMethods = function (name, originalHandler, methodsMap) {\n\tmethodsMap[name] = function (...originalArgs) {\n\t\ttraceConnection(Log_Trace_Methods, Log_Trace_Methods_Filter, 'method', name, this.connection, this.userId);\n\n\t\tconst method = name === 'stream' ? `${name}:${originalArgs[0]}` : name;\n\n\t\tconst end = metrics.meteorMethods.startTimer({\n\t\t\tmethod,\n\t\t\thas_connection: this.connection != null,\n\t\t\thas_user: this.userId != null,\n\t\t});\n\n\t\tlogger.method({\n\t\t\tmethod,\n\t\t\tuserId: Meteor.userId(),\n\t\t\tuserAgent: this.connection?.httpHeaders['user-agent'],\n\t\t\treferer: this.connection?.httpHeaders.referer,\n\t\t\tremoteIP: this.connection?.clientAddress,\n\t\t\tinstanceId: InstanceStatus.id(),\n\t\t\t...getMethodArgs(name, originalArgs),\n\t\t});\n\n\t\tconst result = originalHandler.apply(this, originalArgs);\n\t\tend();\n\t\treturn result;\n\t};\n};\n\nconst originalMeteorMethods = Meteor.methods;\n\nMeteor.methods = function (methodMap) {\n\t_.each(methodMap, function (handler, name) {\n\t\twrapMethods(name, handler, methodMap);\n\t});\n\toriginalMeteorMethods(methodMap);\n};\n\nconst originalMeteorPublish = Meteor.publish;\n\nMeteor.publish = function (name, func) {\n\treturn originalMeteorPublish(name, function (...args) {\n\t\ttraceConnection(Log_Trace_Subscriptions, Log_Trace_Subscriptions_Filter, 'subscription', name, this.connection, this.userId);\n\n\t\tlogger.subscription({\n\t\t\tpublication: name,\n\t\t\tuserId: this.userId,\n\t\t\tuserAgent: this.connection?.httpHeaders['user-agent'],\n\t\t\treferer: this.connection?.httpHeaders.referer,\n\t\t\tremoteIP: this.connection?.clientAddress,\n\t\t\tinstanceId: InstanceStatus.id(),\n\t\t});\n\n\t\tconst end = metrics.meteorSubscriptions.startTimer({ subscription: name });\n\n\t\tconst originalReady = this.ready;\n\t\tthis.ready = function () {\n\t\t\tend();\n\t\t\treturn originalReady.apply(this, args);\n\t\t};\n\n\t\treturn func.apply(this, args);\n\t});\n};\n\nWebApp.rawConnectHandlers.use(function (req, res, next) {\n\tres.setHeader('X-Instance-ID', InstanceStatus.id());\n\treturn next();\n});\n"]},"sourceType":"module","hash":"faad2aadeefd639ab6b390c52ecae950cca8a3cc"}
