{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/apps/server/orchestrator.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/apps/server/orchestrator.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/apps/server/orchestrator.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/apps/server/orchestrator.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/orchestrator.js"}},"code":"module.export({\n  AppServerOrchestrator: () => AppServerOrchestrator,\n  AppEvents: () => AppEvents,\n  Apps: () => Apps\n});\nlet EssentialAppDisabledException;\nmodule.link(\"@rocket.chat/apps-engine/definition/exceptions\", {\n  EssentialAppDisabledException(v) {\n    EssentialAppDisabledException = v;\n  }\n\n}, 0);\nlet AppInterface;\nmodule.link(\"@rocket.chat/apps-engine/definition/metadata\", {\n  AppInterface(v) {\n    AppInterface = v;\n  }\n\n}, 1);\nlet AppManager;\nmodule.link(\"@rocket.chat/apps-engine/server/AppManager\", {\n  AppManager(v) {\n    AppManager = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet Logger;\nmodule.link(\"../../../server/lib/logger/Logger\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 4);\nlet AppsLogsModel, AppsModel, AppsPersistenceModel;\nmodule.link(\"../../models/server\", {\n  AppsLogsModel(v) {\n    AppsLogsModel = v;\n  },\n\n  AppsModel(v) {\n    AppsModel = v;\n  },\n\n  AppsPersistenceModel(v) {\n    AppsPersistenceModel = v;\n  }\n\n}, 5);\nlet settings, settingsRegistry;\nmodule.link(\"../../settings/server\", {\n  settings(v) {\n    settings = v;\n  },\n\n  settingsRegistry(v) {\n    settingsRegistry = v;\n  }\n\n}, 6);\nlet RealAppBridges;\nmodule.link(\"./bridges\", {\n  RealAppBridges(v) {\n    RealAppBridges = v;\n  }\n\n}, 7);\nlet AppMethods, AppServerNotifier, AppsRestApi, AppUIKitInteractionApi;\nmodule.link(\"./communication\", {\n  AppMethods(v) {\n    AppMethods = v;\n  },\n\n  AppServerNotifier(v) {\n    AppServerNotifier = v;\n  },\n\n  AppsRestApi(v) {\n    AppsRestApi = v;\n  },\n\n  AppUIKitInteractionApi(v) {\n    AppUIKitInteractionApi = v;\n  }\n\n}, 8);\nlet AppMessagesConverter, AppRoomsConverter, AppSettingsConverter, AppUsersConverter;\nmodule.link(\"./converters\", {\n  AppMessagesConverter(v) {\n    AppMessagesConverter = v;\n  },\n\n  AppRoomsConverter(v) {\n    AppRoomsConverter = v;\n  },\n\n  AppSettingsConverter(v) {\n    AppSettingsConverter = v;\n  },\n\n  AppUsersConverter(v) {\n    AppUsersConverter = v;\n  }\n\n}, 9);\nlet AppDepartmentsConverter;\nmodule.link(\"./converters/departments\", {\n  AppDepartmentsConverter(v) {\n    AppDepartmentsConverter = v;\n  }\n\n}, 10);\nlet AppUploadsConverter;\nmodule.link(\"./converters/uploads\", {\n  AppUploadsConverter(v) {\n    AppUploadsConverter = v;\n  }\n\n}, 11);\nlet AppVisitorsConverter;\nmodule.link(\"./converters/visitors\", {\n  AppVisitorsConverter(v) {\n    AppVisitorsConverter = v;\n  }\n\n}, 12);\nlet AppRealLogsStorage, AppRealStorage, ConfigurableAppSourceStorage;\nmodule.link(\"./storage\", {\n  AppRealLogsStorage(v) {\n    AppRealLogsStorage = v;\n  },\n\n  AppRealStorage(v) {\n    AppRealStorage = v;\n  },\n\n  ConfigurableAppSourceStorage(v) {\n    ConfigurableAppSourceStorage = v;\n  }\n\n}, 13);\n\nfunction isTesting() {\n  return process.env.TEST_MODE === 'true';\n}\n\nlet appsSourceStorageType;\nlet appsSourceStorageFilesystemPath;\n\nclass AppServerOrchestrator {\n  constructor() {\n    this._isInitialized = false;\n  }\n\n  initialize() {\n    if (this._isInitialized) {\n      return;\n    }\n\n    this._rocketchatLogger = new Logger('Rocket.Chat Apps');\n\n    if (typeof process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL === 'string' && process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL !== '') {\n      this._marketplaceUrl = process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL;\n    } else {\n      this._marketplaceUrl = 'https://marketplace.rocket.chat';\n    }\n\n    this._model = new AppsModel();\n    this._logModel = new AppsLogsModel();\n    this._persistModel = new AppsPersistenceModel();\n    this._storage = new AppRealStorage(this._model);\n    this._logStorage = new AppRealLogsStorage(this._logModel);\n    this._appSourceStorage = new ConfigurableAppSourceStorage(appsSourceStorageType, appsSourceStorageFilesystemPath);\n    this._converters = new Map();\n\n    this._converters.set('messages', new AppMessagesConverter(this));\n\n    this._converters.set('rooms', new AppRoomsConverter(this));\n\n    this._converters.set('settings', new AppSettingsConverter(this));\n\n    this._converters.set('users', new AppUsersConverter(this));\n\n    this._converters.set('visitors', new AppVisitorsConverter(this));\n\n    this._converters.set('departments', new AppDepartmentsConverter(this));\n\n    this._converters.set('uploads', new AppUploadsConverter(this));\n\n    this._bridges = new RealAppBridges(this);\n    this._manager = new AppManager({\n      metadataStorage: this._storage,\n      logStorage: this._logStorage,\n      bridges: this._bridges,\n      sourceStorage: this._appSourceStorage\n    });\n    this._communicators = new Map();\n\n    this._communicators.set('methods', new AppMethods(this));\n\n    this._communicators.set('notifier', new AppServerNotifier(this));\n\n    this._communicators.set('restapi', new AppsRestApi(this, this._manager));\n\n    this._communicators.set('uikit', new AppUIKitInteractionApi(this));\n\n    this._isInitialized = true;\n  }\n\n  getModel() {\n    return this._model;\n  }\n  /**\n   * @returns {AppsPersistenceModel}\n   */\n\n\n  getPersistenceModel() {\n    return this._persistModel;\n  }\n\n  getStorage() {\n    return this._storage;\n  }\n\n  getLogStorage() {\n    return this._logStorage;\n  }\n\n  getConverters() {\n    return this._converters;\n  }\n\n  getBridges() {\n    return this._bridges;\n  }\n\n  getNotifier() {\n    return this._communicators.get('notifier');\n  }\n\n  getManager() {\n    return this._manager;\n  }\n\n  getProvidedComponents() {\n    return this._manager.getExternalComponentManager().getProvidedComponents();\n  }\n\n  getAppSourceStorage() {\n    return this._appSourceStorage;\n  }\n\n  isInitialized() {\n    return this._isInitialized;\n  }\n\n  isEnabled() {\n    return settings.get('Apps_Framework_enabled');\n  }\n\n  isLoaded() {\n    return this.getManager().areAppsLoaded();\n  }\n\n  isDebugging() {\n    return settings.get('Apps_Framework_Development_Mode') && !isTesting();\n  }\n  /**\n   * @returns {Logger}\n   */\n\n\n  getRocketChatLogger() {\n    return this._rocketchatLogger;\n  }\n\n  debugLog() {\n    if (this.isDebugging()) {\n      this.getRocketChatLogger().debug(...arguments);\n    }\n  }\n\n  getMarketplaceUrl() {\n    return this._marketplaceUrl;\n  }\n\n  load() {\n    return Promise.asyncApply(() => {\n      // Don't try to load it again if it has\n      // already been loaded\n      if (this.isLoaded()) {\n        return;\n      }\n\n      return this._manager.load().then(affs => console.log(\"Loaded the Apps Framework and loaded a total of \".concat(affs.length, \" Apps!\"))).catch(err => console.warn('Failed to load the Apps Framework and Apps!', err)).then(() => this.getBridges().getSchedulerBridge().startScheduler());\n    });\n  }\n\n  unload() {\n    return Promise.asyncApply(() => {\n      // Don't try to unload it if it's already been\n      // unlaoded or wasn't unloaded to start with\n      if (!this.isLoaded()) {\n        return;\n      }\n\n      return this._manager.unload().then(() => console.log('Unloaded the Apps Framework.')).catch(err => console.warn('Failed to unload the Apps Framework!', err));\n    });\n  }\n\n  updateAppsMarketplaceInfo() {\n    return Promise.asyncApply(() => {\n      let apps = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n\n      if (!this.isLoaded()) {\n        return;\n      }\n\n      return this._manager.updateAppsMarketplaceInfo(apps).then(() => this._manager.get());\n    });\n  }\n\n  triggerEvent(event) {\n    return Promise.asyncApply(() => {\n      if (!this.isLoaded()) {\n        return;\n      }\n\n      for (var _len = arguments.length, payload = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n        payload[_key - 1] = arguments[_key];\n      }\n\n      return this.getBridges().getListenerBridge().handleEvent(event, ...payload).catch(error => {\n        if (error instanceof EssentialAppDisabledException) {\n          throw new Meteor.Error('error-essential-app-disabled');\n        }\n\n        throw error;\n      });\n    });\n  }\n\n}\n\nconst AppEvents = AppInterface;\nconst Apps = new AppServerOrchestrator();\nsettingsRegistry.addGroup('General', function () {\n  this.section('Apps', function () {\n    this.add('Apps_Logs_TTL', '30_days', {\n      type: 'select',\n      values: [{\n        key: '7_days',\n        i18nLabel: 'Apps_Logs_TTL_7days'\n      }, {\n        key: '14_days',\n        i18nLabel: 'Apps_Logs_TTL_14days'\n      }, {\n        key: '30_days',\n        i18nLabel: 'Apps_Logs_TTL_30days'\n      }],\n      public: true,\n      hidden: false,\n      alert: 'Apps_Logs_TTL_Alert'\n    });\n    this.add('Apps_Framework_enabled', true, {\n      type: 'boolean',\n      hidden: false\n    });\n    this.add('Apps_Framework_Development_Mode', false, {\n      type: 'boolean',\n      enableQuery: {\n        _id: 'Apps_Framework_enabled',\n        value: true\n      },\n      public: true,\n      hidden: false\n    });\n    this.add('Apps_Framework_Source_Package_Storage_Type', 'gridfs', {\n      type: 'select',\n      values: [{\n        key: 'gridfs',\n        i18nLabel: 'GridFS'\n      }, {\n        key: 'filesystem',\n        i18nLabel: 'FileSystem'\n      }],\n      public: true,\n      hidden: false,\n      alert: 'Apps_Framework_Source_Package_Storage_Type_Alert'\n    });\n    this.add('Apps_Framework_Source_Package_Storage_FileSystem_Path', '', {\n      type: 'string',\n      public: true,\n      enableQuery: {\n        _id: 'Apps_Framework_Source_Package_Storage_Type',\n        value: 'filesystem'\n      },\n      alert: 'Apps_Framework_Source_Package_Storage_FileSystem_Alert'\n    });\n  });\n});\nsettings.watch('Apps_Framework_Source_Package_Storage_Type', value => {\n  if (!Apps.isInitialized()) {\n    appsSourceStorageType = value;\n  } else {\n    Apps.getAppSourceStorage().setStorage(value);\n  }\n});\nsettings.watch('Apps_Framework_Source_Package_Storage_FileSystem_Path', value => {\n  if (!Apps.isInitialized()) {\n    appsSourceStorageFilesystemPath = value;\n  } else {\n    Apps.getAppSourceStorage().setFileSystemStoragePath(value);\n  }\n});\nsettings.watch('Apps_Framework_enabled', isEnabled => {\n  // In case this gets called before `Meteor.startup`\n  if (!Apps.isInitialized()) {\n    return;\n  }\n\n  if (isEnabled) {\n    Apps.load();\n  } else {\n    Apps.unload();\n  }\n});\nsettings.watch('Apps_Logs_TTL', value => {\n  if (!Apps.isInitialized()) {\n    return;\n  }\n\n  let expireAfterSeconds = 0;\n\n  switch (value) {\n    case '7_days':\n      expireAfterSeconds = 604800;\n      break;\n\n    case '14_days':\n      expireAfterSeconds = 1209600;\n      break;\n\n    case '30_days':\n      expireAfterSeconds = 2592000;\n      break;\n  }\n\n  if (!expireAfterSeconds) {\n    return;\n  }\n\n  const model = Apps._logModel;\n  model.resetTTLIndex(expireAfterSeconds);\n});\nMeteor.startup(function _appServerOrchestrator() {\n  Apps.initialize();\n\n  if (Apps.isEnabled()) {\n    Apps.load();\n  }\n});","map":{"version":3,"sources":["app/apps/server/orchestrator.js"],"names":["module","export","AppServerOrchestrator","AppEvents","Apps","EssentialAppDisabledException","link","v","AppInterface","AppManager","Meteor","Logger","AppsLogsModel","AppsModel","AppsPersistenceModel","settings","settingsRegistry","RealAppBridges","AppMethods","AppServerNotifier","AppsRestApi","AppUIKitInteractionApi","AppMessagesConverter","AppRoomsConverter","AppSettingsConverter","AppUsersConverter","AppDepartmentsConverter","AppUploadsConverter","AppVisitorsConverter","AppRealLogsStorage","AppRealStorage","ConfigurableAppSourceStorage","isTesting","process","env","TEST_MODE","appsSourceStorageType","appsSourceStorageFilesystemPath","constructor","_isInitialized","initialize","_rocketchatLogger","OVERWRITE_INTERNAL_MARKETPLACE_URL","_marketplaceUrl","_model","_logModel","_persistModel","_storage","_logStorage","_appSourceStorage","_converters","Map","set","_bridges","_manager","metadataStorage","logStorage","bridges","sourceStorage","_communicators","getModel","getPersistenceModel","getStorage","getLogStorage","getConverters","getBridges","getNotifier","get","getManager","getProvidedComponents","getExternalComponentManager","getAppSourceStorage","isInitialized","isEnabled","isLoaded","areAppsLoaded","isDebugging","getRocketChatLogger","debugLog","debug","getMarketplaceUrl","load","then","affs","console","log","length","catch","err","warn","getSchedulerBridge","startScheduler","unload","updateAppsMarketplaceInfo","apps","triggerEvent","event","payload","getListenerBridge","handleEvent","error","Error","addGroup","section","add","type","values","key","i18nLabel","public","hidden","alert","enableQuery","_id","value","watch","setStorage","setFileSystemStoragePath","expireAfterSeconds","model","resetTTLIndex","startup","_appServerOrchestrator"],"mappings":"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","sourcesContent":["import { EssentialAppDisabledException } from '@rocket.chat/apps-engine/definition/exceptions';\nimport { AppInterface } from '@rocket.chat/apps-engine/definition/metadata';\nimport { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\nimport { Meteor } from 'meteor/meteor';\n\nimport { Logger } from '../../../server/lib/logger/Logger';\nimport { AppsLogsModel, AppsModel, AppsPersistenceModel } from '../../models/server';\nimport { settings, settingsRegistry } from '../../settings/server';\nimport { RealAppBridges } from './bridges';\nimport { AppMethods, AppServerNotifier, AppsRestApi, AppUIKitInteractionApi } from './communication';\nimport { AppMessagesConverter, AppRoomsConverter, AppSettingsConverter, AppUsersConverter } from './converters';\nimport { AppDepartmentsConverter } from './converters/departments';\nimport { AppUploadsConverter } from './converters/uploads';\nimport { AppVisitorsConverter } from './converters/visitors';\nimport { AppRealLogsStorage, AppRealStorage, ConfigurableAppSourceStorage } from './storage';\n\nfunction isTesting() {\n\treturn process.env.TEST_MODE === 'true';\n}\n\nlet appsSourceStorageType;\nlet appsSourceStorageFilesystemPath;\n\nexport class AppServerOrchestrator {\n\tconstructor() {\n\t\tthis._isInitialized = false;\n\t}\n\n\tinitialize() {\n\t\tif (this._isInitialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._rocketchatLogger = new Logger('Rocket.Chat Apps');\n\n\t\tif (typeof process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL === 'string' && process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL !== '') {\n\t\t\tthis._marketplaceUrl = process.env.OVERWRITE_INTERNAL_MARKETPLACE_URL;\n\t\t} else {\n\t\t\tthis._marketplaceUrl = 'https://marketplace.rocket.chat';\n\t\t}\n\n\t\tthis._model = new AppsModel();\n\t\tthis._logModel = new AppsLogsModel();\n\t\tthis._persistModel = new AppsPersistenceModel();\n\t\tthis._storage = new AppRealStorage(this._model);\n\t\tthis._logStorage = new AppRealLogsStorage(this._logModel);\n\t\tthis._appSourceStorage = new ConfigurableAppSourceStorage(appsSourceStorageType, appsSourceStorageFilesystemPath);\n\n\t\tthis._converters = new Map();\n\t\tthis._converters.set('messages', new AppMessagesConverter(this));\n\t\tthis._converters.set('rooms', new AppRoomsConverter(this));\n\t\tthis._converters.set('settings', new AppSettingsConverter(this));\n\t\tthis._converters.set('users', new AppUsersConverter(this));\n\t\tthis._converters.set('visitors', new AppVisitorsConverter(this));\n\t\tthis._converters.set('departments', new AppDepartmentsConverter(this));\n\t\tthis._converters.set('uploads', new AppUploadsConverter(this));\n\n\t\tthis._bridges = new RealAppBridges(this);\n\n\t\tthis._manager = new AppManager({\n\t\t\tmetadataStorage: this._storage,\n\t\t\tlogStorage: this._logStorage,\n\t\t\tbridges: this._bridges,\n\t\t\tsourceStorage: this._appSourceStorage,\n\t\t});\n\n\t\tthis._communicators = new Map();\n\t\tthis._communicators.set('methods', new AppMethods(this));\n\t\tthis._communicators.set('notifier', new AppServerNotifier(this));\n\t\tthis._communicators.set('restapi', new AppsRestApi(this, this._manager));\n\t\tthis._communicators.set('uikit', new AppUIKitInteractionApi(this));\n\n\t\tthis._isInitialized = true;\n\t}\n\n\tgetModel() {\n\t\treturn this._model;\n\t}\n\n\t/**\n\t * @returns {AppsPersistenceModel}\n\t */\n\tgetPersistenceModel() {\n\t\treturn this._persistModel;\n\t}\n\n\tgetStorage() {\n\t\treturn this._storage;\n\t}\n\n\tgetLogStorage() {\n\t\treturn this._logStorage;\n\t}\n\n\tgetConverters() {\n\t\treturn this._converters;\n\t}\n\n\tgetBridges() {\n\t\treturn this._bridges;\n\t}\n\n\tgetNotifier() {\n\t\treturn this._communicators.get('notifier');\n\t}\n\n\tgetManager() {\n\t\treturn this._manager;\n\t}\n\n\tgetProvidedComponents() {\n\t\treturn this._manager.getExternalComponentManager().getProvidedComponents();\n\t}\n\n\tgetAppSourceStorage() {\n\t\treturn this._appSourceStorage;\n\t}\n\n\tisInitialized() {\n\t\treturn this._isInitialized;\n\t}\n\n\tisEnabled() {\n\t\treturn settings.get('Apps_Framework_enabled');\n\t}\n\n\tisLoaded() {\n\t\treturn this.getManager().areAppsLoaded();\n\t}\n\n\tisDebugging() {\n\t\treturn settings.get('Apps_Framework_Development_Mode') && !isTesting();\n\t}\n\n\t/**\n\t * @returns {Logger}\n\t */\n\tgetRocketChatLogger() {\n\t\treturn this._rocketchatLogger;\n\t}\n\n\tdebugLog(...args) {\n\t\tif (this.isDebugging()) {\n\t\t\tthis.getRocketChatLogger().debug(...args);\n\t\t}\n\t}\n\n\tgetMarketplaceUrl() {\n\t\treturn this._marketplaceUrl;\n\t}\n\n\tasync load() {\n\t\t// Don't try to load it again if it has\n\t\t// already been loaded\n\t\tif (this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._manager\n\t\t\t.load()\n\t\t\t.then((affs) => console.log(`Loaded the Apps Framework and loaded a total of ${affs.length} Apps!`))\n\t\t\t.catch((err) => console.warn('Failed to load the Apps Framework and Apps!', err))\n\t\t\t.then(() => this.getBridges().getSchedulerBridge().startScheduler());\n\t}\n\n\tasync unload() {\n\t\t// Don't try to unload it if it's already been\n\t\t// unlaoded or wasn't unloaded to start with\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._manager\n\t\t\t.unload()\n\t\t\t.then(() => console.log('Unloaded the Apps Framework.'))\n\t\t\t.catch((err) => console.warn('Failed to unload the Apps Framework!', err));\n\t}\n\n\tasync updateAppsMarketplaceInfo(apps = []) {\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this._manager.updateAppsMarketplaceInfo(apps).then(() => this._manager.get());\n\t}\n\n\tasync triggerEvent(event, ...payload) {\n\t\tif (!this.isLoaded()) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.getBridges()\n\t\t\t.getListenerBridge()\n\t\t\t.handleEvent(event, ...payload)\n\t\t\t.catch((error) => {\n\t\t\t\tif (error instanceof EssentialAppDisabledException) {\n\t\t\t\t\tthrow new Meteor.Error('error-essential-app-disabled');\n\t\t\t\t}\n\n\t\t\t\tthrow error;\n\t\t\t});\n\t}\n}\n\nexport const AppEvents = AppInterface;\nexport const Apps = new AppServerOrchestrator();\n\nsettingsRegistry.addGroup('General', function () {\n\tthis.section('Apps', function () {\n\t\tthis.add('Apps_Logs_TTL', '30_days', {\n\t\t\ttype: 'select',\n\t\t\tvalues: [\n\t\t\t\t{\n\t\t\t\t\tkey: '7_days',\n\t\t\t\t\ti18nLabel: 'Apps_Logs_TTL_7days',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: '14_days',\n\t\t\t\t\ti18nLabel: 'Apps_Logs_TTL_14days',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: '30_days',\n\t\t\t\t\ti18nLabel: 'Apps_Logs_TTL_30days',\n\t\t\t\t},\n\t\t\t],\n\t\t\tpublic: true,\n\t\t\thidden: false,\n\t\t\talert: 'Apps_Logs_TTL_Alert',\n\t\t});\n\n\t\tthis.add('Apps_Framework_enabled', true, {\n\t\t\ttype: 'boolean',\n\t\t\thidden: false,\n\t\t});\n\n\t\tthis.add('Apps_Framework_Development_Mode', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Apps_Framework_enabled',\n\t\t\t\tvalue: true,\n\t\t\t},\n\t\t\tpublic: true,\n\t\t\thidden: false,\n\t\t});\n\n\t\tthis.add('Apps_Framework_Source_Package_Storage_Type', 'gridfs', {\n\t\t\ttype: 'select',\n\t\t\tvalues: [\n\t\t\t\t{\n\t\t\t\t\tkey: 'gridfs',\n\t\t\t\t\ti18nLabel: 'GridFS',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: 'filesystem',\n\t\t\t\t\ti18nLabel: 'FileSystem',\n\t\t\t\t},\n\t\t\t],\n\t\t\tpublic: true,\n\t\t\thidden: false,\n\t\t\talert: 'Apps_Framework_Source_Package_Storage_Type_Alert',\n\t\t});\n\n\t\tthis.add('Apps_Framework_Source_Package_Storage_FileSystem_Path', '', {\n\t\t\ttype: 'string',\n\t\t\tpublic: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'Apps_Framework_Source_Package_Storage_Type',\n\t\t\t\tvalue: 'filesystem',\n\t\t\t},\n\t\t\talert: 'Apps_Framework_Source_Package_Storage_FileSystem_Alert',\n\t\t});\n\t});\n});\n\nsettings.watch('Apps_Framework_Source_Package_Storage_Type', (value) => {\n\tif (!Apps.isInitialized()) {\n\t\tappsSourceStorageType = value;\n\t} else {\n\t\tApps.getAppSourceStorage().setStorage(value);\n\t}\n});\n\nsettings.watch('Apps_Framework_Source_Package_Storage_FileSystem_Path', (value) => {\n\tif (!Apps.isInitialized()) {\n\t\tappsSourceStorageFilesystemPath = value;\n\t} else {\n\t\tApps.getAppSourceStorage().setFileSystemStoragePath(value);\n\t}\n});\n\nsettings.watch('Apps_Framework_enabled', (isEnabled) => {\n\t// In case this gets called before `Meteor.startup`\n\tif (!Apps.isInitialized()) {\n\t\treturn;\n\t}\n\n\tif (isEnabled) {\n\t\tApps.load();\n\t} else {\n\t\tApps.unload();\n\t}\n});\n\nsettings.watch('Apps_Logs_TTL', (value) => {\n\tif (!Apps.isInitialized()) {\n\t\treturn;\n\t}\n\n\tlet expireAfterSeconds = 0;\n\n\tswitch (value) {\n\t\tcase '7_days':\n\t\t\texpireAfterSeconds = 604800;\n\t\t\tbreak;\n\t\tcase '14_days':\n\t\t\texpireAfterSeconds = 1209600;\n\t\t\tbreak;\n\t\tcase '30_days':\n\t\t\texpireAfterSeconds = 2592000;\n\t\t\tbreak;\n\t}\n\n\tif (!expireAfterSeconds) {\n\t\treturn;\n\t}\n\n\tconst model = Apps._logModel;\n\n\tmodel.resetTTLIndex(expireAfterSeconds);\n});\n\nMeteor.startup(function _appServerOrchestrator() {\n\tApps.initialize();\n\n\tif (Apps.isEnabled()) {\n\t\tApps.load();\n\t}\n});\n"]},"sourceType":"module","hash":"de69ccf5e14860546bf4d4e1520b85ad611cd15c"}
