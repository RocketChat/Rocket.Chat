{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/app/livechat/server/api/lib/livechat.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"app/livechat/server/api/lib/livechat.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/app/livechat/server/api/lib/livechat.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/app/livechat/server/api/lib/livechat.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/api/lib/livechat.js"}},"code":"module.export({\n  online: () => online,\n  findDepartments: () => findDepartments,\n  findGuest: () => findGuest,\n  findRoom: () => findRoom,\n  findOpenRoom: () => findOpenRoom,\n  getRoom: () => getRoom,\n  findAgent: () => findAgent,\n  normalizeHttpHeaderData: () => normalizeHttpHeaderData,\n  settings: () => settings,\n  getExtraConfigInfo: () => getExtraConfigInfo,\n  onCheckRoomParams: () => onCheckRoomParams\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 1);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 2);\nlet LivechatRooms, LivechatVisitors, LivechatDepartment;\nmodule.link(\"../../../../models/server\", {\n  LivechatRooms(v) {\n    LivechatRooms = v;\n  },\n\n  LivechatVisitors(v) {\n    LivechatVisitors = v;\n  },\n\n  LivechatDepartment(v) {\n    LivechatDepartment = v;\n  }\n\n}, 3);\nlet EmojiCustom, LivechatTrigger;\nmodule.link(\"../../../../models/server/raw\", {\n  EmojiCustom(v) {\n    EmojiCustom = v;\n  },\n\n  LivechatTrigger(v) {\n    LivechatTrigger = v;\n  }\n\n}, 4);\nlet Livechat;\nmodule.link(\"../../lib/Livechat\", {\n  Livechat(v) {\n    Livechat = v;\n  }\n\n}, 5);\nlet callbacks;\nmodule.link(\"../../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 6);\nlet normalizeAgent;\nmodule.link(\"../../lib/Helper\", {\n  normalizeAgent(v) {\n    normalizeAgent = v;\n  }\n\n}, 7);\n\nfunction online(department) {\n  let skipSettingCheck = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n  let skipFallbackCheck = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n  return Livechat.online(department, skipSettingCheck, skipFallbackCheck);\n}\n\nfunction findTriggers() {\n  return Promise.asyncApply(() => {\n    const triggers = Promise.await(LivechatTrigger.findEnabled().toArray());\n    return triggers.map(_ref => {\n      let {\n        _id,\n        actions,\n        conditions,\n        runOnce\n      } = _ref;\n      return {\n        _id,\n        actions,\n        conditions,\n        runOnce\n      };\n    });\n  });\n}\n\nfunction findDepartments(businessUnit) {\n  return LivechatDepartment.findEnabledWithAgentsAndBusinessUnit(businessUnit, {\n    _id: 1,\n    name: 1,\n    showOnRegistration: 1,\n    showOnOfflineForm: 1\n  }).fetch().map(_ref2 => {\n    let {\n      _id,\n      name,\n      showOnRegistration,\n      showOnOfflineForm\n    } = _ref2;\n    return {\n      _id,\n      name,\n      showOnRegistration,\n      showOnOfflineForm\n    };\n  });\n}\n\nfunction findGuest(token) {\n  return LivechatVisitors.getVisitorByToken(token, {\n    fields: {\n      name: 1,\n      username: 1,\n      token: 1,\n      visitorEmails: 1,\n      department: 1\n    }\n  });\n}\n\nfunction findRoom(token, rid) {\n  const fields = {\n    t: 1,\n    departmentId: 1,\n    servedBy: 1,\n    open: 1,\n    v: 1,\n    ts: 1\n  };\n\n  if (!rid) {\n    return LivechatRooms.findOneByVisitorToken(token, fields);\n  }\n\n  return LivechatRooms.findOneByIdAndVisitorToken(rid, token, fields);\n}\n\nfunction findOpenRoom(token, departmentId) {\n  const options = {\n    fields: {\n      departmentId: 1,\n      servedBy: 1,\n      open: 1,\n      callStatus: 1\n    }\n  };\n  const rooms = departmentId ? LivechatRooms.findOpenByVisitorTokenAndDepartmentId(token, departmentId, options).fetch() : LivechatRooms.findOpenByVisitorToken(token, options).fetch();\n\n  if (rooms && rooms.length > 0) {\n    return rooms[0];\n  }\n}\n\nfunction getRoom(_ref3) {\n  let {\n    guest,\n    rid,\n    roomInfo,\n    agent,\n    extraParams\n  } = _ref3;\n  const token = guest && guest.token;\n  const message = {\n    _id: Random.id(),\n    rid,\n    msg: '',\n    token,\n    ts: new Date()\n  };\n  return Livechat.getRoom(guest, message, roomInfo, agent, extraParams);\n}\n\nfunction findAgent(agentId) {\n  return normalizeAgent(agentId);\n}\n\nfunction normalizeHttpHeaderData() {\n  let headers = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  const httpHeaders = Object.assign({}, headers);\n  return {\n    httpHeaders\n  };\n}\n\nfunction settings() {\n  return Promise.asyncApply(() => {\n    let {\n      businessUnit = ''\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const initSettings = Livechat.getInitSettings();\n    const triggers = Promise.await(findTriggers());\n    const departments = findDepartments(businessUnit);\n    const sound = \"\".concat(Meteor.absoluteUrl(), \"sounds/chime.mp3\");\n    const emojis = Promise.await(EmojiCustom.find().toArray());\n    return {\n      enabled: initSettings.Livechat_enabled,\n      settings: {\n        registrationForm: initSettings.Livechat_registration_form,\n        allowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n        nameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n        emailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n        displayOfflineForm: initSettings.Livechat_display_offline_form,\n        videoCall: initSettings.Omnichannel_call_provider === 'Jitsi' && initSettings.Jitsi_Enabled === true,\n        fileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n        language: initSettings.Language,\n        transcript: initSettings.Livechat_enable_transcript,\n        historyMonitorType: initSettings.Livechat_history_monitor_type,\n        forceAcceptDataProcessingConsent: initSettings.Livechat_force_accept_data_processing_consent,\n        showConnecting: initSettings.Livechat_Show_Connecting,\n        agentHiddenInfo: initSettings.Livechat_show_agent_info === false,\n        clearLocalStorageWhenChatEnded: initSettings.Livechat_clear_local_storage_when_chat_ended,\n        limitTextLength: initSettings.Livechat_enable_message_character_limit && (initSettings.Livechat_message_character_limit || initSettings.Message_MaxAllowedSize)\n      },\n      theme: {\n        title: initSettings.Livechat_title,\n        color: initSettings.Livechat_title_color,\n        offlineTitle: initSettings.Livechat_offline_title,\n        offlineColor: initSettings.Livechat_offline_title_color,\n        actionLinks: {\n          webrtc: [{\n            actionLinksAlignment: 'flex-start',\n            i18nLabel: 'Join_call',\n            label: TAPi18n.__('Join_call'),\n            method_id: 'joinLivechatWebRTCCall'\n          }, {\n            i18nLabel: 'End_call',\n            label: TAPi18n.__('End_call'),\n            method_id: 'endLivechatWebRTCCall',\n            danger: true\n          }],\n          jitsi: [{\n            icon: 'icon-videocam',\n            i18nLabel: 'Accept',\n            method_id: 'createLivechatCall'\n          }, {\n            icon: 'icon-cancel',\n            i18nLabel: 'Decline',\n            method_id: 'denyLivechatCall'\n          }]\n        }\n      },\n      messages: {\n        offlineMessage: initSettings.Livechat_offline_message,\n        offlineSuccessMessage: initSettings.Livechat_offline_success_message,\n        offlineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n        conversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n        conversationFinishedText: initSettings.Livechat_conversation_finished_text,\n        transcriptMessage: initSettings.Livechat_transcript_message,\n        registrationFormMessage: initSettings.Livechat_registration_form_message,\n        dataProcessingConsentText: initSettings.Livechat_data_processing_consent_text\n      },\n      survey: {\n        items: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n        values: ['1', '2', '3', '4', '5']\n      },\n      triggers,\n      departments,\n      resources: {\n        sound,\n        emojis\n      }\n    };\n  });\n}\n\nfunction getExtraConfigInfo(room) {\n  return Promise.asyncApply(() => {\n    return callbacks.run('livechat.onLoadConfigApi', {\n      room\n    });\n  });\n}\n\nfunction onCheckRoomParams(params) {\n  return callbacks.run('livechat.onCheckRoomApiParams', params);\n}","map":{"version":3,"sources":["app/livechat/server/api/lib/livechat.js"],"names":["module","export","online","findDepartments","findGuest","findRoom","findOpenRoom","getRoom","findAgent","normalizeHttpHeaderData","settings","getExtraConfigInfo","onCheckRoomParams","Meteor","link","v","Random","TAPi18n","LivechatRooms","LivechatVisitors","LivechatDepartment","EmojiCustom","LivechatTrigger","Livechat","callbacks","normalizeAgent","department","skipSettingCheck","skipFallbackCheck","findTriggers","triggers","findEnabled","toArray","map","_id","actions","conditions","runOnce","businessUnit","findEnabledWithAgentsAndBusinessUnit","name","showOnRegistration","showOnOfflineForm","fetch","token","getVisitorByToken","fields","username","visitorEmails","rid","t","departmentId","servedBy","open","ts","findOneByVisitorToken","findOneByIdAndVisitorToken","options","callStatus","rooms","findOpenByVisitorTokenAndDepartmentId","findOpenByVisitorToken","length","guest","roomInfo","agent","extraParams","message","id","msg","Date","agentId","headers","httpHeaders","Object","assign","initSettings","getInitSettings","departments","sound","absoluteUrl","emojis","find","enabled","Livechat_enabled","registrationForm","Livechat_registration_form","allowSwitchingDepartments","Livechat_allow_switching_departments","nameFieldRegistrationForm","Livechat_name_field_registration_form","emailFieldRegistrationForm","Livechat_email_field_registration_form","displayOfflineForm","Livechat_display_offline_form","videoCall","Omnichannel_call_provider","Jitsi_Enabled","fileUpload","Livechat_fileupload_enabled","FileUpload_Enabled","language","Language","transcript","Livechat_enable_transcript","historyMonitorType","Livechat_history_monitor_type","forceAcceptDataProcessingConsent","Livechat_force_accept_data_processing_consent","showConnecting","Livechat_Show_Connecting","agentHiddenInfo","Livechat_show_agent_info","clearLocalStorageWhenChatEnded","Livechat_clear_local_storage_when_chat_ended","limitTextLength","Livechat_enable_message_character_limit","Livechat_message_character_limit","Message_MaxAllowedSize","theme","title","Livechat_title","color","Livechat_title_color","offlineTitle","Livechat_offline_title","offlineColor","Livechat_offline_title_color","actionLinks","webrtc","actionLinksAlignment","i18nLabel","label","__","method_id","danger","jitsi","icon","messages","offlineMessage","Livechat_offline_message","offlineSuccessMessage","Livechat_offline_success_message","offlineUnavailableMessage","Livechat_offline_form_unavailable","conversationFinishedMessage","Livechat_conversation_finished_message","conversationFinishedText","Livechat_conversation_finished_text","transcriptMessage","Livechat_transcript_message","registrationFormMessage","Livechat_registration_form_message","dataProcessingConsentText","Livechat_data_processing_consent_text","survey","items","values","resources","room","run","params"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Random } from 'meteor/random';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { LivechatRooms, LivechatVisitors, LivechatDepartment } from '../../../../models/server';\nimport { EmojiCustom, LivechatTrigger } from '../../../../models/server/raw';\nimport { Livechat } from '../../lib/Livechat';\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { normalizeAgent } from '../../lib/Helper';\n\nexport function online(department, skipSettingCheck = false, skipFallbackCheck = false) {\n\treturn Livechat.online(department, skipSettingCheck, skipFallbackCheck);\n}\n\nasync function findTriggers() {\n\tconst triggers = await LivechatTrigger.findEnabled().toArray();\n\treturn triggers.map(({ _id, actions, conditions, runOnce }) => ({\n\t\t_id,\n\t\tactions,\n\t\tconditions,\n\t\trunOnce,\n\t}));\n}\n\nexport function findDepartments(businessUnit) {\n\treturn LivechatDepartment.findEnabledWithAgentsAndBusinessUnit(businessUnit, {\n\t\t_id: 1,\n\t\tname: 1,\n\t\tshowOnRegistration: 1,\n\t\tshowOnOfflineForm: 1,\n\t})\n\t\t.fetch()\n\t\t.map(({ _id, name, showOnRegistration, showOnOfflineForm }) => ({\n\t\t\t_id,\n\t\t\tname,\n\t\t\tshowOnRegistration,\n\t\t\tshowOnOfflineForm,\n\t\t}));\n}\n\nexport function findGuest(token) {\n\treturn LivechatVisitors.getVisitorByToken(token, {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\ttoken: 1,\n\t\t\tvisitorEmails: 1,\n\t\t\tdepartment: 1,\n\t\t},\n\t});\n}\n\nexport function findRoom(token, rid) {\n\tconst fields = {\n\t\tt: 1,\n\t\tdepartmentId: 1,\n\t\tservedBy: 1,\n\t\topen: 1,\n\t\tv: 1,\n\t\tts: 1,\n\t};\n\n\tif (!rid) {\n\t\treturn LivechatRooms.findOneByVisitorToken(token, fields);\n\t}\n\n\treturn LivechatRooms.findOneByIdAndVisitorToken(rid, token, fields);\n}\n\nexport function findOpenRoom(token, departmentId) {\n\tconst options = {\n\t\tfields: {\n\t\t\tdepartmentId: 1,\n\t\t\tservedBy: 1,\n\t\t\topen: 1,\n\t\t\tcallStatus: 1,\n\t\t},\n\t};\n\n\tconst rooms = departmentId\n\t\t? LivechatRooms.findOpenByVisitorTokenAndDepartmentId(token, departmentId, options).fetch()\n\t\t: LivechatRooms.findOpenByVisitorToken(token, options).fetch();\n\tif (rooms && rooms.length > 0) {\n\t\treturn rooms[0];\n\t}\n}\n\nexport function getRoom({ guest, rid, roomInfo, agent, extraParams }) {\n\tconst token = guest && guest.token;\n\n\tconst message = {\n\t\t_id: Random.id(),\n\t\trid,\n\t\tmsg: '',\n\t\ttoken,\n\t\tts: new Date(),\n\t};\n\n\treturn Livechat.getRoom(guest, message, roomInfo, agent, extraParams);\n}\n\nexport function findAgent(agentId) {\n\treturn normalizeAgent(agentId);\n}\n\nexport function normalizeHttpHeaderData(headers = {}) {\n\tconst httpHeaders = Object.assign({}, headers);\n\treturn { httpHeaders };\n}\nexport async function settings({ businessUnit = '' } = {}) {\n\tconst initSettings = Livechat.getInitSettings();\n\tconst triggers = await findTriggers();\n\tconst departments = findDepartments(businessUnit);\n\tconst sound = `${Meteor.absoluteUrl()}sounds/chime.mp3`;\n\tconst emojis = await EmojiCustom.find().toArray();\n\treturn {\n\t\tenabled: initSettings.Livechat_enabled,\n\t\tsettings: {\n\t\t\tregistrationForm: initSettings.Livechat_registration_form,\n\t\t\tallowSwitchingDepartments: initSettings.Livechat_allow_switching_departments,\n\t\t\tnameFieldRegistrationForm: initSettings.Livechat_name_field_registration_form,\n\t\t\temailFieldRegistrationForm: initSettings.Livechat_email_field_registration_form,\n\t\t\tdisplayOfflineForm: initSettings.Livechat_display_offline_form,\n\t\t\tvideoCall: initSettings.Omnichannel_call_provider === 'Jitsi' && initSettings.Jitsi_Enabled === true,\n\t\t\tfileUpload: initSettings.Livechat_fileupload_enabled && initSettings.FileUpload_Enabled,\n\t\t\tlanguage: initSettings.Language,\n\t\t\ttranscript: initSettings.Livechat_enable_transcript,\n\t\t\thistoryMonitorType: initSettings.Livechat_history_monitor_type,\n\t\t\tforceAcceptDataProcessingConsent: initSettings.Livechat_force_accept_data_processing_consent,\n\t\t\tshowConnecting: initSettings.Livechat_Show_Connecting,\n\t\t\tagentHiddenInfo: initSettings.Livechat_show_agent_info === false,\n\t\t\tclearLocalStorageWhenChatEnded: initSettings.Livechat_clear_local_storage_when_chat_ended,\n\t\t\tlimitTextLength:\n\t\t\t\tinitSettings.Livechat_enable_message_character_limit &&\n\t\t\t\t(initSettings.Livechat_message_character_limit || initSettings.Message_MaxAllowedSize),\n\t\t},\n\t\ttheme: {\n\t\t\ttitle: initSettings.Livechat_title,\n\t\t\tcolor: initSettings.Livechat_title_color,\n\t\t\tofflineTitle: initSettings.Livechat_offline_title,\n\t\t\tofflineColor: initSettings.Livechat_offline_title_color,\n\t\t\tactionLinks: {\n\t\t\t\twebrtc: [\n\t\t\t\t\t{\n\t\t\t\t\t\tactionLinksAlignment: 'flex-start',\n\t\t\t\t\t\ti18nLabel: 'Join_call',\n\t\t\t\t\t\tlabel: TAPi18n.__('Join_call'),\n\t\t\t\t\t\tmethod_id: 'joinLivechatWebRTCCall',\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ti18nLabel: 'End_call',\n\t\t\t\t\t\tlabel: TAPi18n.__('End_call'),\n\t\t\t\t\t\tmethod_id: 'endLivechatWebRTCCall',\n\t\t\t\t\t\tdanger: true,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tjitsi: [\n\t\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall' },\n\t\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall' },\n\t\t\t\t],\n\t\t\t},\n\t\t},\n\t\tmessages: {\n\t\t\tofflineMessage: initSettings.Livechat_offline_message,\n\t\t\tofflineSuccessMessage: initSettings.Livechat_offline_success_message,\n\t\t\tofflineUnavailableMessage: initSettings.Livechat_offline_form_unavailable,\n\t\t\tconversationFinishedMessage: initSettings.Livechat_conversation_finished_message,\n\t\t\tconversationFinishedText: initSettings.Livechat_conversation_finished_text,\n\t\t\ttranscriptMessage: initSettings.Livechat_transcript_message,\n\t\t\tregistrationFormMessage: initSettings.Livechat_registration_form_message,\n\t\t\tdataProcessingConsentText: initSettings.Livechat_data_processing_consent_text,\n\t\t},\n\t\tsurvey: {\n\t\t\titems: ['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'],\n\t\t\tvalues: ['1', '2', '3', '4', '5'],\n\t\t},\n\t\ttriggers,\n\t\tdepartments,\n\t\tresources: {\n\t\t\tsound,\n\t\t\temojis,\n\t\t},\n\t};\n}\n\nexport async function getExtraConfigInfo(room) {\n\treturn callbacks.run('livechat.onLoadConfigApi', { room });\n}\n\nexport function onCheckRoomParams(params) {\n\treturn callbacks.run('livechat.onCheckRoomApiParams', params);\n}\n"]},"sourceType":"module","hash":"773a231876c0eb7aed15642ed1f021a584d56cc3"}
