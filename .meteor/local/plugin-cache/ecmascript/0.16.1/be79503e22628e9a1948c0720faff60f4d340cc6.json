{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/server/routes/avatar/utils.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"server/routes/avatar/utils.js","filename":"/home/weslley/Documents/projects/Rocket.Chat/server/routes/avatar/utils.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/server/routes/avatar/utils.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/routes/avatar/utils.js"}},"code":"module.export({\n  serveAvatar: () => serveAvatar,\n  wasFallbackModified: () => wasFallbackModified,\n  userCanAccessAvatar: () => userCanAccessAvatar,\n  renderSVGLetters: () => renderSVGLetters,\n  setCacheAndDispositionHeaders: () => setCacheAndDispositionHeaders\n});\nlet sharp;\nmodule.link(\"sharp\", {\n  default(v) {\n    sharp = v;\n  }\n\n}, 0);\nlet throttle;\nmodule.link(\"underscore\", {\n  throttle(v) {\n    throttle = v;\n  }\n\n}, 1);\nlet Cookies;\nmodule.link(\"meteor/ostrio:cookies\", {\n  Cookies(v) {\n    Cookies = v;\n  }\n\n}, 2);\nlet Users;\nmodule.link(\"../../../app/models/server\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 3);\nlet getAvatarColor;\nmodule.link(\"../../../app/utils\", {\n  getAvatarColor(v) {\n    getAvatarColor = v;\n  }\n\n}, 4);\nlet settings;\nmodule.link(\"../../../app/settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 5);\nconst FALLBACK_LAST_MODIFIED = 'Thu, 01 Jan 2015 00:00:00 GMT';\nconst cookie = new Cookies();\n\nconst serveAvatar = (avatar, format, res) => {\n  res.setHeader('Last-Modified', FALLBACK_LAST_MODIFIED);\n\n  if (['png', 'jpg', 'jpeg'].includes(format)) {\n    res.setHeader('Content-Type', \"image/\".concat(format));\n    sharp(Buffer.from(avatar)).toFormat(format).pipe(res);\n    return;\n  }\n\n  res.setHeader('Content-Type', 'image/svg+xml');\n  res.write(avatar);\n  res.end();\n};\n\nconst wasFallbackModified = reqModifiedHeader => {\n  if (!reqModifiedHeader || reqModifiedHeader !== FALLBACK_LAST_MODIFIED) {\n    return true;\n  }\n\n  return false;\n};\n\nfunction isUserAuthenticated(_ref) {\n  let {\n    headers,\n    query\n  } = _ref;\n  let {\n    rc_uid,\n    rc_token\n  } = query;\n\n  if (!rc_uid && headers.cookie) {\n    rc_uid = cookie.get('rc_uid', headers.cookie);\n    rc_token = cookie.get('rc_token', headers.cookie);\n  }\n\n  if (rc_uid == null || rc_token == null) {\n    return false;\n  }\n\n  const userFound = Users.findOneByIdAndLoginToken(rc_uid, rc_token, {\n    fields: {\n      _id: 1\n    }\n  }); // TODO memoize find\n\n  return !!userFound;\n}\n\nconst warnUnauthenticatedAccess = throttle(() => {\n  console.warn('The server detected an unauthenticated access to an user avatar. This type of request will soon be blocked by default.');\n}, 60000 * 30); // 30 minutes\n\nfunction userCanAccessAvatar(_ref2) {\n  let {\n    headers = {},\n    query = {}\n  } = _ref2;\n\n  if (!settings.get('Accounts_AvatarBlockUnauthenticatedAccess')) {\n    return true;\n  }\n\n  const isAuthenticated = isUserAuthenticated({\n    headers,\n    query\n  });\n\n  if (!isAuthenticated) {\n    warnUnauthenticatedAccess();\n  }\n\n  return isAuthenticated;\n}\n\nconst getFirstLetter = name => name.replace(/[^A-Za-z0-9]/g, '').substr(0, 1).toUpperCase();\n\nconst renderSVGLetters = function (username) {\n  let viewSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 200;\n  let color = '';\n  let initials = '';\n\n  if (username === '?') {\n    color = '#000';\n    initials = username;\n  } else {\n    color = getAvatarColor(username);\n    initials = getFirstLetter(username);\n  }\n\n  const fontSize = viewSize / 1.6;\n  return \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 \".concat(viewSize, \" \").concat(viewSize, \"\\\">\\n<rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"\").concat(color, \"\\\"/>\\n<text x=\\\"50%\\\" y=\\\"50%\\\" dy=\\\"0.36em\\\" text-anchor=\\\"middle\\\" pointer-events=\\\"none\\\" fill=\\\"#ffffff\\\" font-family=\\\"'Helvetica', 'Arial', 'Lucida Grande', 'sans-serif'\\\" font-size=\\\"\").concat(fontSize, \"\\\">\\n\").concat(initials, \"\\n</text>\\n</svg>\");\n};\n\nconst getCacheTime = cacheTime => cacheTime || settings.get('Accounts_AvatarCacheTime');\n\nfunction setCacheAndDispositionHeaders(req, res) {\n  const cacheTime = getCacheTime(req.query.cacheTime);\n  res.setHeader('Cache-Control', \"public, max-age=\".concat(cacheTime));\n  res.setHeader('Content-Disposition', 'inline');\n}","map":{"version":3,"sources":["server/routes/avatar/utils.js"],"names":["module","export","serveAvatar","wasFallbackModified","userCanAccessAvatar","renderSVGLetters","setCacheAndDispositionHeaders","sharp","link","default","v","throttle","Cookies","Users","getAvatarColor","settings","FALLBACK_LAST_MODIFIED","cookie","avatar","format","res","setHeader","includes","Buffer","from","toFormat","pipe","write","end","reqModifiedHeader","isUserAuthenticated","headers","query","rc_uid","rc_token","get","userFound","findOneByIdAndLoginToken","fields","_id","warnUnauthenticatedAccess","console","warn","isAuthenticated","getFirstLetter","name","replace","substr","toUpperCase","username","viewSize","color","initials","fontSize","getCacheTime","cacheTime","req"],"mappings":"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","sourcesContent":["import sharp from 'sharp';\nimport { throttle } from 'underscore';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nimport { Users } from '../../../app/models/server';\nimport { getAvatarColor } from '../../../app/utils';\nimport { settings } from '../../../app/settings/server';\n\nconst FALLBACK_LAST_MODIFIED = 'Thu, 01 Jan 2015 00:00:00 GMT';\n\nconst cookie = new Cookies();\n\nexport const serveAvatar = (avatar, format, res) => {\n\tres.setHeader('Last-Modified', FALLBACK_LAST_MODIFIED);\n\n\tif (['png', 'jpg', 'jpeg'].includes(format)) {\n\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\tsharp(Buffer.from(avatar)).toFormat(format).pipe(res);\n\t\treturn;\n\t}\n\tres.setHeader('Content-Type', 'image/svg+xml');\n\n\tres.write(avatar);\n\tres.end();\n};\n\nexport const wasFallbackModified = (reqModifiedHeader) => {\n\tif (!reqModifiedHeader || reqModifiedHeader !== FALLBACK_LAST_MODIFIED) {\n\t\treturn true;\n\t}\n\treturn false;\n};\n\nfunction isUserAuthenticated({ headers, query }) {\n\tlet { rc_uid, rc_token } = query;\n\n\tif (!rc_uid && headers.cookie) {\n\t\trc_uid = cookie.get('rc_uid', headers.cookie);\n\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t}\n\n\tif (rc_uid == null || rc_token == null) {\n\t\treturn false;\n\t}\n\n\tconst userFound = Users.findOneByIdAndLoginToken(rc_uid, rc_token, { fields: { _id: 1 } }); // TODO memoize find\n\n\treturn !!userFound;\n}\n\nconst warnUnauthenticatedAccess = throttle(() => {\n\tconsole.warn('The server detected an unauthenticated access to an user avatar. This type of request will soon be blocked by default.');\n}, 60000 * 30); // 30 minutes\n\nexport function userCanAccessAvatar({ headers = {}, query = {} }) {\n\tif (!settings.get('Accounts_AvatarBlockUnauthenticatedAccess')) {\n\t\treturn true;\n\t}\n\n\tconst isAuthenticated = isUserAuthenticated({ headers, query });\n\tif (!isAuthenticated) {\n\t\twarnUnauthenticatedAccess();\n\t}\n\n\treturn isAuthenticated;\n}\n\nconst getFirstLetter = (name) =>\n\tname\n\t\t.replace(/[^A-Za-z0-9]/g, '')\n\t\t.substr(0, 1)\n\t\t.toUpperCase();\n\nexport const renderSVGLetters = (username, viewSize = 200) => {\n\tlet color = '';\n\tlet initials = '';\n\n\tif (username === '?') {\n\t\tcolor = '#000';\n\t\tinitials = username;\n\t} else {\n\t\tcolor = getAvatarColor(username);\n\t\tinitials = getFirstLetter(username);\n\t}\n\n\tconst fontSize = viewSize / 1.6;\n\n\treturn `<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 ${viewSize} ${viewSize}\\\">\\n<rect width=\\\"100%\\\" height=\\\"100%\\\" fill=\\\"${color}\\\"/>\\n<text x=\\\"50%\\\" y=\\\"50%\\\" dy=\\\"0.36em\\\" text-anchor=\\\"middle\\\" pointer-events=\\\"none\\\" fill=\\\"#ffffff\\\" font-family=\\\"'Helvetica', 'Arial', 'Lucida Grande', 'sans-serif'\\\" font-size=\"${fontSize}\">\\n${initials}\\n</text>\\n</svg>`;\n};\n\nconst getCacheTime = (cacheTime) => cacheTime || settings.get('Accounts_AvatarCacheTime');\n\nexport function setCacheAndDispositionHeaders(req, res) {\n\tconst cacheTime = getCacheTime(req.query.cacheTime);\n\tres.setHeader('Cache-Control', `public, max-age=${cacheTime}`);\n\tres.setHeader('Content-Disposition', 'inline');\n}\n"]},"sourceType":"module","hash":"be79503e22628e9a1948c0720faff60f4d340cc6"}
