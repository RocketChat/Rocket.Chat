{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/weslley/Documents/projects/Rocket.Chat/server/startup/migrations/v238.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"server/startup/migrations/v238.ts","filename":"/home/weslley/Documents/projects/Rocket.Chat/server/startup/migrations/v238.ts","inputSourceMap":{"version":3,"file":"server/startup/migrations/v238.ts","sourceRoot":"","sources":["server/startup/migrations/v238.ts"],"names":[],"mappings":"AAAA,OAAO,MAAM,MAAM,SAAS,CAAC;AAG7B,OAAO,EAAE,YAAY,EAAE,MAAM,sBAAsB,CAAC;AACpD,OAAO,EAAE,IAAI,EAAE,MAAM,0BAA0B,CAAC;AAEhD,SAAS,oBAAoB,CAAC,GAAQ;IACrC,MAAM,SAAS,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IAC5C,OAAO,SAAS,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;AACvD,CAAC;AAED,SAAS,eAAe,CAAC,GAAQ;IAChC,MAAM,GAAG,GAAG,IAAI,MAAM,EAAE,CAAC;IAEzB,MAAM,WAAW,GAAa,EAAE,CAAC;IAEjC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,EAAE,KAAK,CAAC,EAAE,EAAE;QACrD,MAAM,cAAc,GAAG,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;QAC/E,WAAW,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QACjC,GAAG,CAAC,OAAO,CAAC,cAAc,EAAE,MAAM,CAAC,IAAI,CAAC,KAAe,EAAE,MAAM,CAAC,CAAC,CAAC;IACnE,CAAC,CAAC,CAAC;IAEH,MAAM,SAAS,GAAG,IAAI,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC,CAAC;IAE7D,SAAS,CAAC,UAAU,EAAE,CAAC,OAAO,CAAC,CAAC,KAAU,EAAE,EAAE;QAC7C,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,SAAS,CAAC,EAAE;YAC3C,GAAG,CAAC,OAAO,CAAC,KAAK,CAAC,SAAS,EAAE,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;SAC9C;IACF,CAAC,CAAC,CAAC;IAEH,OAAO,GAAG,CAAC,QAAQ,EAAE,CAAC;AACvB,CAAC;AAED,YAAY,CAAC;IACZ,OAAO,EAAE,GAAG;IACZ,EAAE;QACD,IAAI,CAAC,UAAU,EAAE,CAAC;QAElB,MAAM,IAAI,GAAG,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,CAAC,KAAK,EAAE,CAAC;QAEzC,KAAK,MAAM,GAAG,IAAI,IAAI,EAAE;YACvB,MAAM,OAAO,GAAG,oBAAoB,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;YAClG,OAAO,CAAC,KAAK,CAAE,IAAI,CAAC,QAAuB,CAAC,MAAM,CAAC,OAAO,EAAE,GAAG,CAAC,kBAAkB,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC;YACzG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,GAAG,CAAC,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,GAAG,EAAE,CAAC,EAAE,QAAQ,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;SACxF;IACF,CAAC;CACD,CAAC,CAAC","sourcesContent":["import AdmZip from 'adm-zip';\nimport { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\n\nimport { addMigration } from '../../lib/migrations';\nimport { Apps } from '../../../app/apps/server';\n\nfunction isPreCompilerRemoval(app: any): boolean {\n\tconst fileNames = Object.keys(app.compiled);\n\treturn fileNames.some((file) => file.endsWith('$ts'));\n}\n\nfunction repackageAppZip(app: any): Buffer {\n\tconst zip = new AdmZip();\n\n\tconst sourceFiles: string[] = [];\n\n\tObject.entries(app.compiled).forEach(([key, value]) => {\n\t\tconst actualFileName = key.endsWith('$ts') ? key.replace(/\\$ts$/, '.js') : key;\n\t\tsourceFiles.push(actualFileName);\n\t\tzip.addFile(actualFileName, Buffer.from(value as string, 'utf8'));\n\t});\n\n\tconst zipToRead = new AdmZip(Buffer.from(app.zip, 'base64'));\n\n\tzipToRead.getEntries().forEach((entry: any) => {\n\t\tif (!sourceFiles.includes(entry.entryName)) {\n\t\t\tzip.addFile(entry.entryName, entry.getData());\n\t\t}\n\t});\n\n\treturn zip.toBuffer();\n}\n\naddMigration({\n\tversion: 238,\n\tup() {\n\t\tApps.initialize();\n\n\t\tconst apps = Apps._model?.find().fetch();\n\n\t\tfor (const app of apps) {\n\t\t\tconst zipFile = isPreCompilerRemoval(app) ? repackageAppZip(app) : Buffer.from(app.zip, 'base64');\n\t\t\tPromise.await((Apps._manager as AppManager).update(zipFile, app.permissionsGranted, { loadApp: false }));\n\t\t\tPromise.await(Apps._model?.update({ id: app.id }, { $unset: { zip: 1, compiled: 1 } }));\n\t\t}\n\t},\n});\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/weslley/Documents/projects/Rocket.Chat","root":"/home/weslley/Documents/projects/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/weslley/Documents/projects/Rocket.Chat/server/startup/migrations/v238.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/startup/migrations/v238.ts"}},"code":"let AdmZip;\nmodule.link(\"adm-zip\", {\n  default(v) {\n    AdmZip = v;\n  }\n\n}, 0);\nlet addMigration;\nmodule.link(\"../../lib/migrations\", {\n  addMigration(v) {\n    addMigration = v;\n  }\n\n}, 1);\nlet Apps;\nmodule.link(\"../../../app/apps/server\", {\n  Apps(v) {\n    Apps = v;\n  }\n\n}, 2);\n\nfunction isPreCompilerRemoval(app) {\n  const fileNames = Object.keys(app.compiled);\n  return fileNames.some(file => file.endsWith('$ts'));\n}\n\nfunction repackageAppZip(app) {\n  const zip = new AdmZip();\n  const sourceFiles = [];\n  Object.entries(app.compiled).forEach(_ref => {\n    let [key, value] = _ref;\n    const actualFileName = key.endsWith('$ts') ? key.replace(/\\$ts$/, '.js') : key;\n    sourceFiles.push(actualFileName);\n    zip.addFile(actualFileName, Buffer.from(value, 'utf8'));\n  });\n  const zipToRead = new AdmZip(Buffer.from(app.zip, 'base64'));\n  zipToRead.getEntries().forEach(entry => {\n    if (!sourceFiles.includes(entry.entryName)) {\n      zip.addFile(entry.entryName, entry.getData());\n    }\n  });\n  return zip.toBuffer();\n}\n\naddMigration({\n  version: 238,\n\n  up() {\n    var _Apps$_model;\n\n    Apps.initialize();\n    const apps = (_Apps$_model = Apps._model) === null || _Apps$_model === void 0 ? void 0 : _Apps$_model.find().fetch();\n\n    for (const app of apps) {\n      var _Apps$_model2;\n\n      const zipFile = isPreCompilerRemoval(app) ? repackageAppZip(app) : Buffer.from(app.zip, 'base64');\n      Promise.await(Apps._manager.update(zipFile, app.permissionsGranted, {\n        loadApp: false\n      }));\n      Promise.await((_Apps$_model2 = Apps._model) === null || _Apps$_model2 === void 0 ? void 0 : _Apps$_model2.update({\n        id: app.id\n      }, {\n        $unset: {\n          zip: 1,\n          compiled: 1\n        }\n      }));\n    }\n  }\n\n});","map":{"version":3,"sources":["server/startup/migrations/v238.ts"],"names":[],"mappings":"AAAA,IAAA,MAAA;AAAO,MAAM,CAAA,IAAN,CAAY,SAAZ,EAAsB;AAAA,EAAA,OAAA,CAAA,CAAA,EAAA;AAAA,IAAA,MAAA,GAAA,CAAA;AAAA;;AAAA,CAAtB,EAAsB,CAAtB;AAAsB,IAAA,YAAA;AAAA,MAAA,CAAA,IAAA,CAAA,sBAAA,EAAA;AAAA,EAAA,YAAA,CAAA,CAAA,EAAA;AAAA,IAAA,YAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,IAAA;AAAA,MAAA,CAAA,IAAA,CAAA,0BAAA,EAAA;AAAA,EAAA,IAAA,CAAA,CAAA,EAAA;AAAA,IAAA,IAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;;AAM7B,SAAS,oBAAT,CAA8B,GAA9B,EAAsC;AACrC,QAAM,SAAS,GAAG,MAAM,CAAC,IAAP,CAAY,GAAG,CAAC,QAAhB,CAAlB;AACA,SAAO,SAAS,CAAC,IAAV,CAAgB,IAAD,IAAU,IAAI,CAAC,QAAL,CAAc,KAAd,CAAzB,CAAP;AACA;;AAED,SAAS,eAAT,CAAyB,GAAzB,EAAiC;AAChC,QAAM,GAAG,GAAG,IAAI,MAAJ,EAAZ;AAEA,QAAM,WAAW,GAAa,EAA9B;AAEA,EAAA,MAAM,CAAC,OAAP,CAAe,GAAG,CAAC,QAAnB,EAA6B,OAA7B,CAAqC,QAAiB;AAAA,QAAhB,CAAC,GAAD,EAAM,KAAN,CAAgB;AACrD,UAAM,cAAc,GAAG,GAAG,CAAC,QAAJ,CAAa,KAAb,IAAsB,GAAG,CAAC,OAAJ,CAAY,OAAZ,EAAqB,KAArB,CAAtB,GAAoD,GAA3E;AACA,IAAA,WAAW,CAAC,IAAZ,CAAiB,cAAjB;AACA,IAAA,GAAG,CAAC,OAAJ,CAAY,cAAZ,EAA4B,MAAM,CAAC,IAAP,CAAY,KAAZ,EAA6B,MAA7B,CAA5B;AACA,GAJD;AAMA,QAAM,SAAS,GAAG,IAAI,MAAJ,CAAW,MAAM,CAAC,IAAP,CAAY,GAAG,CAAC,GAAhB,EAAqB,QAArB,CAAX,CAAlB;AAEA,EAAA,SAAS,CAAC,UAAV,GAAuB,OAAvB,CAAgC,KAAD,IAAe;AAC7C,QAAI,CAAC,WAAW,CAAC,QAAZ,CAAqB,KAAK,CAAC,SAA3B,CAAL,EAA4C;AAC3C,MAAA,GAAG,CAAC,OAAJ,CAAY,KAAK,CAAC,SAAlB,EAA6B,KAAK,CAAC,OAAN,EAA7B;AACA;AACD,GAJD;AAMA,SAAO,GAAG,CAAC,QAAJ,EAAP;AACA;;AAED,YAAY,CAAC;AACZ,EAAA,OAAO,EAAE,GADG;;AAEZ,EAAA,EAAE,GAAA;AAAA;;AACD,IAAA,IAAI,CAAC,UAAL;AAEA,UAAM,IAAI,mBAAG,IAAI,CAAC,MAAR,iDAAG,aAAa,IAAb,GAAoB,KAApB,EAAb;;AAEA,SAAK,MAAM,GAAX,IAAkB,IAAlB,EAAwB;AAAA;;AACvB,YAAM,OAAO,GAAG,oBAAoB,CAAC,GAAD,CAApB,GAA4B,eAAe,CAAC,GAAD,CAA3C,GAAmD,MAAM,CAAC,IAAP,CAAY,GAAG,CAAC,GAAhB,EAAqB,QAArB,CAAnE;AACA,MAAA,OAAO,CAAC,KAAR,CAAe,IAAI,CAAC,QAAL,CAA6B,MAA7B,CAAoC,OAApC,EAA6C,GAAG,CAAC,kBAAjD,EAAqE;AAAE,QAAA,OAAO,EAAE;AAAX,OAArE,CAAf;AACA,MAAA,OAAO,CAAC,KAAR,kBAAc,IAAI,CAAC,MAAnB,kDAAc,cAAa,MAAb,CAAoB;AAAE,QAAA,EAAE,EAAE,GAAG,CAAC;AAAV,OAApB,EAAoC;AAAE,QAAA,MAAM,EAAE;AAAE,UAAA,GAAG,EAAE,CAAP;AAAU,UAAA,QAAQ,EAAE;AAApB;AAAV,OAApC,CAAd;AACA;AACD;;AAZW,CAAD,CAAZ","sourcesContent":["import AdmZip from 'adm-zip';\nimport { AppManager } from '@rocket.chat/apps-engine/server/AppManager';\n\nimport { addMigration } from '../../lib/migrations';\nimport { Apps } from '../../../app/apps/server';\n\nfunction isPreCompilerRemoval(app: any): boolean {\n\tconst fileNames = Object.keys(app.compiled);\n\treturn fileNames.some((file) => file.endsWith('$ts'));\n}\n\nfunction repackageAppZip(app: any): Buffer {\n\tconst zip = new AdmZip();\n\n\tconst sourceFiles: string[] = [];\n\n\tObject.entries(app.compiled).forEach(([key, value]) => {\n\t\tconst actualFileName = key.endsWith('$ts') ? key.replace(/\\$ts$/, '.js') : key;\n\t\tsourceFiles.push(actualFileName);\n\t\tzip.addFile(actualFileName, Buffer.from(value as string, 'utf8'));\n\t});\n\n\tconst zipToRead = new AdmZip(Buffer.from(app.zip, 'base64'));\n\n\tzipToRead.getEntries().forEach((entry: any) => {\n\t\tif (!sourceFiles.includes(entry.entryName)) {\n\t\t\tzip.addFile(entry.entryName, entry.getData());\n\t\t}\n\t});\n\n\treturn zip.toBuffer();\n}\n\naddMigration({\n\tversion: 238,\n\tup() {\n\t\tApps.initialize();\n\n\t\tconst apps = Apps._model?.find().fetch();\n\n\t\tfor (const app of apps) {\n\t\t\tconst zipFile = isPreCompilerRemoval(app) ? repackageAppZip(app) : Buffer.from(app.zip, 'base64');\n\t\t\tPromise.await((Apps._manager as AppManager).update(zipFile, app.permissionsGranted, { loadApp: false }));\n\t\t\tPromise.await(Apps._model?.update({ id: app.id }, { $unset: { zip: 1, compiled: 1 } }));\n\t\t}\n\t},\n});\n"],"sourceRoot":""},"sourceType":"module","hash":"63745594e0f1e7721e28ffe5571cd776f39223e3"}
