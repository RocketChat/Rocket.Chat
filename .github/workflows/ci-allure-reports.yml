name: Generate Allure Reports

on:
  workflow_dispatch:
    inputs:
      publish-to-pages:
        description: 'Publish report to GitHub Pages'
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      publish-to-pages:
        required: false
        type: boolean
        default: false
        description: 'Whether to publish report to GitHub Pages'
      report-name:
        required: false
        type: string
        default: 'Rocket.Chat E2E Test Report'
        description: 'Name for the Allure report'

jobs:
  generate-allure-report:
    name: üìä Generate Allure Report
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Allure Commandline
        run: |
          # Download and install Allure commandline tool
          wget https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
          tar -zxf allure-2.24.1.tgz
          sudo mv allure-2.24.1 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Download E2E test artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: ./downloaded-artifacts
          merge-multiple: true

      - name: Extract and combine Allure results
        run: |
          mkdir -p combined-allure-results

          # Extract Allure results from downloaded artifacts
          for artifact_dir in ./downloaded-artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              echo "Processing artifact: $artifact_dir"
              
              # Look for allure-results in the artifact
              if [ -d "$artifact_dir/apps/meteor/allure-results" ]; then
                echo "Found Allure results in $artifact_dir"
                cp -r "$artifact_dir/apps/meteor/allure-results"/* combined-allure-results/ 2>/dev/null || true
              fi
              
              # Also check for results in the root of the artifact
              if [ -d "$artifact_dir/allure-results" ]; then
                echo "Found Allure results in root of $artifact_dir"
                cp -r "$artifact_dir/allure-results"/* combined-allure-results/ 2>/dev/null || true
              fi
            fi
          done

          # Count results
          result_count=$(find combined-allure-results -name "*.json" | wc -l)
          echo "üìä Found $result_count Allure result files"

          if [ $result_count -eq 0 ]; then
            echo "‚ö†Ô∏è No Allure result files found. Creating empty report."
            echo '{"uuid":"empty","name":"No E2E tests executed","status":"skipped","start":'$(date +%s000)',"stop":'$(date +%s000)',"steps":[]}' > combined-allure-results/empty-result.json
          fi

      - name: Generate Allure Report
        run: |
          # Create report directory
          mkdir -p allure-report

          # Generate Allure report from combined results
          allure generate combined-allure-results --clean -o allure-report

          # Verify report was generated
          if [ ! -d "allure-report" ] || [ ! -f "allure-report/index.html" ]; then
            echo "‚ùå Failed to generate Allure report"
            exit 1
          fi

          echo "‚úÖ Allure report generated successfully"
          ls -la allure-report/

      - name: Upload Allure Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-e2e-report-${{ github.run_number }}
          path: allure-report/
          retention-days: 30

      - name: Publish to GitHub Pages
        if: inputs.publish-to-pages == true || github.event.inputs.publish-to-pages == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: allure-reports/e2e/${{ github.run_number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment PR with Report Link
        if: github.event_name == 'pull_request' && (inputs.publish-to-pages == true || github.event.inputs.publish-to-pages == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const reportUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-reports/e2e/${{ github.run_number }}`;
            const reportName = '${{ inputs.report-name || "Rocket.Chat E2E Test Report" }}';

            const comment = `## üìä ${reportName}

            **Allure E2E Test Report:** [View Report](${reportUrl})

            This report contains detailed E2E test results, including:
            - Test execution summary
            - Failed test details with screenshots and traces
            - Test trends and history
            - Environment information
            - Playwright test traces for debugging

            ---
            *E2E Test Report generated for commit: \`${{ github.sha }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
