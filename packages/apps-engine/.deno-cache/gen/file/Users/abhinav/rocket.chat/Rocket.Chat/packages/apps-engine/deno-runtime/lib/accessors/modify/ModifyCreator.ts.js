import { randomBytes } from 'node:crypto';
import { BlockBuilder } from '../builders/BlockBuilder.ts';
import { MessageBuilder } from '../builders/MessageBuilder.ts';
import { DiscussionBuilder } from '../builders/DiscussionBuilder.ts';
import { LivechatMessageBuilder } from '../builders/LivechatMessageBuilder.ts';
import { RoomBuilder } from '../builders/RoomBuilder.ts';
import { UserBuilder } from '../builders/UserBuilder.ts';
import { VideoConferenceBuilder } from '../builders/VideoConferenceBuilder.ts';
import { AppObjectRegistry } from '../../../AppObjectRegistry.ts';
import { require } from '../../../lib/require.ts';
const { UIHelper } = require('@rocket.chat/apps-engine/server/misc/UIHelper.js');
const { RoomType } = require('@rocket.chat/apps-engine/definition/rooms/RoomType.js');
const { UserType } = require('@rocket.chat/apps-engine/definition/users/UserType.js');
const { RocketChatAssociationModel } = require('@rocket.chat/apps-engine/definition/metadata/RocketChatAssociations.js');
export class ModifyCreator {
  senderFn;
  constructor(senderFn){
    this.senderFn = senderFn;
  }
  getLivechatCreator() {
    return new Proxy({
      __kind: 'getLivechatCreator'
    }, {
      get: (_target, prop)=>{
        // It's not worthwhile to make an asynchronous request for such a simple method
        if (prop === 'createToken') {
          return ()=>randomBytes(16).toString('hex');
        }
        if (prop === 'toJSON') {
          return ()=>({});
        }
        return (...params)=>this.senderFn({
            method: `accessor:getModifier:getCreator:getLivechatCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          });
      }
    });
  }
  getUploadCreator() {
    return new Proxy({
      __kind: 'getUploadCreator'
    }, {
      get: (_target, prop)=>(...params)=>prop === 'toJSON' ? {} : this.senderFn({
            method: `accessor:getModifier:getCreator:getUploadCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          })
    });
  }
  getEmailCreator() {
    return new Proxy({
      __kind: 'getEmailCreator'
    }, {
      get: (_target, prop)=>(...params)=>prop === 'toJSON' ? {} : this.senderFn({
            method: `accessor:getModifier:getCreator:getEmailCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          })
    });
  }
  getContactCreator() {
    return new Proxy({
      __kind: 'getContactCreator'
    }, {
      get: (_target, prop)=>(...params)=>prop === 'toJSON' ? {} : this.senderFn({
            method: `accessor:getModifier:getCreator:getContactCreator:${prop}`,
            params
          }).then((response)=>response.result).catch((err)=>{
            throw new Error(err.error);
          })
    });
  }
  getBlockBuilder() {
    return new BlockBuilder();
  }
  startMessage(data) {
    if (data) {
      delete data.id;
    }
    return new MessageBuilder(data);
  }
  startLivechatMessage(data) {
    if (data) {
      delete data.id;
    }
    return new LivechatMessageBuilder(data);
  }
  startRoom(data) {
    if (data) {
      // @ts-ignore - this has been imported from the Apps-Engine
      delete data.id;
    }
    return new RoomBuilder(data);
  }
  startDiscussion(data) {
    if (data) {
      delete data.id;
    }
    return new DiscussionBuilder(data);
  }
  startVideoConference(data) {
    return new VideoConferenceBuilder(data);
  }
  startBotUser(data) {
    if (data) {
      delete data.id;
      const { roles } = data;
      if (roles?.length) {
        const hasRole = roles.map((role)=>role.toLocaleLowerCase()).some((role)=>role === 'admin' || role === 'owner' || role === 'moderator');
        if (hasRole) {
          throw new Error('Invalid role assigned to the user. Should not be admin, owner or moderator.');
        }
      }
      if (!data.type) {
        data.type = UserType.BOT;
      }
    }
    return new UserBuilder(data);
  }
  finish(builder) {
    switch(builder.kind){
      case RocketChatAssociationModel.MESSAGE:
        return this._finishMessage(builder);
      case RocketChatAssociationModel.LIVECHAT_MESSAGE:
        return this._finishLivechatMessage(builder);
      case RocketChatAssociationModel.ROOM:
        return this._finishRoom(builder);
      case RocketChatAssociationModel.DISCUSSION:
        return this._finishDiscussion(builder);
      case RocketChatAssociationModel.VIDEO_CONFERENCE:
        return this._finishVideoConference(builder);
      case RocketChatAssociationModel.USER:
        return this._finishUser(builder);
      default:
        throw new Error('Invalid builder passed to the ModifyCreator.finish function.');
    }
  }
  async _finishMessage(builder) {
    const result = builder.getMessage();
    delete result.id;
    if (!result.sender || !result.sender.id) {
      const response = await this.senderFn({
        method: 'bridges:getUserBridge:doGetAppUser',
        params: [
          'APP_ID'
        ]
      });
      const appUser = response.result;
      if (!appUser) {
        throw new Error('Invalid sender assigned to the message.');
      }
      result.sender = appUser;
    }
    if (result.blocks?.length) {
      // Can we move this elsewhere? This AppObjectRegistry usage doesn't really belong here, but where?
      result.blocks = UIHelper.assignIds(result.blocks, AppObjectRegistry.get('id') || '');
    }
    const response = await this.senderFn({
      method: 'bridges:getMessageBridge:doCreate',
      params: [
        result,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishLivechatMessage(builder) {
    if (builder.getSender() && !builder.getVisitor()) {
      return this._finishMessage(builder.getMessageBuilder());
    }
    const result = builder.getMessage();
    delete result.id;
    if (!result.token && (!result.visitor || !result.visitor.token)) {
      throw new Error('Invalid visitor sending the message');
    }
    result.token = result.visitor ? result.visitor.token : result.token;
    const response = await this.senderFn({
      method: 'bridges:getLivechatBridge:doCreateMessage',
      params: [
        result,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishRoom(builder) {
    const result = builder.getRoom();
    delete result.id;
    if (!result.type) {
      throw new Error('Invalid type assigned to the room.');
    }
    if (result.type !== RoomType.LIVE_CHAT) {
      if (!result.creator || !result.creator.id) {
        throw new Error('Invalid creator assigned to the room.');
      }
    }
    if (result.type !== RoomType.DIRECT_MESSAGE) {
      if (result.type !== RoomType.LIVE_CHAT) {
        if (!result.slugifiedName || !result.slugifiedName.trim()) {
          throw new Error('Invalid slugifiedName assigned to the room.');
        }
      }
      if (!result.displayName || !result.displayName.trim()) {
        throw new Error('Invalid displayName assigned to the room.');
      }
    }
    const response = await this.senderFn({
      method: 'bridges:getRoomBridge:doCreate',
      params: [
        result,
        builder.getMembersToBeAddedUsernames(),
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishDiscussion(builder) {
    const room = builder.getRoom();
    delete room.id;
    if (!room.creator || !room.creator.id) {
      throw new Error('Invalid creator assigned to the discussion.');
    }
    if (!room.slugifiedName || !room.slugifiedName.trim()) {
      throw new Error('Invalid slugifiedName assigned to the discussion.');
    }
    if (!room.displayName || !room.displayName.trim()) {
      throw new Error('Invalid displayName assigned to the discussion.');
    }
    if (!room.parentRoom || !room.parentRoom.id) {
      throw new Error('Invalid parentRoom assigned to the discussion.');
    }
    const response = await this.senderFn({
      method: 'bridges:getRoomBridge:doCreateDiscussion',
      params: [
        room,
        builder.getParentMessage(),
        builder.getReply(),
        builder.getMembersToBeAddedUsernames(),
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishVideoConference(builder) {
    const videoConference = builder.getVideoConference();
    if (!videoConference.createdBy) {
      throw new Error('Invalid creator assigned to the video conference.');
    }
    if (!videoConference.providerName?.trim()) {
      throw new Error('Invalid provider name assigned to the video conference.');
    }
    if (!videoConference.rid) {
      throw new Error('Invalid roomId assigned to the video conference.');
    }
    const response = await this.senderFn({
      method: 'bridges:getVideoConferenceBridge:doCreate',
      params: [
        videoConference,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
  async _finishUser(builder) {
    const user = builder.getUser();
    const response = await this.senderFn({
      method: 'bridges:getUserBridge:doCreate',
      params: [
        user,
        AppObjectRegistry.get('id')
      ]
    });
    return String(response.result);
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZpbGU6Ly8vVXNlcnMvYWJoaW5hdi9yb2NrZXQuY2hhdC9Sb2NrZXQuQ2hhdC9wYWNrYWdlcy9hcHBzLWVuZ2luZS9kZW5vLXJ1bnRpbWUvbGliL2FjY2Vzc29ycy9tb2RpZnkvTW9kaWZ5Q3JlYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IElNb2RpZnlDcmVhdG9yIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vYWNjZXNzb3JzL0lNb2RpZnlDcmVhdG9yLnRzJztcbmltcG9ydCB0eXBlIHsgSVVwbG9hZENyZWF0b3IgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSVVwbG9hZENyZWF0b3IudHMnO1xuaW1wb3J0IHR5cGUgeyBJRW1haWxDcmVhdG9yIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vYWNjZXNzb3JzL0lFbWFpbENyZWF0b3IudHMnO1xuaW1wb3J0IHR5cGUgeyBJQ29udGFjdENyZWF0b3IgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSUNvbnRhY3RDcmVhdG9yLnRzJztcbmltcG9ydCB0eXBlIHsgSUxpdmVjaGF0Q3JlYXRvciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL2FjY2Vzc29ycy9JTGl2ZWNoYXRDcmVhdG9yLnRzJztcbmltcG9ydCB0eXBlIHsgSU1lc3NhZ2UgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9tZXNzYWdlcy9JTWVzc2FnZS50cyc7XG5pbXBvcnQgdHlwZSB7IElSb29tIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vcm9vbXMvSVJvb20udHMnO1xuaW1wb3J0IHR5cGUgeyBJQm90VXNlciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL3VzZXJzL0lCb3RVc2VyLnRzJztcbmltcG9ydCB0eXBlIHsgVXNlclR5cGUgYXMgX1VzZXJUeXBlIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vdXNlcnMvVXNlclR5cGUudHMnO1xuaW1wb3J0IHR5cGUgeyBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbCBhcyBfUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWwgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9tZXRhZGF0YS9Sb2NrZXRDaGF0QXNzb2NpYXRpb25zLnRzJztcbmltcG9ydCB0eXBlIHsgSU1lc3NhZ2VCdWlsZGVyIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vYWNjZXNzb3JzL0lNZXNzYWdlQnVpbGRlci50cyc7XG5pbXBvcnQgdHlwZSB7IElSb29tQnVpbGRlciB9IGZyb20gJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL2FjY2Vzc29ycy9JUm9vbUJ1aWxkZXIudHMnO1xuaW1wb3J0IHR5cGUgeyBJVXNlckJ1aWxkZXIgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSVVzZXJCdWlsZGVyLnRzJztcbmltcG9ydCB0eXBlIHsgSVZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9hY2Nlc3NvcnMvSVZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIudHMnO1xuaW1wb3J0IHR5cGUgeyBSb29tVHlwZSBhcyBfUm9vbVR5cGUgfSBmcm9tICdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi9yb29tcy9Sb29tVHlwZS50cyc7XG5pbXBvcnQgdHlwZSB7IElMaXZlY2hhdE1lc3NhZ2VCdWlsZGVyIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vYWNjZXNzb3JzL0lMaXZlY2hhdE1lc3NhZ2VCdWlsZGVyLnRzJztcbmltcG9ydCB0eXBlIHsgVUlIZWxwZXIgYXMgX1VJSGVscGVyIH0gZnJvbSAnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL3NlcnZlci9taXNjL1VJSGVscGVyLnRzJztcblxuaW1wb3J0ICogYXMgTWVzc2VuZ2VyIGZyb20gJy4uLy4uL21lc3Nlbmdlci50cyc7XG5pbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gJ25vZGU6Y3J5cHRvJztcblxuaW1wb3J0IHsgQmxvY2tCdWlsZGVyIH0gZnJvbSAnLi4vYnVpbGRlcnMvQmxvY2tCdWlsZGVyLnRzJztcbmltcG9ydCB7IE1lc3NhZ2VCdWlsZGVyIH0gZnJvbSAnLi4vYnVpbGRlcnMvTWVzc2FnZUJ1aWxkZXIudHMnO1xuaW1wb3J0IHsgRGlzY3Vzc2lvbkJ1aWxkZXIsIElEaXNjdXNzaW9uQnVpbGRlciB9IGZyb20gJy4uL2J1aWxkZXJzL0Rpc2N1c3Npb25CdWlsZGVyLnRzJztcbmltcG9ydCB7IElMaXZlY2hhdE1lc3NhZ2UsIExpdmVjaGF0TWVzc2FnZUJ1aWxkZXIgfSBmcm9tICcuLi9idWlsZGVycy9MaXZlY2hhdE1lc3NhZ2VCdWlsZGVyLnRzJztcbmltcG9ydCB7IFJvb21CdWlsZGVyIH0gZnJvbSAnLi4vYnVpbGRlcnMvUm9vbUJ1aWxkZXIudHMnO1xuaW1wb3J0IHsgVXNlckJ1aWxkZXIgfSBmcm9tICcuLi9idWlsZGVycy9Vc2VyQnVpbGRlci50cyc7XG5pbXBvcnQgeyBBcHBWaWRlb0NvbmZlcmVuY2UsIFZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIgfSBmcm9tICcuLi9idWlsZGVycy9WaWRlb0NvbmZlcmVuY2VCdWlsZGVyLnRzJztcbmltcG9ydCB7IEFwcE9iamVjdFJlZ2lzdHJ5IH0gZnJvbSAnLi4vLi4vLi4vQXBwT2JqZWN0UmVnaXN0cnkudHMnO1xuaW1wb3J0IHsgcmVxdWlyZSB9IGZyb20gJy4uLy4uLy4uL2xpYi9yZXF1aXJlLnRzJztcblxuY29uc3QgeyBVSUhlbHBlciB9ID0gcmVxdWlyZSgnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL3NlcnZlci9taXNjL1VJSGVscGVyLmpzJykgYXMgeyBVSUhlbHBlcjogdHlwZW9mIF9VSUhlbHBlciB9O1xuY29uc3QgeyBSb29tVHlwZSB9ID0gcmVxdWlyZSgnQHJvY2tldC5jaGF0L2FwcHMtZW5naW5lL2RlZmluaXRpb24vcm9vbXMvUm9vbVR5cGUuanMnKSBhcyB7IFJvb21UeXBlOiB0eXBlb2YgX1Jvb21UeXBlIH07XG5jb25zdCB7IFVzZXJUeXBlIH0gPSByZXF1aXJlKCdAcm9ja2V0LmNoYXQvYXBwcy1lbmdpbmUvZGVmaW5pdGlvbi91c2Vycy9Vc2VyVHlwZS5qcycpIGFzIHsgVXNlclR5cGU6IHR5cGVvZiBfVXNlclR5cGUgfTtcbmNvbnN0IHsgUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWwgfSA9IHJlcXVpcmUoJ0Byb2NrZXQuY2hhdC9hcHBzLWVuZ2luZS9kZWZpbml0aW9uL21ldGFkYXRhL1JvY2tldENoYXRBc3NvY2lhdGlvbnMuanMnKSBhcyB7XG4gICAgUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWw6IHR5cGVvZiBfUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWw7XG59O1xuXG5leHBvcnQgY2xhc3MgTW9kaWZ5Q3JlYXRvciBpbXBsZW1lbnRzIElNb2RpZnlDcmVhdG9yIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHNlbmRlckZuOiB0eXBlb2YgTWVzc2VuZ2VyLnNlbmRSZXF1ZXN0KSB7IH1cblxuICAgIGdldExpdmVjaGF0Q3JlYXRvcigpOiBJTGl2ZWNoYXRDcmVhdG9yIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm94eShcbiAgICAgICAgICAgIHsgX19raW5kOiAnZ2V0TGl2ZWNoYXRDcmVhdG9yJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGdldDogKF90YXJnZXQ6IHVua25vd24sIHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBJdCdzIG5vdCB3b3J0aHdoaWxlIHRvIG1ha2UgYW4gYXN5bmNocm9ub3VzIHJlcXVlc3QgZm9yIHN1Y2ggYSBzaW1wbGUgbWV0aG9kXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9wID09PSAnY3JlYXRlVG9rZW4nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCkgPT4gcmFuZG9tQnl0ZXMoMTYpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9wID09PSAndG9KU09OJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgpID0+ICh7fSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKC4uLnBhcmFtczogdW5rbm93bltdKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBgYWNjZXNzb3I6Z2V0TW9kaWZpZXI6Z2V0Q3JlYXRvcjpnZXRMaXZlY2hhdENyZWF0b3I6JHtwcm9wfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLnJlc3VsdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyLmVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgKSBhcyBJTGl2ZWNoYXRDcmVhdG9yO1xuICAgIH1cblxuICAgIGdldFVwbG9hZENyZWF0b3IoKTogSVVwbG9hZENyZWF0b3Ige1xuICAgICAgICByZXR1cm4gbmV3IFByb3h5KFxuICAgICAgICAgICAgeyBfX2tpbmQ6ICdnZXRVcGxvYWRDcmVhdG9yJyB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGdldDpcbiAgICAgICAgICAgICAgICAgICAgKF90YXJnZXQ6IHVua25vd24sIHByb3A6IHN0cmluZykgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICguLi5wYXJhbXM6IHVua25vd25bXSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wID09PSAndG9KU09OJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHt9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGBhY2Nlc3NvcjpnZXRNb2RpZmllcjpnZXRDcmVhdG9yOmdldFVwbG9hZENyZWF0b3I6JHtwcm9wfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLnJlc3VsdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5lcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICkgYXMgSVVwbG9hZENyZWF0b3I7XG4gICAgfVxuXG4gICAgZ2V0RW1haWxDcmVhdG9yKCk6IElFbWFpbENyZWF0b3Ige1xuICAgICAgICByZXR1cm4gbmV3IFByb3h5KFxuICAgICAgICAgICAgeyBfX2tpbmQ6ICdnZXRFbWFpbENyZWF0b3InIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2V0OiAoX3RhcmdldDogdW5rbm93biwgcHJvcDogc3RyaW5nKSA9PiBcbiAgICAgICAgICAgICAgICAgICAgICAgICguLi5wYXJhbXM6IHVua25vd25bXSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9wID09PSAndG9KU09OJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHt9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGBhY2Nlc3NvcjpnZXRNb2RpZmllcjpnZXRDcmVhdG9yOmdldEVtYWlsQ3JlYXRvcjoke3Byb3B9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNwb25zZS5yZXN1bHQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIuZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9XG4gICAgICAgIClcbiAgICB9XG5cbiAgICBnZXRDb250YWN0Q3JlYXRvcigpOiBJQ29udGFjdENyZWF0b3Ige1xuICAgICAgICByZXR1cm4gbmV3IFByb3h5KFxuICAgICAgICAgICAgeyBfX2tpbmQ6ICdnZXRDb250YWN0Q3JlYXRvcicgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBnZXQ6IChfdGFyZ2V0OiB1bmtub3duLCBwcm9wOiBzdHJpbmcpID0+IFxuICAgICAgICAgICAgICAgICAgICAgICAgKC4uLnBhcmFtczogdW5rbm93bltdKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3AgPT09ICd0b0pTT04nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8ge31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB0aGlzLnNlbmRlckZuKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZDogYGFjY2Vzc29yOmdldE1vZGlmaWVyOmdldENyZWF0b3I6Z2V0Q29udGFjdENyZWF0b3I6JHtwcm9wfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gcmVzcG9uc2UucmVzdWx0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyLmVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgfVxuICAgICAgICApXG4gICAgfVxuXG4gICAgZ2V0QmxvY2tCdWlsZGVyKCkge1xuICAgICAgICByZXR1cm4gbmV3IEJsb2NrQnVpbGRlcigpO1xuICAgIH1cblxuICAgIHN0YXJ0TWVzc2FnZShkYXRhPzogSU1lc3NhZ2UpIHtcbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBNZXNzYWdlQnVpbGRlcihkYXRhKTtcbiAgICB9XG5cbiAgICBzdGFydExpdmVjaGF0TWVzc2FnZShkYXRhPzogSUxpdmVjaGF0TWVzc2FnZSkge1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgZGVsZXRlIGRhdGEuaWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IExpdmVjaGF0TWVzc2FnZUJ1aWxkZXIoZGF0YSk7XG4gICAgfVxuXG4gICAgc3RhcnRSb29tKGRhdGE/OiBJUm9vbSkge1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZSAtIHRoaXMgaGFzIGJlZW4gaW1wb3J0ZWQgZnJvbSB0aGUgQXBwcy1FbmdpbmVcbiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmlkO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBSb29tQnVpbGRlcihkYXRhKTtcbiAgICB9XG5cbiAgICBzdGFydERpc2N1c3Npb24oZGF0YT86IFBhcnRpYWw8SVJvb20+KSB7XG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBkZWxldGUgZGF0YS5pZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgRGlzY3Vzc2lvbkJ1aWxkZXIoZGF0YSk7XG4gICAgfVxuXG4gICAgc3RhcnRWaWRlb0NvbmZlcmVuY2UoZGF0YT86IFBhcnRpYWw8QXBwVmlkZW9Db25mZXJlbmNlPikge1xuICAgICAgICByZXR1cm4gbmV3IFZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIoZGF0YSk7XG4gICAgfVxuXG4gICAgc3RhcnRCb3RVc2VyKGRhdGE/OiBQYXJ0aWFsPElCb3RVc2VyPikge1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgZGVsZXRlIGRhdGEuaWQ7XG5cbiAgICAgICAgICAgIGNvbnN0IHsgcm9sZXMgfSA9IGRhdGE7XG5cbiAgICAgICAgICAgIGlmIChyb2xlcz8ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzUm9sZSA9IHJvbGVzXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoKHJvbGU6IHN0cmluZykgPT4gcm9sZS50b0xvY2FsZUxvd2VyQ2FzZSgpKVxuICAgICAgICAgICAgICAgICAgICAuc29tZSgocm9sZTogc3RyaW5nKSA9PiByb2xlID09PSAnYWRtaW4nIHx8IHJvbGUgPT09ICdvd25lcicgfHwgcm9sZSA9PT0gJ21vZGVyYXRvcicpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGhhc1JvbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHJvbGUgYXNzaWduZWQgdG8gdGhlIHVzZXIuIFNob3VsZCBub3QgYmUgYWRtaW4sIG93bmVyIG9yIG1vZGVyYXRvci4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghZGF0YS50eXBlKSB7XG4gICAgICAgICAgICAgICAgZGF0YS50eXBlID0gVXNlclR5cGUuQk9UO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBVc2VyQnVpbGRlcihkYXRhKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmluaXNoKFxuICAgICAgICBidWlsZGVyOiBJTWVzc2FnZUJ1aWxkZXIgfCBJTGl2ZWNoYXRNZXNzYWdlQnVpbGRlciB8IElSb29tQnVpbGRlciB8IElEaXNjdXNzaW9uQnVpbGRlciB8IElWaWRlb0NvbmZlcmVuY2VCdWlsZGVyIHwgSVVzZXJCdWlsZGVyLFxuICAgICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHN3aXRjaCAoYnVpbGRlci5raW5kKSB7XG4gICAgICAgICAgICBjYXNlIFJvY2tldENoYXRBc3NvY2lhdGlvbk1vZGVsLk1FU1NBR0U6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmlzaE1lc3NhZ2UoYnVpbGRlciBhcyBJTWVzc2FnZUJ1aWxkZXIpO1xuICAgICAgICAgICAgY2FzZSBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbC5MSVZFQ0hBVF9NRVNTQUdFOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9maW5pc2hMaXZlY2hhdE1lc3NhZ2UoYnVpbGRlciBhcyBJTGl2ZWNoYXRNZXNzYWdlQnVpbGRlcik7XG4gICAgICAgICAgICBjYXNlIFJvY2tldENoYXRBc3NvY2lhdGlvbk1vZGVsLlJPT006XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmlzaFJvb20oYnVpbGRlciBhcyBJUm9vbUJ1aWxkZXIpO1xuICAgICAgICAgICAgY2FzZSBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbC5ESVNDVVNTSU9OOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9maW5pc2hEaXNjdXNzaW9uKGJ1aWxkZXIgYXMgSURpc2N1c3Npb25CdWlsZGVyKTtcbiAgICAgICAgICAgIGNhc2UgUm9ja2V0Q2hhdEFzc29jaWF0aW9uTW9kZWwuVklERU9fQ09ORkVSRU5DRTpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZmluaXNoVmlkZW9Db25mZXJlbmNlKGJ1aWxkZXIgYXMgSVZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIpO1xuICAgICAgICAgICAgY2FzZSBSb2NrZXRDaGF0QXNzb2NpYXRpb25Nb2RlbC5VU0VSOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9maW5pc2hVc2VyKGJ1aWxkZXIgYXMgSVVzZXJCdWlsZGVyKTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGJ1aWxkZXIgcGFzc2VkIHRvIHRoZSBNb2RpZnlDcmVhdG9yLmZpbmlzaCBmdW5jdGlvbi4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2ZpbmlzaE1lc3NhZ2UoYnVpbGRlcjogSU1lc3NhZ2VCdWlsZGVyKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYnVpbGRlci5nZXRNZXNzYWdlKCk7XG4gICAgICAgIGRlbGV0ZSByZXN1bHQuaWQ7XG5cbiAgICAgICAgaWYgKCFyZXN1bHQuc2VuZGVyIHx8ICFyZXN1bHQuc2VuZGVyLmlkKSB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZGVyRm4oe1xuICAgICAgICAgICAgICAgIG1ldGhvZDogJ2JyaWRnZXM6Z2V0VXNlckJyaWRnZTpkb0dldEFwcFVzZXInLFxuICAgICAgICAgICAgICAgIHBhcmFtczogWydBUFBfSUQnXSxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBhcHBVc2VyID0gcmVzcG9uc2UucmVzdWx0O1xuXG4gICAgICAgICAgICBpZiAoIWFwcFVzZXIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2VuZGVyIGFzc2lnbmVkIHRvIHRoZSBtZXNzYWdlLicpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXN1bHQuc2VuZGVyID0gYXBwVXNlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQuYmxvY2tzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIENhbiB3ZSBtb3ZlIHRoaXMgZWxzZXdoZXJlPyBUaGlzIEFwcE9iamVjdFJlZ2lzdHJ5IHVzYWdlIGRvZXNuJ3QgcmVhbGx5IGJlbG9uZyBoZXJlLCBidXQgd2hlcmU/XG4gICAgICAgICAgICByZXN1bHQuYmxvY2tzID0gVUlIZWxwZXIuYXNzaWduSWRzKHJlc3VsdC5ibG9ja3MsIEFwcE9iamVjdFJlZ2lzdHJ5LmdldCgnaWQnKSB8fCAnJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZGVyRm4oe1xuICAgICAgICAgICAgbWV0aG9kOiAnYnJpZGdlczpnZXRNZXNzYWdlQnJpZGdlOmRvQ3JlYXRlJyxcbiAgICAgICAgICAgIHBhcmFtczogW3Jlc3VsdCwgQXBwT2JqZWN0UmVnaXN0cnkuZ2V0KCdpZCcpXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFN0cmluZyhyZXNwb25zZS5yZXN1bHQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2ZpbmlzaExpdmVjaGF0TWVzc2FnZShidWlsZGVyOiBJTGl2ZWNoYXRNZXNzYWdlQnVpbGRlcik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGlmIChidWlsZGVyLmdldFNlbmRlcigpICYmICFidWlsZGVyLmdldFZpc2l0b3IoKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbmlzaE1lc3NhZ2UoYnVpbGRlci5nZXRNZXNzYWdlQnVpbGRlcigpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1aWxkZXIuZ2V0TWVzc2FnZSgpO1xuICAgICAgICBkZWxldGUgcmVzdWx0LmlkO1xuXG4gICAgICAgIGlmICghcmVzdWx0LnRva2VuICYmICghcmVzdWx0LnZpc2l0b3IgfHwgIXJlc3VsdC52aXNpdG9yLnRva2VuKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHZpc2l0b3Igc2VuZGluZyB0aGUgbWVzc2FnZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0LnRva2VuID0gcmVzdWx0LnZpc2l0b3IgPyByZXN1bHQudmlzaXRvci50b2tlbiA6IHJlc3VsdC50b2tlbjtcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZGVyRm4oe1xuICAgICAgICAgICAgbWV0aG9kOiAnYnJpZGdlczpnZXRMaXZlY2hhdEJyaWRnZTpkb0NyZWF0ZU1lc3NhZ2UnLFxuICAgICAgICAgICAgcGFyYW1zOiBbcmVzdWx0LCBBcHBPYmplY3RSZWdpc3RyeS5nZXQoJ2lkJyldLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gU3RyaW5nKHJlc3BvbnNlLnJlc3VsdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZmluaXNoUm9vbShidWlsZGVyOiBJUm9vbUJ1aWxkZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBidWlsZGVyLmdldFJvb20oKTtcbiAgICAgICAgZGVsZXRlIHJlc3VsdC5pZDtcblxuICAgICAgICBpZiAoIXJlc3VsdC50eXBlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgdHlwZSBhc3NpZ25lZCB0byB0aGUgcm9vbS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQudHlwZSAhPT0gUm9vbVR5cGUuTElWRV9DSEFUKSB7XG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5jcmVhdG9yIHx8ICFyZXN1bHQuY3JlYXRvci5pZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjcmVhdG9yIGFzc2lnbmVkIHRvIHRoZSByb29tLicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlc3VsdC50eXBlICE9PSBSb29tVHlwZS5ESVJFQ1RfTUVTU0FHRSkge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC50eXBlICE9PSBSb29tVHlwZS5MSVZFX0NIQVQpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdC5zbHVnaWZpZWROYW1lIHx8ICFyZXN1bHQuc2x1Z2lmaWVkTmFtZS50cmltKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNsdWdpZmllZE5hbWUgYXNzaWduZWQgdG8gdGhlIHJvb20uJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5kaXNwbGF5TmFtZSB8fCAhcmVzdWx0LmRpc3BsYXlOYW1lLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkaXNwbGF5TmFtZSBhc3NpZ25lZCB0byB0aGUgcm9vbS4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zZW5kZXJGbih7XG4gICAgICAgICAgICBtZXRob2Q6ICdicmlkZ2VzOmdldFJvb21CcmlkZ2U6ZG9DcmVhdGUnLFxuICAgICAgICAgICAgcGFyYW1zOiBbcmVzdWx0LCBidWlsZGVyLmdldE1lbWJlcnNUb0JlQWRkZWRVc2VybmFtZXMoKSwgQXBwT2JqZWN0UmVnaXN0cnkuZ2V0KCdpZCcpXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFN0cmluZyhyZXNwb25zZS5yZXN1bHQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX2ZpbmlzaERpc2N1c3Npb24oYnVpbGRlcjogSURpc2N1c3Npb25CdWlsZGVyKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgY29uc3Qgcm9vbSA9IGJ1aWxkZXIuZ2V0Um9vbSgpO1xuICAgICAgICBkZWxldGUgcm9vbS5pZDtcblxuICAgICAgICBpZiAoIXJvb20uY3JlYXRvciB8fCAhcm9vbS5jcmVhdG9yLmlkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY3JlYXRvciBhc3NpZ25lZCB0byB0aGUgZGlzY3Vzc2lvbi4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcm9vbS5zbHVnaWZpZWROYW1lIHx8ICFyb29tLnNsdWdpZmllZE5hbWUudHJpbSgpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2x1Z2lmaWVkTmFtZSBhc3NpZ25lZCB0byB0aGUgZGlzY3Vzc2lvbi4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcm9vbS5kaXNwbGF5TmFtZSB8fCAhcm9vbS5kaXNwbGF5TmFtZS50cmltKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBkaXNwbGF5TmFtZSBhc3NpZ25lZCB0byB0aGUgZGlzY3Vzc2lvbi4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcm9vbS5wYXJlbnRSb29tIHx8ICFyb29tLnBhcmVudFJvb20uaWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBwYXJlbnRSb29tIGFzc2lnbmVkIHRvIHRoZSBkaXNjdXNzaW9uLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNlbmRlckZuKHtcbiAgICAgICAgICAgIG1ldGhvZDogJ2JyaWRnZXM6Z2V0Um9vbUJyaWRnZTpkb0NyZWF0ZURpc2N1c3Npb24nLFxuICAgICAgICAgICAgcGFyYW1zOiBbcm9vbSwgYnVpbGRlci5nZXRQYXJlbnRNZXNzYWdlKCksIGJ1aWxkZXIuZ2V0UmVwbHkoKSwgYnVpbGRlci5nZXRNZW1iZXJzVG9CZUFkZGVkVXNlcm5hbWVzKCksIEFwcE9iamVjdFJlZ2lzdHJ5LmdldCgnaWQnKV0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBTdHJpbmcocmVzcG9uc2UucmVzdWx0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9maW5pc2hWaWRlb0NvbmZlcmVuY2UoYnVpbGRlcjogSVZpZGVvQ29uZmVyZW5jZUJ1aWxkZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCB2aWRlb0NvbmZlcmVuY2UgPSBidWlsZGVyLmdldFZpZGVvQ29uZmVyZW5jZSgpO1xuXG4gICAgICAgIGlmICghdmlkZW9Db25mZXJlbmNlLmNyZWF0ZWRCeSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNyZWF0b3IgYXNzaWduZWQgdG8gdGhlIHZpZGVvIGNvbmZlcmVuY2UuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXZpZGVvQ29uZmVyZW5jZS5wcm92aWRlck5hbWU/LnRyaW0oKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHByb3ZpZGVyIG5hbWUgYXNzaWduZWQgdG8gdGhlIHZpZGVvIGNvbmZlcmVuY2UuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXZpZGVvQ29uZmVyZW5jZS5yaWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByb29tSWQgYXNzaWduZWQgdG8gdGhlIHZpZGVvIGNvbmZlcmVuY2UuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuc2VuZGVyRm4oe1xuICAgICAgICAgICAgbWV0aG9kOiAnYnJpZGdlczpnZXRWaWRlb0NvbmZlcmVuY2VCcmlkZ2U6ZG9DcmVhdGUnLFxuICAgICAgICAgICAgcGFyYW1zOiBbdmlkZW9Db25mZXJlbmNlLCBBcHBPYmplY3RSZWdpc3RyeS5nZXQoJ2lkJyldLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gU3RyaW5nKHJlc3BvbnNlLnJlc3VsdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZmluaXNoVXNlcihidWlsZGVyOiBJVXNlckJ1aWxkZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCB1c2VyID0gYnVpbGRlci5nZXRVc2VyKCk7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNlbmRlckZuKHtcbiAgICAgICAgICAgIG1ldGhvZDogJ2JyaWRnZXM6Z2V0VXNlckJyaWRnZTpkb0NyZWF0ZScsXG4gICAgICAgICAgICBwYXJhbXM6IFt1c2VyLCBBcHBPYmplY3RSZWdpc3RyeS5nZXQoJ2lkJyldLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gU3RyaW5nKHJlc3BvbnNlLnJlc3VsdCk7XG4gICAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQW1CQSxTQUFTLFdBQVcsUUFBUSxjQUFjO0FBRTFDLFNBQVMsWUFBWSxRQUFRLDhCQUE4QjtBQUMzRCxTQUFTLGNBQWMsUUFBUSxn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