sequenceDiagram
    autonumber
    participant U as User Client
    participant RS as Room State
    participant Sub as Subscriptions Store
    participant API as REST API
    participant KMS as Key Source (peer/creator)

    Note over RS: Initial load
    U->>RS: Open room
    RS->>RS: state = NOT_STARTED

    alt Existing key present
        Sub-->>RS: E2EKey (room subscription)
        RS->>RS: state = KEYS_RECEIVED
    else Suggested key rotation
        Sub-->>RS: E2ESuggestedKey
        RS->>RS: importSuggestedKey()
        RS-->>API: POST /v1/e2e.acceptSuggestedGroupKey
        RS->>RS: state = KEYS_RECEIVED
    else No key yet
        RS->>RS: remain NOT_STARTED
    end

    U->>RS: handshake()
    RS->>RS: Guard: require state in {NOT_STARTED, KEYS_RECEIVED} & e2e.isReady()
    RS->>RS: state = ESTABLISHING

    opt Fast-path import
        Sub-->>RS: (lookup) E2EKey
        RS->>RS: importGroupKey()
        RS->>RS: state = READY
        RS-->>U: Handshake complete
    end

    alt No existing key
        RS-->>API: Request /v1/e2e.requestSubscriptionKeys
        API-->>RS: 404 / no material
        RS->>RS: state = CREATING_KEYS
        RS->>RS: generate group key
        RS-->>API: publish new key
        RS->>RS: state = READY
        RS-->>U: Handshake complete
    else Key arrives late
        par Parallel events
            API-->>RS: E2EKey via subscription update
            RS-->>RS: state = KEYS_RECEIVED
        and RS->>RS: continuing ESTABLISHING
        end
        RS->>RS: importGroupKey() (idempotent)
        RS->>RS: state = READY
        RS-->>U: Handshake complete
    end

    rect rgba(255,200,0,0.15)
    note over RS: ERROR path
    RS-->>RS: on fetch/import error -> state = ERROR
    Sub-->>RS: Later E2EKey
    RS->>RS: state = KEYS_RECEIVED
    U->>RS: handshake() retry
    end

    rect rgba(150,200,255,0.15)
    note over RS: Key rotation
    Sub-->>RS: E2ESuggestedKey
    RS->>RS: importGroupKey() (new keyID)
    RS-->>API: acceptSuggestedGroupKey
    RS->>RS: state = KEYS_RECEIVED
    U->>RS: handshake() (re-establish)
    RS->>RS: state = ESTABLISHING -> READY
    end